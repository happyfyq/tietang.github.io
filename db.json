{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/favicon.ico","path":"favicon.ico","modified":0,"renderable":0},{"_id":"source/images/m1.jpg","path":"images/m1.jpg","modified":0,"renderable":0},{"_id":"source/images/185638fo3y9el8ie2ohese.jpg","path":"images/185638fo3y9el8ie2ohese.jpg","modified":0,"renderable":0},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/weix.jpg","path":"images/weix.jpg","modified":0,"renderable":1},{"_id":"source/images/weix.jpg","path":"images/weix.jpg","modified":0,"renderable":0}],"Cache":[{"_id":"source/.DS_Store","hash":"d34cc5b7877ad3f76d4e9aa0194dca214d0886e9","modified":1495341810000},{"_id":"source/CNAME","hash":"704f5291fe9f9f9d297c839806479c17e209a2d7","modified":1495341810000},{"_id":"source/favicon.ico","hash":"a5c41d966e5eef597a50b91f0b6a9bdf8ac80583","modified":1495341811000},{"_id":"source/readme.md","hash":"fdef384994559bdcc01dfdd1d772ff778cc92d01","modified":1495341811000},{"_id":"themes/next/.bowerrc","hash":"3228a58ed0ece9f85e1e3136352094080b8dece1","modified":1490291568000},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1490291568000},{"_id":"themes/next/.hound.yml","hash":"b76daa84c9ca3ad292c78412603370a367cc2bc3","modified":1490291568000},{"_id":"themes/next/.gitattributes","hash":"44bd4729c74ccb88110804f41746fec07bf487d4","modified":1490291568000},{"_id":"themes/next/.gitignore","hash":"5f09fca02e030b7676c1d312cd88ce8fbccf381c","modified":1490291568000},{"_id":"themes/next/.jshintrc","hash":"9928f81bd822f6a8d67fdbc909b517178533bca9","modified":1490291568000},{"_id":"themes/next/.travis.yml","hash":"c42d9608c8c7fe90de7b1581a8dc3886e90c179e","modified":1490291568000},{"_id":"themes/next/.javascript_ignore","hash":"f9ea3c5395f8feb225a24e2c32baa79afda30c16","modified":1490291568000},{"_id":"themes/next/.stylintrc","hash":"b28e24704a5d8de08346c45286574c8e76cc109f","modified":1490291568000},{"_id":"themes/next/LICENSE","hash":"f293bcfcdc06c0b77ba13570bb8af55eb5c059fd","modified":1490291568000},{"_id":"themes/next/README.en.md","hash":"4ece25ee5f64447cd522e54cb0fffd9a375f0bd4","modified":1490291568000},{"_id":"themes/next/_config.yml","hash":"5753c2345343829104413e6f4e35a0f347a301e7","modified":1496636334000},{"_id":"themes/next/README.md","hash":"500b5606eb6a09c979d16128f8b00f4bf9bc95ac","modified":1490291568000},{"_id":"themes/next/bower.json","hash":"5abc236d9cc2512f5457ed57c1fba76669eb7399","modified":1490291568000},{"_id":"themes/next/gulpfile.coffee","hash":"031bffc483e417b20e90eceb6cf358e7596d2e69","modified":1490291568000},{"_id":"themes/next/package.json","hash":"7e87b2621104b39a30488654c2a8a0c6a563574b","modified":1490291568000},{"_id":"source/_posts/.DS_Store","hash":"ae50929691b60c2af2ab2b5f0ae6e2ed89ad9fb5","modified":1495341810000},{"_id":"source/_posts/春天花会开.md","hash":"ef48ea849017084cde1c927b67a625edcfac1f8b","modified":1495341811000},{"_id":"source/categories/index.md","hash":"294d1802502f5b81ac182231acc346304a566d2f","modified":1495341811000},{"_id":"source/about/index.md","hash":"75cbc514dd78b7419574eefa17b1a3d7b1766760","modified":1495341811000},{"_id":"source/images/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1495341811000},{"_id":"source/tags/index.md","hash":"a1b7d6bd13f485f8f96e966d176804a1d15f5757","modified":1495341811000},{"_id":"source/images/m1.jpg","hash":"4975231d503be2c0b00ed01322b88d70574d3076","modified":1495341811000},{"_id":"themes/next/languages/de.yml","hash":"306db8c865630f32c6b6260ade9d3209fbec8011","modified":1490291568000},{"_id":"themes/next/languages/default.yml","hash":"4cc6aeb1ac09a58330e494c8771773758ab354af","modified":1490291568000},{"_id":"themes/next/languages/en.yml","hash":"e7def07a709ef55684490b700a06998c67f35f39","modified":1490291568000},{"_id":"themes/next/languages/fr-FR.yml","hash":"24180322c83587a153cea110e74e96eacc3355ad","modified":1490291568000},{"_id":"themes/next/languages/id.yml","hash":"2835ea80dadf093fcf47edd957680973f1fb6b85","modified":1490291568000},{"_id":"themes/next/languages/ja.yml","hash":"1c3a05ab80a6f8be63268b66da6f19da7aa2c638","modified":1490291568000},{"_id":"themes/next/languages/ko.yml","hash":"be150543379150f78329815af427bf152c0e9431","modified":1490291568000},{"_id":"themes/next/languages/pt-BR.yml","hash":"958e49571818a34fdf4af3232a07a024050f8f4e","modified":1490291568000},{"_id":"themes/next/languages/pt.yml","hash":"36c8f60dacbe5d27d84d0e0d6974d7679f928da0","modified":1490291568000},{"_id":"themes/next/languages/ru.yml","hash":"7462c3017dae88e5f80ff308db0b95baf960c83f","modified":1490291568000},{"_id":"themes/next/languages/zh-Hans.yml","hash":"3c0c7dfd0256457ee24df9e9879226c58cb084b5","modified":1490291568000},{"_id":"themes/next/languages/zh-hk.yml","hash":"1c917997413bf566cb79e0975789f3c9c9128ccd","modified":1490291568000},{"_id":"themes/next/languages/zh-tw.yml","hash":"0b2c18aa76570364003c8d1cd429fa158ae89022","modified":1490291568000},{"_id":"themes/next/layout/_layout.swig","hash":"909d68b164227fe7601d82e2303bf574eb754172","modified":1490291568000},{"_id":"themes/next/layout/archive.swig","hash":"b5b59d70fc1563f482fa07afd435752774ad5981","modified":1490291568000},{"_id":"themes/next/layout/category.swig","hash":"6422d196ceaff4220d54b8af770e7e957f3364ad","modified":1490291568000},{"_id":"themes/next/layout/page.swig","hash":"3727fab9dadb967e9c2204edca787dc72264674a","modified":1490291568000},{"_id":"themes/next/layout/index.swig","hash":"427d0b95b854e311ae363088ab39a393bf8fdc8b","modified":1490291568000},{"_id":"themes/next/layout/post.swig","hash":"e2e512142961ddfe77eba29eaa88f4a2ee43ae18","modified":1495358037000},{"_id":"themes/next/layout/schedule.swig","hash":"234dc8c3b9e276e7811c69011efd5d560519ef19","modified":1490291568000},{"_id":"themes/next/scripts/merge-configs.js","hash":"13c8b3a2d9fce06c2488820d9248d190c8100e0a","modified":1490291568000},{"_id":"themes/next/scripts/merge.js","hash":"9130dabe6a674c54b535f322b17d75fe6081472f","modified":1490291568000},{"_id":"themes/next/layout/tag.swig","hash":"07cf49c49c39a14dfbe9ce8e7d7eea3d4d0a4911","modified":1490291568000},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1490291568000},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1490291568000},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1490291568000},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"source/_posts/MQ/一次线上事故对本地文件异步队列的思考.md","hash":"8837460393e087deba886cd860ca5f72a1e31abf","modified":1495341856000},{"_id":"source/_posts/MQ/本地文件队列-异步隔离.md","hash":"5459e533d7119da31c694cbcd6d36bd357563095","modified":1495341810000},{"_id":"source/_posts/binlog/Maxwell MySQL binlog订阅和一些坑.md","hash":"427d74d1fc75d8beca10cb0e2373912a69e93358","modified":1495341810000},{"_id":"source/_posts/微服务/微服务下分布式事务问题.md","hash":"33648b18d4db077479f32c873ddb353e3e446be8","modified":1495341811000},{"_id":"source/_posts/nginx/安装Nginx&Lua模块.md","hash":"932a03236ad0efbdba511a5a4ca7aba839b98d83","modified":1495341811000},{"_id":"source/_posts/music/Matthew-Lien-Bleeding-Wolves.md","hash":"176287eb31802776c2d1202d8148d0c2ee944e13","modified":1495341811000},{"_id":"source/_posts/微服务/Feign使用性能优化.md","hash":"9eb416aac91ff5f85d2d8b4f43d80b2319f1ea0c","modified":1495341811000},{"_id":"source/_posts/微服务/微服务之API网关设计.md","hash":"a75c953e48774e8807ee7ca25c28c4c372ea7e55","modified":1495341811000},{"_id":"source/_posts/微服务/微服务之Eureka服务发现.md","hash":"8b77140ac18a74949c55cb2392a7afbac5ea8dff","modified":1495341811000},{"_id":"source/_posts/微服务/微服务之EurekaServer原理.md","hash":"bff270f7754d35529cc843dd01f56bb00d2f5029","modified":1495341811000},{"_id":"source/_posts/微服务/微服务之spring-cloud分布式外部化和中心化配置管理.md","hash":"f0c7a54fa1664c12b4cc72832680e16fd24d2670","modified":1495341811000},{"_id":"source/_posts/微服务/微服务之微.md","hash":"f0449b998678386a2dabb0c4924f4f406fd7a64f","modified":1495341811000},{"_id":"source/_posts/微服务/微服务优缺点论述.md","hash":"73a9473b98eff79c6d22f29a0fe75c6214ec343d","modified":1495341811000},{"_id":"source/_posts/hystrix/.DS_Store","hash":"f9b6497e91a13896b90b89dd7549838a791a5a17","modified":1495341810000},{"_id":"source/_posts/微服务/微服务实施spring-cloud中踩过的坑.md","hash":"7ead383fd250ac7cfcd49dc988977fc3136ea629","modified":1495341811000},{"_id":"source/_posts/微服务/微服务拆分实践.md","hash":"a16a0605bd23d6e3e826c918aeddc7ea0f21332e","modified":1495341811000},{"_id":"source/_posts/hystrix/Hystrix semaphore和thread隔离的区别.md","hash":"663b7f14249bcc6198cc3ed5b4728397606aab50","modified":1495341810000},{"_id":"source/_posts/hystrix/Hystrix参数详解.md","hash":"f0a79b618f97690cf20bfb4719d570baa236d276","modified":1495341810000},{"_id":"source/_posts/hystrix/Hystrix降级模式总结.md","hash":"ff4ba6b939c0c07cb32da615766ef95e69d0519a","modified":1495341810000},{"_id":"source/_posts/hystrix/RestTemplate遇上Hystrix.md","hash":"33db7f4e658bd73de40e91215a0ee53104144a5c","modified":1495341810000},{"_id":"source/_posts/hystrix/Hystrix是怎样工作的.md.todo","hash":"12547685bb7c5d6c4703d6a652ccedb5765b2c20","modified":1495341810000},{"_id":"source/_posts/技术/.DS_Store","hash":"6a9f941481a966f9e939ba0d57cecaf1a09852a9","modified":1495341811000},{"_id":"source/_posts/hystrix/Hystrix简介.md","hash":"123c8b30be57d733d4c5b6e49d2483cf6929cc84","modified":1495341810000},{"_id":"source/_posts/hystrix/zuu参数l优化和配置.md","hash":"1db3c92e34bd5e54270b5997ade36a0d7fcc9dd0","modified":1495341811000},{"_id":"source/_posts/技术/JDBC如何开启事务.md","hash":"8bd14fef96a68933ba57552df1ec548253f7542f","modified":1495341811000},{"_id":"source/_posts/技术/负载均衡之加权轮询算法.md","hash":"eec5cc90000f17b90605cdc482f6072f6528d9b0","modified":1495341811000},{"_id":"source/_posts/技术/软件开发中的单一职责.md","hash":"f9bf87818cfbd64d8e92b57aafc146a5f7b0aa25","modified":1495341811000},{"_id":"source/_posts/hystrix/怎样使用Hystrix.md.todo","hash":"fdc0dbfb2d18fdf7cb8b15be71d40c7b16cf35b1","modified":1495341811000},{"_id":"source/_posts/转载/.DS_Store","hash":"10a5f5e23ea5263475686bb72ec99254d8d3997d","modified":1495341811000},{"_id":"source/images/185638fo3y9el8ie2ohese.jpg","hash":"4d278765113277adc24d16fda2004d179911d5bc","modified":1495341811000},{"_id":"themes/next/layout/_custom/header.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1495357593000},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"51e1596193320128c3461c180e304521c1be0a6c","modified":1495365323000},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"b16fcbf0efd20c018d7545257a8533c497ea7647","modified":1490291568000},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"5864f5567ba5efeabcf6ea355013c0b603ee07f2","modified":1490291568000},{"_id":"themes/next/layout/_macro/reward.swig","hash":"37e5b7c42ec17b9b6b786c5512bcc481a21c974e","modified":1490291568000},{"_id":"themes/next/layout/_macro/post.swig","hash":"640b431eccbbd27f10c6781f33db5ea9a6e064de","modified":1495357765000},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"911b99ba0445b2c07373128d87a4ef2eb7de341a","modified":1490291568000},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"14e785adeb0e671ba0ff9a553e6f0d8def6c670c","modified":1490291568000},{"_id":"themes/next/layout/_partials/comments.swig","hash":"1c7d3c975e499b9aa3119d6724b030b7b00fc87e","modified":1490291568000},{"_id":"themes/next/layout/_partials/footer.swig","hash":"7172c6053118b7c291a56a7860128a652ae66b83","modified":1490291568000},{"_id":"themes/next/layout/_partials/head.swig","hash":"a0eafe24d1dae30c790ae35612154b3ffbbd5cce","modified":1490291568000},{"_id":"themes/next/layout/_partials/header.swig","hash":"a1ffbb691dfad3eaf2832a11766e58a179003b8b","modified":1490291568000},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"1efd925d34a5d4ba2dc0838d9c86ba911e705fc9","modified":1490291568000},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9e8e21d194ef44d271b1cca0bc1448c14d7edf4f","modified":1490291568000},{"_id":"themes/next/layout/_partials/search.swig","hash":"9dbd378e94abfcb3f864a5b8dbbf18d212ca2ee0","modified":1490291568000},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"5d4638c46aef65bf32a01681495b62416ccc98db","modified":1490291568000},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"7c04a42319d728be356746363aff8ea247791d24","modified":1490291568000},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"6d25596d6a7c57700d37b607f8d9a62d89708683","modified":1490291568000},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"22369026c87fc23893c35a7f250b42f3bb1b60f1","modified":1490291568000},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"03aaebe9d50f6acb007ec38cc04acd1cfceb404d","modified":1490291568000},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"766b2bdda29523ed6cd8d7aa197f996022f8fd94","modified":1490291568000},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"9de352a32865869e7ed6863db271c46db5853e5a","modified":1490291568000},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"535fc542781021c4326dec24d8495cbb1387634a","modified":1490291568000},{"_id":"themes/next/scripts/tags/button.js","hash":"62e6dbeb53d07627a048132c79630b45d9a8f2cc","modified":1490291568000},{"_id":"themes/next/scripts/tags/exturl.js","hash":"8d7e60f60779bde050d20fd76f6fdc36fc85e06d","modified":1490291568000},{"_id":"themes/next/scripts/tags/full-image.js","hash":"8eeb3fb89540299bdbb799edfdfdac3743b50596","modified":1490291568000},{"_id":"themes/next/scripts/tags/note.js","hash":"6752925eedbdb939d8ec4d11bdfb75199f18dd70","modified":1490291568000},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"49252824cd53184dc9b97b2f2d87ff28e1b3ef27","modified":1490291568000},{"_id":"themes/next/source/css/main.styl","hash":"20702c48d6053c92c5bcdbc68e8d0ef1369848a0","modified":1490291568000},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"90035272fa31a3f65b3c0e2cb8a633876ef457dc","modified":1490291568000},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1490291568000},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1490291568000},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1490291568000},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1490291568000},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1490291568000},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1490291568000},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1490291568000},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1490291568000},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1490291568000},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1490291568000},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1490291568000},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1490291568000},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1490291568000},{"_id":"source/_posts/MQ/async.png","hash":"e7556005419741286cf6caf655f883db0cfe9597","modified":1495341810000},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1490291568000},{"_id":"source/_posts/技术/FlatBuffers/FlatBuffers简介.md","hash":"26ff079b5809dd67ba1cb07f8fffa16820a51bbd","modified":1495341811000},{"_id":"source/_posts/技术/FlatBuffers/FlatBuffers使用指南.md","hash":"1e449739cb72cf1721461a9707d27f5c424c1c6b","modified":1495341811000},{"_id":"source/_posts/技术/工具/wrk基准测试工具安装使用.md","hash":"bcd0db7bd156b9036f7e34cf9d3f7caaebd02d34","modified":1495341811000},{"_id":"source/_posts/技术/Hexo/Hexo命令速记.md","hash":"957bd92c5466c58b049b139bc86d34e5e2e70e2c","modified":1495341811000},{"_id":"source/_posts/技术/领域模型/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1495341811000},{"_id":"source/_posts/转载/http2.0/装载：HTTP2-0的奇妙日常.md","hash":"9b597fa6a433bdf287bbae9c50679bda3dd270b7","modified":1495341811000},{"_id":"source/_posts/技术/领域模型/领域模型的价值.md","hash":"559ff74a1c99e776f64cae80e823057b11b77d39","modified":1495341811000},{"_id":"source/_posts/hystrix/images/.DS_Store","hash":"d3ed620ce95c9987592040ac15a4fd1e2ed1bdf0","modified":1495341810000},{"_id":"source/_posts/hystrix/images/circuit-identity-jitter-640.png","hash":"135da3a23c10948de618849d6494b0dfc433f2c6","modified":1495341810000},{"_id":"source/_posts/hystrix/images/circuit-identity-jitter.png","hash":"821d85ffcd3d26c7a887e1e44134c679314efe8e","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-direct-vs-turbine-640.png","hash":"276a9423acbda0686cd8b5a145d50bf8970fca77","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-example-open-circuit-640.png","hash":"fd81fc8bcd35391f9121907ce45efcdcda3a385d","modified":1495341810000},{"_id":"source/_posts/hystrix/images/fallback-640.png","hash":"c0d6c9bf527dde8fa08355e05b38b8b95f8c0f6b","modified":1495341810000},{"_id":"source/_posts/hystrix/images/fallback-original.png","hash":"3e32d8498d66d1dab0d8b4fcb9f5637536bba2b2","modified":1495341810000},{"_id":"source/_posts/hystrix/images/fallback-via-command-640.png","hash":"b126e4a3c058c320fc7d5bbcabef89650e3af2bc","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-dashboard-single-row-640.png","hash":"27f4fb06ec60fdb17245c209be28b229155939ab","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-flow-chart-640.png","hash":"bf8298330f1dab68b6be738af506ced4d471f208","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-small.png","hash":"56efa7fcc51b9e83f4349411926d31fd699a0a5b","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tagline-tiny.png","hash":"91a5f1685da6faa6339257f58757af739c70df9c","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tiny.png","hash":"230ea59eacd045eef9bb24a8276c2090bd6e49b3","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo.png","hash":"d1f1e2250adab47330eea7b7bbc8827dce70635b","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-return-flow-640.png","hash":"38897b0a0f3c0f233db9f064767436196fe2ef6d","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-return-flow.png","hash":"2c5d2ec83b730f679092013e8085a1032673adeb","modified":1495341810000},{"_id":"source/_posts/hystrix/images/library-migration-to-hystrix-without-640.png","hash":"3115e27c225110d3020606793c97e1e4fe7d2775","modified":1495341810000},{"_id":"source/_posts/hystrix/images/primary-secondary-example-640.png","hash":"6ba522ed88c63b18c7fbbdcc669aaa4c12233a02","modified":1495341811000},{"_id":"source/_posts/hystrix/images/request-example-with-latency-640.png","hash":"25febf95dd29b3e29356e9079b3caf1175a3e5ce","modified":1495341811000},{"_id":"source/_posts/hystrix/images/rolling-stats-640.png","hash":"e981ebefb95332bf421c4e3460f1aae610559ece","modified":1495341811000},{"_id":"source/_posts/hystrix/images/transitive-commands-640.png","hash":"4b9a9f10096913db1a6b825cd747c4b94997e0b4","modified":1495341811000},{"_id":"source/_posts/hystrix/images/transitive-commands.png","hash":"b8cd5957414b9740676c562dd935c335bec5b1b5","modified":1495341811000},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"9e1b9666efa77f4cf8d8261bcfa445a9ac608e53","modified":1490291568000},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"7ce76358411184482bb0934e70037949dd0da8ca","modified":1490291568000},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"2d1075f4cabcb3956b7b84a8e210f5a66f0a5562","modified":1490291568000},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"959b7e04a96a5596056e4009b73b6489c117597e","modified":1490291568000},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"eefe2388ff3d424694045eda21346989b123977c","modified":1490291568000},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"23e23dc0f76ef3c631f24c65277adf7ea517b383","modified":1490291568000},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"1f1107468aaf03f7d0dcd7eb2b653e2813a675b4","modified":1490291568000},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"89c5a5240ecb223acfe1d12377df5562a943fd5d","modified":1490291568000},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"63315fcf210799f894208c9f512737096df84962","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"60426bf73f8a89ba61fb1be2df3ad5398e32c4ef","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"deda6a814ed48debc694c4e0c466f06c127163d0","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"18e7bef8923d83ea42df6c97405e515a876cede4","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"8160b27bee0aa372c7dc7c8476c05bae57f58d0f","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"394d008e5e94575280407ad8a1607a028026cbc3","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"3358d11b9a26185a2d36c96049e4340e701646e4","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"92dc60821307fc9769bea9b2d60adaeb798342af","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"3658414379e0e8a34c45c40feadc3edc8dc55f88","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"5d9943d74cc2e0a91badcf4f755c6de77eab193a","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"a652f202bd5b30c648c228ab8f0e997eb4928e44","modified":1490291568000},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"c3971fd154d781088e1cc665035f8561a4098f4c","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"0e3378f7c39b2b0f69638290873ede6b6b6825c0","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"c316758546dc9ba6c60cb4d852c17ca6bb6d6724","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"a356b2185d40914447fde817eb3d358ab6b3e4c3","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/gentie.swig","hash":"03592d1d731592103a41ebb87437fe4b0a4c78ca","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"af9dd8a4aed7d06cf47b363eebff48850888566c","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"3e8dc5c6c912628a37e3b5f886bec7b2e5ed14ea","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"abb92620197a16ed2c0775edf18a0f044a82256e","modified":1490291568000},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"7240f2e5ec7115f8abbbc4c9ef73d4bed180fdc7","modified":1490291568000},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"c747fb5c6b1f500e8f0c583e44195878b66e4e29","modified":1490291568000},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"f4dbd4c896e6510ded8ebe05394c28f8a86e71bf","modified":1490291568000},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"cb3a5d36dbe1630bab84e03a52733a46df7c219b","modified":1490291568000},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"c057b17f79e8261680fbae8dc4e81317a127c799","modified":1490291568000},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"069d1357c717572256e5cdee09574ebce529cbae","modified":1490291568000},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1490291568000},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"a14546f7bdc270118ebcfe8c40ed43338abae881","modified":1495358380000},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"715d5b40dc52f319fe4bff0325beb874774d9bd9","modified":1490291568000},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"78a83c38f69a8747bb74e420e6c9eeef1ea76525","modified":1490291568000},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"c8d35a6b9e3bff6d8fdb66de853065af9d37562d","modified":1490291568000},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"06f432f328a5b8a9ef0dbd5301b002aba600b4ce","modified":1490291568000},{"_id":"themes/next/source/css/_variables/base.styl","hash":"28a7f84242ca816a6452a0a79669ca963d824607","modified":1490291568000},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1490291568000},{"_id":"themes/next/source/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1490291568000},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"aab7be0a6e2724b3faa9338db93c19556c559625","modified":1490291568000},{"_id":"themes/next/source/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1490291568000},{"_id":"themes/next/source/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1490291568000},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1490291568000},{"_id":"themes/next/source/js/src/post-details.js","hash":"af7a417dd1cb02465a7b98211653e7c6192e6d55","modified":1490291568000},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1490291568000},{"_id":"themes/next/source/js/src/utils.js","hash":"e13c9ccf70d593bdf3b8cc1d768f595abd610e6e","modified":1490291568000},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/.bower.json","hash":"cc40a9b11e52348e554c84e4a5c058056f6b7aeb","modified":1490291568000},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1490291568000},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"93ebd5b35e632f714dcf1753e1f6db77ec74449b","modified":1490291568000},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1490291568000},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"1decd8e1adad2cd6db0ab50cf56de6035156f4ea","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"a2aaaf12378db56bd10596ba3daae30950eac051","modified":1490291568000},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"13379463c7463b4b96d13556b46faa4cc38d81e6","modified":1490291568000},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4891864c24c28efecd81a6a8d3f261145190f901","modified":1490291568000},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"895d50fa29759af7835256522e9dd7dac597765c","modified":1490291568000},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"b7638afc93e9cd350d0783565ee9a7da6805ad8e","modified":1490291568000},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"65bc85d12197e71c40a55c0cd7f6823995a05222","modified":1490291568000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1490291568000},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1490291568000},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"5b38ae00297ffc07f433c632c3dbf7bde4cdf39a","modified":1490291568000},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"91745c2cc6c946c7275f952b2b0760b880cea69e","modified":1490291568000},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"05f960846f1c7a93dab1d3f9a1121e86812e8c88","modified":1490291568000},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"2ec99573e84c7117368beccb9e94b6bf35d2db03","modified":1490291568000},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1490291568000},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1490291568000},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1490291568000},{"_id":"source/_posts/hystrix/images/circuit-breaker-640.png","hash":"6dee7062440ac53277ef97e0bd8000e4c19b90d9","modified":1495341810000},{"_id":"source/_posts/hystrix/images/collapser-640.png","hash":"c27ac262add50eff2d2ff300b15d21b253929304","modified":1495341810000},{"_id":"source/_posts/hystrix/images/collapser-flow-640.png","hash":"28aa4117d38673c44dd0ec4a83b3869f07de1d4c","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-annoted-circuit-640.png","hash":"948e548cfef1deb9129b8ea82afef27b4cf94cc2","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-direct-vs-turbine.png","hash":"11d22278b6ce5c8f5d0dec564dde0c3a827a8571","modified":1495341810000},{"_id":"source/_posts/hystrix/images/fallback-via-command-1280.png","hash":"a9b7e695a88ec66e5dba042d4ed824084ad6c260","modified":1495341810000},{"_id":"source/_posts/hystrix/images/fallback-via-command-original.png","hash":"f179625e7510541b61cec9b8c326ed6ec1c79dea","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-command-flow-chart-640.png","hash":"111a6f17a4fc132dff069c60b797548d971cc0ea","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-command-flow-chart.png","hash":"530633edb85557bbb6a6f31b384bf7f2f95daa3a","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-dashboard-netflix-api-example-620.png","hash":"d837ef2bd778ec1eb56513ee4e699fecca41e7e8","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-dashboard-single-row.png","hash":"ad2f050bc1aebab2c9e66881d648e92b1ec41f6a","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tagline-640.png","hash":"209ea2caa9bd43006ce8f3bd11f2e228408153e9","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tagline-github-516.png","hash":"10e663fb2e3d839f8f875a92fc9a10dee1d71c50","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tagline-850.png","hash":"684300d9ef43d50c89c065e276871b7bef6199ac","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tagline-github-640.png","hash":"6542fb3862bada2a3e9f5f56846519f2dac9c0b8","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tagline.graffle","hash":"dc1b74c04d0c9a83943dede41f11f7702b0558db","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-logo-tagline.png","hash":"c3e6a33e0b0ceeb8c1218632415aacdd98d1a3fa","modified":1495341810000},{"_id":"source/_posts/hystrix/images/isolation-options-640.png","hash":"066719d23b378aa011dbc03e95cbe1e50741b8eb","modified":1495341810000},{"_id":"source/_posts/hystrix/images/library-migration-to-hystrix-640.png","hash":"9eb820ba5ffd5e1e34f1ab1767b838327ed8a1d0","modified":1495341810000},{"_id":"source/_posts/hystrix/images/library-migration-to-hystrix-with-640.png","hash":"810b1ddffb9b7f0327df0997ecebe562f293cf41","modified":1495341810000},{"_id":"source/_posts/hystrix/images/ops-cinematch-1-640.png","hash":"709e7ffcdc9fcba221ef91c48cb4ecca21115781","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-cinematch-1.png","hash":"8f2650b8712a0289f8233dd9043b618eaba562dc","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-getbookmarks-640.png","hash":"11d87be552894886f8968db273a04004f8b85161","modified":1495341811000},{"_id":"source/_posts/hystrix/images/request-cache-640.png","hash":"3432e75e505598e0875a10940fa6ef925577ca4c","modified":1495341811000},{"_id":"source/_posts/hystrix/images/rolling-stats-1280.png","hash":"5e299504ba402de113568f3a7d2207a51691af0b","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-1-640.png","hash":"0264dedf3fd4ec05ad4321151fb06728b3eb05a3","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-2-640.png","hash":"487f186ee27f9afaee04ea501770da21f9aebfa4","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-5-isolation-focused-640.png","hash":"4f40ed3361f652c019d9a56b4e3f990f5211b26c","modified":1495341811000},{"_id":"source/_posts/hystrix/images/thread-configuration-640.png","hash":"31fbb49d3d5525c0caf503103d56690f727ff318","modified":1495341811000},{"_id":"source/_posts/hystrix/images/thread-cost-60rps-640.png","hash":"3171b32cade8738593d21973588925be59fd9302","modified":1495341811000},{"_id":"themes/next/source/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1490291568000},{"_id":"source/_posts/hystrix/images/cascading-failure-preventing-640.png","hash":"a4faa2c09103e7b1f0ead2374b594716f979d9be","modified":1495341810000},{"_id":"source/_posts/hystrix/images/circuit-breaker-1280.png","hash":"c730869b2cd9bf96aa644c0a28870cb5ec7a125e","modified":1495341810000},{"_id":"source/_posts/hystrix/images/collapser-1280.png","hash":"e23cb36f2076c908f91cd188217a610fff1ddd41","modified":1495341810000},{"_id":"source/_posts/hystrix/images/collapser-flow-1280.png","hash":"e26a49f1d866e0995f02e11a8c70925887ea32e8","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-example-640.png","hash":"7dae892ac61dae2d3c60963deb7479f313abdda5","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-home-640.png","hash":"713063d28059ed57a743abe8bb330d302deaddd3","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-home.png","hash":"f34a8bf0d7a2b0be57bfb44c4a4265428a34c66f","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-dashboard-netflix-api-example.png","hash":"cec68ca6e16e2b89b78da6c2eaea946059bbf300","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-flow-chart-1280.png","hash":"022ba7d91a876f0be5d918b866c544b4f3c72e9f","modified":1495341810000},{"_id":"source/_posts/hystrix/images/isolation-options-1280.png","hash":"c11e4b8c8e78deae78046d46b8e2b33de5a588b6","modified":1495341810000},{"_id":"source/_posts/hystrix/images/ops-ab.png","hash":"687b75e3b21cc0f2761537dd15ca52680b090a8f","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-cinematch-2-640.png","hash":"04c5820fa5721ccb454a30e677db907d203a7cb7","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-cinematch-2.png","hash":"ad39f8d08e97b7ca5874edd5abea5fe8a35e4d93","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-complete-system.png","hash":"4b2fbdbb8884a21fc3d4ad9bd6be15f31d4e9208","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-social-640.png","hash":"e7524c836025c9c0eeb749fa681cca5c89408cfe","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-social-original.png","hash":"7ab759016de29869e840746869ae05559a39e303","modified":1495341811000},{"_id":"source/_posts/hystrix/images/primary-secondary-example-original.png","hash":"75ba5408cb5d0d31dc30341971efb5f2d05efea3","modified":1495341811000},{"_id":"source/_posts/hystrix/images/request-cache-1280.png","hash":"97e236f01a0e7a7028fab6010341259924915194","modified":1495341811000},{"_id":"source/_posts/hystrix/images/request-example-with-latency-1280.png","hash":"783113c029aafd7449a17c155592289a9f772ac8","modified":1495341811000},{"_id":"source/_posts/hystrix/images/rolling-stats-original.png","hash":"c6c56a4733950803b2bccdfb867b73200847f2af","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-3-640.png","hash":"6416dfb879bc3cac0c173fc68c71a4867c567da2","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-4-isolation-640.png","hash":"e87a1deb0ee48cc3643f4a72fd6474467040dd5c","modified":1495341811000},{"_id":"source/_posts/hystrix/images/thread-cost-60rps-original.png","hash":"f9ca0bfe40510d95aaaf707798e4f025da999b1b","modified":1495341811000},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"ba698f49dd3a868c95b240d802f5b1b24ff287e4","modified":1490291568000},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"28ff4ed6714c59124569ffcbd10f1173d53ca923","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"ef089a407c90e58eca10c49bc47ec978f96e03ba","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"59ad08bcc6fe9793594869ac2b4c525021453e78","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"0dfb4b3ba3180d7285e66f270e1d3fa0f132c3d2","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"a6bb5256be6195e76addbda12f4ed7c662d65e7a","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"711c8830886619d4f4a0598b0cde5499dce50c62","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"dd8a3b22fc2f222ac6e6c05bd8a773fb039169c0","modified":1490291568000},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"7804e31c44717c9a9ddf0f8482b9b9c1a0f74538","modified":1490291568000},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"2186be20e317505cd31886f1291429cc21f76703","modified":1490291568000},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"9c25c75311e1bd4d68df031d3f2ae6d141a90766","modified":1490291568000},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"013619c472c7e4b08311c464fcbe9fcf5edde603","modified":1490291568000},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"ece571f38180febaf02ace8187ead8318a300ea7","modified":1490291568000},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"64f5d56c08d74a338813df1265580ca0cbf0190b","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"c2d079788d6fc2e9a191ccdae94e50d55bf849dc","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"5ae7906dc7c1d9468c7f4b4a6feddddc555797a1","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"b0dcca862cd0cc6e732e33d975b476d744911742","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"fda14bc35be2e1b332809b55b3d07155a833dbf4","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9a5581a770af8964064fef7afd3e16963e45547f","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"0efa036a15c18f5abb058b7c0fad1dd9ac5eed4c","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"8829bc556ca38bfec4add4f15a2f028092ac6d46","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"82bbaa6322764779a1ac2e2c8390ce901c7972e2","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"a0e2030a606c934fb2c5c7373aaae04a1caac4c5","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c4ed249798296f60bda02351fe6404fb3ef2126f","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"1eb34b9c1f6d541605ff23333eeb133e1c4daf17","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"215de948be49bcf14f06d500cef9f7035e406a43","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"e3e23751d4ad24e8714b425d768cf68e37de7ded","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"2f878213cb24c5ddc18877f6d15ec5c5f57745ac","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"69ecd6c97e7cdfd822ac8102b45ad0ede85050db","modified":1490291568000},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"79da92119bc246fe05d1626ac98426a83ec90a94","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1490291568000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1490291568000},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1490291568000},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1490291568000},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1490291568000},{"_id":"source/_posts/hystrix/images/collapser-flow-original.png","hash":"69d9b785e6ce1ae5584ee19dedcc2e9765bab8b1","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-annoted-circuit-original.png","hash":"a25faa48260b30e92b1f9270d3fa11e9fc699db4","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-dashboard-netflix-api-example-iPad-620.png","hash":"e5ae3b5cfe3babd8c31334a663698cb9bfa8e48a","modified":1495341810000},{"_id":"source/_posts/hystrix/images/library-migration-to-hystrix-1280.png","hash":"03bc1c86572a73e334aac14e162fab6b93384e71","modified":1495341810000},{"_id":"source/_posts/hystrix/images/ops-ab-640.png","hash":"ec29160251d9c10722c7d87e80b8cd7c8e469fec","modified":1495341811000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1490291568000},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1490291568000},{"_id":"source/_posts/hystrix/images/ops-complete-system-640.png","hash":"47120ad690a834db225a8499caf8f19820ccb7ac","modified":1495341811000},{"_id":"source/_posts/hystrix/images/ops-getbookmarks.png","hash":"8596fc651f6182f54f85eefdc53cbaa2f52e54e0","modified":1495341811000},{"_id":"source/_posts/hystrix/images/request-cache-original.png","hash":"8435b5f070043655685148d3cd842a2edb70119e","modified":1495341811000},{"_id":"source/_posts/hystrix/images/request-example-with-latency-original.png","hash":"6430ac913484ef09e80c7b8d21f94b9785cc353f","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-1-1280.png","hash":"a7c73f21630a232dbeea1e7d71123704af683f5f","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-2-1280.png","hash":"6e602eb59079308e64c8bfe58807a728526b8e80","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-5-isolation-focused-1280.png","hash":"d366f2671c80c18c1a0c8510adab3df40f594b37","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-5-isolation-focused-original.png","hash":"2525840274b1d46cfd8f68b694c0613c26225236","modified":1495341811000},{"_id":"source/_posts/hystrix/images/thread-configuration-1280.png","hash":"a5b25580b21f8fe5bc1796ff563ec61ad769819c","modified":1495341811000},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"8994ffcce84deac0471532f270f97c44fea54dc0","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"ae1ca14e51de67b07dba8f61ec79ee0e2e344574","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"8a2421cb9005352905fae9d41a847ae56957247e","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"49c2b2c14a1e7fcc810c6be4b632975d0204c281","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"7778920dd105fa4de3a7ab206eeba30b1a7bac45","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"6c00f6e0978f4d8f9a846a15579963728aaa6a17","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"2039590632bba3943c39319d80ef630af7928185","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"4eff5b252d7b614e500fc7d52c97ce325e57d3ab","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"a82afbb72d83ee394aedc7b37ac0008a9823b4f4","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"beccb53dcd658136fb91a0c5678dea8f37d6e0b6","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"8fae54591877a73dff0b29b2be2e8935e3c63575","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f54367c0feda6986c030cc4d15a0ca6ceea14bcb","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"2cdc094ecf907a02fce25ad4a607cd5c40da0f2b","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"387ce23bba52b22a586b2dfb4ec618fe1ffd3926","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"b25132fe6a7ad67059a2c3afc60feabb479bdd75","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"b9a2e76f019a5941191f1263b54aef7b69c48789","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"a5d8617a24d7cb6c5ad91ea621183ca2c0917331","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"e792c8dc41561c96d128e9b421187f1c3dc978a0","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"963105a531403d7aad6d9e5e23e3bfabb8ec065a","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"10251257aceecb117233c9554dcf8ecfef8e2104","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"2e7ec9aaa3293941106b1bdd09055246aa3c3dc6","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"8c0276883398651336853d5ec0e9da267a00dd86","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"920343e41c124221a17f050bbb989494d44f7a24","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"5f6ea57aabfa30a437059bf8352f1ad829dbd4ff","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"9486ddd2cb255227db102d09a7df4cae0fabad72","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"45fa7193435a8eae9960267438750b4c9fa9587f","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"a2ec22ef4a6817bbb2abe8660fcd99fe4ca0cc5e","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"7690b9596ec3a49befbe529a5a2649abec0faf76","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"234facd038f144bd0fe09a31ed1357c5d74c517f","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"3623e7fa4324ec1307370f33d8f287a9e20a5578","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"96f32ea6c3265a3889e6abe57587f6e2a2a40dfb","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"755b04edbbfbdd981a783edb09c9cc34cb79cea7","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"b76387934fb6bb75212b23c1a194486892cc495e","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"c2abe4d87148e23e15d49ee225bc650de60baf46","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"1b3cc9f4e5a7f6e05b4100e9990b37b20d4a2005","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"b8969e1654eec89a0fd10d88b337fee9cb03cd44","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"4851b981020c5cbc354a1af9b831a2dcb3cf9d39","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"74d0ba86f698165d13402670382a822c8736a556","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"fd42777b9125fd8969dc39d4f15473e2b91b4142","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"dd310c2d999185e881db007360176ee2f811df10","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"93b08815c4d17e2b96fef8530ec1f1064dede6ef","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"d4e6d8d7b34dc69994593c208f875ae8f7e8a3ae","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/gentie.styl","hash":"586a3ec0f1015e7207cd6a2474362e068c341744","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"2340dd9b3202c61d73cc708b790fac5adddbfc7f","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"327b5f63d55ec26f7663185c1a778440588d9803","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"173490e21bece35a34858e8e534cf86e34561350","modified":1490291568000},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"42348219db93a85d2ee23cb06cebd4d8ab121726","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1490291568000},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1490291568000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1490291568000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1490291568000},{"_id":"source/_posts/hystrix/images/collapser-original.png","hash":"81fb51310999305b23285a99fac7d7836d4c3fd1","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-examples-webapp-home.png","hash":"10f9df7ad08a1080f97b700793e1edcb08417e81","modified":1495341810000},{"_id":"source/_posts/hystrix/images/isolation-options-original.png","hash":"0a3f5da5335e00dbbf329ddf2fd3394d4f568879","modified":1495341810000},{"_id":"source/_posts/hystrix/images/soa-3-1280.png","hash":"148452655f23b98891f10564cc53f5aca81cbbec","modified":1495341811000},{"_id":"source/_posts/hystrix/images/thread-configuration-original.png","hash":"1efac02e91756f059dcaf8bc6ff40ac46c6aa1ed","modified":1495341811000},{"_id":"source/_posts/hystrix/images/cascading-failure-preventing.png","hash":"7e08eb521c9856451681b25d18c056f889881684","modified":1495341810000},{"_id":"source/_posts/hystrix/images/circuit-breaker-original.png","hash":"aa93fa77ab6a206152a048d204964653dd73283d","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-example-1280.png","hash":"df18fe4eddd84e68416eb74c7697215dd6b0c827","modified":1495341810000},{"_id":"source/_posts/hystrix/images/dashboard-example-original.png","hash":"81ebad4a1aeba9b466d95c27505ac2dc0aa58903","modified":1495341810000},{"_id":"source/_posts/hystrix/images/hystrix-flow-chart-original.png","hash":"4577f01394b1605bcf9ff53157b494e51054bce7","modified":1495341810000},{"_id":"source/_posts/hystrix/images/soa-1-original.png","hash":"3ce4b0a11c2271fa92dc94cde82573afcbebc6b0","modified":1495341811000},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1490291568000},{"_id":"source/_posts/hystrix/images/soa-2-original.png","hash":"6747720006edb6770a28811c75c15f1b774fa87f","modified":1495341811000},{"_id":"source/_posts/hystrix/images/soa-4-isolation-1280.png","hash":"facf44be2c0fe54d059c8553f27342d7bfb4cfdd","modified":1495341811000},{"_id":"themes/next/source/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1490291568000},{"_id":"source/_posts/hystrix/images/hystrix-dashboard-netflix-api-example-iPad.png","hash":"33ddd07a4e65cc74edaf54913d71484e5c39f7d4","modified":1495341810000},{"_id":"source/_posts/hystrix/images/soa-3-original.png","hash":"046b841b7cb92583624480f513585b7d146ef5b1","modified":1495341811000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1490291568000},{"_id":"source/_posts/hystrix/images/library-migration-to-hystrix-original.png","hash":"426aa98175e52d516f470a6a34919a393b02a163","modified":1495341810000},{"_id":"source/_posts/hystrix/images/soa-4-isolation-original.png","hash":"68a394f28663ae3196ed23e4df7c1f377785d97e","modified":1495341811000},{"_id":"source/_posts/hystrix/images/hystrix.graffle","hash":"19ffa1864138388e506d53bb8d8eefa21f07c09f","modified":1495341810000},{"_id":"public/readme.html","hash":"1aaaa25f6d508f218ffa51c41dc7ced563f9bd6a","modified":1496636960783},{"_id":"public/categories/index.html","hash":"ada9218533b15747186f996c394ea2e183016f5b","modified":1496636960786},{"_id":"public/about/index.html","hash":"fd2702a51c0efba636bab6213e0966b3f7f505d3","modified":1496636960786},{"_id":"public/tags/index.html","hash":"ea5bf51941fcf9661b837568c46d81a8f8ba0a34","modified":1496636960786},{"_id":"public/2017/05/10/MQ/一次线上事故对本地文件异步队列的思考/index.html","hash":"a4a473436d6fd3353ffcb2404681807e2603052d","modified":1496636960786},{"_id":"public/2017/05/10/MQ/本地文件队列-异步隔离/index.html","hash":"0885e2cf604c25aa7dee2c08fa82ea08ed39d366","modified":1496636960787},{"_id":"public/2017/04/10/技术/JDBC如何开启事务/index.html","hash":"f27f0f469ab18bb90ee7a5995b814c66e9d3957d","modified":1496636960787},{"_id":"public/2017/03/26/微服务/微服务之EurekaServer原理/index.html","hash":"2ad5e02345cb29a433e2ba0b76c39fcf7bb9098d","modified":1496636960787},{"_id":"public/2016/11/27/nginx/安装Nginx&Lua模块/index.html","hash":"6695664406be3b8b4db675933ec5dde4918f1392","modified":1496636960787},{"_id":"public/2016/11/18/hystrix/Hystrix semaphore和thread隔离的区别/index.html","hash":"fc55a6f7d76f885483ba292072d21f2170379619","modified":1496636960787},{"_id":"public/2016/11/17/hystrix/zuu参数l优化和配置/index.html","hash":"a3c465479e51eb669377948294f3ab1de486fb71","modified":1496636960787},{"_id":"public/2016/11/09/binlog/Maxwell MySQL binlog订阅和一些坑/index.html","hash":"81211b9c5b4194594ced475a7bbab86a0623e0cb","modified":1496636960787},{"_id":"public/2016/09/10/微服务/微服务优缺点论述/index.html","hash":"7e997a9a6d7ce138b4d8aef95995da79d70acf77","modified":1496636960787},{"_id":"public/2016/09/08/微服务/微服务实施spring-cloud中踩过的坑/index.html","hash":"3a33db1dea37677025d4a40382dd7851cf74da02","modified":1496636960787},{"_id":"public/2016/09/08/微服务/微服务之spring-cloud分布式外部化和中心化配置管理/index.html","hash":"1096aa70df33c3563773ae327cf6a8e418c2764f","modified":1496636960787},{"_id":"public/2016/09/08/微服务/微服务拆分实践/index.html","hash":"1084bedbf6ceb0179bf0c162efb83f077256a0f3","modified":1496636960787},{"_id":"public/2016/09/08/微服务/微服务之API网关设计/index.html","hash":"27f982d98e9a747b28f45a77f2a09c42b9067243","modified":1496636960787},{"_id":"public/2016/09/08/微服务/微服务之Eureka服务发现/index.html","hash":"a4ad3d718714f48a034d57b00b6c7f6b1cdf65b5","modified":1496636960787},{"_id":"public/2016/09/08/微服务/微服务下分布式事务问题/index.html","hash":"342e7f92e2c6a8847c06d07110c710033a09b171","modified":1496636960787},{"_id":"public/2016/09/06/微服务/Feign使用性能优化/index.html","hash":"a3bbcad0ce35caaacde1ab7e2fbeeaf1eba436fb","modified":1496636960787},{"_id":"public/2016/09/02/hystrix/RestTemplate遇上Hystrix/index.html","hash":"420195e39c13912dfcb3b370cd6f4e5403bc7f43","modified":1496636960787},{"_id":"public/2016/06/28/技术/软件开发中的单一职责/index.html","hash":"60b22addab121a705204180663321118bde686d5","modified":1496636960788},{"_id":"public/2016/06/16/技术/负载均衡之加权轮询算法/index.html","hash":"52e5f4a5624ebfe5203fbcfe2826f59393feddfc","modified":1496636960788},{"_id":"public/2016/06/02/微服务/微服务之微/index.html","hash":"96110efa649fd3da613f52903d9f584843cc7a0b","modified":1496636960788},{"_id":"public/2016/03/09/hystrix/Hystrix降级模式总结/index.html","hash":"5aca0298ef470da1878e2c0d6e8934a2c37198a8","modified":1496636960788},{"_id":"public/2016/03/09/hystrix/Hystrix简介/index.html","hash":"8c277f1ee3c14484160b99902dd3842cf040e7d2","modified":1496636960788},{"_id":"public/2016/03/04/技术/工具/wrk基准测试工具安装使用/index.html","hash":"358b54c77032e4a53a5ecf687e1e2e9d8e4a7230","modified":1496636960788},{"_id":"public/2016/02/25/hystrix/Hystrix参数详解/index.html","hash":"9597859d8a6d18f7c8267d56bfc53a9769d3fb13","modified":1496636960788},{"_id":"public/2016/02/22/music/Matthew-Lien-Bleeding-Wolves/index.html","hash":"ce6397ac58fcaad7e076fcf2482fb850ae8f0511","modified":1496636960788},{"_id":"public/2016/02/22/转载/http2.0/装载：HTTP2-0的奇妙日常/index.html","hash":"89aab6fa05fe380269fbebefa6de854a1fa4aded","modified":1496636960788},{"_id":"public/2016/02/21/技术/Hexo/Hexo命令速记/index.html","hash":"c9cb54aa7194ccbd4b2aac57c1e9802d336c9fdb","modified":1496636960788},{"_id":"public/2016/02/21/技术/领域模型/领域模型的价值/index.html","hash":"e91d784770b67d2424a68e8c6feba31ffa1a9465","modified":1496636960788},{"_id":"public/2016/02/19/技术/FlatBuffers/FlatBuffers使用指南/index.html","hash":"ac35bfe95175e90c9346e1eaa85fd3e9c09f45dd","modified":1496636960788},{"_id":"public/2016/02/19/技术/FlatBuffers/FlatBuffers简介/index.html","hash":"c4ee56a2578357029c4f476acf5cae8616bee9f3","modified":1496636960788},{"_id":"public/2016/02/19/春天花会开/index.html","hash":"d3e4bd970359963b3f7c33a9d8c8c39ee2ec0ee3","modified":1496636960788},{"_id":"public/archives/index.html","hash":"7c63e50867eae14d170ee94df390bdead8d22c5f","modified":1496636960793},{"_id":"public/archives/page/2/index.html","hash":"5b029817525d0dab6341c60d8d8a6bec2df0301c","modified":1496636960793},{"_id":"public/archives/page/3/index.html","hash":"21ecb0262ee4fdb2b207f4bdbc003b6c3d722cb6","modified":1496636960793},{"_id":"public/archives/page/4/index.html","hash":"d016e27f495381090672d85d87cfed313e9b7f92","modified":1496636960793},{"_id":"public/archives/2016/index.html","hash":"4abbc4dc892f37280ba7725e64ec1d1b143919a1","modified":1496636960793},{"_id":"public/archives/2016/page/2/index.html","hash":"d3861684f205d439bc905ac1976172054b7318cc","modified":1496636960793},{"_id":"public/archives/2016/page/3/index.html","hash":"13f2e878e88d309489aa55c585df0881a7b60bcd","modified":1496636960793},{"_id":"public/archives/2016/02/index.html","hash":"01d681091f7a359b6b1be7a1c01ce36ea7e0c2b7","modified":1496636960793},{"_id":"public/archives/2016/03/index.html","hash":"81fe87ad0d84d8f4ebab41259d03c86e7f794951","modified":1496636960793},{"_id":"public/archives/2016/06/index.html","hash":"5dd84c37abda0b093d5eb18566a212e24428be13","modified":1496636960793},{"_id":"public/archives/2016/09/index.html","hash":"915dec3151bd761180de382e01d806080ba9ef16","modified":1496636960794},{"_id":"public/archives/2016/11/index.html","hash":"5318412bb473ff232a4d61ac7d0e0ef77284411f","modified":1496636960794},{"_id":"public/archives/2017/index.html","hash":"a08fa3a84d6fd54f2d7c3737371584274fc12eb1","modified":1496636960794},{"_id":"public/archives/2017/03/index.html","hash":"9157d5f865bb921f9ba6abe731b1d8c2ad61bb58","modified":1496636960794},{"_id":"public/archives/2017/04/index.html","hash":"615b6f19bf2ad655ae2515132059e057b773d3a3","modified":1496636960794},{"_id":"public/archives/2017/05/index.html","hash":"02438d90be7eeea7188863983c5c8e83e9c5a22d","modified":1496636960794},{"_id":"public/categories/那年今日/index.html","hash":"a8573bf166ff0cfec04b72f674f59aafd04c62f3","modified":1496636960789},{"_id":"public/categories/MQ/index.html","hash":"964c59d3b1f9cc3a19719523c696dfa6c2aa8a8b","modified":1496636960789},{"_id":"public/categories/mysql/index.html","hash":"4c5d5a1d876e488f1064f345fb358667ad9d75d5","modified":1496636960789},{"_id":"public/categories/微服务/index.html","hash":"24238dc90947c29de962b0ed07bf6fcba8d20dd0","modified":1496636960789},{"_id":"public/categories/nginx/index.html","hash":"bc2a3e3d2516f409215e1aa7129986582236913e","modified":1496636960789},{"_id":"public/categories/music/index.html","hash":"edce1cb1bfaabb6b0d3df8908ca4ead6955d2dfb","modified":1496636960789},{"_id":"public/categories/技术/index.html","hash":"eab72b3c040d51d598be09a9e0980208a989d2ad","modified":1496636960789},{"_id":"public/categories/技术/page/2/index.html","hash":"e7828e1f89922a390f8fcb1c61f9003947901f29","modified":1496636960789},{"_id":"public/categories/技术/Hystrix/index.html","hash":"32ae3bf5d18c5d0b14da63042c1cc57139d2882b","modified":1496636960789},{"_id":"public/categories/JDBC/index.html","hash":"2443884d9402e78250bd7d6a10b33ffd793fa737","modified":1496636960789},{"_id":"public/categories/技术/算法/index.html","hash":"c32fa968124bf626bbfd9acd4df272cc2e09d73a","modified":1496636960789},{"_id":"public/categories/技术/杂谈/index.html","hash":"9da0ea1fc420108fe756517dc39d12e3804bdc4a","modified":1496636960789},{"_id":"public/categories/技术/FlatBuffers/index.html","hash":"a5c1acf815705cdb1d6a6989d9bb39bf53a89159","modified":1496636960789},{"_id":"public/categories/技术/工具/index.html","hash":"a79458cc873523228d7772698969d999aa91b50d","modified":1496636960789},{"_id":"public/categories/转载/index.html","hash":"ae92737b2854a674f5bd1da474d53d7c8ace26ea","modified":1496636960789},{"_id":"public/categories/转载/http-2-0/index.html","hash":"f96eabf4a78a97620e32411c9e889d504b24af14","modified":1496636960789},{"_id":"public/categories/技术/Hexo/index.html","hash":"b1bd83e5b68cbbfb8f2ef974ebb5ee1ddf276dcd","modified":1496636960790},{"_id":"public/categories/技术/领域模型/index.html","hash":"5f15a47ed0f75ef7be86d205997d433d6bfbde5a","modified":1496636960792},{"_id":"public/index.html","hash":"da24e310fb1cae6a6c49c4bbc0beebd1b60ef64e","modified":1496636960792},{"_id":"public/page/2/index.html","hash":"11706767047b858c90e3cad5133a69fe128045ff","modified":1496636960792},{"_id":"public/page/3/index.html","hash":"e254a9e4252a288f41ab37a5eb66595c284e587a","modified":1496636960793},{"_id":"public/page/4/index.html","hash":"7c29511cdb77838883e83bcda35e4a109c734fa2","modified":1496636960793},{"_id":"public/tags/春天/index.html","hash":"f4671f0285804ca7634b914fc2b0964b77e64447","modified":1496636960794},{"_id":"public/tags/梅花/index.html","hash":"3ca2386856ebe0611d4c12797a13c395c28b48e6","modified":1496636960794},{"_id":"public/tags/MQ/index.html","hash":"30dcb8a8d3ac4b40eea6cf76b7363630940e49ea","modified":1496636960794},{"_id":"public/tags/本地文件队列/index.html","hash":"ce5511835d207b21151e1947613eae9a15419cb4","modified":1496636960794},{"_id":"public/tags/隔离/index.html","hash":"446d91a977b76321411d3842acbfd9b1b2739bec","modified":1496636960794},{"_id":"public/tags/降级/index.html","hash":"05f036bec27ff3a71590fe3f6873cdfd9a9d6a71","modified":1496636960794},{"_id":"public/tags/Maxwell/index.html","hash":"5583f8d05e812ebcdc18b6cb4e7e208831e33048","modified":1496636960795},{"_id":"public/tags/binlog/index.html","hash":"626a27d2a5804810c7a91d4039a60c0b0dd7064e","modified":1496636960795},{"_id":"public/tags/mysql/index.html","hash":"10cb29d9cbfcb6c38d3a921e35bfb13801554d73","modified":1496636960795},{"_id":"public/tags/微服务/index.html","hash":"ebf4ea6178bb7ef56ec45e46c8239847e04eef20","modified":1496636960795},{"_id":"public/tags/微服务/page/2/index.html","hash":"d68a62deecf2666846dfed299557b328c4c3b48d","modified":1496636960795},{"_id":"public/tags/Spring-Boot/index.html","hash":"dbacd6ba222ec539d53a1fc52de6f2e796fbb565","modified":1496636960795},{"_id":"public/tags/分布式事务/index.html","hash":"9c20a5a0a1d91ba6e7fb83839c0ea14d27e83b5f","modified":1496636960795},{"_id":"public/tags/nginx/index.html","hash":"674e16d80a1c40329e9b95d98292e4e36b37d5f2","modified":1496636960795},{"_id":"public/tags/lua/index.html","hash":"95a47bcb3b78a066ada27bde2c36c2f7fbc23d3e","modified":1496636960795},{"_id":"public/tags/openresty/index.html","hash":"3c46dcb75dae879de67fc0726366ce4eb25cab36","modified":1496636960795},{"_id":"public/tags/Feign/index.html","hash":"62163c0f57e4f2f9e944d7b1e88684709faaa6c9","modified":1496636960795},{"_id":"public/tags/Spring-Cloud/index.html","hash":"02155de86a09e51b97a06bf3a120e28854afa8a5","modified":1496636960795},{"_id":"public/tags/API-Gateway/index.html","hash":"d7280b67bc777a8fbff4a621d51b2e300190fbcf","modified":1496636960795},{"_id":"public/tags/网关/index.html","hash":"0d123fd7679f9c0cd07aae368b276e167f66735c","modified":1496636960795},{"_id":"public/tags/Eureka/index.html","hash":"293f425ec09a551a37a23d868251c995d0fe8fdb","modified":1496636960795},{"_id":"public/tags/服务发现/index.html","hash":"bcd30564b645b66833ef23f892e6f0c1d557c21d","modified":1496636960795},{"_id":"public/tags/分布式配置管理/index.html","hash":"164216a42dfc1974be366af547633ed05f11e9b0","modified":1496636960795},{"_id":"public/tags/semaphore/index.html","hash":"d8354782e4c211050ccc18ff2b52d0833ec74b11","modified":1496636960795},{"_id":"public/tags/hystrix/index.html","hash":"4340bfe2f94aa3e47aa28e610d6a3927ab762ef4","modified":1496636960795},{"_id":"public/tags/Circuit-Breaker/index.html","hash":"2d4b48a2fd1e786566e7b3edea511bf9c491e9a6","modified":1496636960795},{"_id":"public/tags/zuul/index.html","hash":"f0b1909ef037c8d78d3f741e55b6936a24306466","modified":1496636960796},{"_id":"public/tags/JDBC/index.html","hash":"e53f5e9a5e093aecc81678d244296d0182bc8623","modified":1496636960796},{"_id":"public/tags/事务/index.html","hash":"18a66835987e7fe4b65334bc9006a18df4351258","modified":1496636960796},{"_id":"public/tags/负载均衡/index.html","hash":"868e5efc249743d1cfdd32086e0da99b90c4e242","modified":1496636960796},{"_id":"public/tags/加权轮询/index.html","hash":"a702932948176092dfa029ad790c2bced383b3d6","modified":1496636960796},{"_id":"public/tags/轮询/index.html","hash":"421ddd91887b7a1f38ec1cac158d3df76122f345","modified":1496636960797},{"_id":"public/tags/算法/index.html","hash":"1327fe2915aac3180ef7b5d7c571b0e2094c016a","modified":1496636960797},{"_id":"public/tags/单一职责/index.html","hash":"f40cbda6dec99adebb6b9b2a66326f91957ed78c","modified":1496636960797},{"_id":"public/tags/软件开发/index.html","hash":"d3de3abb33e01daed4a91f762dbf86f351ca4e1f","modified":1496636960797},{"_id":"public/tags/FlatBuffers/index.html","hash":"bf14f5d487206ea10a87026d63737364e1a142cc","modified":1496636960797},{"_id":"public/tags/序列化/index.html","hash":"c4e6955668170ce75b0481de981e570036521dc6","modified":1496636960797},{"_id":"public/tags/基准测试/index.html","hash":"4b1727ce533397e9003ab8090ea8dbb922b5b25a","modified":1496636960797},{"_id":"public/tags/wrk/index.html","hash":"9e01c171609e85e84e907bfebe1d938c2a9e37a7","modified":1496636960797},{"_id":"public/tags/http-2-0/index.html","hash":"e3d9d799a7ccbb1c3b4f1ed433ec38ca5156c6a9","modified":1496636960797},{"_id":"public/tags/Hexo/index.html","hash":"e459c9ca58333ba1b3c94b229835ce17a84e22a8","modified":1496636960797},{"_id":"public/tags/领域模型/index.html","hash":"f44afe20aa910453387586c1e12b14474827e5fe","modified":1496636960797},{"_id":"public/tags/DDD/index.html","hash":"7728dc8b57e43f25cf7faad383f96786bc16e2da","modified":1496636960797},{"_id":"public/tags/spring-cloud/index.html","hash":"8aadc394f1e0e4cda3659e361bd4be3c745a6f69","modified":1496636960803},{"_id":"public/tags/Hystrix/index.html","hash":"8ecc584c7d34f069e57d5e826233844e14702ba6","modified":1496636960803},{"_id":"public/CNAME","hash":"704f5291fe9f9f9d297c839806479c17e209a2d7","modified":1495358323138},{"_id":"public/favicon.ico","hash":"a5c41d966e5eef597a50b91f0b6a9bdf8ac80583","modified":1495358323138},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1495358323138},{"_id":"public/images/m1.jpg","hash":"4975231d503be2c0b00ed01322b88d70574d3076","modified":1495358323139},{"_id":"public/images/algolia_logo.svg","hash":"90035272fa31a3f65b3c0e2cb8a633876ef457dc","modified":1495358323139},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1495358323139},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1495358323140},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1495358323140},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1495358323140},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1495358323140},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1495358323141},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1495358323144},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1495358323144},{"_id":"public/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1495358323145},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1495358323146},{"_id":"public/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1495358323147},{"_id":"public/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1495358323147},{"_id":"public/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1495358323147},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1495358323147},{"_id":"public/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1495358323148},{"_id":"public/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1495358323148},{"_id":"public/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1495358323148},{"_id":"public/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1495358323148},{"_id":"public/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1495358323149},{"_id":"public/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1495358323149},{"_id":"public/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1495358323149},{"_id":"public/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1495358323155},{"_id":"public/css/main.css","hash":"ae55c1b4b50e456344ab8a8c675ca9e41269ffa1","modified":1495358324049},{"_id":"public/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1495358324049},{"_id":"public/js/src/bootstrap.js","hash":"aab7be0a6e2724b3faa9338db93c19556c559625","modified":1495358324049},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1495358324049},{"_id":"public/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1495358324050},{"_id":"public/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1495358324050},{"_id":"public/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1495358324050},{"_id":"public/js/src/post-details.js","hash":"af7a417dd1cb02465a7b98211653e7c6192e6d55","modified":1495358324050},{"_id":"public/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1495358324050},{"_id":"public/js/src/utils.js","hash":"e13c9ccf70d593bdf3b8cc1d768f595abd610e6e","modified":1495358324051},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1495358324051},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1495358324051},{"_id":"public/lib/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1495358324052},{"_id":"public/lib/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1495358324069},{"_id":"public/lib/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1495358324070},{"_id":"public/lib/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1495358324071},{"_id":"public/lib/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1495358324071},{"_id":"public/lib/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1495358324076},{"_id":"public/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1495358324076},{"_id":"public/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1495358324076},{"_id":"public/lib/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1495358324077},{"_id":"public/lib/three/three-waves.min.js","hash":"5b38ae00297ffc07f433c632c3dbf7bde4cdf39a","modified":1495358324077},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1495358324077},{"_id":"public/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1495358324077},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1495358324079},{"_id":"public/js/src/schemes/pisces.js","hash":"79da92119bc246fe05d1626ac98426a83ec90a94","modified":1495358324079},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1495358324080},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1495358324080},{"_id":"public/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1495358324081},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1495358324081},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1495358324081},{"_id":"public/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1495358324081},{"_id":"public/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1495358324081},{"_id":"public/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1495358324082},{"_id":"public/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1495358324083},{"_id":"public/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1495358324083},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1495358324083},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1495358324083},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1495358324083},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1495358324084},{"_id":"public/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1495358324084},{"_id":"public/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1495358324084},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1495358324085},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1495358324085},{"_id":"public/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1495358324094},{"_id":"public/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1495358324103},{"_id":"public/images/185638fo3y9el8ie2ohese.jpg","hash":"4d278765113277adc24d16fda2004d179911d5bc","modified":1495358324135},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1495358324138},{"_id":"public/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1495358324139},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1495358324139},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1495358324180},{"_id":"themes/next/source/lib/.DS_Store","hash":"a0c16f5da0135ab998121ae31e9b9c469fc28dd1","modified":1495358580000},{"_id":"themes/next/source/lib/font-awesome/.DS_Store","hash":"4a9558eb75051b81cd2f192b461929e7ef89825b","modified":1495358585000},{"_id":"source/images/weix.jpg","hash":"6e1fc0c298ed8e80ab290be12ac06fcf0e48f46f","modified":1495364744000},{"_id":"themes/next/source/images/weix.jpg","hash":"6e1fc0c298ed8e80ab290be12ac06fcf0e48f46f","modified":1495364744000},{"_id":"public/images/weix.jpg","hash":"6e1fc0c298ed8e80ab290be12ac06fcf0e48f46f","modified":1496636960986}],"Category":[{"name":"那年今日","_id":"cj2yhqbuf0002z29kx7jkkeqi"},{"name":"MQ","_id":"cj2yhqc05000cz29kpb5g27ob"},{"name":"mysql","_id":"cj2yhqc0c000tz29kahmcdy3f"},{"name":"微服务","_id":"cj2yhqc0f0012z29kfreaoola"},{"name":"nginx","_id":"cj2yhqc0i001dz29krhmgbzbp"},{"name":"music","_id":"cj2yhqc0l001mz29kavth5yzj"},{"name":"技术","_id":"cj2yhqc180038z29krw969atb"},{"name":"Hystrix","parent":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc18003bz29kjt4npyzi"},{"name":"JDBC","_id":"cj2yhqc1q004az29kzk2253h0"},{"name":"算法","parent":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1t004iz29ku5t8iz6x"},{"name":"杂谈","parent":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1v004uz29k916a4q7o"},{"name":"FlatBuffers","parent":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc4q0053z29k25fdh5q1"},{"name":"工具","parent":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc4v005gz29k9tde3k36"},{"name":"转载","_id":"cj2yhqc4y005nz29k8h605rxj"},{"name":"http 2.0","parent":"cj2yhqc4y005nz29k8h605rxj","_id":"cj2yhqc4z005qz29kjqyatc5p"},{"name":"Hexo","parent":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc51005vz29kxdfy57q3"},{"name":"领域模型","parent":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc540061z29kn080vi1e"}],"Data":[],"Page":[{"_content":"\n主页：http://tietang.wang/\n\n简书: http://www.jianshu.com/users/ae2ad10f3a37/latest_articles\n\n简书微服务专题： http://www.jianshu.com/collection/3f476518d832","source":"readme.md","raw":"\n主页：http://tietang.wang/\n\n简书: http://www.jianshu.com/users/ae2ad10f3a37/latest_articles\n\n简书微服务专题： http://www.jianshu.com/collection/3f476518d832","date":"2017-05-21T04:43:31.000Z","updated":"2017-05-21T04:43:31.000Z","path":"readme.html","title":"","comments":1,"layout":"page","_id":"cj2yhqbqw0000z29kyfepkyv7","content":"<p>主页：<a href=\"http://tietang.wang/\">http://tietang.wang/</a></p>\n<p>简书: <a href=\"http://www.jianshu.com/users/ae2ad10f3a37/latest_articles\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/users/ae2ad10f3a37/latest_articles</a></p>\n<p>简书微服务专题： <a href=\"http://www.jianshu.com/collection/3f476518d832\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/collection/3f476518d832</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>主页：<a href=\"http://tietang.wang/\">http://tietang.wang/</a></p>\n<p>简书: <a href=\"http://www.jianshu.com/users/ae2ad10f3a37/latest_articles\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/users/ae2ad10f3a37/latest_articles</a></p>\n<p>简书微服务专题： <a href=\"http://www.jianshu.com/collection/3f476518d832\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/collection/3f476518d832</a></p>\n"},{"title":"分类","date":"2016-11-24T07:49:16.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2016-11-24 15:49:16\ntype: \"categories\"\ncomments: false\n---\n","updated":"2017-05-21T04:43:31.000Z","path":"categories/index.html","layout":"page","_id":"cj2yhqbuj0008z29kw59ofl5t","content":"","site":{"data":{}},"excerpt":"","more":""},{"_content":"# 关于\n\n暂无","source":"about/index.md","raw":"# 关于\n\n暂无","date":"2017-05-21T04:43:31.000Z","updated":"2017-05-21T04:43:31.000Z","path":"about/index.html","title":"","comments":1,"layout":"page","_id":"cj2yhqbv00009z29kk0obnq16","content":"<h1 id=\"关于\"><a href=\"#关于\" class=\"headerlink\" title=\"关于\"></a>关于</h1><p>暂无</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"关于\"><a href=\"#关于\" class=\"headerlink\" title=\"关于\"></a>关于</h1><p>暂无</p>\n"},{"title":"标签","date":"2016-11-24T07:48:34.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2016-11-24 15:48:34\ntype: \"tags\"\ncomments: false\n---\n","updated":"2017-05-21T04:43:31.000Z","path":"tags/index.html","layout":"page","_id":"cj2yhqbv3000az29kvegpmrr4","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"春天开篇","date":"2016-02-19T01:20:42.000Z","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/IMG_20160218_122144.JPG","_content":"\n## 一年之计在于始\n\n想到这句名言时，却不知道出处，也忘记了其他的句子，随即搜了一下，原句如下：\n\n“一日之计在于晨,一年之计在于春,一生之计在于勤”\n\n**更有：**\n\n“一年之计在于春,一日之计在于晨,一家之计在于和,一生之计在于勤”\n\n春，晨，和，勤\n\n\n\n","source":"_posts/春天花会开.md","raw":"---\ntitle: 春天开篇\ndate: 2016-02-19 09:20:42\ncategories: \n\t- 那年今日\nthumbnail: http://7xiovs.com1.z0.glb.clouddn.com/IMG_20160218_122144.JPG\ntags: \n\t- 春天 \n\t- 梅花\n---\n\n## 一年之计在于始\n\n想到这句名言时，却不知道出处，也忘记了其他的句子，随即搜了一下，原句如下：\n\n“一日之计在于晨,一年之计在于春,一生之计在于勤”\n\n**更有：**\n\n“一年之计在于春,一日之计在于晨,一家之计在于和,一生之计在于勤”\n\n春，晨，和，勤\n\n\n\n","slug":"春天花会开","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqbub0001z29k1z36bp8m","content":"<h2 id=\"一年之计在于始\"><a href=\"#一年之计在于始\" class=\"headerlink\" title=\"一年之计在于始\"></a>一年之计在于始</h2><p>想到这句名言时，却不知道出处，也忘记了其他的句子，随即搜了一下，原句如下：</p>\n<p>“一日之计在于晨,一年之计在于春,一生之计在于勤”</p>\n<p><strong>更有：</strong></p>\n<p>“一年之计在于春,一日之计在于晨,一家之计在于和,一生之计在于勤”</p>\n<p>春，晨，和，勤</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一年之计在于始\"><a href=\"#一年之计在于始\" class=\"headerlink\" title=\"一年之计在于始\"></a>一年之计在于始</h2><p>想到这句名言时，却不知道出处，也忘记了其他的句子，随即搜了一下，原句如下：</p>\n<p>“一日之计在于晨,一年之计在于春,一生之计在于勤”</p>\n<p><strong>更有：</strong></p>\n<p>“一年之计在于春,一日之计在于晨,一家之计在于和,一生之计在于勤”</p>\n<p>春，晨，和，勤</p>\n"},{"title":"本地文件队列-异步隔离架构","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/P70422-151230.jpg","date":"2017-05-10T10:00:47.000Z","keywords":["MQ","本地文件队列","隔离","降级"],"description":null,"_content":"\n\n## 常见的异步方式：\n\n### 创建异步线程\n\n每个新创建一个线程来执行异步任务，任务结束线程也终止。\n线程的创建成本比较大，不建议使用。\n\n### 使用Queue，producer/consumer方式\n\n在内部创建一个Queue，worker线程直接将异步处理的任务放入queue，一个或多个异步线程从queue中消费并执行任务。\n\n### 线程池\n\n用线程池来替换每次创建线程，减少线程创建的成本，线程被复用，一次创建多处使用。\n\n和使用Queue类似，也是通过`BlockingQueue`实现,但策略上更复杂，向线程池提交Callable&Runnable任务，由线程池调度执行。\n\n参考：`java.util.concurrent.ThreadPoolExecutor#execute`\n\n### spring @Async注解\n\n通过注解来来简化了异步编程，只需要在需要异步的方法上使用`@Async`注解即可。\n其本质也是在线程池功能上扩展的，将异步执行方法封装为一个`Callable`，然后提交给线程池。\n\n#### org.springframework.aop.interceptor.AsyncExecutionInterceptor:\n\n\n```java\npublic Object invoke(final MethodInvocation invocation) throws Throwable {\n\t\tClass<?> targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);\n\t\tMethod specificMethod = ClassUtils.getMostSpecificMethod(invocation.getMethod(), targetClass);\n\t\tfinal Method userDeclaredMethod = BridgeMethodResolver.findBridgedMethod(specificMethod);\n\n\t\tAsyncTaskExecutor executor = determineAsyncExecutor(userDeclaredMethod);\n\t\tif (executor == null) {\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t\"No executor specified and no default executor set on AsyncExecutionInterceptor either\");\n\t\t}\n\n\t\tCallable<Object> task = new Callable<Object>() {\n\t\t\t@Override\n\t\t\tpublic Object call() throws Exception {\n\t\t\t\ttry {\n\t\t\t\t\tObject result = invocation.proceed();\n\t\t\t\t\tif (result instanceof Future) {\n\t\t\t\t\t\treturn ((Future<?>) result).get();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (ExecutionException ex) {\n\t\t\t\t\thandleError(ex.getCause(), userDeclaredMethod, invocation.getArguments());\n\t\t\t\t}\n\t\t\t\tcatch (Throwable ex) {\n\t\t\t\t\thandleError(ex, userDeclaredMethod, invocation.getArguments());\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t}\n\t\t};\n\n\t\treturn doSubmit(task, executor, invocation.getMethod().getReturnType());\n\t}\n```\n\n详细参考：http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#scheduling-annotation-support-async\n\n## 背景和场景\n\n\n### 产生的背景\n\n在项目中使用了`@Async`来执行异步任务，但在线上运行时出现了一次OOM的故障。通过分析发现是，线程池队列设置的比较大，当时的JVM内存给的也比较少（2048M），异步任务方法参数中传了大量的数据，任务执行被后端数据库阻塞（后端数据库变慢），最后导致缓存了大量的数据被放到线程池队列。其实JVM内存配置合适，线程池队列数合适，并配置合适的`RejectedExecutionHandler`策略。\n\n\n产生这个组件，1) 旨在替换内存队列的异步方式 2) 用来方便扩展集成分布式MQ\n\n### 异步隔离\n\n除了上面背景和场景，开发这个组件的另一个初衷就是有效异步隔离和作为一个降级备份方案。\n也是主要实现了文件队列方式的一个原因。\n\n当我们使用分布式MQ时，难免分布式MQ宕机或者其他网络等原因导致不能生产消息，或者阻塞影响到本身的业务，出现这种情况时可以降级到本地文件队列。\n\n本地文件队列的优点是速度快，只要文件系统不出问题可以认为不会被阻塞。缺点是本地文件队列生产的消息必须自己来消费，出现故障时消息消费会延迟，文件系统的损坏也会导致消息丢失。主要看使用的姿势，更看重哪一方面了。\n\n\n## 基本架构设计思路\n\n采用producer/consumer生产消费设计模式。\n\n\n参考了`@Async`思路，定义一个注解`@AsyncExecutable`, 使用Spring拦截器拦截注解了`@AsyncExecutable`的方法，可以使用AOP或者BeanPostProcessor来应用拦截器。\n\n\n\n### producer\n\n拦截器拦截到`@AsyncExecutable`方法后，将该方法所有的参数和方法信息作为Message，并序列化Message，序列化采用Kryo或者Json，将序列化后的信息放入队列。\n\n```java\nclass Message {\n\n     String beanName;\n     String klassName;\n     String methodName;\n     Class<?>[] argTypes;\n     Object[] args;\n     boolean hasTransactional = true;\n     \n}\n```\n### consumer\n\n有1个调度主线程和worker线程组成，主线程负责从队列中拉取消息，并分发到worker线程，worker线程采用线程池，使用了spring提供的TaskExecutor。\n\nworker线程反序列化消息为Message对象，并根据Message中的方法信息在spring ApplicationContext中查找到spring 管理的bean，并通过反射来调用。\n\n### 队列\n\n队列抽象了一个`BlockableQueue`, 通过`BlockableQueue`具体实现来扩展，可以是内存，文件，或分布式MQ。\n\n```java\n public interface BlockableQueue<T> {\n\n    String DefaultQueueName = \"fileQueue\";\n\n    /**\n     * push一个消息到队列\n     *\n     * @param t\n     * @return\n     */\n    boolean offer(T t);\n\n    /**\n     * 从队列pop一个消息，如果队列中无可用消息，则阻塞\n     *\n     * @return\n     * @throws InterruptedException\n     */\n    T take() throws InterruptedException;\n\n    /**\n     * 从队列pop一个消息，如果队列中无可用消息，则返回null\n     *\n     * @return\n     */\n    T poll();\n\n    /**\n     * 队列中消息数量\n     *\n     * @return\n     */\n    int size();\n}\n```\n\n通用的默认实现：\n\n```java\n \nimport java.util.Queue;\nimport java.util.concurrent.locks.Condition;\nimport java.util.concurrent.locks.Lock;\nimport java.util.concurrent.locks.ReentrantLock;\n\npublic class DefaultBlockableQueue implements BlockableQueue<byte[]> {\n    final Lock lock = new ReentrantLock();\n    final Condition notEmpty = lock.newCondition();\n    private Queue<byte[]> queue = null;\n\n\n    public FileBlockableQueue(Queue<byte[]> queue) {\n        this.queue = queue;\n    }\n\n    @Override\n    public boolean offer(byte[] bytes) {\n        lock.lock();\n        try {\n            boolean v = queue.offer(bytes);\n            notEmpty.signal();\n            return v;\n        } finally {\n            lock.unlock();\n        }\n    }\n\n\n    @Override\n    public byte[] take() throws InterruptedException {\n        lock.lock();\n        try {\n            while (queue.size() == 0) {\n                notEmpty.await();\n            }\n            byte[] bytes = queue.poll();\n            return bytes;\n        } finally {\n            lock.unlock();\n        }\n\n    }\n\n    @Override\n    public byte[] poll() {\n        return queue.poll();\n    }\n\n    @Override\n    public int size() {\n        return queue.size();\n    }\n}\n\n```\n\n本文实现了一个文件队列，采用去哪儿文件队列实现，这是一个fork：https://github.com/tietang/fqueue。\n\n\n对编程模型来说不用关心异步细节，只需要在需要异步的方法上注解`@AsyncExecutable`即可。\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/MQ/本地文件队列-异步隔离.md","raw":"---\ntitle: 本地文件队列-异步隔离架构\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/P70422-151230.jpg'\ndate: 2017-05-10 18:00:47\ncategories:\n\t- MQ\ntags:\n\t- MQ\n\t- 本地文件队列\n\t- 隔离\n\t- 降级\nkeywords:\n\t- MQ\n\t- 本地文件队列\n\t- 隔离\n\t- 降级\ndescription:\n---\n\n\n## 常见的异步方式：\n\n### 创建异步线程\n\n每个新创建一个线程来执行异步任务，任务结束线程也终止。\n线程的创建成本比较大，不建议使用。\n\n### 使用Queue，producer/consumer方式\n\n在内部创建一个Queue，worker线程直接将异步处理的任务放入queue，一个或多个异步线程从queue中消费并执行任务。\n\n### 线程池\n\n用线程池来替换每次创建线程，减少线程创建的成本，线程被复用，一次创建多处使用。\n\n和使用Queue类似，也是通过`BlockingQueue`实现,但策略上更复杂，向线程池提交Callable&Runnable任务，由线程池调度执行。\n\n参考：`java.util.concurrent.ThreadPoolExecutor#execute`\n\n### spring @Async注解\n\n通过注解来来简化了异步编程，只需要在需要异步的方法上使用`@Async`注解即可。\n其本质也是在线程池功能上扩展的，将异步执行方法封装为一个`Callable`，然后提交给线程池。\n\n#### org.springframework.aop.interceptor.AsyncExecutionInterceptor:\n\n\n```java\npublic Object invoke(final MethodInvocation invocation) throws Throwable {\n\t\tClass<?> targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);\n\t\tMethod specificMethod = ClassUtils.getMostSpecificMethod(invocation.getMethod(), targetClass);\n\t\tfinal Method userDeclaredMethod = BridgeMethodResolver.findBridgedMethod(specificMethod);\n\n\t\tAsyncTaskExecutor executor = determineAsyncExecutor(userDeclaredMethod);\n\t\tif (executor == null) {\n\t\t\tthrow new IllegalStateException(\n\t\t\t\t\t\"No executor specified and no default executor set on AsyncExecutionInterceptor either\");\n\t\t}\n\n\t\tCallable<Object> task = new Callable<Object>() {\n\t\t\t@Override\n\t\t\tpublic Object call() throws Exception {\n\t\t\t\ttry {\n\t\t\t\t\tObject result = invocation.proceed();\n\t\t\t\t\tif (result instanceof Future) {\n\t\t\t\t\t\treturn ((Future<?>) result).get();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcatch (ExecutionException ex) {\n\t\t\t\t\thandleError(ex.getCause(), userDeclaredMethod, invocation.getArguments());\n\t\t\t\t}\n\t\t\t\tcatch (Throwable ex) {\n\t\t\t\t\thandleError(ex, userDeclaredMethod, invocation.getArguments());\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t}\n\t\t};\n\n\t\treturn doSubmit(task, executor, invocation.getMethod().getReturnType());\n\t}\n```\n\n详细参考：http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#scheduling-annotation-support-async\n\n## 背景和场景\n\n\n### 产生的背景\n\n在项目中使用了`@Async`来执行异步任务，但在线上运行时出现了一次OOM的故障。通过分析发现是，线程池队列设置的比较大，当时的JVM内存给的也比较少（2048M），异步任务方法参数中传了大量的数据，任务执行被后端数据库阻塞（后端数据库变慢），最后导致缓存了大量的数据被放到线程池队列。其实JVM内存配置合适，线程池队列数合适，并配置合适的`RejectedExecutionHandler`策略。\n\n\n产生这个组件，1) 旨在替换内存队列的异步方式 2) 用来方便扩展集成分布式MQ\n\n### 异步隔离\n\n除了上面背景和场景，开发这个组件的另一个初衷就是有效异步隔离和作为一个降级备份方案。\n也是主要实现了文件队列方式的一个原因。\n\n当我们使用分布式MQ时，难免分布式MQ宕机或者其他网络等原因导致不能生产消息，或者阻塞影响到本身的业务，出现这种情况时可以降级到本地文件队列。\n\n本地文件队列的优点是速度快，只要文件系统不出问题可以认为不会被阻塞。缺点是本地文件队列生产的消息必须自己来消费，出现故障时消息消费会延迟，文件系统的损坏也会导致消息丢失。主要看使用的姿势，更看重哪一方面了。\n\n\n## 基本架构设计思路\n\n采用producer/consumer生产消费设计模式。\n\n\n参考了`@Async`思路，定义一个注解`@AsyncExecutable`, 使用Spring拦截器拦截注解了`@AsyncExecutable`的方法，可以使用AOP或者BeanPostProcessor来应用拦截器。\n\n\n\n### producer\n\n拦截器拦截到`@AsyncExecutable`方法后，将该方法所有的参数和方法信息作为Message，并序列化Message，序列化采用Kryo或者Json，将序列化后的信息放入队列。\n\n```java\nclass Message {\n\n     String beanName;\n     String klassName;\n     String methodName;\n     Class<?>[] argTypes;\n     Object[] args;\n     boolean hasTransactional = true;\n     \n}\n```\n### consumer\n\n有1个调度主线程和worker线程组成，主线程负责从队列中拉取消息，并分发到worker线程，worker线程采用线程池，使用了spring提供的TaskExecutor。\n\nworker线程反序列化消息为Message对象，并根据Message中的方法信息在spring ApplicationContext中查找到spring 管理的bean，并通过反射来调用。\n\n### 队列\n\n队列抽象了一个`BlockableQueue`, 通过`BlockableQueue`具体实现来扩展，可以是内存，文件，或分布式MQ。\n\n```java\n public interface BlockableQueue<T> {\n\n    String DefaultQueueName = \"fileQueue\";\n\n    /**\n     * push一个消息到队列\n     *\n     * @param t\n     * @return\n     */\n    boolean offer(T t);\n\n    /**\n     * 从队列pop一个消息，如果队列中无可用消息，则阻塞\n     *\n     * @return\n     * @throws InterruptedException\n     */\n    T take() throws InterruptedException;\n\n    /**\n     * 从队列pop一个消息，如果队列中无可用消息，则返回null\n     *\n     * @return\n     */\n    T poll();\n\n    /**\n     * 队列中消息数量\n     *\n     * @return\n     */\n    int size();\n}\n```\n\n通用的默认实现：\n\n```java\n \nimport java.util.Queue;\nimport java.util.concurrent.locks.Condition;\nimport java.util.concurrent.locks.Lock;\nimport java.util.concurrent.locks.ReentrantLock;\n\npublic class DefaultBlockableQueue implements BlockableQueue<byte[]> {\n    final Lock lock = new ReentrantLock();\n    final Condition notEmpty = lock.newCondition();\n    private Queue<byte[]> queue = null;\n\n\n    public FileBlockableQueue(Queue<byte[]> queue) {\n        this.queue = queue;\n    }\n\n    @Override\n    public boolean offer(byte[] bytes) {\n        lock.lock();\n        try {\n            boolean v = queue.offer(bytes);\n            notEmpty.signal();\n            return v;\n        } finally {\n            lock.unlock();\n        }\n    }\n\n\n    @Override\n    public byte[] take() throws InterruptedException {\n        lock.lock();\n        try {\n            while (queue.size() == 0) {\n                notEmpty.await();\n            }\n            byte[] bytes = queue.poll();\n            return bytes;\n        } finally {\n            lock.unlock();\n        }\n\n    }\n\n    @Override\n    public byte[] poll() {\n        return queue.poll();\n    }\n\n    @Override\n    public int size() {\n        return queue.size();\n    }\n}\n\n```\n\n本文实现了一个文件队列，采用去哪儿文件队列实现，这是一个fork：https://github.com/tietang/fqueue。\n\n\n对编程模型来说不用关心异步细节，只需要在需要异步的方法上注解`@AsyncExecutable`即可。\n\n\n\n\n\n\n\n\n\n\n\n","slug":"MQ/本地文件队列-异步隔离","published":1,"updated":"2017-05-21T04:43:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc04000bz29k30egd1hz","content":"<h2 id=\"常见的异步方式：\"><a href=\"#常见的异步方式：\" class=\"headerlink\" title=\"常见的异步方式：\"></a>常见的异步方式：</h2><h3 id=\"创建异步线程\"><a href=\"#创建异步线程\" class=\"headerlink\" title=\"创建异步线程\"></a>创建异步线程</h3><p>每个新创建一个线程来执行异步任务，任务结束线程也终止。<br>线程的创建成本比较大，不建议使用。</p>\n<h3 id=\"使用Queue，producer-consumer方式\"><a href=\"#使用Queue，producer-consumer方式\" class=\"headerlink\" title=\"使用Queue，producer/consumer方式\"></a>使用Queue，producer/consumer方式</h3><p>在内部创建一个Queue，worker线程直接将异步处理的任务放入queue，一个或多个异步线程从queue中消费并执行任务。</p>\n<h3 id=\"线程池\"><a href=\"#线程池\" class=\"headerlink\" title=\"线程池\"></a>线程池</h3><p>用线程池来替换每次创建线程，减少线程创建的成本，线程被复用，一次创建多处使用。</p>\n<p>和使用Queue类似，也是通过<code>BlockingQueue</code>实现,但策略上更复杂，向线程池提交Callable&amp;Runnable任务，由线程池调度执行。</p>\n<p>参考：<code>java.util.concurrent.ThreadPoolExecutor#execute</code></p>\n<h3 id=\"spring-Async注解\"><a href=\"#spring-Async注解\" class=\"headerlink\" title=\"spring @Async注解\"></a>spring @Async注解</h3><p>通过注解来来简化了异步编程，只需要在需要异步的方法上使用<code>@Async</code>注解即可。<br>其本质也是在线程池功能上扩展的，将异步执行方法封装为一个<code>Callable</code>，然后提交给线程池。</p>\n<h4 id=\"org-springframework-aop-interceptor-AsyncExecutionInterceptor\"><a href=\"#org-springframework-aop-interceptor-AsyncExecutionInterceptor\" class=\"headerlink\" title=\"org.springframework.aop.interceptor.AsyncExecutionInterceptor:\"></a>org.springframework.aop.interceptor.AsyncExecutionInterceptor:</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(<span class=\"keyword\">final</span> MethodInvocation invocation)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</div><div class=\"line\">\t\tClass&lt;?&gt; targetClass = (invocation.getThis() != <span class=\"keyword\">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class=\"keyword\">null</span>);</div><div class=\"line\">\t\tMethod specificMethod = ClassUtils.getMostSpecificMethod(invocation.getMethod(), targetClass);</div><div class=\"line\">\t\t<span class=\"keyword\">final</span> Method userDeclaredMethod = BridgeMethodResolver.findBridgedMethod(specificMethod);</div><div class=\"line\"></div><div class=\"line\">\t\tAsyncTaskExecutor executor = determineAsyncExecutor(userDeclaredMethod);</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> (executor == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(</div><div class=\"line\">\t\t\t\t\t<span class=\"string\">\"No executor specified and no default executor set on AsyncExecutionInterceptor either\"</span>);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\tCallable&lt;Object&gt; task = <span class=\"keyword\">new</span> Callable&lt;Object&gt;() &#123;</div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\t\tObject result = invocation.proceed();</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> Future) &#123;</div><div class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">return</span> ((Future&lt;?&gt;) result).get();</div><div class=\"line\">\t\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">catch</span> (ExecutionException ex) &#123;</div><div class=\"line\">\t\t\t\t\thandleError(ex.getCause(), userDeclaredMethod, invocation.getArguments());</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">catch</span> (Throwable ex) &#123;</div><div class=\"line\">\t\t\t\t\thandleError(ex, userDeclaredMethod, invocation.getArguments());</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">return</span> doSubmit(task, executor, invocation.getMethod().getReturnType());</div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>\n<p>详细参考：<a href=\"http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#scheduling-annotation-support-async\" target=\"_blank\" rel=\"external\">http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#scheduling-annotation-support-async</a></p>\n<h2 id=\"背景和场景\"><a href=\"#背景和场景\" class=\"headerlink\" title=\"背景和场景\"></a>背景和场景</h2><h3 id=\"产生的背景\"><a href=\"#产生的背景\" class=\"headerlink\" title=\"产生的背景\"></a>产生的背景</h3><p>在项目中使用了<code>@Async</code>来执行异步任务，但在线上运行时出现了一次OOM的故障。通过分析发现是，线程池队列设置的比较大，当时的JVM内存给的也比较少（2048M），异步任务方法参数中传了大量的数据，任务执行被后端数据库阻塞（后端数据库变慢），最后导致缓存了大量的数据被放到线程池队列。其实JVM内存配置合适，线程池队列数合适，并配置合适的<code>RejectedExecutionHandler</code>策略。</p>\n<p>产生这个组件，1) 旨在替换内存队列的异步方式 2) 用来方便扩展集成分布式MQ</p>\n<h3 id=\"异步隔离\"><a href=\"#异步隔离\" class=\"headerlink\" title=\"异步隔离\"></a>异步隔离</h3><p>除了上面背景和场景，开发这个组件的另一个初衷就是有效异步隔离和作为一个降级备份方案。<br>也是主要实现了文件队列方式的一个原因。</p>\n<p>当我们使用分布式MQ时，难免分布式MQ宕机或者其他网络等原因导致不能生产消息，或者阻塞影响到本身的业务，出现这种情况时可以降级到本地文件队列。</p>\n<p>本地文件队列的优点是速度快，只要文件系统不出问题可以认为不会被阻塞。缺点是本地文件队列生产的消息必须自己来消费，出现故障时消息消费会延迟，文件系统的损坏也会导致消息丢失。主要看使用的姿势，更看重哪一方面了。</p>\n<h2 id=\"基本架构设计思路\"><a href=\"#基本架构设计思路\" class=\"headerlink\" title=\"基本架构设计思路\"></a>基本架构设计思路</h2><p>采用producer/consumer生产消费设计模式。</p>\n<p>参考了<code>@Async</code>思路，定义一个注解<code>@AsyncExecutable</code>, 使用Spring拦截器拦截注解了<code>@AsyncExecutable</code>的方法，可以使用AOP或者BeanPostProcessor来应用拦截器。</p>\n<h3 id=\"producer\"><a href=\"#producer\" class=\"headerlink\" title=\"producer\"></a>producer</h3><p>拦截器拦截到<code>@AsyncExecutable</code>方法后，将该方法所有的参数和方法信息作为Message，并序列化Message，序列化采用Kryo或者Json，将序列化后的信息放入队列。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Message</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">     String beanName;</div><div class=\"line\">     String klassName;</div><div class=\"line\">     String methodName;</div><div class=\"line\">     Class&lt;?&gt;[] argTypes;</div><div class=\"line\">     Object[] args;</div><div class=\"line\">     <span class=\"keyword\">boolean</span> hasTransactional = <span class=\"keyword\">true</span>;</div><div class=\"line\">     </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"consumer\"><a href=\"#consumer\" class=\"headerlink\" title=\"consumer\"></a>consumer</h3><p>有1个调度主线程和worker线程组成，主线程负责从队列中拉取消息，并分发到worker线程，worker线程采用线程池，使用了spring提供的TaskExecutor。</p>\n<p>worker线程反序列化消息为Message对象，并根据Message中的方法信息在spring ApplicationContext中查找到spring 管理的bean，并通过反射来调用。</p>\n<h3 id=\"队列\"><a href=\"#队列\" class=\"headerlink\" title=\"队列\"></a>队列</h3><p>队列抽象了一个<code>BlockableQueue</code>, 通过<code>BlockableQueue</code>具体实现来扩展，可以是内存，文件，或分布式MQ。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"> <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">BlockableQueue</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    String DefaultQueueName = <span class=\"string\">\"fileQueue\"</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * push一个消息到队列</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> t</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">offer</span><span class=\"params\">(T t)</span></span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 从队列pop一个消息，如果队列中无可用消息，则阻塞</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     * <span class=\"doctag\">@throws</span> InterruptedException</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\">T <span class=\"title\">take</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 从队列pop一个消息，如果队列中无可用消息，则返回null</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\">T <span class=\"title\">poll</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 队列中消息数量</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">size</span><span class=\"params\">()</span></span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>通用的默认实现：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div></pre></td><td class=\"code\"><pre><div class=\"line\"> </div><div class=\"line\">import java.util.Queue;</div><div class=\"line\">import java.util.concurrent.locks.Condition;</div><div class=\"line\">import java.util.concurrent.locks.Lock;</div><div class=\"line\">import java.util.concurrent.locks.ReentrantLock;</div><div class=\"line\"></div><div class=\"line\">public class DefaultBlockableQueue implements BlockableQueue&lt;byte[]&gt; &#123;</div><div class=\"line\">    final Lock lock = new ReentrantLock();</div><div class=\"line\">    final Condition notEmpty = lock.newCondition();</div><div class=\"line\">    private Queue&lt;byte[]&gt; queue = null;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    public FileBlockableQueue(Queue&lt;byte[]&gt; queue) &#123;</div><div class=\"line\">        this.queue = queue;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public boolean offer(byte[] bytes) &#123;</div><div class=\"line\">        lock.lock();</div><div class=\"line\">        try &#123;</div><div class=\"line\">            boolean v = queue.offer(bytes);</div><div class=\"line\">            notEmpty.signal();</div><div class=\"line\">            return v;</div><div class=\"line\">        &#125; finally &#123;</div><div class=\"line\">            lock.unlock();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public byte[] take() throws InterruptedException &#123;</div><div class=\"line\">        lock.lock();</div><div class=\"line\">        try &#123;</div><div class=\"line\">            while (queue.size() == 0) &#123;</div><div class=\"line\">                notEmpty.await();</div><div class=\"line\">            &#125;</div><div class=\"line\">            byte[] bytes = queue.poll();</div><div class=\"line\">            return bytes;</div><div class=\"line\">        &#125; finally &#123;</div><div class=\"line\">            lock.unlock();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public byte[] poll() &#123;</div><div class=\"line\">        return queue.poll();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public int size() &#123;</div><div class=\"line\">        return queue.size();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>本文实现了一个文件队列，采用去哪儿文件队列实现，这是一个fork：<a href=\"https://github.com/tietang/fqueue。\" target=\"_blank\" rel=\"external\">https://github.com/tietang/fqueue。</a></p>\n<p>对编程模型来说不用关心异步细节，只需要在需要异步的方法上注解<code>@AsyncExecutable</code>即可。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"常见的异步方式：\"><a href=\"#常见的异步方式：\" class=\"headerlink\" title=\"常见的异步方式：\"></a>常见的异步方式：</h2><h3 id=\"创建异步线程\"><a href=\"#创建异步线程\" class=\"headerlink\" title=\"创建异步线程\"></a>创建异步线程</h3><p>每个新创建一个线程来执行异步任务，任务结束线程也终止。<br>线程的创建成本比较大，不建议使用。</p>\n<h3 id=\"使用Queue，producer-consumer方式\"><a href=\"#使用Queue，producer-consumer方式\" class=\"headerlink\" title=\"使用Queue，producer/consumer方式\"></a>使用Queue，producer/consumer方式</h3><p>在内部创建一个Queue，worker线程直接将异步处理的任务放入queue，一个或多个异步线程从queue中消费并执行任务。</p>\n<h3 id=\"线程池\"><a href=\"#线程池\" class=\"headerlink\" title=\"线程池\"></a>线程池</h3><p>用线程池来替换每次创建线程，减少线程创建的成本，线程被复用，一次创建多处使用。</p>\n<p>和使用Queue类似，也是通过<code>BlockingQueue</code>实现,但策略上更复杂，向线程池提交Callable&amp;Runnable任务，由线程池调度执行。</p>\n<p>参考：<code>java.util.concurrent.ThreadPoolExecutor#execute</code></p>\n<h3 id=\"spring-Async注解\"><a href=\"#spring-Async注解\" class=\"headerlink\" title=\"spring @Async注解\"></a>spring @Async注解</h3><p>通过注解来来简化了异步编程，只需要在需要异步的方法上使用<code>@Async</code>注解即可。<br>其本质也是在线程池功能上扩展的，将异步执行方法封装为一个<code>Callable</code>，然后提交给线程池。</p>\n<h4 id=\"org-springframework-aop-interceptor-AsyncExecutionInterceptor\"><a href=\"#org-springframework-aop-interceptor-AsyncExecutionInterceptor\" class=\"headerlink\" title=\"org.springframework.aop.interceptor.AsyncExecutionInterceptor:\"></a>org.springframework.aop.interceptor.AsyncExecutionInterceptor:</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(<span class=\"keyword\">final</span> MethodInvocation invocation)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</div><div class=\"line\">\t\tClass&lt;?&gt; targetClass = (invocation.getThis() != <span class=\"keyword\">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class=\"keyword\">null</span>);</div><div class=\"line\">\t\tMethod specificMethod = ClassUtils.getMostSpecificMethod(invocation.getMethod(), targetClass);</div><div class=\"line\">\t\t<span class=\"keyword\">final</span> Method userDeclaredMethod = BridgeMethodResolver.findBridgedMethod(specificMethod);</div><div class=\"line\"></div><div class=\"line\">\t\tAsyncTaskExecutor executor = determineAsyncExecutor(userDeclaredMethod);</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> (executor == <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(</div><div class=\"line\">\t\t\t\t\t<span class=\"string\">\"No executor specified and no default executor set on AsyncExecutionInterceptor either\"</span>);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\tCallable&lt;Object&gt; task = <span class=\"keyword\">new</span> Callable&lt;Object&gt;() &#123;</div><div class=\"line\">\t\t\t<span class=\"meta\">@Override</span></div><div class=\"line\">\t\t\t<span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t\t\t\tObject result = invocation.proceed();</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> Future) &#123;</div><div class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">return</span> ((Future&lt;?&gt;) result).get();</div><div class=\"line\">\t\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">catch</span> (ExecutionException ex) &#123;</div><div class=\"line\">\t\t\t\t\thandleError(ex.getCause(), userDeclaredMethod, invocation.getArguments());</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">catch</span> (Throwable ex) &#123;</div><div class=\"line\">\t\t\t\t\thandleError(ex, userDeclaredMethod, invocation.getArguments());</div><div class=\"line\">\t\t\t\t&#125;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">return</span> doSubmit(task, executor, invocation.getMethod().getReturnType());</div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>\n<p>详细参考：<a href=\"http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#scheduling-annotation-support-async\" target=\"_blank\" rel=\"external\">http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#scheduling-annotation-support-async</a></p>\n<h2 id=\"背景和场景\"><a href=\"#背景和场景\" class=\"headerlink\" title=\"背景和场景\"></a>背景和场景</h2><h3 id=\"产生的背景\"><a href=\"#产生的背景\" class=\"headerlink\" title=\"产生的背景\"></a>产生的背景</h3><p>在项目中使用了<code>@Async</code>来执行异步任务，但在线上运行时出现了一次OOM的故障。通过分析发现是，线程池队列设置的比较大，当时的JVM内存给的也比较少（2048M），异步任务方法参数中传了大量的数据，任务执行被后端数据库阻塞（后端数据库变慢），最后导致缓存了大量的数据被放到线程池队列。其实JVM内存配置合适，线程池队列数合适，并配置合适的<code>RejectedExecutionHandler</code>策略。</p>\n<p>产生这个组件，1) 旨在替换内存队列的异步方式 2) 用来方便扩展集成分布式MQ</p>\n<h3 id=\"异步隔离\"><a href=\"#异步隔离\" class=\"headerlink\" title=\"异步隔离\"></a>异步隔离</h3><p>除了上面背景和场景，开发这个组件的另一个初衷就是有效异步隔离和作为一个降级备份方案。<br>也是主要实现了文件队列方式的一个原因。</p>\n<p>当我们使用分布式MQ时，难免分布式MQ宕机或者其他网络等原因导致不能生产消息，或者阻塞影响到本身的业务，出现这种情况时可以降级到本地文件队列。</p>\n<p>本地文件队列的优点是速度快，只要文件系统不出问题可以认为不会被阻塞。缺点是本地文件队列生产的消息必须自己来消费，出现故障时消息消费会延迟，文件系统的损坏也会导致消息丢失。主要看使用的姿势，更看重哪一方面了。</p>\n<h2 id=\"基本架构设计思路\"><a href=\"#基本架构设计思路\" class=\"headerlink\" title=\"基本架构设计思路\"></a>基本架构设计思路</h2><p>采用producer/consumer生产消费设计模式。</p>\n<p>参考了<code>@Async</code>思路，定义一个注解<code>@AsyncExecutable</code>, 使用Spring拦截器拦截注解了<code>@AsyncExecutable</code>的方法，可以使用AOP或者BeanPostProcessor来应用拦截器。</p>\n<h3 id=\"producer\"><a href=\"#producer\" class=\"headerlink\" title=\"producer\"></a>producer</h3><p>拦截器拦截到<code>@AsyncExecutable</code>方法后，将该方法所有的参数和方法信息作为Message，并序列化Message，序列化采用Kryo或者Json，将序列化后的信息放入队列。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Message</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">     String beanName;</div><div class=\"line\">     String klassName;</div><div class=\"line\">     String methodName;</div><div class=\"line\">     Class&lt;?&gt;[] argTypes;</div><div class=\"line\">     Object[] args;</div><div class=\"line\">     <span class=\"keyword\">boolean</span> hasTransactional = <span class=\"keyword\">true</span>;</div><div class=\"line\">     </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"consumer\"><a href=\"#consumer\" class=\"headerlink\" title=\"consumer\"></a>consumer</h3><p>有1个调度主线程和worker线程组成，主线程负责从队列中拉取消息，并分发到worker线程，worker线程采用线程池，使用了spring提供的TaskExecutor。</p>\n<p>worker线程反序列化消息为Message对象，并根据Message中的方法信息在spring ApplicationContext中查找到spring 管理的bean，并通过反射来调用。</p>\n<h3 id=\"队列\"><a href=\"#队列\" class=\"headerlink\" title=\"队列\"></a>队列</h3><p>队列抽象了一个<code>BlockableQueue</code>, 通过<code>BlockableQueue</code>具体实现来扩展，可以是内存，文件，或分布式MQ。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"> <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">BlockableQueue</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    String DefaultQueueName = <span class=\"string\">\"fileQueue\"</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * push一个消息到队列</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@param</span> t</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">offer</span><span class=\"params\">(T t)</span></span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 从队列pop一个消息，如果队列中无可用消息，则阻塞</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     * <span class=\"doctag\">@throws</span> InterruptedException</div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\">T <span class=\"title\">take</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 从队列pop一个消息，如果队列中无可用消息，则返回null</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\">T <span class=\"title\">poll</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 队列中消息数量</div><div class=\"line\">     *</div><div class=\"line\">     * <span class=\"doctag\">@return</span></div><div class=\"line\">     */</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">size</span><span class=\"params\">()</span></span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>通用的默认实现：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div></pre></td><td class=\"code\"><pre><div class=\"line\"> </div><div class=\"line\">import java.util.Queue;</div><div class=\"line\">import java.util.concurrent.locks.Condition;</div><div class=\"line\">import java.util.concurrent.locks.Lock;</div><div class=\"line\">import java.util.concurrent.locks.ReentrantLock;</div><div class=\"line\"></div><div class=\"line\">public class DefaultBlockableQueue implements BlockableQueue&lt;byte[]&gt; &#123;</div><div class=\"line\">    final Lock lock = new ReentrantLock();</div><div class=\"line\">    final Condition notEmpty = lock.newCondition();</div><div class=\"line\">    private Queue&lt;byte[]&gt; queue = null;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    public FileBlockableQueue(Queue&lt;byte[]&gt; queue) &#123;</div><div class=\"line\">        this.queue = queue;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public boolean offer(byte[] bytes) &#123;</div><div class=\"line\">        lock.lock();</div><div class=\"line\">        try &#123;</div><div class=\"line\">            boolean v = queue.offer(bytes);</div><div class=\"line\">            notEmpty.signal();</div><div class=\"line\">            return v;</div><div class=\"line\">        &#125; finally &#123;</div><div class=\"line\">            lock.unlock();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public byte[] take() throws InterruptedException &#123;</div><div class=\"line\">        lock.lock();</div><div class=\"line\">        try &#123;</div><div class=\"line\">            while (queue.size() == 0) &#123;</div><div class=\"line\">                notEmpty.await();</div><div class=\"line\">            &#125;</div><div class=\"line\">            byte[] bytes = queue.poll();</div><div class=\"line\">            return bytes;</div><div class=\"line\">        &#125; finally &#123;</div><div class=\"line\">            lock.unlock();</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public byte[] poll() &#123;</div><div class=\"line\">        return queue.poll();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    @Override</div><div class=\"line\">    public int size() &#123;</div><div class=\"line\">        return queue.size();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>本文实现了一个文件队列，采用去哪儿文件队列实现，这是一个fork：<a href=\"https://github.com/tietang/fqueue。\" target=\"_blank\" rel=\"external\">https://github.com/tietang/fqueue。</a></p>\n<p>对编程模型来说不用关心异步细节，只需要在需要异步的方法上注解<code>@AsyncExecutable</code>即可。</p>\n"},{"title":"一次线上事故对“本地文件队列异步使用”的思考","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/P70430-092839.jpg","date":"2017-05-10T10:22:47.000Z","keywords":["MQ","本地文件队列","隔离","降级"],"description":null,"_content":"\n\n## 事故描述\n\n事故现象是部分服务http请求无响应。事故从发生到恢复，接近3个小时，事故过程中重启应用服务，只能坚持几分钟到十几分钟，在真正发现问题前通过不断重启服务实例来支撑，庆幸的是核心服务没有出现无响应的事故。\n\n最终分析为AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待，AMQ监控端口ok，控制台也可以打开，由于紧急没有具体分析，直接重启AMQ服务，切换master，通过验证服务全部恢复。\n\n这次故障大部分服务都使用了AMQ，但除了一个核心服务没受到明显影响外，其他使用AMQ的服务都不同程度的收到了影响，服务不可用。\n\n<font color=\"red\">\n事后通过分析这个核心服务正式使用了**本地文件队列**避免了事故放大，逃过一劫，当时如果这个核心服务也受到影响就可想而知了，事故间期正直商户业务高峰期，客户估计要炸了，公司也会受到很大的损失。\n\n此次事故比较严重，就是因为使用了**本地文件队列**有效隔离故障，使得影响面不大。假设（当然不希望发生了）核心业务没有使用**本地文件队列**来隔离故障，整个下单、收银服务将不可用，商户无法营业，损失应该在数量级。\n</font>\n\n此次事故也证明了我当时的这个架构思路的正确性，主要体现在隔离和降级。\n\n## 说说这个核心服务使用“本地文件队列”\n\n我开发出来这个组件在这个团队使用一直很稳定效果也很好。\n\n实际上这个团队使用**“本地文件队列”**的姿势并不是我期望的，本身使用方法并没有明显不妥，只是会延迟消息的消费，但这中方法可以很好的且有效的隔离故障。\n\n就是在发送AMQ消息的方法上添加了`@AsyncExecutable`，所以在入AMQ前先入队“本地文件队列”，然后“本地文件队列”消费者再把消息生产到AMQ。\n\n![](<http://7xiovs.com1.z0.glb.clouddn.com/async.png>)\n\n这里正是利用率“本地文件队列”的优点，比较可靠，只依赖于本地文件系统，不会有网络故障的特性，近似不会被阻塞。\n\n在事故分析中，实际上AMQ对该核心服务也受到影响，但由于采用了“本地文件队列”作为一级队列，有效的隔离了对AMQ的网络依赖，所以没有放大事故。事故中“本地文件队列”中消息被积累，没有被消费，重启服务后才被消费，原因后面再分析。\n\n\n## 再说说此次事故中服务不可用的原因\n\n1. AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待。\n2. AMQ Client消息的生产和Tomcat共用worker线程\n3. AMQ Client消息的生产没有超时机制\n4. AMQ Client消息的生产采用同步发送，异步发送有一些问题场景不太合适。\n\n\n所以基于以上信息，AMQ消息的生产阻塞了Tomcat worker线程，最终导致worker线程被耗光而服务不可用。\n\n在事故中通过线程堆栈信息和Tomcat线程使用数统计也确定了线程很快被耗光而请求被阻塞。\n\n另一个服务中采用了异步线程池来生产AMQ消息，但拒绝策略采用了`CallerRunsPolicy`, 也是线程池线程很快被耗光而再耗光Tomcat worker线程，最终导致服务不可用。\n\n事故产生的原因就是代码中没有有效做网路调用的隔离和降级。\n\n\n上面提到的核心服务也受到影响，参考《[本地文件队列-异步隔离](<本地文件队列-异步隔离.md>)》，也是因为**“本地文件队列”**拒绝策略采用了`CallerRunsPolicy`，最终导致线程池线程很快被耗光，而使用**“本地文件队列”**消费调度主线程，消费调度主线程被阻塞而无法消费“本地文件队列”消息并生产到AMQ。但这里和其他服务不同的是，主业务和AMQ的消息生产是隔离的，主业务生产消息到**“本地文件队列”**就返回，并不直接依赖AMQ。\n\n\n本文中提到了使用**本地文件队列**的隔离姿势。\n\n后面再介绍使用**本地文件队列**的降级姿势。\n","source":"_posts/MQ/一次线上事故对本地文件异步队列的思考.md","raw":"---\ntitle: 一次线上事故对“本地文件队列异步使用”的思考\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/P70430-092839.jpg'\ndate: 2017-05-10 18:22:47\ncategories:\n\t- MQ\ntags:\n\t- MQ\n\t- 本地文件队列\n\t- 隔离\n\t- 降级\nkeywords:\n\t- MQ\n\t- 本地文件队列\n\t- 隔离\n\t- 降级\ndescription:\n---\n\n\n## 事故描述\n\n事故现象是部分服务http请求无响应。事故从发生到恢复，接近3个小时，事故过程中重启应用服务，只能坚持几分钟到十几分钟，在真正发现问题前通过不断重启服务实例来支撑，庆幸的是核心服务没有出现无响应的事故。\n\n最终分析为AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待，AMQ监控端口ok，控制台也可以打开，由于紧急没有具体分析，直接重启AMQ服务，切换master，通过验证服务全部恢复。\n\n这次故障大部分服务都使用了AMQ，但除了一个核心服务没受到明显影响外，其他使用AMQ的服务都不同程度的收到了影响，服务不可用。\n\n<font color=\"red\">\n事后通过分析这个核心服务正式使用了**本地文件队列**避免了事故放大，逃过一劫，当时如果这个核心服务也受到影响就可想而知了，事故间期正直商户业务高峰期，客户估计要炸了，公司也会受到很大的损失。\n\n此次事故比较严重，就是因为使用了**本地文件队列**有效隔离故障，使得影响面不大。假设（当然不希望发生了）核心业务没有使用**本地文件队列**来隔离故障，整个下单、收银服务将不可用，商户无法营业，损失应该在数量级。\n</font>\n\n此次事故也证明了我当时的这个架构思路的正确性，主要体现在隔离和降级。\n\n## 说说这个核心服务使用“本地文件队列”\n\n我开发出来这个组件在这个团队使用一直很稳定效果也很好。\n\n实际上这个团队使用**“本地文件队列”**的姿势并不是我期望的，本身使用方法并没有明显不妥，只是会延迟消息的消费，但这中方法可以很好的且有效的隔离故障。\n\n就是在发送AMQ消息的方法上添加了`@AsyncExecutable`，所以在入AMQ前先入队“本地文件队列”，然后“本地文件队列”消费者再把消息生产到AMQ。\n\n![](<http://7xiovs.com1.z0.glb.clouddn.com/async.png>)\n\n这里正是利用率“本地文件队列”的优点，比较可靠，只依赖于本地文件系统，不会有网络故障的特性，近似不会被阻塞。\n\n在事故分析中，实际上AMQ对该核心服务也受到影响，但由于采用了“本地文件队列”作为一级队列，有效的隔离了对AMQ的网络依赖，所以没有放大事故。事故中“本地文件队列”中消息被积累，没有被消费，重启服务后才被消费，原因后面再分析。\n\n\n## 再说说此次事故中服务不可用的原因\n\n1. AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待。\n2. AMQ Client消息的生产和Tomcat共用worker线程\n3. AMQ Client消息的生产没有超时机制\n4. AMQ Client消息的生产采用同步发送，异步发送有一些问题场景不太合适。\n\n\n所以基于以上信息，AMQ消息的生产阻塞了Tomcat worker线程，最终导致worker线程被耗光而服务不可用。\n\n在事故中通过线程堆栈信息和Tomcat线程使用数统计也确定了线程很快被耗光而请求被阻塞。\n\n另一个服务中采用了异步线程池来生产AMQ消息，但拒绝策略采用了`CallerRunsPolicy`, 也是线程池线程很快被耗光而再耗光Tomcat worker线程，最终导致服务不可用。\n\n事故产生的原因就是代码中没有有效做网路调用的隔离和降级。\n\n\n上面提到的核心服务也受到影响，参考《[本地文件队列-异步隔离](<本地文件队列-异步隔离.md>)》，也是因为**“本地文件队列”**拒绝策略采用了`CallerRunsPolicy`，最终导致线程池线程很快被耗光，而使用**“本地文件队列”**消费调度主线程，消费调度主线程被阻塞而无法消费“本地文件队列”消息并生产到AMQ。但这里和其他服务不同的是，主业务和AMQ的消息生产是隔离的，主业务生产消息到**“本地文件队列”**就返回，并不直接依赖AMQ。\n\n\n本文中提到了使用**本地文件队列**的隔离姿势。\n\n后面再介绍使用**本地文件队列**的降级姿势。\n","slug":"MQ/一次线上事故对本地文件异步队列的思考","published":1,"updated":"2017-05-21T04:44:16.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc07000mz29kpdjtcp88","content":"<h2 id=\"事故描述\"><a href=\"#事故描述\" class=\"headerlink\" title=\"事故描述\"></a>事故描述</h2><p>事故现象是部分服务http请求无响应。事故从发生到恢复，接近3个小时，事故过程中重启应用服务，只能坚持几分钟到十几分钟，在真正发现问题前通过不断重启服务实例来支撑，庆幸的是核心服务没有出现无响应的事故。</p>\n<p>最终分析为AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待，AMQ监控端口ok，控制台也可以打开，由于紧急没有具体分析，直接重启AMQ服务，切换master，通过验证服务全部恢复。</p>\n<p>这次故障大部分服务都使用了AMQ，但除了一个核心服务没受到明显影响外，其他使用AMQ的服务都不同程度的收到了影响，服务不可用。</p>\n<font color=\"red\"><br>事后通过分析这个核心服务正式使用了<strong>本地文件队列</strong>避免了事故放大，逃过一劫，当时如果这个核心服务也受到影响就可想而知了，事故间期正直商户业务高峰期，客户估计要炸了，公司也会受到很大的损失。<br><br>此次事故比较严重，就是因为使用了<strong>本地文件队列</strong>有效隔离故障，使得影响面不大。假设（当然不希望发生了）核心业务没有使用<strong>本地文件队列</strong>来隔离故障，整个下单、收银服务将不可用，商户无法营业，损失应该在数量级。<br></font>\n\n<p>此次事故也证明了我当时的这个架构思路的正确性，主要体现在隔离和降级。</p>\n<h2 id=\"说说这个核心服务使用“本地文件队列”\"><a href=\"#说说这个核心服务使用“本地文件队列”\" class=\"headerlink\" title=\"说说这个核心服务使用“本地文件队列”\"></a>说说这个核心服务使用“本地文件队列”</h2><p>我开发出来这个组件在这个团队使用一直很稳定效果也很好。</p>\n<p>实际上这个团队使用<strong>“本地文件队列”</strong>的姿势并不是我期望的，本身使用方法并没有明显不妥，只是会延迟消息的消费，但这中方法可以很好的且有效的隔离故障。</p>\n<p>就是在发送AMQ消息的方法上添加了<code>@AsyncExecutable</code>，所以在入AMQ前先入队“本地文件队列”，然后“本地文件队列”消费者再把消息生产到AMQ。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/async.png\" alt=\"\"></p>\n<p>这里正是利用率“本地文件队列”的优点，比较可靠，只依赖于本地文件系统，不会有网络故障的特性，近似不会被阻塞。</p>\n<p>在事故分析中，实际上AMQ对该核心服务也受到影响，但由于采用了“本地文件队列”作为一级队列，有效的隔离了对AMQ的网络依赖，所以没有放大事故。事故中“本地文件队列”中消息被积累，没有被消费，重启服务后才被消费，原因后面再分析。</p>\n<h2 id=\"再说说此次事故中服务不可用的原因\"><a href=\"#再说说此次事故中服务不可用的原因\" class=\"headerlink\" title=\"再说说此次事故中服务不可用的原因\"></a>再说说此次事故中服务不可用的原因</h2><ol>\n<li>AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待。</li>\n<li>AMQ Client消息的生产和Tomcat共用worker线程</li>\n<li>AMQ Client消息的生产没有超时机制</li>\n<li>AMQ Client消息的生产采用同步发送，异步发送有一些问题场景不太合适。</li>\n</ol>\n<p>所以基于以上信息，AMQ消息的生产阻塞了Tomcat worker线程，最终导致worker线程被耗光而服务不可用。</p>\n<p>在事故中通过线程堆栈信息和Tomcat线程使用数统计也确定了线程很快被耗光而请求被阻塞。</p>\n<p>另一个服务中采用了异步线程池来生产AMQ消息，但拒绝策略采用了<code>CallerRunsPolicy</code>, 也是线程池线程很快被耗光而再耗光Tomcat worker线程，最终导致服务不可用。</p>\n<p>事故产生的原因就是代码中没有有效做网路调用的隔离和降级。</p>\n<p>上面提到的核心服务也受到影响，参考《<a href=\"本地文件队列-异步隔离.md\">本地文件队列-异步隔离</a>》，也是因为<strong>“本地文件队列”</strong>拒绝策略采用了<code>CallerRunsPolicy</code>，最终导致线程池线程很快被耗光，而使用<strong>“本地文件队列”</strong>消费调度主线程，消费调度主线程被阻塞而无法消费“本地文件队列”消息并生产到AMQ。但这里和其他服务不同的是，主业务和AMQ的消息生产是隔离的，主业务生产消息到<strong>“本地文件队列”</strong>就返回，并不直接依赖AMQ。</p>\n<p>本文中提到了使用<strong>本地文件队列</strong>的隔离姿势。</p>\n<p>后面再介绍使用<strong>本地文件队列</strong>的降级姿势。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"事故描述\"><a href=\"#事故描述\" class=\"headerlink\" title=\"事故描述\"></a>事故描述</h2><p>事故现象是部分服务http请求无响应。事故从发生到恢复，接近3个小时，事故过程中重启应用服务，只能坚持几分钟到十几分钟，在真正发现问题前通过不断重启服务实例来支撑，庆幸的是核心服务没有出现无响应的事故。</p>\n<p>最终分析为AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待，AMQ监控端口ok，控制台也可以打开，由于紧急没有具体分析，直接重启AMQ服务，切换master，通过验证服务全部恢复。</p>\n<p>这次故障大部分服务都使用了AMQ，但除了一个核心服务没受到明显影响外，其他使用AMQ的服务都不同程度的收到了影响，服务不可用。</p>\n<font color=\"red\"><br>事后通过分析这个核心服务正式使用了<strong>本地文件队列</strong>避免了事故放大，逃过一劫，当时如果这个核心服务也受到影响就可想而知了，事故间期正直商户业务高峰期，客户估计要炸了，公司也会受到很大的损失。<br><br>此次事故比较严重，就是因为使用了<strong>本地文件队列</strong>有效隔离故障，使得影响面不大。假设（当然不希望发生了）核心业务没有使用<strong>本地文件队列</strong>来隔离故障，整个下单、收银服务将不可用，商户无法营业，损失应该在数量级。<br></font>\n\n<p>此次事故也证明了我当时的这个架构思路的正确性，主要体现在隔离和降级。</p>\n<h2 id=\"说说这个核心服务使用“本地文件队列”\"><a href=\"#说说这个核心服务使用“本地文件队列”\" class=\"headerlink\" title=\"说说这个核心服务使用“本地文件队列”\"></a>说说这个核心服务使用“本地文件队列”</h2><p>我开发出来这个组件在这个团队使用一直很稳定效果也很好。</p>\n<p>实际上这个团队使用<strong>“本地文件队列”</strong>的姿势并不是我期望的，本身使用方法并没有明显不妥，只是会延迟消息的消费，但这中方法可以很好的且有效的隔离故障。</p>\n<p>就是在发送AMQ消息的方法上添加了<code>@AsyncExecutable</code>，所以在入AMQ前先入队“本地文件队列”，然后“本地文件队列”消费者再把消息生产到AMQ。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/async.png\" alt=\"\"></p>\n<p>这里正是利用率“本地文件队列”的优点，比较可靠，只依赖于本地文件系统，不会有网络故障的特性，近似不会被阻塞。</p>\n<p>在事故分析中，实际上AMQ对该核心服务也受到影响，但由于采用了“本地文件队列”作为一级队列，有效的隔离了对AMQ的网络依赖，所以没有放大事故。事故中“本地文件队列”中消息被积累，没有被消费，重启服务后才被消费，原因后面再分析。</p>\n<h2 id=\"再说说此次事故中服务不可用的原因\"><a href=\"#再说说此次事故中服务不可用的原因\" class=\"headerlink\" title=\"再说说此次事故中服务不可用的原因\"></a>再说说此次事故中服务不可用的原因</h2><ol>\n<li>AMQ出现故障，现象是MQ客户端sendMessage后等待响应，但一直在等待。</li>\n<li>AMQ Client消息的生产和Tomcat共用worker线程</li>\n<li>AMQ Client消息的生产没有超时机制</li>\n<li>AMQ Client消息的生产采用同步发送，异步发送有一些问题场景不太合适。</li>\n</ol>\n<p>所以基于以上信息，AMQ消息的生产阻塞了Tomcat worker线程，最终导致worker线程被耗光而服务不可用。</p>\n<p>在事故中通过线程堆栈信息和Tomcat线程使用数统计也确定了线程很快被耗光而请求被阻塞。</p>\n<p>另一个服务中采用了异步线程池来生产AMQ消息，但拒绝策略采用了<code>CallerRunsPolicy</code>, 也是线程池线程很快被耗光而再耗光Tomcat worker线程，最终导致服务不可用。</p>\n<p>事故产生的原因就是代码中没有有效做网路调用的隔离和降级。</p>\n<p>上面提到的核心服务也受到影响，参考《<a href=\"本地文件队列-异步隔离.md\">本地文件队列-异步隔离</a>》，也是因为<strong>“本地文件队列”</strong>拒绝策略采用了<code>CallerRunsPolicy</code>，最终导致线程池线程很快被耗光，而使用<strong>“本地文件队列”</strong>消费调度主线程，消费调度主线程被阻塞而无法消费“本地文件队列”消息并生产到AMQ。但这里和其他服务不同的是，主业务和AMQ的消息生产是隔离的，主业务生产消息到<strong>“本地文件队列”</strong>就返回，并不直接依赖AMQ。</p>\n<p>本文中提到了使用<strong>本地文件队列</strong>的隔离姿势。</p>\n<p>后面再介绍使用<strong>本地文件队列</strong>的降级姿势。</p>\n"},{"title":"Maxwell MySQL binlog订阅和一些坑","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/P60724-115835.jpg","date":"2016-11-09T11:22:47.000Z","keywords":["Maxwell - Binlog - mysql"],"description":null,"_content":"\n## maxwell 相关资源\n\nhttp://maxwells-daemon.io/\nhttps://github.com/zendesk/maxwell\nhttps://github.com/zendesk/open-replicator\n\n## 配置MySQL master数据源\n\n```\n[mysqld]\nserver-id=1\nlog-bin=master\nbinlog_format=row\n```\n\n注意：\n1. MySQL必须开启了binlogs，即log-bin指定了目录\n2. binlog_format必须是row\n\n## master数据源配置REPLICATION权限：\n\nMaxwell需要储存他自己的一些状态数据，启动参数schema_database选型来指定，默认是`maxwell`.\n\n\n```sql\nGRANT ALL on maxwell.* to 'maxwell'@'%' identified by '123456';\nGRANT SELECT, REPLICATION CLIENT, REPLICATION SLAVE on *.* to 'maxwell'@'%';\n\n```\n\n\n## 问题列表\n1. 当binlog文件不存在时（被删除、移除、过期）\n\t- 无法启动maxwell\n\t- 正在运行的maxwell**`可能`**会stop\n\n  \n### 在阿里云RDS下的风险问题\n\n1. binlog文件清理问题\n2. binlog文件名在切换master主备或者阿里运维维护时会重置\n\nRDS for MySQL 的 Binlog 生成和清理规则：\n\n参考：[RDS for MySQL 之 Binlog 日志生成和清理规则](<https://help.aliyun.com/knowledge_detail/41815.html>)\n\n### 其他问题\n\n1. 阿里RDS的binlog在被复制完成后，会将之前的最后的binlog文件复制到其他地方，如果maxwell挂起时间较长，有可能未复制的binlog不能被复制过来。\n\t- 在AWS下的相关issue：https://github.com/zendesk/maxwell/issues/282\n```\nAmazon rds peridically deletes binlog files, `bin/maxwell` throws error and stops\n```\n\t- Maxwell loses connection during RDS backups：https://github.com/zendesk/maxwell/issues/326\n```\ncom.google.code.or.net.TransportException: Could not find first log file name in binary log index file\n        at com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:288)\n```\n\n### 当master中的binlog文件被删除后，无法启动\n\n```java\n09:35:06,785 ERROR MaxwellReplicator - Missing binlog 'mysql-bin.007213' on rdst5ai4d32fe3qd6if46.mysql.rds.aliyuncs.com\n09:35:06,785 ERROR MaxwellReplicator - Transport exception #1236\ncom.google.code.or.net.TransportException: Could not find first log file name in binary log index file\n\tat com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:343)\n\tat com.google.code.or.OpenReplicator.start(OpenReplicator.java:115)\n\tat com.zendesk.maxwell.replication.MaxwellReplicator.startReplicator(MaxwellReplicator.java:140)\n\tat com.zendesk.maxwell.replication.MaxwellReplicator.beforeStart(MaxwellReplicator.java:155)\n\tat com.zendesk.maxwell.util.RunLoopProcess.runLoop(RunLoopProcess.java:29)\n\tat com.zendesk.maxwell.Maxwell.start(Maxwell.java:160)\n\tat com.zendesk.maxwell.Maxwell.main(Maxwell.java:181)\n09:35:06,786 INFO  Maxwell - starting shutdown\n\n\n```","source":"_posts/binlog/Maxwell MySQL binlog订阅和一些坑.md","raw":"---\ntitle: Maxwell MySQL binlog订阅和一些坑\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/P60724-115835.jpg'\ndate: 2016-11-09 19:22:47\ncategories:\n\t- mysql\ntags:\n\t- Maxwell\n\t- binlog\n\t- mysql\nkeywords:\n\t- Maxwell\n    - Binlog\n    - mysql\ndescription:\n---\n\n## maxwell 相关资源\n\nhttp://maxwells-daemon.io/\nhttps://github.com/zendesk/maxwell\nhttps://github.com/zendesk/open-replicator\n\n## 配置MySQL master数据源\n\n```\n[mysqld]\nserver-id=1\nlog-bin=master\nbinlog_format=row\n```\n\n注意：\n1. MySQL必须开启了binlogs，即log-bin指定了目录\n2. binlog_format必须是row\n\n## master数据源配置REPLICATION权限：\n\nMaxwell需要储存他自己的一些状态数据，启动参数schema_database选型来指定，默认是`maxwell`.\n\n\n```sql\nGRANT ALL on maxwell.* to 'maxwell'@'%' identified by '123456';\nGRANT SELECT, REPLICATION CLIENT, REPLICATION SLAVE on *.* to 'maxwell'@'%';\n\n```\n\n\n## 问题列表\n1. 当binlog文件不存在时（被删除、移除、过期）\n\t- 无法启动maxwell\n\t- 正在运行的maxwell**`可能`**会stop\n\n  \n### 在阿里云RDS下的风险问题\n\n1. binlog文件清理问题\n2. binlog文件名在切换master主备或者阿里运维维护时会重置\n\nRDS for MySQL 的 Binlog 生成和清理规则：\n\n参考：[RDS for MySQL 之 Binlog 日志生成和清理规则](<https://help.aliyun.com/knowledge_detail/41815.html>)\n\n### 其他问题\n\n1. 阿里RDS的binlog在被复制完成后，会将之前的最后的binlog文件复制到其他地方，如果maxwell挂起时间较长，有可能未复制的binlog不能被复制过来。\n\t- 在AWS下的相关issue：https://github.com/zendesk/maxwell/issues/282\n```\nAmazon rds peridically deletes binlog files, `bin/maxwell` throws error and stops\n```\n\t- Maxwell loses connection during RDS backups：https://github.com/zendesk/maxwell/issues/326\n```\ncom.google.code.or.net.TransportException: Could not find first log file name in binary log index file\n        at com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:288)\n```\n\n### 当master中的binlog文件被删除后，无法启动\n\n```java\n09:35:06,785 ERROR MaxwellReplicator - Missing binlog 'mysql-bin.007213' on rdst5ai4d32fe3qd6if46.mysql.rds.aliyuncs.com\n09:35:06,785 ERROR MaxwellReplicator - Transport exception #1236\ncom.google.code.or.net.TransportException: Could not find first log file name in binary log index file\n\tat com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:343)\n\tat com.google.code.or.OpenReplicator.start(OpenReplicator.java:115)\n\tat com.zendesk.maxwell.replication.MaxwellReplicator.startReplicator(MaxwellReplicator.java:140)\n\tat com.zendesk.maxwell.replication.MaxwellReplicator.beforeStart(MaxwellReplicator.java:155)\n\tat com.zendesk.maxwell.util.RunLoopProcess.runLoop(RunLoopProcess.java:29)\n\tat com.zendesk.maxwell.Maxwell.start(Maxwell.java:160)\n\tat com.zendesk.maxwell.Maxwell.main(Maxwell.java:181)\n09:35:06,786 INFO  Maxwell - starting shutdown\n\n\n```","slug":"binlog/Maxwell MySQL binlog订阅和一些坑","published":1,"updated":"2017-05-21T04:43:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0a000sz29ksuoo6wy4","content":"<h2 id=\"maxwell-相关资源\"><a href=\"#maxwell-相关资源\" class=\"headerlink\" title=\"maxwell 相关资源\"></a>maxwell 相关资源</h2><p><a href=\"http://maxwells-daemon.io/\" target=\"_blank\" rel=\"external\">http://maxwells-daemon.io/</a><br><a href=\"https://github.com/zendesk/maxwell\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/maxwell</a><br><a href=\"https://github.com/zendesk/open-replicator\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/open-replicator</a></p>\n<h2 id=\"配置MySQL-master数据源\"><a href=\"#配置MySQL-master数据源\" class=\"headerlink\" title=\"配置MySQL master数据源\"></a>配置MySQL master数据源</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[mysqld]</div><div class=\"line\">server-id=1</div><div class=\"line\">log-bin=master</div><div class=\"line\">binlog_format=row</div></pre></td></tr></table></figure>\n<p>注意：</p>\n<ol>\n<li>MySQL必须开启了binlogs，即log-bin指定了目录</li>\n<li>binlog_format必须是row</li>\n</ol>\n<h2 id=\"master数据源配置REPLICATION权限：\"><a href=\"#master数据源配置REPLICATION权限：\" class=\"headerlink\" title=\"master数据源配置REPLICATION权限：\"></a>master数据源配置REPLICATION权限：</h2><p>Maxwell需要储存他自己的一些状态数据，启动参数schema_database选型来指定，默认是<code>maxwell</code>.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">GRANT</span> ALL <span class=\"keyword\">on</span> maxwell.* <span class=\"keyword\">to</span> <span class=\"string\">'maxwell'</span>@<span class=\"string\">'%'</span> <span class=\"keyword\">identified</span> <span class=\"keyword\">by</span> <span class=\"string\">'123456'</span>;</div><div class=\"line\"><span class=\"keyword\">GRANT</span> <span class=\"keyword\">SELECT</span>, <span class=\"keyword\">REPLICATION</span> <span class=\"keyword\">CLIENT</span>, <span class=\"keyword\">REPLICATION</span> <span class=\"keyword\">SLAVE</span> <span class=\"keyword\">on</span> *.* <span class=\"keyword\">to</span> <span class=\"string\">'maxwell'</span>@<span class=\"string\">'%'</span>;</div></pre></td></tr></table></figure>\n<h2 id=\"问题列表\"><a href=\"#问题列表\" class=\"headerlink\" title=\"问题列表\"></a>问题列表</h2><ol>\n<li>当binlog文件不存在时（被删除、移除、过期）<ul>\n<li>无法启动maxwell</li>\n<li>正在运行的maxwell<strong><code>可能</code></strong>会stop</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"在阿里云RDS下的风险问题\"><a href=\"#在阿里云RDS下的风险问题\" class=\"headerlink\" title=\"在阿里云RDS下的风险问题\"></a>在阿里云RDS下的风险问题</h3><ol>\n<li>binlog文件清理问题</li>\n<li>binlog文件名在切换master主备或者阿里运维维护时会重置</li>\n</ol>\n<p>RDS for MySQL 的 Binlog 生成和清理规则：</p>\n<p>参考：<a href=\"https://help.aliyun.com/knowledge_detail/41815.html\" target=\"_blank\" rel=\"external\">RDS for MySQL 之 Binlog 日志生成和清理规则</a></p>\n<h3 id=\"其他问题\"><a href=\"#其他问题\" class=\"headerlink\" title=\"其他问题\"></a>其他问题</h3><ol>\n<li><p>阿里RDS的binlog在被复制完成后，会将之前的最后的binlog文件复制到其他地方，如果maxwell挂起时间较长，有可能未复制的binlog不能被复制过来。</p>\n<ul>\n<li><p>在AWS下的相关issue：<a href=\"https://github.com/zendesk/maxwell/issues/282\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/maxwell/issues/282</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Amazon rds peridically deletes binlog files, `bin/maxwell` throws error and stops</div></pre></td></tr></table></figure>\n</li>\n<li><p>Maxwell loses connection during RDS backups：<a href=\"https://github.com/zendesk/maxwell/issues/326\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/maxwell/issues/326</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">com.google.code.or.net.TransportException: Could not find first log file name in binary log index file</div><div class=\"line\">        at com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:288)</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"当master中的binlog文件被删除后，无法启动\"><a href=\"#当master中的binlog文件被删除后，无法启动\" class=\"headerlink\" title=\"当master中的binlog文件被删除后，无法启动\"></a>当master中的binlog文件被删除后，无法启动</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">09:35:06,785 ERROR MaxwellReplicator - Missing binlog 'mysql-bin.007213' on rdst5ai4d32fe3qd6if46.mysql.rds.aliyuncs.com</div><div class=\"line\">09:35:06,785 ERROR MaxwellReplicator - Transport exception #1236</div><div class=\"line\">com.google.code.or.net.TransportException: Could not find first log file name in binary log index file</div><div class=\"line\">\tat com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:343)</div><div class=\"line\">\tat com.google.code.or.OpenReplicator.start(OpenReplicator.java:115)</div><div class=\"line\">\tat com.zendesk.maxwell.replication.MaxwellReplicator.startReplicator(MaxwellReplicator.java:140)</div><div class=\"line\">\tat com.zendesk.maxwell.replication.MaxwellReplicator.beforeStart(MaxwellReplicator.java:155)</div><div class=\"line\">\tat com.zendesk.maxwell.util.RunLoopProcess.runLoop(RunLoopProcess.java:29)</div><div class=\"line\">\tat com.zendesk.maxwell.Maxwell.start(Maxwell.java:160)</div><div class=\"line\">\tat com.zendesk.maxwell.Maxwell.main(Maxwell.java:181)</div><div class=\"line\">09:35:06,786 INFO  Maxwell - starting shutdown</div></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"maxwell-相关资源\"><a href=\"#maxwell-相关资源\" class=\"headerlink\" title=\"maxwell 相关资源\"></a>maxwell 相关资源</h2><p><a href=\"http://maxwells-daemon.io/\" target=\"_blank\" rel=\"external\">http://maxwells-daemon.io/</a><br><a href=\"https://github.com/zendesk/maxwell\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/maxwell</a><br><a href=\"https://github.com/zendesk/open-replicator\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/open-replicator</a></p>\n<h2 id=\"配置MySQL-master数据源\"><a href=\"#配置MySQL-master数据源\" class=\"headerlink\" title=\"配置MySQL master数据源\"></a>配置MySQL master数据源</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[mysqld]</div><div class=\"line\">server-id=1</div><div class=\"line\">log-bin=master</div><div class=\"line\">binlog_format=row</div></pre></td></tr></table></figure>\n<p>注意：</p>\n<ol>\n<li>MySQL必须开启了binlogs，即log-bin指定了目录</li>\n<li>binlog_format必须是row</li>\n</ol>\n<h2 id=\"master数据源配置REPLICATION权限：\"><a href=\"#master数据源配置REPLICATION权限：\" class=\"headerlink\" title=\"master数据源配置REPLICATION权限：\"></a>master数据源配置REPLICATION权限：</h2><p>Maxwell需要储存他自己的一些状态数据，启动参数schema_database选型来指定，默认是<code>maxwell</code>.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">GRANT</span> ALL <span class=\"keyword\">on</span> maxwell.* <span class=\"keyword\">to</span> <span class=\"string\">'maxwell'</span>@<span class=\"string\">'%'</span> <span class=\"keyword\">identified</span> <span class=\"keyword\">by</span> <span class=\"string\">'123456'</span>;</div><div class=\"line\"><span class=\"keyword\">GRANT</span> <span class=\"keyword\">SELECT</span>, <span class=\"keyword\">REPLICATION</span> <span class=\"keyword\">CLIENT</span>, <span class=\"keyword\">REPLICATION</span> <span class=\"keyword\">SLAVE</span> <span class=\"keyword\">on</span> *.* <span class=\"keyword\">to</span> <span class=\"string\">'maxwell'</span>@<span class=\"string\">'%'</span>;</div></pre></td></tr></table></figure>\n<h2 id=\"问题列表\"><a href=\"#问题列表\" class=\"headerlink\" title=\"问题列表\"></a>问题列表</h2><ol>\n<li>当binlog文件不存在时（被删除、移除、过期）<ul>\n<li>无法启动maxwell</li>\n<li>正在运行的maxwell<strong><code>可能</code></strong>会stop</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"在阿里云RDS下的风险问题\"><a href=\"#在阿里云RDS下的风险问题\" class=\"headerlink\" title=\"在阿里云RDS下的风险问题\"></a>在阿里云RDS下的风险问题</h3><ol>\n<li>binlog文件清理问题</li>\n<li>binlog文件名在切换master主备或者阿里运维维护时会重置</li>\n</ol>\n<p>RDS for MySQL 的 Binlog 生成和清理规则：</p>\n<p>参考：<a href=\"https://help.aliyun.com/knowledge_detail/41815.html\" target=\"_blank\" rel=\"external\">RDS for MySQL 之 Binlog 日志生成和清理规则</a></p>\n<h3 id=\"其他问题\"><a href=\"#其他问题\" class=\"headerlink\" title=\"其他问题\"></a>其他问题</h3><ol>\n<li><p>阿里RDS的binlog在被复制完成后，会将之前的最后的binlog文件复制到其他地方，如果maxwell挂起时间较长，有可能未复制的binlog不能被复制过来。</p>\n<ul>\n<li><p>在AWS下的相关issue：<a href=\"https://github.com/zendesk/maxwell/issues/282\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/maxwell/issues/282</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Amazon rds peridically deletes binlog files, `bin/maxwell` throws error and stops</div></pre></td></tr></table></figure>\n</li>\n<li><p>Maxwell loses connection during RDS backups：<a href=\"https://github.com/zendesk/maxwell/issues/326\" target=\"_blank\" rel=\"external\">https://github.com/zendesk/maxwell/issues/326</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">com.google.code.or.net.TransportException: Could not find first log file name in binary log index file</div><div class=\"line\">        at com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:288)</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"当master中的binlog文件被删除后，无法启动\"><a href=\"#当master中的binlog文件被删除后，无法启动\" class=\"headerlink\" title=\"当master中的binlog文件被删除后，无法启动\"></a>当master中的binlog文件被删除后，无法启动</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">09:35:06,785 ERROR MaxwellReplicator - Missing binlog 'mysql-bin.007213' on rdst5ai4d32fe3qd6if46.mysql.rds.aliyuncs.com</div><div class=\"line\">09:35:06,785 ERROR MaxwellReplicator - Transport exception #1236</div><div class=\"line\">com.google.code.or.net.TransportException: Could not find first log file name in binary log index file</div><div class=\"line\">\tat com.google.code.or.OpenReplicator.dumpBinlog(OpenReplicator.java:343)</div><div class=\"line\">\tat com.google.code.or.OpenReplicator.start(OpenReplicator.java:115)</div><div class=\"line\">\tat com.zendesk.maxwell.replication.MaxwellReplicator.startReplicator(MaxwellReplicator.java:140)</div><div class=\"line\">\tat com.zendesk.maxwell.replication.MaxwellReplicator.beforeStart(MaxwellReplicator.java:155)</div><div class=\"line\">\tat com.zendesk.maxwell.util.RunLoopProcess.runLoop(RunLoopProcess.java:29)</div><div class=\"line\">\tat com.zendesk.maxwell.Maxwell.start(Maxwell.java:160)</div><div class=\"line\">\tat com.zendesk.maxwell.Maxwell.main(Maxwell.java:181)</div><div class=\"line\">09:35:06,786 INFO  Maxwell - starting shutdown</div></pre></td></tr></table></figure>"},{"title":"微服务下分布式事务问题","thumbnail":"images/m1.jpg","date":"2016-09-08T11:22:47.000Z","keywords":["微服务","Spring Cloud","Spring Boot","分布式事务"],"description":null,"_content":"\n\n\n![IMG_20160925_143422.jpg](http://upload-images.jianshu.io/upload_images/2519252-f3c6ae1fcc9ee375.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n\n用`数据一致性`来描述更贴切一些，在微服务化后，分布式事务上有很多选择，像**多阶段提交、补偿模式、可靠事件、TCC**等等，多阶段提交强一致性好但很难提升吞吐，为了吞吐基本上都是选择了最终一致性的分布式事务模型。补偿模式、可靠事件、TCC都属于最终一致性的范畴，都被广泛采用。无论采用哪种模式，都应该在特定业务场景下选择合适的分布式事务模型，并且具体场景具体分析了。这些模型也有很多分享参考，不再废话，下面着重介绍另一种分布式事务模型。\n\n### 交叉事务模型\n\n最初是2个数据源，我把它叫做`双事务`，扩展后支持多个数据源叫做`交叉事务`，这种事务适用于有2个或多个DataSource的场景下来保证数据的事务完整性，吞吐和一致性效果都很不错，这种事务模型利用了JDBC事务，基本思路是先执行DML SQL，出现异常或者需要回滚时依次回滚已经执行事务，最后再执行提交, 并且实现难度也不大，下面是伪代码：\n\n```java\nList<Connection> connections = new ArrayList<>();\nint i = 0;\ntry {\n    for (Connection connection : connections) {\n       boolean isExecuted= execute(connection);\n        i++;\n        if(!isExecuted){\n            throw new SQLException();\n        }\n    }\n} catch (SQLException e) {\n    for (int j = 0; j <= i; j++) {\n        connections.get(j).rollback();\n    }\n} finally {\n    for (Connection connection : connections) {\n        connection.commit();\n    }\n\n}\n\n```\n\n\n交叉事务要配合实际的JDBC事务和一些锁机制才能很好的工作，交叉事务很好的解决了多数据源的问题，但不是任何场景都适用，我总结了适用场景供大家参考：\n\n1. 每个数据源事务处理要求很快，通常是零点几~十几毫秒，**不适合长事务慢事务**。\n2. 通过建立多个数据源来工作，不是网络接口。\n3. 每个数据源事务中要**配合锁机制保证数据一致性**，where id=? for update行锁或者乐观锁都可以，但必须保证整个个事务过程中不允许被其他事务修改。\n\n**这个事务模型在这样一个测试模型下的测试结果：**\n\n在多线程下随机对10组数据做随机更新，并记录下测试的最终状态，最后读取数据库最后实际数据比较。在这样的测试模型，每秒大约3000的事务，多次测试结果均显示无不一致数据，效果很好，后期的实际业务测试下也显示出其一致性和性能都不错。\n","source":"_posts/微服务/微服务下分布式事务问题.md","raw":"\n---\ntitle: 微服务下分布式事务问题\nthumbnail: 'images/m1.jpg'\ndate: 2016-09-08 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- spring-cloud\n\t- 微服务\n\t- Spring Boot\n\t- 分布式事务\nkeywords:\n\t- 微服务\n\t- Spring Cloud\n\t- Spring Boot\n\t- 分布式事务\ndescription:\n---\n\n\n\n![IMG_20160925_143422.jpg](http://upload-images.jianshu.io/upload_images/2519252-f3c6ae1fcc9ee375.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n\n用`数据一致性`来描述更贴切一些，在微服务化后，分布式事务上有很多选择，像**多阶段提交、补偿模式、可靠事件、TCC**等等，多阶段提交强一致性好但很难提升吞吐，为了吞吐基本上都是选择了最终一致性的分布式事务模型。补偿模式、可靠事件、TCC都属于最终一致性的范畴，都被广泛采用。无论采用哪种模式，都应该在特定业务场景下选择合适的分布式事务模型，并且具体场景具体分析了。这些模型也有很多分享参考，不再废话，下面着重介绍另一种分布式事务模型。\n\n### 交叉事务模型\n\n最初是2个数据源，我把它叫做`双事务`，扩展后支持多个数据源叫做`交叉事务`，这种事务适用于有2个或多个DataSource的场景下来保证数据的事务完整性，吞吐和一致性效果都很不错，这种事务模型利用了JDBC事务，基本思路是先执行DML SQL，出现异常或者需要回滚时依次回滚已经执行事务，最后再执行提交, 并且实现难度也不大，下面是伪代码：\n\n```java\nList<Connection> connections = new ArrayList<>();\nint i = 0;\ntry {\n    for (Connection connection : connections) {\n       boolean isExecuted= execute(connection);\n        i++;\n        if(!isExecuted){\n            throw new SQLException();\n        }\n    }\n} catch (SQLException e) {\n    for (int j = 0; j <= i; j++) {\n        connections.get(j).rollback();\n    }\n} finally {\n    for (Connection connection : connections) {\n        connection.commit();\n    }\n\n}\n\n```\n\n\n交叉事务要配合实际的JDBC事务和一些锁机制才能很好的工作，交叉事务很好的解决了多数据源的问题，但不是任何场景都适用，我总结了适用场景供大家参考：\n\n1. 每个数据源事务处理要求很快，通常是零点几~十几毫秒，**不适合长事务慢事务**。\n2. 通过建立多个数据源来工作，不是网络接口。\n3. 每个数据源事务中要**配合锁机制保证数据一致性**，where id=? for update行锁或者乐观锁都可以，但必须保证整个个事务过程中不允许被其他事务修改。\n\n**这个事务模型在这样一个测试模型下的测试结果：**\n\n在多线程下随机对10组数据做随机更新，并记录下测试的最终状态，最后读取数据库最后实际数据比较。在这样的测试模型，每秒大约3000的事务，多次测试结果均显示无不一致数据，效果很好，后期的实际业务测试下也显示出其一致性和性能都不错。\n","slug":"微服务/微服务下分布式事务问题","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0e0011z29kmqmjpvvf","content":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-f3c6ae1fcc9ee375.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"IMG_20160925_143422.jpg\"></p>\n<p>用<code>数据一致性</code>来描述更贴切一些，在微服务化后，分布式事务上有很多选择，像<strong>多阶段提交、补偿模式、可靠事件、TCC</strong>等等，多阶段提交强一致性好但很难提升吞吐，为了吞吐基本上都是选择了最终一致性的分布式事务模型。补偿模式、可靠事件、TCC都属于最终一致性的范畴，都被广泛采用。无论采用哪种模式，都应该在特定业务场景下选择合适的分布式事务模型，并且具体场景具体分析了。这些模型也有很多分享参考，不再废话，下面着重介绍另一种分布式事务模型。</p>\n<h3 id=\"交叉事务模型\"><a href=\"#交叉事务模型\" class=\"headerlink\" title=\"交叉事务模型\"></a>交叉事务模型</h3><p>最初是2个数据源，我把它叫做<code>双事务</code>，扩展后支持多个数据源叫做<code>交叉事务</code>，这种事务适用于有2个或多个DataSource的场景下来保证数据的事务完整性，吞吐和一致性效果都很不错，这种事务模型利用了JDBC事务，基本思路是先执行DML SQL，出现异常或者需要回滚时依次回滚已经执行事务，最后再执行提交, 并且实现难度也不大，下面是伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">List&lt;Connection&gt; connections = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"><span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"keyword\">try</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (Connection connection : connections) &#123;</div><div class=\"line\">       <span class=\"keyword\">boolean</span> isExecuted= execute(connection);</div><div class=\"line\">        i++;</div><div class=\"line\">        <span class=\"keyword\">if</span>(!isExecuted)&#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SQLException();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt;= i; j++) &#123;</div><div class=\"line\">        connections.get(j).rollback();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (Connection connection : connections) &#123;</div><div class=\"line\">        connection.commit();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>交叉事务要配合实际的JDBC事务和一些锁机制才能很好的工作，交叉事务很好的解决了多数据源的问题，但不是任何场景都适用，我总结了适用场景供大家参考：</p>\n<ol>\n<li>每个数据源事务处理要求很快，通常是零点几~十几毫秒，<strong>不适合长事务慢事务</strong>。</li>\n<li>通过建立多个数据源来工作，不是网络接口。</li>\n<li>每个数据源事务中要<strong>配合锁机制保证数据一致性</strong>，where id=? for update行锁或者乐观锁都可以，但必须保证整个个事务过程中不允许被其他事务修改。</li>\n</ol>\n<p><strong>这个事务模型在这样一个测试模型下的测试结果：</strong></p>\n<p>在多线程下随机对10组数据做随机更新，并记录下测试的最终状态，最后读取数据库最后实际数据比较。在这样的测试模型，每秒大约3000的事务，多次测试结果均显示无不一致数据，效果很好，后期的实际业务测试下也显示出其一致性和性能都不错。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-f3c6ae1fcc9ee375.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"IMG_20160925_143422.jpg\"></p>\n<p>用<code>数据一致性</code>来描述更贴切一些，在微服务化后，分布式事务上有很多选择，像<strong>多阶段提交、补偿模式、可靠事件、TCC</strong>等等，多阶段提交强一致性好但很难提升吞吐，为了吞吐基本上都是选择了最终一致性的分布式事务模型。补偿模式、可靠事件、TCC都属于最终一致性的范畴，都被广泛采用。无论采用哪种模式，都应该在特定业务场景下选择合适的分布式事务模型，并且具体场景具体分析了。这些模型也有很多分享参考，不再废话，下面着重介绍另一种分布式事务模型。</p>\n<h3 id=\"交叉事务模型\"><a href=\"#交叉事务模型\" class=\"headerlink\" title=\"交叉事务模型\"></a>交叉事务模型</h3><p>最初是2个数据源，我把它叫做<code>双事务</code>，扩展后支持多个数据源叫做<code>交叉事务</code>，这种事务适用于有2个或多个DataSource的场景下来保证数据的事务完整性，吞吐和一致性效果都很不错，这种事务模型利用了JDBC事务，基本思路是先执行DML SQL，出现异常或者需要回滚时依次回滚已经执行事务，最后再执行提交, 并且实现难度也不大，下面是伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">List&lt;Connection&gt; connections = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\"><span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\"><span class=\"keyword\">try</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (Connection connection : connections) &#123;</div><div class=\"line\">       <span class=\"keyword\">boolean</span> isExecuted= execute(connection);</div><div class=\"line\">        i++;</div><div class=\"line\">        <span class=\"keyword\">if</span>(!isExecuted)&#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SQLException();</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt;= i; j++) &#123;</div><div class=\"line\">        connections.get(j).rollback();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (Connection connection : connections) &#123;</div><div class=\"line\">        connection.commit();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>交叉事务要配合实际的JDBC事务和一些锁机制才能很好的工作，交叉事务很好的解决了多数据源的问题，但不是任何场景都适用，我总结了适用场景供大家参考：</p>\n<ol>\n<li>每个数据源事务处理要求很快，通常是零点几~十几毫秒，<strong>不适合长事务慢事务</strong>。</li>\n<li>通过建立多个数据源来工作，不是网络接口。</li>\n<li>每个数据源事务中要<strong>配合锁机制保证数据一致性</strong>，where id=? for update行锁或者乐观锁都可以，但必须保证整个个事务过程中不允许被其他事务修改。</li>\n</ol>\n<p><strong>这个事务模型在这样一个测试模型下的测试结果：</strong></p>\n<p>在多线程下随机对10组数据做随机更新，并记录下测试的最终状态，最后读取数据库最后实际数据比较。在这样的测试模型，每秒大约3000的事务，多次测试结果均显示无不一致数据，效果很好，后期的实际业务测试下也显示出其一致性和性能都不错。</p>\n"},{"title":"安装Nginx Lua环境","thumbnail":"images/m1.jpg","date":"2016-11-27T11:22:47.000Z","keywords":["nginx","lua","openresty"],"description":null,"_content":"\n# 安装Nginx Lua模块\n\n## 环境准备：\n > $ yum -y install pcre-devel\n \n > $ yum -y install openssl openssl-devel\n\n### 下载所需文件\n\n亦可参考官方安装指南：[lua-nginx-module Installation](<https://github.com/openresty/lua-nginx-module#installation>)\n\n这是我总结的安装，供参考：\n \n需要最新版的Nginx，LuaJIT，ngx\\_devel\\_kit，lua-nginx-module等安装文件:\n\n+ [Nginx](<http://nginx.org/en/download.html>)\n+ [LuaJIT](<http://luajit.org/download.html>) Lua或者LuaJIT都是可以的，但是出于性能的考虑，推荐安装LuaJIT\n+ [ngx\\_devel\\_kit](<https://github.com/simpl/ngx_devel_kit/tags>)\n+ [lua-nginx-module](<https://github.com/openresty/lua-nginx-module/tags>)\n\n\n\n参考命令下载：\n\n> $ curl -O http://nginx.org/download/nginx-1.10.1.tar.gz\n>\n> $ curl -O http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz\n>\n> $ curl -L -O https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz\n> \n> $ curl -L -O https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz \n> \n\n## 安装LuaJIT\n\n> $ wget http://luajit.org/download/LuaJIT-<VERSION>.tar.gz\n> \n> $ tar zxvf LuaJIT-<VERSION>.tar.gz\n> \n> $ cd LuaJIT-<VERSION>\n> \n> $ make\n> \n> $ sudo make install\n> \n\n## 编译安装lua-nginx-module\n\n```\n\nexport LUAJIT_LIB=/usr/local/lib\nexport LUAJIT_INC=/usr/local/include/luajit-2.1\n\ncd nginx-1.10.1\n./configure --prefix=/opt/nginx  --with-ld-opt=\"-Wl,-rpath,/usr/local/lib\"  --add-module=/path/to/ngx_devel_kit-0.3.0  --add-module=/path/to/nginx/lua-nginx-module-0.10.5\nmake\nmake install\n\n```\n  \n\n\n\n## 动态module方式\n\nNginx 1.9.11 开始可以编译module为一个动态module，在执行./configure命令时用--add-dynamic-module=PATH替换--add-module=PATH。编译后可以在nginx.conf配置中使用 load_module 来动态加载这个module：\n\n> load\\_module /path/to/modules/ndk_http_module.so;\n>  \n> load\\_module /path/to/modules/ngx_http_lua_module.so;\n\n\t\n\n## lua cjson install\nEureka Zuul 网关\n  安装编译cjson需要lua运行时，编译前需要修改MakeFile中的LUA_VERSION、LUA_INCLUDE_DIR、LUA_CMODULE_DIR参数，让cjson模块知道lua库文件和头文件目录，才可以正常编译安装。\n\n下载解压：\n\n```\nwget http://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz\ntar -zxvf cjson-2.1.0.tar.gz\ncd cjson-2.1.0\n\n```\n修改MakeFile：\n\n```\nLUA_VERSION =  luajit-2.1\nLUA_INCLUDE_DIR =   $(PREFIX)/include/$(LUA_VERSION)\nLUA_CMODULE_DIR =   $(PREFIX)/lib\n\n\nmake & sudo make install\nsudo cp cjson.so /usr/local/lib/lua/5.1/\n\n```\n","source":"_posts/nginx/安装Nginx&Lua模块.md","raw":"---\ntitle: 安装Nginx Lua环境\nthumbnail: 'images/m1.jpg'\ndate: 2016-11-27 19:22:47\ncategories:\n\t- nginx\ntags:\n\t- nginx\n\t- lua\n\t- openresty\nkeywords:\n\t- nginx\n\t- lua\n\t- openresty\ndescription:\n---\n\n# 安装Nginx Lua模块\n\n## 环境准备：\n > $ yum -y install pcre-devel\n \n > $ yum -y install openssl openssl-devel\n\n### 下载所需文件\n\n亦可参考官方安装指南：[lua-nginx-module Installation](<https://github.com/openresty/lua-nginx-module#installation>)\n\n这是我总结的安装，供参考：\n \n需要最新版的Nginx，LuaJIT，ngx\\_devel\\_kit，lua-nginx-module等安装文件:\n\n+ [Nginx](<http://nginx.org/en/download.html>)\n+ [LuaJIT](<http://luajit.org/download.html>) Lua或者LuaJIT都是可以的，但是出于性能的考虑，推荐安装LuaJIT\n+ [ngx\\_devel\\_kit](<https://github.com/simpl/ngx_devel_kit/tags>)\n+ [lua-nginx-module](<https://github.com/openresty/lua-nginx-module/tags>)\n\n\n\n参考命令下载：\n\n> $ curl -O http://nginx.org/download/nginx-1.10.1.tar.gz\n>\n> $ curl -O http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz\n>\n> $ curl -L -O https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz\n> \n> $ curl -L -O https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz \n> \n\n## 安装LuaJIT\n\n> $ wget http://luajit.org/download/LuaJIT-<VERSION>.tar.gz\n> \n> $ tar zxvf LuaJIT-<VERSION>.tar.gz\n> \n> $ cd LuaJIT-<VERSION>\n> \n> $ make\n> \n> $ sudo make install\n> \n\n## 编译安装lua-nginx-module\n\n```\n\nexport LUAJIT_LIB=/usr/local/lib\nexport LUAJIT_INC=/usr/local/include/luajit-2.1\n\ncd nginx-1.10.1\n./configure --prefix=/opt/nginx  --with-ld-opt=\"-Wl,-rpath,/usr/local/lib\"  --add-module=/path/to/ngx_devel_kit-0.3.0  --add-module=/path/to/nginx/lua-nginx-module-0.10.5\nmake\nmake install\n\n```\n  \n\n\n\n## 动态module方式\n\nNginx 1.9.11 开始可以编译module为一个动态module，在执行./configure命令时用--add-dynamic-module=PATH替换--add-module=PATH。编译后可以在nginx.conf配置中使用 load_module 来动态加载这个module：\n\n> load\\_module /path/to/modules/ndk_http_module.so;\n>  \n> load\\_module /path/to/modules/ngx_http_lua_module.so;\n\n\t\n\n## lua cjson install\nEureka Zuul 网关\n  安装编译cjson需要lua运行时，编译前需要修改MakeFile中的LUA_VERSION、LUA_INCLUDE_DIR、LUA_CMODULE_DIR参数，让cjson模块知道lua库文件和头文件目录，才可以正常编译安装。\n\n下载解压：\n\n```\nwget http://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz\ntar -zxvf cjson-2.1.0.tar.gz\ncd cjson-2.1.0\n\n```\n修改MakeFile：\n\n```\nLUA_VERSION =  luajit-2.1\nLUA_INCLUDE_DIR =   $(PREFIX)/include/$(LUA_VERSION)\nLUA_CMODULE_DIR =   $(PREFIX)/lib\n\n\nmake & sudo make install\nsudo cp cjson.so /usr/local/lib/lua/5.1/\n\n```\n","slug":"nginx/安装Nginx&Lua模块","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0h001cz29kjxicw6o1","content":"<h1 id=\"安装Nginx-Lua模块\"><a href=\"#安装Nginx-Lua模块\" class=\"headerlink\" title=\"安装Nginx Lua模块\"></a>安装Nginx Lua模块</h1><h2 id=\"环境准备：\"><a href=\"#环境准备：\" class=\"headerlink\" title=\"环境准备：\"></a>环境准备：</h2><blockquote>\n<p>$ yum -y install pcre-devel</p>\n<p>$ yum -y install openssl openssl-devel</p>\n</blockquote>\n<h3 id=\"下载所需文件\"><a href=\"#下载所需文件\" class=\"headerlink\" title=\"下载所需文件\"></a>下载所需文件</h3><p>亦可参考官方安装指南：<a href=\"https://github.com/openresty/lua-nginx-module#installation\" target=\"_blank\" rel=\"external\">lua-nginx-module Installation</a></p>\n<p>这是我总结的安装，供参考：</p>\n<p>需要最新版的Nginx，LuaJIT，ngx_devel_kit，lua-nginx-module等安装文件:</p>\n<ul>\n<li><a href=\"http://nginx.org/en/download.html\" target=\"_blank\" rel=\"external\">Nginx</a></li>\n<li><a href=\"http://luajit.org/download.html\" target=\"_blank\" rel=\"external\">LuaJIT</a> Lua或者LuaJIT都是可以的，但是出于性能的考虑，推荐安装LuaJIT</li>\n<li><a href=\"https://github.com/simpl/ngx_devel_kit/tags\" target=\"_blank\" rel=\"external\">ngx_devel_kit</a></li>\n<li><a href=\"https://github.com/openresty/lua-nginx-module/tags\" target=\"_blank\" rel=\"external\">lua-nginx-module</a></li>\n</ul>\n<p>参考命令下载：</p>\n<blockquote>\n<p>$ curl -O <a href=\"http://nginx.org/download/nginx-1.10.1.tar.gz\" target=\"_blank\" rel=\"external\">http://nginx.org/download/nginx-1.10.1.tar.gz</a></p>\n<p>$ curl -O <a href=\"http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz\" target=\"_blank\" rel=\"external\">http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz</a></p>\n<p>$ curl -L -O <a href=\"https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz\" target=\"_blank\" rel=\"external\">https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz</a></p>\n<p>$ curl -L -O <a href=\"https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz\" target=\"_blank\" rel=\"external\">https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz</a> </p>\n</blockquote>\n<h2 id=\"安装LuaJIT\"><a href=\"#安装LuaJIT\" class=\"headerlink\" title=\"安装LuaJIT\"></a>安装LuaJIT</h2><blockquote>\n<p>$ wget <a href=\"http://luajit.org/download/LuaJIT-\" target=\"_blank\" rel=\"external\">http://luajit.org/download/LuaJIT-</a><version>.tar.gz</version></p>\n<p>$ tar zxvf LuaJIT-<version>.tar.gz</version></p>\n<p>$ cd LuaJIT-<version></version></p>\n<p>$ make</p>\n<p>$ sudo make install</p>\n</blockquote>\n<h2 id=\"编译安装lua-nginx-module\"><a href=\"#编译安装lua-nginx-module\" class=\"headerlink\" title=\"编译安装lua-nginx-module\"></a>编译安装lua-nginx-module</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">export LUAJIT_LIB=/usr/local/lib</div><div class=\"line\">export LUAJIT_INC=/usr/local/include/luajit-2.1</div><div class=\"line\"></div><div class=\"line\">cd nginx-1.10.1</div><div class=\"line\">./configure --prefix=/opt/nginx  --with-ld-opt=&quot;-Wl,-rpath,/usr/local/lib&quot;  --add-module=/path/to/ngx_devel_kit-0.3.0  --add-module=/path/to/nginx/lua-nginx-module-0.10.5</div><div class=\"line\">make</div><div class=\"line\">make install</div></pre></td></tr></table></figure>\n<h2 id=\"动态module方式\"><a href=\"#动态module方式\" class=\"headerlink\" title=\"动态module方式\"></a>动态module方式</h2><p>Nginx 1.9.11 开始可以编译module为一个动态module，在执行./configure命令时用–add-dynamic-module=PATH替换–add-module=PATH。编译后可以在nginx.conf配置中使用 load_module 来动态加载这个module：</p>\n<blockquote>\n<p>load_module /path/to/modules/ndk_http_module.so;</p>\n<p>load_module /path/to/modules/ngx_http_lua_module.so;</p>\n</blockquote>\n<h2 id=\"lua-cjson-install\"><a href=\"#lua-cjson-install\" class=\"headerlink\" title=\"lua cjson install\"></a>lua cjson install</h2><p>Eureka Zuul 网关<br>  安装编译cjson需要lua运行时，编译前需要修改MakeFile中的LUA_VERSION、LUA_INCLUDE_DIR、LUA_CMODULE_DIR参数，让cjson模块知道lua库文件和头文件目录，才可以正常编译安装。</p>\n<p>下载解压：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz</div><div class=\"line\">tar -zxvf cjson-2.1.0.tar.gz</div><div class=\"line\">cd cjson-2.1.0</div></pre></td></tr></table></figure>\n<p>修改MakeFile：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">LUA_VERSION =  luajit-2.1</div><div class=\"line\">LUA_INCLUDE_DIR =   $(PREFIX)/include/$(LUA_VERSION)</div><div class=\"line\">LUA_CMODULE_DIR =   $(PREFIX)/lib</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">make &amp; sudo make install</div><div class=\"line\">sudo cp cjson.so /usr/local/lib/lua/5.1/</div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"安装Nginx-Lua模块\"><a href=\"#安装Nginx-Lua模块\" class=\"headerlink\" title=\"安装Nginx Lua模块\"></a>安装Nginx Lua模块</h1><h2 id=\"环境准备：\"><a href=\"#环境准备：\" class=\"headerlink\" title=\"环境准备：\"></a>环境准备：</h2><blockquote>\n<p>$ yum -y install pcre-devel</p>\n<p>$ yum -y install openssl openssl-devel</p>\n</blockquote>\n<h3 id=\"下载所需文件\"><a href=\"#下载所需文件\" class=\"headerlink\" title=\"下载所需文件\"></a>下载所需文件</h3><p>亦可参考官方安装指南：<a href=\"https://github.com/openresty/lua-nginx-module#installation\" target=\"_blank\" rel=\"external\">lua-nginx-module Installation</a></p>\n<p>这是我总结的安装，供参考：</p>\n<p>需要最新版的Nginx，LuaJIT，ngx_devel_kit，lua-nginx-module等安装文件:</p>\n<ul>\n<li><a href=\"http://nginx.org/en/download.html\" target=\"_blank\" rel=\"external\">Nginx</a></li>\n<li><a href=\"http://luajit.org/download.html\" target=\"_blank\" rel=\"external\">LuaJIT</a> Lua或者LuaJIT都是可以的，但是出于性能的考虑，推荐安装LuaJIT</li>\n<li><a href=\"https://github.com/simpl/ngx_devel_kit/tags\" target=\"_blank\" rel=\"external\">ngx_devel_kit</a></li>\n<li><a href=\"https://github.com/openresty/lua-nginx-module/tags\" target=\"_blank\" rel=\"external\">lua-nginx-module</a></li>\n</ul>\n<p>参考命令下载：</p>\n<blockquote>\n<p>$ curl -O <a href=\"http://nginx.org/download/nginx-1.10.1.tar.gz\" target=\"_blank\" rel=\"external\">http://nginx.org/download/nginx-1.10.1.tar.gz</a></p>\n<p>$ curl -O <a href=\"http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz\" target=\"_blank\" rel=\"external\">http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz</a></p>\n<p>$ curl -L -O <a href=\"https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz\" target=\"_blank\" rel=\"external\">https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz</a></p>\n<p>$ curl -L -O <a href=\"https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz\" target=\"_blank\" rel=\"external\">https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz</a> </p>\n</blockquote>\n<h2 id=\"安装LuaJIT\"><a href=\"#安装LuaJIT\" class=\"headerlink\" title=\"安装LuaJIT\"></a>安装LuaJIT</h2><blockquote>\n<p>$ wget <a href=\"http://luajit.org/download/LuaJIT-\" target=\"_blank\" rel=\"external\">http://luajit.org/download/LuaJIT-</a><version>.tar.gz</version></p>\n<p>$ tar zxvf LuaJIT-<version>.tar.gz</version></p>\n<p>$ cd LuaJIT-<version></version></p>\n<p>$ make</p>\n<p>$ sudo make install</p>\n</blockquote>\n<h2 id=\"编译安装lua-nginx-module\"><a href=\"#编译安装lua-nginx-module\" class=\"headerlink\" title=\"编译安装lua-nginx-module\"></a>编译安装lua-nginx-module</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">export LUAJIT_LIB=/usr/local/lib</div><div class=\"line\">export LUAJIT_INC=/usr/local/include/luajit-2.1</div><div class=\"line\"></div><div class=\"line\">cd nginx-1.10.1</div><div class=\"line\">./configure --prefix=/opt/nginx  --with-ld-opt=&quot;-Wl,-rpath,/usr/local/lib&quot;  --add-module=/path/to/ngx_devel_kit-0.3.0  --add-module=/path/to/nginx/lua-nginx-module-0.10.5</div><div class=\"line\">make</div><div class=\"line\">make install</div></pre></td></tr></table></figure>\n<h2 id=\"动态module方式\"><a href=\"#动态module方式\" class=\"headerlink\" title=\"动态module方式\"></a>动态module方式</h2><p>Nginx 1.9.11 开始可以编译module为一个动态module，在执行./configure命令时用–add-dynamic-module=PATH替换–add-module=PATH。编译后可以在nginx.conf配置中使用 load_module 来动态加载这个module：</p>\n<blockquote>\n<p>load_module /path/to/modules/ndk_http_module.so;</p>\n<p>load_module /path/to/modules/ngx_http_lua_module.so;</p>\n</blockquote>\n<h2 id=\"lua-cjson-install\"><a href=\"#lua-cjson-install\" class=\"headerlink\" title=\"lua cjson install\"></a>lua cjson install</h2><p>Eureka Zuul 网关<br>  安装编译cjson需要lua运行时，编译前需要修改MakeFile中的LUA_VERSION、LUA_INCLUDE_DIR、LUA_CMODULE_DIR参数，让cjson模块知道lua库文件和头文件目录，才可以正常编译安装。</p>\n<p>下载解压：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz</div><div class=\"line\">tar -zxvf cjson-2.1.0.tar.gz</div><div class=\"line\">cd cjson-2.1.0</div></pre></td></tr></table></figure>\n<p>修改MakeFile：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">LUA_VERSION =  luajit-2.1</div><div class=\"line\">LUA_INCLUDE_DIR =   $(PREFIX)/include/$(LUA_VERSION)</div><div class=\"line\">LUA_CMODULE_DIR =   $(PREFIX)/lib</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">make &amp; sudo make install</div><div class=\"line\">sudo cp cjson.so /usr/local/lib/lua/5.1/</div></pre></td></tr></table></figure>\n"},{"title":"Matthew Lien-Bleeding Wolves","thumbnail":"http://ftp.ytbbs.com/attachments/forum/day_081028/20081028_ae33dbbe16d4417e2b55GlDpalRfZsm4.jpg","date":"2016-02-22T05:22:54.000Z","keywords":null,"description":null,"_content":"\n\n \n<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=330 height=450 src=\"http://music.163.com/outchain/player?type=1&id=172149&auto=1&height=430\"></iframe>\n\n ","source":"_posts/music/Matthew-Lien-Bleeding-Wolves.md","raw":"---\ntitle: Matthew Lien-Bleeding Wolves\nthumbnail: 'http://ftp.ytbbs.com/attachments/forum/day_081028/20081028_ae33dbbe16d4417e2b55GlDpalRfZsm4.jpg'\ndate: 2016-02-22 13:22:54\ncategories: music\ntags:\nkeywords:\ndescription:\n---\n\n\n \n<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=330 height=450 src=\"http://music.163.com/outchain/player?type=1&id=172149&auto=1&height=430\"></iframe>\n\n ","slug":"music/Matthew-Lien-Bleeding-Wolves","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0k001lz29krd4yp2kx","content":"<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=\"330\" height=\"450\" src=\"http://music.163.com/outchain/player?type=1&id=172149&auto=1&height=430\"></iframe>\n\n","site":{"data":{}},"excerpt":"","more":"<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=\"330\" height=\"450\" src=\"http://music.163.com/outchain/player?type=1&id=172149&auto=1&height=430\"></iframe>\n\n"},{"title":"Feign正确的使用方法和性能优化注意事项","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/P60724-115835.jpg","date":"2016-09-06T11:22:47.000Z","keywords":["Feign","微服务","Spring Cloud"],"description":null,"_content":"\n## Feign正确的使用方法和性能优化注意事项\n\n### 1. feign自定义Configuration和root 容器有效隔离。\n\n- 用@Configuration注解\n- 不能在主@ComponentScan (or @SpringBootApplication)范围内，从其包名上分离\n- 注意避免包扫描重叠，最好的方法是明确的指定包名\n\n### 2. Spring Cloud Netflix 提供了默认的Bean类型:\n\n* Decoder feignDecoder: ResponseEntityDecoder (which wraps a SpringDecoder)\n* Encoder feignEncoder: SpringEncoder\n* Logger feignLogger: Slf4jLogger\n* Contract feignContract: SpringMvcContract\n* Feign.Builder feignBuilder: HystrixFeign.Builder\n\n### 3. Spring Cloud Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\n\n* Logger.Level\n* Retryer\n* ErrorDecoder\n* Request.Options\n* Collection<RequestInterceptor>\n\n### 4. 自定义feign的消息编码解码器：\n\t\n不要在如下代码中getObject方法内new 对象，外部会频繁调用getObject方法。\n\t\n```java\n\tObjectFactory<HttpMessageConverters> messageConvertersObjectFactory = new ObjectFactory<HttpMessageConverters>() {\n\t@Override\n\tpublic HttpMessageConverters getObject() throws BeansException {\n\t\treturn httpMessageConverters;\n\t}\n\t};\n```\n\n### 5. 注意测试环境和生产环境，注意正确使用feign日志级别。\n\n### 6. apacheHttpclient或者其他client的正确配置：\n\t\n- apacheHttpclient自定义配置放在spring root context，不要在FeignContext，否则不会起作用。\n- apacheHttpclient 连接池配置合理地连接和其他参数\n\n### 7. Feign配置\n\n```properties\n#Hystrix支持，如果为true，hystrix库必须在classpath中\nfeign.hystrix.enabled=false\n \n#请求和响应GZIP压缩支持\nfeign.compression.request.enabled=true\nfeign.compression.response.enabled=true\n#支持压缩的mime types\nfeign.compression.request.enabled=true\nfeign.compression.request.mime-types=text/xml,application/xml,application/json\nfeign.compression.request.min-request-size=2048\n\n# 日志支持\nlogging.level.project.user.UserClient: DEBUG\n\t\n\n```\n\n### 8. Logger.Level支持\n\n必须为每一个Feign Client配置来告诉Feign如何输出日志，可选：\n\t\n* **NONE**, No logging (**DEFAULT**).\n* **BASIC**,  Log only the request method and URL and the response status code and execution time.\n* **HEADERS**, Log the basic information along with request and response headers.\n* **FULL**, Log the headers, body, and metadata for both requests and responses.\n\n### 9. FeignClient.fallback 正确的使用方法\n\n 配置的fallback class也必须在FeignClient Configuration中实例化，否则会报\n` java.lang.IllegalStateException: No fallback instance of type class `异常。\n\n例子：\n\n```java\n\t@FeignClient(name = \"hello\", fallback = HystrixClientFallback.class)\n\tpublic interface HystrixClient {\n\t    @RequestMapping(method = RequestMethod.GET, value = \"/hello\")\n\t    Hello iFailSometimes();\n\t}\n\t\n\tpublic class HystrixClientFallback implements HystrixClient {\n\t    @Override\n\t    public Hello iFailSometimes() {\n\t        return new Hello(\"fallback\");\n\t    }\n\t}\n\t\n\t@Configuration\n\tpublic class FooConfiguration {\n\t    @Bean\n\t\t@Scope(\"prototype\")\n\t\tpublic Feign.Builder feignBuilder() {\n\t\t\treturn Feign.builder();\n\t\t}\n\t\t\n\t\t@Bean\n\t\tpublic HystrixClientFallback fb(){\n\t\t\treturn new HystrixClientFallback();\n\t\t}\n\t\t\n\t}\n\t\n```\n\n### 10. 使用Feign Client 和@RequestMapping时，注意事项\n \n \n当前工程中有和Feign Client中一样的Endpoint时，Feign Client的类上不能用@RequestMapping注解否则，当前工程该endpoint http请求且使用accpet时会报404.\n  \n \n下面的例子：\n \n\n**有一个 Controller**\n\n```java\n@RestController\n@RequestMapping(\"/v1/card\")\npublic class IndexApi {\n\n    @PostMapping(\"balance\")\n    @ResponseBody\n    public Info index() {\n        Info.Builder builder = new Info.Builder();\n        builder.withDetail(\"x\", 2);\n        builder.withDetail(\"y\", 2);\n        return builder.build();\n    }\n}\n\n```\n\n**有一个Feign Client**\n\n```java\n@FeignClient(\n        name = \"card\",\n        url = \"http://localhost:7913\",\n        fallback = CardFeignClientFallback.class,\n        configuration = FeignClientConfiguration.class\n)\n@RequestMapping(value = \"/v1/card\")\npublic interface CardFeignClient {\n\n    @RequestMapping(value = \"/balance\", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)\n    Info info();\n\n}\n```\n\nif @RequestMapping is used on class, when invoke http /v1/card/balance, like this :\n\n如果 @RequestMapping注解被用在FeignClient类上，当像如下代码请求/v1/card/balance时，注意有Accept header：\n\n```yaml\nContent-Type: application/json\nAccept: application/json\n\nPOST http://localhost:7913/v1/card/balance\n```\n\n\n那么会返回 404。\n\n**如果不包含Accept header时请求，则是OK：**\n\n```\nContent-Type:application/json\nPOST http://localhost:7913/v1/card/balance\n```\n\n\n**或者像下面不在Feign Client上使用@RequestMapping注解,请求也是ok，无论是否包含Accept:**\n\n```java\n\n@FeignClient(\n        name = \"card\",\n        url = \"http://localhost:7913\",\n        fallback = CardFeignClientFallback.class,\n        configuration = FeignClientConfiguration.class\n)\n\npublic interface CardFeignClient {\n\n    @RequestMapping(value = \"/v1/card/balance\", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)\n    Info info();\n\n}\n\n```\n \n\n\n\n ","source":"_posts/微服务/Feign使用性能优化.md","raw":"---\ntitle: Feign正确的使用方法和性能优化注意事项\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/P60724-115835.jpg'\ndate: 2016-09-06 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- Feign\n\t- 微服务\n\t- Spring Cloud\nkeywords:\n\t- Feign\n\t- 微服务\n\t- Spring Cloud\ndescription:\n---\n\n## Feign正确的使用方法和性能优化注意事项\n\n### 1. feign自定义Configuration和root 容器有效隔离。\n\n- 用@Configuration注解\n- 不能在主@ComponentScan (or @SpringBootApplication)范围内，从其包名上分离\n- 注意避免包扫描重叠，最好的方法是明确的指定包名\n\n### 2. Spring Cloud Netflix 提供了默认的Bean类型:\n\n* Decoder feignDecoder: ResponseEntityDecoder (which wraps a SpringDecoder)\n* Encoder feignEncoder: SpringEncoder\n* Logger feignLogger: Slf4jLogger\n* Contract feignContract: SpringMvcContract\n* Feign.Builder feignBuilder: HystrixFeign.Builder\n\n### 3. Spring Cloud Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\n\n* Logger.Level\n* Retryer\n* ErrorDecoder\n* Request.Options\n* Collection<RequestInterceptor>\n\n### 4. 自定义feign的消息编码解码器：\n\t\n不要在如下代码中getObject方法内new 对象，外部会频繁调用getObject方法。\n\t\n```java\n\tObjectFactory<HttpMessageConverters> messageConvertersObjectFactory = new ObjectFactory<HttpMessageConverters>() {\n\t@Override\n\tpublic HttpMessageConverters getObject() throws BeansException {\n\t\treturn httpMessageConverters;\n\t}\n\t};\n```\n\n### 5. 注意测试环境和生产环境，注意正确使用feign日志级别。\n\n### 6. apacheHttpclient或者其他client的正确配置：\n\t\n- apacheHttpclient自定义配置放在spring root context，不要在FeignContext，否则不会起作用。\n- apacheHttpclient 连接池配置合理地连接和其他参数\n\n### 7. Feign配置\n\n```properties\n#Hystrix支持，如果为true，hystrix库必须在classpath中\nfeign.hystrix.enabled=false\n \n#请求和响应GZIP压缩支持\nfeign.compression.request.enabled=true\nfeign.compression.response.enabled=true\n#支持压缩的mime types\nfeign.compression.request.enabled=true\nfeign.compression.request.mime-types=text/xml,application/xml,application/json\nfeign.compression.request.min-request-size=2048\n\n# 日志支持\nlogging.level.project.user.UserClient: DEBUG\n\t\n\n```\n\n### 8. Logger.Level支持\n\n必须为每一个Feign Client配置来告诉Feign如何输出日志，可选：\n\t\n* **NONE**, No logging (**DEFAULT**).\n* **BASIC**,  Log only the request method and URL and the response status code and execution time.\n* **HEADERS**, Log the basic information along with request and response headers.\n* **FULL**, Log the headers, body, and metadata for both requests and responses.\n\n### 9. FeignClient.fallback 正确的使用方法\n\n 配置的fallback class也必须在FeignClient Configuration中实例化，否则会报\n` java.lang.IllegalStateException: No fallback instance of type class `异常。\n\n例子：\n\n```java\n\t@FeignClient(name = \"hello\", fallback = HystrixClientFallback.class)\n\tpublic interface HystrixClient {\n\t    @RequestMapping(method = RequestMethod.GET, value = \"/hello\")\n\t    Hello iFailSometimes();\n\t}\n\t\n\tpublic class HystrixClientFallback implements HystrixClient {\n\t    @Override\n\t    public Hello iFailSometimes() {\n\t        return new Hello(\"fallback\");\n\t    }\n\t}\n\t\n\t@Configuration\n\tpublic class FooConfiguration {\n\t    @Bean\n\t\t@Scope(\"prototype\")\n\t\tpublic Feign.Builder feignBuilder() {\n\t\t\treturn Feign.builder();\n\t\t}\n\t\t\n\t\t@Bean\n\t\tpublic HystrixClientFallback fb(){\n\t\t\treturn new HystrixClientFallback();\n\t\t}\n\t\t\n\t}\n\t\n```\n\n### 10. 使用Feign Client 和@RequestMapping时，注意事项\n \n \n当前工程中有和Feign Client中一样的Endpoint时，Feign Client的类上不能用@RequestMapping注解否则，当前工程该endpoint http请求且使用accpet时会报404.\n  \n \n下面的例子：\n \n\n**有一个 Controller**\n\n```java\n@RestController\n@RequestMapping(\"/v1/card\")\npublic class IndexApi {\n\n    @PostMapping(\"balance\")\n    @ResponseBody\n    public Info index() {\n        Info.Builder builder = new Info.Builder();\n        builder.withDetail(\"x\", 2);\n        builder.withDetail(\"y\", 2);\n        return builder.build();\n    }\n}\n\n```\n\n**有一个Feign Client**\n\n```java\n@FeignClient(\n        name = \"card\",\n        url = \"http://localhost:7913\",\n        fallback = CardFeignClientFallback.class,\n        configuration = FeignClientConfiguration.class\n)\n@RequestMapping(value = \"/v1/card\")\npublic interface CardFeignClient {\n\n    @RequestMapping(value = \"/balance\", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)\n    Info info();\n\n}\n```\n\nif @RequestMapping is used on class, when invoke http /v1/card/balance, like this :\n\n如果 @RequestMapping注解被用在FeignClient类上，当像如下代码请求/v1/card/balance时，注意有Accept header：\n\n```yaml\nContent-Type: application/json\nAccept: application/json\n\nPOST http://localhost:7913/v1/card/balance\n```\n\n\n那么会返回 404。\n\n**如果不包含Accept header时请求，则是OK：**\n\n```\nContent-Type:application/json\nPOST http://localhost:7913/v1/card/balance\n```\n\n\n**或者像下面不在Feign Client上使用@RequestMapping注解,请求也是ok，无论是否包含Accept:**\n\n```java\n\n@FeignClient(\n        name = \"card\",\n        url = \"http://localhost:7913\",\n        fallback = CardFeignClientFallback.class,\n        configuration = FeignClientConfiguration.class\n)\n\npublic interface CardFeignClient {\n\n    @RequestMapping(value = \"/v1/card/balance\", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)\n    Info info();\n\n}\n\n```\n \n\n\n\n ","slug":"微服务/Feign使用性能优化","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0m001oz29k8l23ku73","content":"<h2 id=\"Feign正确的使用方法和性能优化注意事项\"><a href=\"#Feign正确的使用方法和性能优化注意事项\" class=\"headerlink\" title=\"Feign正确的使用方法和性能优化注意事项\"></a>Feign正确的使用方法和性能优化注意事项</h2><h3 id=\"1-feign自定义Configuration和root-容器有效隔离。\"><a href=\"#1-feign自定义Configuration和root-容器有效隔离。\" class=\"headerlink\" title=\"1. feign自定义Configuration和root 容器有效隔离。\"></a>1. feign自定义Configuration和root 容器有效隔离。</h3><ul>\n<li>用@Configuration注解</li>\n<li>不能在主@ComponentScan (or @SpringBootApplication)范围内，从其包名上分离</li>\n<li>注意避免包扫描重叠，最好的方法是明确的指定包名</li>\n</ul>\n<h3 id=\"2-Spring-Cloud-Netflix-提供了默认的Bean类型\"><a href=\"#2-Spring-Cloud-Netflix-提供了默认的Bean类型\" class=\"headerlink\" title=\"2. Spring Cloud Netflix 提供了默认的Bean类型:\"></a>2. Spring Cloud Netflix 提供了默认的Bean类型:</h3><ul>\n<li>Decoder feignDecoder: ResponseEntityDecoder (which wraps a SpringDecoder)</li>\n<li>Encoder feignEncoder: SpringEncoder</li>\n<li>Logger feignLogger: Slf4jLogger</li>\n<li>Contract feignContract: SpringMvcContract</li>\n<li>Feign.Builder feignBuilder: HystrixFeign.Builder</li>\n</ul>\n<h3 id=\"3-Spring-Cloud-Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\"><a href=\"#3-Spring-Cloud-Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\" class=\"headerlink\" title=\"3. Spring Cloud Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\"></a>3. Spring Cloud Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：</h3><ul>\n<li>Logger.Level</li>\n<li>Retryer</li>\n<li>ErrorDecoder</li>\n<li>Request.Options</li>\n<li>Collection<requestinterceptor></requestinterceptor></li>\n</ul>\n<h3 id=\"4-自定义feign的消息编码解码器：\"><a href=\"#4-自定义feign的消息编码解码器：\" class=\"headerlink\" title=\"4. 自定义feign的消息编码解码器：\"></a>4. 自定义feign的消息编码解码器：</h3><p>不要在如下代码中getObject方法内new 对象，外部会频繁调用getObject方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">ObjectFactory&lt;HttpMessageConverters&gt; messageConvertersObjectFactory = <span class=\"keyword\">new</span> ObjectFactory&lt;HttpMessageConverters&gt;() &#123;</div><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> HttpMessageConverters <span class=\"title\">getObject</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">return</span> httpMessageConverters;</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<h3 id=\"5-注意测试环境和生产环境，注意正确使用feign日志级别。\"><a href=\"#5-注意测试环境和生产环境，注意正确使用feign日志级别。\" class=\"headerlink\" title=\"5. 注意测试环境和生产环境，注意正确使用feign日志级别。\"></a>5. 注意测试环境和生产环境，注意正确使用feign日志级别。</h3><h3 id=\"6-apacheHttpclient或者其他client的正确配置：\"><a href=\"#6-apacheHttpclient或者其他client的正确配置：\" class=\"headerlink\" title=\"6. apacheHttpclient或者其他client的正确配置：\"></a>6. apacheHttpclient或者其他client的正确配置：</h3><ul>\n<li>apacheHttpclient自定义配置放在spring root context，不要在FeignContext，否则不会起作用。</li>\n<li>apacheHttpclient 连接池配置合理地连接和其他参数</li>\n</ul>\n<h3 id=\"7-Feign配置\"><a href=\"#7-Feign配置\" class=\"headerlink\" title=\"7. Feign配置\"></a>7. Feign配置</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">#Hystrix支持，如果为true，hystrix库必须在classpath中</div><div class=\"line\">feign.hystrix.enabled=false</div><div class=\"line\"> </div><div class=\"line\">#请求和响应GZIP压缩支持</div><div class=\"line\">feign.compression.request.enabled=true</div><div class=\"line\">feign.compression.response.enabled=true</div><div class=\"line\">#支持压缩的mime types</div><div class=\"line\">feign.compression.request.enabled=true</div><div class=\"line\">feign.compression.request.mime-types=text/xml,application/xml,application/json</div><div class=\"line\">feign.compression.request.min-request-size=2048</div><div class=\"line\"></div><div class=\"line\"># 日志支持</div><div class=\"line\">logging.level.project.user.UserClient: DEBUG</div></pre></td></tr></table></figure>\n<h3 id=\"8-Logger-Level支持\"><a href=\"#8-Logger-Level支持\" class=\"headerlink\" title=\"8. Logger.Level支持\"></a>8. Logger.Level支持</h3><p>必须为每一个Feign Client配置来告诉Feign如何输出日志，可选：</p>\n<ul>\n<li><strong>NONE</strong>, No logging (<strong>DEFAULT</strong>).</li>\n<li><strong>BASIC</strong>,  Log only the request method and URL and the response status code and execution time.</li>\n<li><strong>HEADERS</strong>, Log the basic information along with request and response headers.</li>\n<li><strong>FULL</strong>, Log the headers, body, and metadata for both requests and responses.</li>\n</ul>\n<h3 id=\"9-FeignClient-fallback-正确的使用方法\"><a href=\"#9-FeignClient-fallback-正确的使用方法\" class=\"headerlink\" title=\"9. FeignClient.fallback 正确的使用方法\"></a>9. FeignClient.fallback 正确的使用方法</h3><p> 配置的fallback class也必须在FeignClient Configuration中实例化，否则会报<br><code>java.lang.IllegalStateException: No fallback instance of type class</code>异常。</p>\n<p>例子：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@FeignClient</span>(name = <span class=\"string\">\"hello\"</span>, fallback = HystrixClientFallback.class)</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">HystrixClient</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@RequestMapping</span>(method = RequestMethod.GET, value = <span class=\"string\">\"/hello\"</span>)</div><div class=\"line\">    <span class=\"function\">Hello <span class=\"title\">iFailSometimes</span><span class=\"params\">()</span></span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HystrixClientFallback</span> <span class=\"keyword\">implements</span> <span class=\"title\">HystrixClient</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Hello <span class=\"title\">iFailSometimes</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Hello(<span class=\"string\">\"fallback\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">@Configuration</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FooConfiguration</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@Bean</span></div><div class=\"line\">\t<span class=\"meta\">@Scope</span>(<span class=\"string\">\"prototype\"</span>)</div><div class=\"line\">\t<span class=\"keyword\">public</span> Feign.<span class=\"function\">Builder <span class=\"title\">feignBuilder</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> Feign.builder();</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t</div><div class=\"line\">\t<span class=\"meta\">@Bean</span></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> HystrixClientFallback <span class=\"title\">fb</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> HystrixClientFallback();</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"10-使用Feign-Client-和-RequestMapping时，注意事项\"><a href=\"#10-使用Feign-Client-和-RequestMapping时，注意事项\" class=\"headerlink\" title=\"10. 使用Feign Client 和@RequestMapping时，注意事项\"></a>10. 使用Feign Client 和@RequestMapping时，注意事项</h3><p>当前工程中有和Feign Client中一样的Endpoint时，Feign Client的类上不能用@RequestMapping注解否则，当前工程该endpoint http请求且使用accpet时会报404.</p>\n<p>下面的例子：</p>\n<p><strong>有一个 Controller</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@RestController</span></div><div class=\"line\"><span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/v1/card\"</span>)</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">IndexApi</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@PostMapping</span>(<span class=\"string\">\"balance\"</span>)</div><div class=\"line\">    <span class=\"meta\">@ResponseBody</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Info <span class=\"title\">index</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        Info.Builder builder = <span class=\"keyword\">new</span> Info.Builder();</div><div class=\"line\">        builder.withDetail(<span class=\"string\">\"x\"</span>, <span class=\"number\">2</span>);</div><div class=\"line\">        builder.withDetail(<span class=\"string\">\"y\"</span>, <span class=\"number\">2</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> builder.build();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p><strong>有一个Feign Client</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@FeignClient</span>(</div><div class=\"line\">        name = <span class=\"string\">\"card\"</span>,</div><div class=\"line\">        url = <span class=\"string\">\"http://localhost:7913\"</span>,</div><div class=\"line\">        fallback = CardFeignClientFallback.class,</div><div class=\"line\">        configuration = FeignClientConfiguration.class</div><div class=\"line\">)</div><div class=\"line\"><span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/v1/card\"</span>)</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CardFeignClient</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/balance\"</span>, method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class=\"line\">    <span class=\"function\">Info <span class=\"title\">info</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>if @RequestMapping is used on class, when invoke http /v1/card/balance, like this :</p>\n<p>如果 @RequestMapping注解被用在FeignClient类上，当像如下代码请求/v1/card/balance时，注意有Accept header：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">Content-Type:</span> <span class=\"string\">application/json</span></div><div class=\"line\"><span class=\"attr\">Accept:</span> <span class=\"string\">application/json</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">POST</span> <span class=\"attr\">http://localhost:7913/v1/card/balance</span></div></pre></td></tr></table></figure>\n<p>那么会返回 404。</p>\n<p><strong>如果不包含Accept header时请求，则是OK：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type:application/json</div><div class=\"line\">POST http://localhost:7913/v1/card/balance</div></pre></td></tr></table></figure>\n<p><strong>或者像下面不在Feign Client上使用@RequestMapping注解,请求也是ok，无论是否包含Accept:</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">@FeignClient</span>(</div><div class=\"line\">        name = <span class=\"string\">\"card\"</span>,</div><div class=\"line\">        url = <span class=\"string\">\"http://localhost:7913\"</span>,</div><div class=\"line\">        fallback = CardFeignClientFallback.class,</div><div class=\"line\">        configuration = FeignClientConfiguration.class</div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CardFeignClient</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/v1/card/balance\"</span>, method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class=\"line\">    <span class=\"function\">Info <span class=\"title\">info</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Feign正确的使用方法和性能优化注意事项\"><a href=\"#Feign正确的使用方法和性能优化注意事项\" class=\"headerlink\" title=\"Feign正确的使用方法和性能优化注意事项\"></a>Feign正确的使用方法和性能优化注意事项</h2><h3 id=\"1-feign自定义Configuration和root-容器有效隔离。\"><a href=\"#1-feign自定义Configuration和root-容器有效隔离。\" class=\"headerlink\" title=\"1. feign自定义Configuration和root 容器有效隔离。\"></a>1. feign自定义Configuration和root 容器有效隔离。</h3><ul>\n<li>用@Configuration注解</li>\n<li>不能在主@ComponentScan (or @SpringBootApplication)范围内，从其包名上分离</li>\n<li>注意避免包扫描重叠，最好的方法是明确的指定包名</li>\n</ul>\n<h3 id=\"2-Spring-Cloud-Netflix-提供了默认的Bean类型\"><a href=\"#2-Spring-Cloud-Netflix-提供了默认的Bean类型\" class=\"headerlink\" title=\"2. Spring Cloud Netflix 提供了默认的Bean类型:\"></a>2. Spring Cloud Netflix 提供了默认的Bean类型:</h3><ul>\n<li>Decoder feignDecoder: ResponseEntityDecoder (which wraps a SpringDecoder)</li>\n<li>Encoder feignEncoder: SpringEncoder</li>\n<li>Logger feignLogger: Slf4jLogger</li>\n<li>Contract feignContract: SpringMvcContract</li>\n<li>Feign.Builder feignBuilder: HystrixFeign.Builder</li>\n</ul>\n<h3 id=\"3-Spring-Cloud-Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\"><a href=\"#3-Spring-Cloud-Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\" class=\"headerlink\" title=\"3. Spring Cloud Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：\"></a>3. Spring Cloud Netflix没有提供默认值，但仍然可以在feign上下文配置中创建：</h3><ul>\n<li>Logger.Level</li>\n<li>Retryer</li>\n<li>ErrorDecoder</li>\n<li>Request.Options</li>\n<li>Collection<requestinterceptor></requestinterceptor></li>\n</ul>\n<h3 id=\"4-自定义feign的消息编码解码器：\"><a href=\"#4-自定义feign的消息编码解码器：\" class=\"headerlink\" title=\"4. 自定义feign的消息编码解码器：\"></a>4. 自定义feign的消息编码解码器：</h3><p>不要在如下代码中getObject方法内new 对象，外部会频繁调用getObject方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">ObjectFactory&lt;HttpMessageConverters&gt; messageConvertersObjectFactory = <span class=\"keyword\">new</span> ObjectFactory&lt;HttpMessageConverters&gt;() &#123;</div><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> HttpMessageConverters <span class=\"title\">getObject</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">return</span> httpMessageConverters;</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<h3 id=\"5-注意测试环境和生产环境，注意正确使用feign日志级别。\"><a href=\"#5-注意测试环境和生产环境，注意正确使用feign日志级别。\" class=\"headerlink\" title=\"5. 注意测试环境和生产环境，注意正确使用feign日志级别。\"></a>5. 注意测试环境和生产环境，注意正确使用feign日志级别。</h3><h3 id=\"6-apacheHttpclient或者其他client的正确配置：\"><a href=\"#6-apacheHttpclient或者其他client的正确配置：\" class=\"headerlink\" title=\"6. apacheHttpclient或者其他client的正确配置：\"></a>6. apacheHttpclient或者其他client的正确配置：</h3><ul>\n<li>apacheHttpclient自定义配置放在spring root context，不要在FeignContext，否则不会起作用。</li>\n<li>apacheHttpclient 连接池配置合理地连接和其他参数</li>\n</ul>\n<h3 id=\"7-Feign配置\"><a href=\"#7-Feign配置\" class=\"headerlink\" title=\"7. Feign配置\"></a>7. Feign配置</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">#Hystrix支持，如果为true，hystrix库必须在classpath中</div><div class=\"line\">feign.hystrix.enabled=false</div><div class=\"line\"> </div><div class=\"line\">#请求和响应GZIP压缩支持</div><div class=\"line\">feign.compression.request.enabled=true</div><div class=\"line\">feign.compression.response.enabled=true</div><div class=\"line\">#支持压缩的mime types</div><div class=\"line\">feign.compression.request.enabled=true</div><div class=\"line\">feign.compression.request.mime-types=text/xml,application/xml,application/json</div><div class=\"line\">feign.compression.request.min-request-size=2048</div><div class=\"line\"></div><div class=\"line\"># 日志支持</div><div class=\"line\">logging.level.project.user.UserClient: DEBUG</div></pre></td></tr></table></figure>\n<h3 id=\"8-Logger-Level支持\"><a href=\"#8-Logger-Level支持\" class=\"headerlink\" title=\"8. Logger.Level支持\"></a>8. Logger.Level支持</h3><p>必须为每一个Feign Client配置来告诉Feign如何输出日志，可选：</p>\n<ul>\n<li><strong>NONE</strong>, No logging (<strong>DEFAULT</strong>).</li>\n<li><strong>BASIC</strong>,  Log only the request method and URL and the response status code and execution time.</li>\n<li><strong>HEADERS</strong>, Log the basic information along with request and response headers.</li>\n<li><strong>FULL</strong>, Log the headers, body, and metadata for both requests and responses.</li>\n</ul>\n<h3 id=\"9-FeignClient-fallback-正确的使用方法\"><a href=\"#9-FeignClient-fallback-正确的使用方法\" class=\"headerlink\" title=\"9. FeignClient.fallback 正确的使用方法\"></a>9. FeignClient.fallback 正确的使用方法</h3><p> 配置的fallback class也必须在FeignClient Configuration中实例化，否则会报<br><code>java.lang.IllegalStateException: No fallback instance of type class</code>异常。</p>\n<p>例子：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@FeignClient</span>(name = <span class=\"string\">\"hello\"</span>, fallback = HystrixClientFallback.class)</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">HystrixClient</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@RequestMapping</span>(method = RequestMethod.GET, value = <span class=\"string\">\"/hello\"</span>)</div><div class=\"line\">    <span class=\"function\">Hello <span class=\"title\">iFailSometimes</span><span class=\"params\">()</span></span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HystrixClientFallback</span> <span class=\"keyword\">implements</span> <span class=\"title\">HystrixClient</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Hello <span class=\"title\">iFailSometimes</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Hello(<span class=\"string\">\"fallback\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">@Configuration</span></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FooConfiguration</span> </span>&#123;</div><div class=\"line\">    <span class=\"meta\">@Bean</span></div><div class=\"line\">\t<span class=\"meta\">@Scope</span>(<span class=\"string\">\"prototype\"</span>)</div><div class=\"line\">\t<span class=\"keyword\">public</span> Feign.<span class=\"function\">Builder <span class=\"title\">feignBuilder</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> Feign.builder();</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t</div><div class=\"line\">\t<span class=\"meta\">@Bean</span></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> HystrixClientFallback <span class=\"title\">fb</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> HystrixClientFallback();</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"10-使用Feign-Client-和-RequestMapping时，注意事项\"><a href=\"#10-使用Feign-Client-和-RequestMapping时，注意事项\" class=\"headerlink\" title=\"10. 使用Feign Client 和@RequestMapping时，注意事项\"></a>10. 使用Feign Client 和@RequestMapping时，注意事项</h3><p>当前工程中有和Feign Client中一样的Endpoint时，Feign Client的类上不能用@RequestMapping注解否则，当前工程该endpoint http请求且使用accpet时会报404.</p>\n<p>下面的例子：</p>\n<p><strong>有一个 Controller</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@RestController</span></div><div class=\"line\"><span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/v1/card\"</span>)</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">IndexApi</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@PostMapping</span>(<span class=\"string\">\"balance\"</span>)</div><div class=\"line\">    <span class=\"meta\">@ResponseBody</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Info <span class=\"title\">index</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        Info.Builder builder = <span class=\"keyword\">new</span> Info.Builder();</div><div class=\"line\">        builder.withDetail(<span class=\"string\">\"x\"</span>, <span class=\"number\">2</span>);</div><div class=\"line\">        builder.withDetail(<span class=\"string\">\"y\"</span>, <span class=\"number\">2</span>);</div><div class=\"line\">        <span class=\"keyword\">return</span> builder.build();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p><strong>有一个Feign Client</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@FeignClient</span>(</div><div class=\"line\">        name = <span class=\"string\">\"card\"</span>,</div><div class=\"line\">        url = <span class=\"string\">\"http://localhost:7913\"</span>,</div><div class=\"line\">        fallback = CardFeignClientFallback.class,</div><div class=\"line\">        configuration = FeignClientConfiguration.class</div><div class=\"line\">)</div><div class=\"line\"><span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/v1/card\"</span>)</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CardFeignClient</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/balance\"</span>, method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class=\"line\">    <span class=\"function\">Info <span class=\"title\">info</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>if @RequestMapping is used on class, when invoke http /v1/card/balance, like this :</p>\n<p>如果 @RequestMapping注解被用在FeignClient类上，当像如下代码请求/v1/card/balance时，注意有Accept header：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">Content-Type:</span> <span class=\"string\">application/json</span></div><div class=\"line\"><span class=\"attr\">Accept:</span> <span class=\"string\">application/json</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"string\">POST</span> <span class=\"attr\">http://localhost:7913/v1/card/balance</span></div></pre></td></tr></table></figure>\n<p>那么会返回 404。</p>\n<p><strong>如果不包含Accept header时请求，则是OK：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type:application/json</div><div class=\"line\">POST http://localhost:7913/v1/card/balance</div></pre></td></tr></table></figure>\n<p><strong>或者像下面不在Feign Client上使用@RequestMapping注解,请求也是ok，无论是否包含Accept:</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">@FeignClient</span>(</div><div class=\"line\">        name = <span class=\"string\">\"card\"</span>,</div><div class=\"line\">        url = <span class=\"string\">\"http://localhost:7913\"</span>,</div><div class=\"line\">        fallback = CardFeignClientFallback.class,</div><div class=\"line\">        configuration = FeignClientConfiguration.class</div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">CardFeignClient</span> </span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/v1/card/balance\"</span>, method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class=\"line\">    <span class=\"function\">Info <span class=\"title\">info</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n"},{"title":"微服务之API网关设计","thumbnail":"images/m1.jpg","date":"2016-09-08T11:22:47.000Z","keywords":["微服务","Spring Cloud","Spring Boot","API Gateway","网关"],"description":null,"_content":"\n\n![P60528-094513-01.jpeg](http://upload-images.jianshu.io/upload_images/2519252-3f8e955deefa1708.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n微服务除了互相之间调用，还需要将API提供给外部应用访问，像浏览器，移动app，第三合作方等等，这就需要前段路由来管理后端微服务提供的服务。提供类似功能的应用有着多样化的名称，比如前置服务器/前置机、路由服务器、(反向)代理服务器，API网关服务器也是其中的一个叫法，只是场景和侧重点不一样。\n\nAPI网关，顾名思义，就是外部到内部的一道门，其主要功能：\n\n- 服务路由：将前段应用的调用请求路由定位并负载均衡到具体的后端微服务实例，对于前端应用看起来就是1个应用提供的服务，微服务对于前段应用来说就是黑盒，前段应用也不需要关心内部如何分布，由哪个微服务提供。主要有静态路由和动态路由。\n\t- 静态路由：有时候需要通过域名或者其他固定方式提供和配置路由表\n\t- 动态路由：通过服务发现服务，动态调整后端微服务的运行实例和路由表，为路由和负载均衡提供动态变化的服务注册信息。\n- 安全：统一集中的身份认证，安全控制。比如登录，签名，黑名单等等，还可以挖掘和开发更高级的安全策略。\n- 弹性：限流和容错，也是另一个层面的安全防护，防止突发的流量或者高峰流量冲击后端微服务而导致其服务不可用，另一方面可以在高峰期通过容错和降级保证核心服务的运行。\n- 监控：实时观察后端微服务的TPS、响应时间，失败数量等准确的信息。\n- 日志：记录所有请求的访问日志数据，可以为日志分析和查询提供统一支持。\n- 其他，当然还有很多需要统一集中管理的都可以在网关层解决。\n\n在Spring Cloud Netflix中使用Zuul来作为API Gateway组件，并结合Undertow，可以满足大部分性能和网关功能需求了(更高要求可以参考：https://github.com/tietang/ngx-lua-zuul)，Zuul + Undertow一般性能延迟，包括JVM和网络延迟在10%~20%，JVM延迟可以控制到10ms以内。另一方面，Zuul有强大的可定制化，通过ZuulFilter可以定制开发更多的网关功能。如下图所示：在Spring Cloud技术上，Zuul集成了Hystrix，Ribbon，Eureka Client等强大的技术栈，提供了开箱即用的Spring Cloud微服务网关功能。Zuul的强大之处是自由定制，这样对于很多老项目微服务化后，就不能按照Spring Cloud默认的动态路由规则运行，因此在其基础上定制了一些路由规则功能，更好的适应老项目微服务化。\n\n![API gateway](<http://7xiovs.com1.z0.glb.clouddn.com/API-Gateway.png>)\n\n**定制的路由规则的主要功能:**\n\n\n1. 路由表中包含源路径，微服务名称，目标路径。\n2. Endpoint粒度配置支持。\n3. 路由支持1对1精确路由。\n4. 源路径可以`前缀/**`格式来模糊路由。\n5. 目标路径可以使用`前缀/**`格式来装配目标路径。\n6. 保留默认动态路由规则：`服务名称/**` --> 是否截去前缀 --> 目标路径。\n7. 保留默认动态路由规则是否支持截去前缀的配置参数`stripPrefix`特性。\n8. 路由规则可以在不重启服务动态更新，这个功能通过外化配置来支持。\n9. 匹配股则采取谁先匹配路由谁，也就是说在路由表中有2个或以上的路由规则可能被匹配到时，匹配最先查询到的规则。\n\n**路由规则格式采用properties格式：**\n\n> 源路径 = 微服务名称, 目标路径\n\n启动时读取配置并解析，放入路由表。请求时通过查询匹配到合适的路由转发。\n\n例如：\n\n```\n/api/v1/trade=trade,/v1/trade\n/api/customer/**=customer,/api/v1/**\n/api/user/**=user\n\n```\n在上面的例子中：\n\n- /api/v1/trade会精确的路由到trade微服务的/v1/trade；\n- /api/customer/开头的api会路由转发到customer微服务的/api/v1/\\*\\*，其中后面的\\*\\*会被前面的\\*\\*部分替换，比如/api/customer/card->/api/v1/card的转换。\n- /api/user/开头的api会路由转发到user微服务的/api/user/**，endppoint不变。\n\n\n如果在Eureka Server中已经注册了微服务`payment`,那么在zuul启动后会自动添加路由规则，如果stripPrefix=false:\n\n```\n/payment/**=payment,/payment/**\n```\n如果stripPrefix=true:\n\n```\n/payment/**=payment,/payment/**\n```\n\nAPI网关通过部署多个实例来保证可用性，前端通过Nginx来负载均衡。\n","source":"_posts/微服务/微服务之API网关设计.md","raw":"---\ntitle: 微服务之API网关设计\nthumbnail: 'images/m1.jpg'\ndate: 2016-09-08 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- spring-cloud\n\t- 微服务\n\t- Spring Boot\n\t- API Gateway\n\t- 网关\nkeywords:\n\t- 微服务\n\t- Spring Cloud\n\t- Spring Boot\n\t- API Gateway\n\t- 网关\ndescription:\n---\n\n\n![P60528-094513-01.jpeg](http://upload-images.jianshu.io/upload_images/2519252-3f8e955deefa1708.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n微服务除了互相之间调用，还需要将API提供给外部应用访问，像浏览器，移动app，第三合作方等等，这就需要前段路由来管理后端微服务提供的服务。提供类似功能的应用有着多样化的名称，比如前置服务器/前置机、路由服务器、(反向)代理服务器，API网关服务器也是其中的一个叫法，只是场景和侧重点不一样。\n\nAPI网关，顾名思义，就是外部到内部的一道门，其主要功能：\n\n- 服务路由：将前段应用的调用请求路由定位并负载均衡到具体的后端微服务实例，对于前端应用看起来就是1个应用提供的服务，微服务对于前段应用来说就是黑盒，前段应用也不需要关心内部如何分布，由哪个微服务提供。主要有静态路由和动态路由。\n\t- 静态路由：有时候需要通过域名或者其他固定方式提供和配置路由表\n\t- 动态路由：通过服务发现服务，动态调整后端微服务的运行实例和路由表，为路由和负载均衡提供动态变化的服务注册信息。\n- 安全：统一集中的身份认证，安全控制。比如登录，签名，黑名单等等，还可以挖掘和开发更高级的安全策略。\n- 弹性：限流和容错，也是另一个层面的安全防护，防止突发的流量或者高峰流量冲击后端微服务而导致其服务不可用，另一方面可以在高峰期通过容错和降级保证核心服务的运行。\n- 监控：实时观察后端微服务的TPS、响应时间，失败数量等准确的信息。\n- 日志：记录所有请求的访问日志数据，可以为日志分析和查询提供统一支持。\n- 其他，当然还有很多需要统一集中管理的都可以在网关层解决。\n\n在Spring Cloud Netflix中使用Zuul来作为API Gateway组件，并结合Undertow，可以满足大部分性能和网关功能需求了(更高要求可以参考：https://github.com/tietang/ngx-lua-zuul)，Zuul + Undertow一般性能延迟，包括JVM和网络延迟在10%~20%，JVM延迟可以控制到10ms以内。另一方面，Zuul有强大的可定制化，通过ZuulFilter可以定制开发更多的网关功能。如下图所示：在Spring Cloud技术上，Zuul集成了Hystrix，Ribbon，Eureka Client等强大的技术栈，提供了开箱即用的Spring Cloud微服务网关功能。Zuul的强大之处是自由定制，这样对于很多老项目微服务化后，就不能按照Spring Cloud默认的动态路由规则运行，因此在其基础上定制了一些路由规则功能，更好的适应老项目微服务化。\n\n![API gateway](<http://7xiovs.com1.z0.glb.clouddn.com/API-Gateway.png>)\n\n**定制的路由规则的主要功能:**\n\n\n1. 路由表中包含源路径，微服务名称，目标路径。\n2. Endpoint粒度配置支持。\n3. 路由支持1对1精确路由。\n4. 源路径可以`前缀/**`格式来模糊路由。\n5. 目标路径可以使用`前缀/**`格式来装配目标路径。\n6. 保留默认动态路由规则：`服务名称/**` --> 是否截去前缀 --> 目标路径。\n7. 保留默认动态路由规则是否支持截去前缀的配置参数`stripPrefix`特性。\n8. 路由规则可以在不重启服务动态更新，这个功能通过外化配置来支持。\n9. 匹配股则采取谁先匹配路由谁，也就是说在路由表中有2个或以上的路由规则可能被匹配到时，匹配最先查询到的规则。\n\n**路由规则格式采用properties格式：**\n\n> 源路径 = 微服务名称, 目标路径\n\n启动时读取配置并解析，放入路由表。请求时通过查询匹配到合适的路由转发。\n\n例如：\n\n```\n/api/v1/trade=trade,/v1/trade\n/api/customer/**=customer,/api/v1/**\n/api/user/**=user\n\n```\n在上面的例子中：\n\n- /api/v1/trade会精确的路由到trade微服务的/v1/trade；\n- /api/customer/开头的api会路由转发到customer微服务的/api/v1/\\*\\*，其中后面的\\*\\*会被前面的\\*\\*部分替换，比如/api/customer/card->/api/v1/card的转换。\n- /api/user/开头的api会路由转发到user微服务的/api/user/**，endppoint不变。\n\n\n如果在Eureka Server中已经注册了微服务`payment`,那么在zuul启动后会自动添加路由规则，如果stripPrefix=false:\n\n```\n/payment/**=payment,/payment/**\n```\n如果stripPrefix=true:\n\n```\n/payment/**=payment,/payment/**\n```\n\nAPI网关通过部署多个实例来保证可用性，前端通过Nginx来负载均衡。\n","slug":"微服务/微服务之API网关设计","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0o001vz29ktce89543","content":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-3f8e955deefa1708.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"P60528-094513-01.jpeg\"></p>\n<p>微服务除了互相之间调用，还需要将API提供给外部应用访问，像浏览器，移动app，第三合作方等等，这就需要前段路由来管理后端微服务提供的服务。提供类似功能的应用有着多样化的名称，比如前置服务器/前置机、路由服务器、(反向)代理服务器，API网关服务器也是其中的一个叫法，只是场景和侧重点不一样。</p>\n<p>API网关，顾名思义，就是外部到内部的一道门，其主要功能：</p>\n<ul>\n<li>服务路由：将前段应用的调用请求路由定位并负载均衡到具体的后端微服务实例，对于前端应用看起来就是1个应用提供的服务，微服务对于前段应用来说就是黑盒，前段应用也不需要关心内部如何分布，由哪个微服务提供。主要有静态路由和动态路由。<ul>\n<li>静态路由：有时候需要通过域名或者其他固定方式提供和配置路由表</li>\n<li>动态路由：通过服务发现服务，动态调整后端微服务的运行实例和路由表，为路由和负载均衡提供动态变化的服务注册信息。</li>\n</ul>\n</li>\n<li>安全：统一集中的身份认证，安全控制。比如登录，签名，黑名单等等，还可以挖掘和开发更高级的安全策略。</li>\n<li>弹性：限流和容错，也是另一个层面的安全防护，防止突发的流量或者高峰流量冲击后端微服务而导致其服务不可用，另一方面可以在高峰期通过容错和降级保证核心服务的运行。</li>\n<li>监控：实时观察后端微服务的TPS、响应时间，失败数量等准确的信息。</li>\n<li>日志：记录所有请求的访问日志数据，可以为日志分析和查询提供统一支持。</li>\n<li>其他，当然还有很多需要统一集中管理的都可以在网关层解决。</li>\n</ul>\n<p>在Spring Cloud Netflix中使用Zuul来作为API Gateway组件，并结合Undertow，可以满足大部分性能和网关功能需求了(更高要求可以参考：<a href=\"https://github.com/tietang/ngx-lua-zuul)，Zuul\" target=\"_blank\" rel=\"external\">https://github.com/tietang/ngx-lua-zuul)，Zuul</a> + Undertow一般性能延迟，包括JVM和网络延迟在10%~20%，JVM延迟可以控制到10ms以内。另一方面，Zuul有强大的可定制化，通过ZuulFilter可以定制开发更多的网关功能。如下图所示：在Spring Cloud技术上，Zuul集成了Hystrix，Ribbon，Eureka Client等强大的技术栈，提供了开箱即用的Spring Cloud微服务网关功能。Zuul的强大之处是自由定制，这样对于很多老项目微服务化后，就不能按照Spring Cloud默认的动态路由规则运行，因此在其基础上定制了一些路由规则功能，更好的适应老项目微服务化。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/API-Gateway.png\" alt=\"API gateway\"></p>\n<p><strong>定制的路由规则的主要功能:</strong></p>\n<ol>\n<li>路由表中包含源路径，微服务名称，目标路径。</li>\n<li>Endpoint粒度配置支持。</li>\n<li>路由支持1对1精确路由。</li>\n<li>源路径可以<code>前缀/**</code>格式来模糊路由。</li>\n<li>目标路径可以使用<code>前缀/**</code>格式来装配目标路径。</li>\n<li>保留默认动态路由规则：<code>服务名称/**</code> –&gt; 是否截去前缀 –&gt; 目标路径。</li>\n<li>保留默认动态路由规则是否支持截去前缀的配置参数<code>stripPrefix</code>特性。</li>\n<li>路由规则可以在不重启服务动态更新，这个功能通过外化配置来支持。</li>\n<li>匹配股则采取谁先匹配路由谁，也就是说在路由表中有2个或以上的路由规则可能被匹配到时，匹配最先查询到的规则。</li>\n</ol>\n<p><strong>路由规则格式采用properties格式：</strong></p>\n<blockquote>\n<p>源路径 = 微服务名称, 目标路径</p>\n</blockquote>\n<p>启动时读取配置并解析，放入路由表。请求时通过查询匹配到合适的路由转发。</p>\n<p>例如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/api/v1/trade=trade,/v1/trade</div><div class=\"line\">/api/customer/**=customer,/api/v1/**</div><div class=\"line\">/api/user/**=user</div></pre></td></tr></table></figure>\n<p>在上面的例子中：</p>\n<ul>\n<li>/api/v1/trade会精确的路由到trade微服务的/v1/trade；</li>\n<li>/api/customer/开头的api会路由转发到customer微服务的/api/v1/**，其中后面的**会被前面的**部分替换，比如/api/customer/card-&gt;/api/v1/card的转换。</li>\n<li>/api/user/开头的api会路由转发到user微服务的/api/user/**，endppoint不变。</li>\n</ul>\n<p>如果在Eureka Server中已经注册了微服务<code>payment</code>,那么在zuul启动后会自动添加路由规则，如果stripPrefix=false:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/payment/**=payment,/payment/**</div></pre></td></tr></table></figure>\n<p>如果stripPrefix=true:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/payment/**=payment,/payment/**</div></pre></td></tr></table></figure>\n<p>API网关通过部署多个实例来保证可用性，前端通过Nginx来负载均衡。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-3f8e955deefa1708.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"P60528-094513-01.jpeg\"></p>\n<p>微服务除了互相之间调用，还需要将API提供给外部应用访问，像浏览器，移动app，第三合作方等等，这就需要前段路由来管理后端微服务提供的服务。提供类似功能的应用有着多样化的名称，比如前置服务器/前置机、路由服务器、(反向)代理服务器，API网关服务器也是其中的一个叫法，只是场景和侧重点不一样。</p>\n<p>API网关，顾名思义，就是外部到内部的一道门，其主要功能：</p>\n<ul>\n<li>服务路由：将前段应用的调用请求路由定位并负载均衡到具体的后端微服务实例，对于前端应用看起来就是1个应用提供的服务，微服务对于前段应用来说就是黑盒，前段应用也不需要关心内部如何分布，由哪个微服务提供。主要有静态路由和动态路由。<ul>\n<li>静态路由：有时候需要通过域名或者其他固定方式提供和配置路由表</li>\n<li>动态路由：通过服务发现服务，动态调整后端微服务的运行实例和路由表，为路由和负载均衡提供动态变化的服务注册信息。</li>\n</ul>\n</li>\n<li>安全：统一集中的身份认证，安全控制。比如登录，签名，黑名单等等，还可以挖掘和开发更高级的安全策略。</li>\n<li>弹性：限流和容错，也是另一个层面的安全防护，防止突发的流量或者高峰流量冲击后端微服务而导致其服务不可用，另一方面可以在高峰期通过容错和降级保证核心服务的运行。</li>\n<li>监控：实时观察后端微服务的TPS、响应时间，失败数量等准确的信息。</li>\n<li>日志：记录所有请求的访问日志数据，可以为日志分析和查询提供统一支持。</li>\n<li>其他，当然还有很多需要统一集中管理的都可以在网关层解决。</li>\n</ul>\n<p>在Spring Cloud Netflix中使用Zuul来作为API Gateway组件，并结合Undertow，可以满足大部分性能和网关功能需求了(更高要求可以参考：<a href=\"https://github.com/tietang/ngx-lua-zuul)，Zuul\" target=\"_blank\" rel=\"external\">https://github.com/tietang/ngx-lua-zuul)，Zuul</a> + Undertow一般性能延迟，包括JVM和网络延迟在10%~20%，JVM延迟可以控制到10ms以内。另一方面，Zuul有强大的可定制化，通过ZuulFilter可以定制开发更多的网关功能。如下图所示：在Spring Cloud技术上，Zuul集成了Hystrix，Ribbon，Eureka Client等强大的技术栈，提供了开箱即用的Spring Cloud微服务网关功能。Zuul的强大之处是自由定制，这样对于很多老项目微服务化后，就不能按照Spring Cloud默认的动态路由规则运行，因此在其基础上定制了一些路由规则功能，更好的适应老项目微服务化。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/API-Gateway.png\" alt=\"API gateway\"></p>\n<p><strong>定制的路由规则的主要功能:</strong></p>\n<ol>\n<li>路由表中包含源路径，微服务名称，目标路径。</li>\n<li>Endpoint粒度配置支持。</li>\n<li>路由支持1对1精确路由。</li>\n<li>源路径可以<code>前缀/**</code>格式来模糊路由。</li>\n<li>目标路径可以使用<code>前缀/**</code>格式来装配目标路径。</li>\n<li>保留默认动态路由规则：<code>服务名称/**</code> –&gt; 是否截去前缀 –&gt; 目标路径。</li>\n<li>保留默认动态路由规则是否支持截去前缀的配置参数<code>stripPrefix</code>特性。</li>\n<li>路由规则可以在不重启服务动态更新，这个功能通过外化配置来支持。</li>\n<li>匹配股则采取谁先匹配路由谁，也就是说在路由表中有2个或以上的路由规则可能被匹配到时，匹配最先查询到的规则。</li>\n</ol>\n<p><strong>路由规则格式采用properties格式：</strong></p>\n<blockquote>\n<p>源路径 = 微服务名称, 目标路径</p>\n</blockquote>\n<p>启动时读取配置并解析，放入路由表。请求时通过查询匹配到合适的路由转发。</p>\n<p>例如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/api/v1/trade=trade,/v1/trade</div><div class=\"line\">/api/customer/**=customer,/api/v1/**</div><div class=\"line\">/api/user/**=user</div></pre></td></tr></table></figure>\n<p>在上面的例子中：</p>\n<ul>\n<li>/api/v1/trade会精确的路由到trade微服务的/v1/trade；</li>\n<li>/api/customer/开头的api会路由转发到customer微服务的/api/v1/**，其中后面的**会被前面的**部分替换，比如/api/customer/card-&gt;/api/v1/card的转换。</li>\n<li>/api/user/开头的api会路由转发到user微服务的/api/user/**，endppoint不变。</li>\n</ul>\n<p>如果在Eureka Server中已经注册了微服务<code>payment</code>,那么在zuul启动后会自动添加路由规则，如果stripPrefix=false:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/payment/**=payment,/payment/**</div></pre></td></tr></table></figure>\n<p>如果stripPrefix=true:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/payment/**=payment,/payment/**</div></pre></td></tr></table></figure>\n<p>API网关通过部署多个实例来保证可用性，前端通过Nginx来负载均衡。</p>\n"},{"title":"微服务之Eureka服务发现","thumbnail":"images/m1.jpg","date":"2016-09-08T11:22:47.000Z","keywords":["微服务","Spring Cloud","Spring Boot","Eureka","服务发现"],"description":null,"_content":"\n\n\n![](http://upload-images.jianshu.io/upload_images/2519252-3691e262041c9cdd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n当调用API或者发起网络通信的时候，无论如何我们都要知道被调用方的IP和服务端口，大部分情况是通过域名和服务端口，事实上基于DNS的服务发现，因为DNS缓存、无法自治和其他不利因素的存在，有很多局限。传统的DNS方式，都是通过nginx或者其他代理软件来实现，物理机器的ip和port都是固定的，那么nginx中配置的服务ip和port也是固定的，服务列表的更新只能通过手动来做，但如果后端服务很多时，手动更新容易出错，效率也很低，这在后端服务发生故障时，不可用时间就可能会加长。在微服务中，尤其是使用了Docker等虚拟化技术的微服务，其IP和port都是动态分配的，服务实例数也是动态变化的，那么就需要精细而准确的服务发现机制。当微服务app启动后，告诉其他服务自己的ip和端口，这里的其他服务就是Eureka Server和Eureka Client，这样其他服务就知道这个服务有多少实例在线，都在哪些地方，方便去负载均衡和调用。\n\nEureka属于客户端发现模式，客户端负责决定相应服务实例的网络位置，并且对请求实现负载均衡。客户端从一个服务注册服务中查询所有可用服务实例的库，并缓存到本地。服务调用时，客户端使用负载均衡算法从多个后端服务实例中选择出一个，然后发出请求。Eureka分为Eureka Server和Eureka client， Eureka Server是一个服务注册中心，为服务实例注册管理和查询可用实例提供了REST API，并可以用其定位、负载均衡、故障恢复后端服务的中间层服务。在服务启动后，Eureka Client向服务注册中心注册服务同时会拉去注册中心注册表副本；在服务停止的时候，Eureka Client向服务注册中心注销服务；服务注册后，Eureka Client会定时的发送心跳来刷新服务的最新状态。\n\n客户端发现模式的优点是服务调用、负载均衡不需要和Eureka Server通信，直接使用本地注册表副本，因此Eureka Server不可用时是不会影响正常的服务调用，性能也不会因为网络延迟和服务端延迟受到影响。但其缺点也很明显，但某个服务不可用时，各个Eureka Client不能及时的知道，需要1~3个心跳周期才能感知，但是，由于基于Netflix的服务调用端都会使用Hystrix来容错和降级，当服务调用不可用时Hystrix也能及时感知到，通过熔断机制来降级服务调用，因此弥补了基于客户端服务发现的时效性的缺点。\n\nEureka Server采用的是对等通信(P2P),无中心化的架构，无master/slave区分，每一个server都是对等的，既是Server又是Client,所以其集群方式可以自由发挥，可以各点互连，也可以接力互连。Eureka Server通过运行多个实例以及彼此之间互相注册来提高可用性，每个节点需要添加一个或多个有效的serviceUrl指向另一个节点。利用Eureka Server这种架构特性， 我在Eureka Server Cluster的部署时采用了三角形通信模型，三角形是一个很好的均衡模型，既是各点互连，又是接力互连，三角形本身就是一个稳定性几何形状，有着稳固、坚定搜索、耐压的特点，家具、建筑、交通等各种行业都有应用。如下图所示，Eureka Cluster的每个实例都和另外2个实例通信交互。\n![](<http://7xiovs.com1.z0.glb.clouddn.com/eureka_cluster.png>)\n\n\n","source":"_posts/微服务/微服务之Eureka服务发现.md","raw":"---\ntitle: 微服务之Eureka服务发现\nthumbnail: 'images/m1.jpg'\ndate: 2016-09-08 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- spring-cloud\n\t- 微服务\n\t- Spring Boot\n\t- Eureka\n\t- 服务发现\nkeywords:\n\t- 微服务\n\t- Spring Cloud\n\t- Spring Boot\n\t- Eureka\n\t- 服务发现\ndescription:\n---\n\n\n\n![](http://upload-images.jianshu.io/upload_images/2519252-3691e262041c9cdd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n当调用API或者发起网络通信的时候，无论如何我们都要知道被调用方的IP和服务端口，大部分情况是通过域名和服务端口，事实上基于DNS的服务发现，因为DNS缓存、无法自治和其他不利因素的存在，有很多局限。传统的DNS方式，都是通过nginx或者其他代理软件来实现，物理机器的ip和port都是固定的，那么nginx中配置的服务ip和port也是固定的，服务列表的更新只能通过手动来做，但如果后端服务很多时，手动更新容易出错，效率也很低，这在后端服务发生故障时，不可用时间就可能会加长。在微服务中，尤其是使用了Docker等虚拟化技术的微服务，其IP和port都是动态分配的，服务实例数也是动态变化的，那么就需要精细而准确的服务发现机制。当微服务app启动后，告诉其他服务自己的ip和端口，这里的其他服务就是Eureka Server和Eureka Client，这样其他服务就知道这个服务有多少实例在线，都在哪些地方，方便去负载均衡和调用。\n\nEureka属于客户端发现模式，客户端负责决定相应服务实例的网络位置，并且对请求实现负载均衡。客户端从一个服务注册服务中查询所有可用服务实例的库，并缓存到本地。服务调用时，客户端使用负载均衡算法从多个后端服务实例中选择出一个，然后发出请求。Eureka分为Eureka Server和Eureka client， Eureka Server是一个服务注册中心，为服务实例注册管理和查询可用实例提供了REST API，并可以用其定位、负载均衡、故障恢复后端服务的中间层服务。在服务启动后，Eureka Client向服务注册中心注册服务同时会拉去注册中心注册表副本；在服务停止的时候，Eureka Client向服务注册中心注销服务；服务注册后，Eureka Client会定时的发送心跳来刷新服务的最新状态。\n\n客户端发现模式的优点是服务调用、负载均衡不需要和Eureka Server通信，直接使用本地注册表副本，因此Eureka Server不可用时是不会影响正常的服务调用，性能也不会因为网络延迟和服务端延迟受到影响。但其缺点也很明显，但某个服务不可用时，各个Eureka Client不能及时的知道，需要1~3个心跳周期才能感知，但是，由于基于Netflix的服务调用端都会使用Hystrix来容错和降级，当服务调用不可用时Hystrix也能及时感知到，通过熔断机制来降级服务调用，因此弥补了基于客户端服务发现的时效性的缺点。\n\nEureka Server采用的是对等通信(P2P),无中心化的架构，无master/slave区分，每一个server都是对等的，既是Server又是Client,所以其集群方式可以自由发挥，可以各点互连，也可以接力互连。Eureka Server通过运行多个实例以及彼此之间互相注册来提高可用性，每个节点需要添加一个或多个有效的serviceUrl指向另一个节点。利用Eureka Server这种架构特性， 我在Eureka Server Cluster的部署时采用了三角形通信模型，三角形是一个很好的均衡模型，既是各点互连，又是接力互连，三角形本身就是一个稳定性几何形状，有着稳固、坚定搜索、耐压的特点，家具、建筑、交通等各种行业都有应用。如下图所示，Eureka Cluster的每个实例都和另外2个实例通信交互。\n![](<http://7xiovs.com1.z0.glb.clouddn.com/eureka_cluster.png>)\n\n\n","slug":"微服务/微服务之Eureka服务发现","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0s0024z29kgvd77xm0","content":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-3691e262041c9cdd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"\"></p>\n<p>当调用API或者发起网络通信的时候，无论如何我们都要知道被调用方的IP和服务端口，大部分情况是通过域名和服务端口，事实上基于DNS的服务发现，因为DNS缓存、无法自治和其他不利因素的存在，有很多局限。传统的DNS方式，都是通过nginx或者其他代理软件来实现，物理机器的ip和port都是固定的，那么nginx中配置的服务ip和port也是固定的，服务列表的更新只能通过手动来做，但如果后端服务很多时，手动更新容易出错，效率也很低，这在后端服务发生故障时，不可用时间就可能会加长。在微服务中，尤其是使用了Docker等虚拟化技术的微服务，其IP和port都是动态分配的，服务实例数也是动态变化的，那么就需要精细而准确的服务发现机制。当微服务app启动后，告诉其他服务自己的ip和端口，这里的其他服务就是Eureka Server和Eureka Client，这样其他服务就知道这个服务有多少实例在线，都在哪些地方，方便去负载均衡和调用。</p>\n<p>Eureka属于客户端发现模式，客户端负责决定相应服务实例的网络位置，并且对请求实现负载均衡。客户端从一个服务注册服务中查询所有可用服务实例的库，并缓存到本地。服务调用时，客户端使用负载均衡算法从多个后端服务实例中选择出一个，然后发出请求。Eureka分为Eureka Server和Eureka client， Eureka Server是一个服务注册中心，为服务实例注册管理和查询可用实例提供了REST API，并可以用其定位、负载均衡、故障恢复后端服务的中间层服务。在服务启动后，Eureka Client向服务注册中心注册服务同时会拉去注册中心注册表副本；在服务停止的时候，Eureka Client向服务注册中心注销服务；服务注册后，Eureka Client会定时的发送心跳来刷新服务的最新状态。</p>\n<p>客户端发现模式的优点是服务调用、负载均衡不需要和Eureka Server通信，直接使用本地注册表副本，因此Eureka Server不可用时是不会影响正常的服务调用，性能也不会因为网络延迟和服务端延迟受到影响。但其缺点也很明显，但某个服务不可用时，各个Eureka Client不能及时的知道，需要1~3个心跳周期才能感知，但是，由于基于Netflix的服务调用端都会使用Hystrix来容错和降级，当服务调用不可用时Hystrix也能及时感知到，通过熔断机制来降级服务调用，因此弥补了基于客户端服务发现的时效性的缺点。</p>\n<p>Eureka Server采用的是对等通信(P2P),无中心化的架构，无master/slave区分，每一个server都是对等的，既是Server又是Client,所以其集群方式可以自由发挥，可以各点互连，也可以接力互连。Eureka Server通过运行多个实例以及彼此之间互相注册来提高可用性，每个节点需要添加一个或多个有效的serviceUrl指向另一个节点。利用Eureka Server这种架构特性， 我在Eureka Server Cluster的部署时采用了三角形通信模型，三角形是一个很好的均衡模型，既是各点互连，又是接力互连，三角形本身就是一个稳定性几何形状，有着稳固、坚定搜索、耐压的特点，家具、建筑、交通等各种行业都有应用。如下图所示，Eureka Cluster的每个实例都和另外2个实例通信交互。<br><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/eureka_cluster.png\" alt=\"\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-3691e262041c9cdd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"\"></p>\n<p>当调用API或者发起网络通信的时候，无论如何我们都要知道被调用方的IP和服务端口，大部分情况是通过域名和服务端口，事实上基于DNS的服务发现，因为DNS缓存、无法自治和其他不利因素的存在，有很多局限。传统的DNS方式，都是通过nginx或者其他代理软件来实现，物理机器的ip和port都是固定的，那么nginx中配置的服务ip和port也是固定的，服务列表的更新只能通过手动来做，但如果后端服务很多时，手动更新容易出错，效率也很低，这在后端服务发生故障时，不可用时间就可能会加长。在微服务中，尤其是使用了Docker等虚拟化技术的微服务，其IP和port都是动态分配的，服务实例数也是动态变化的，那么就需要精细而准确的服务发现机制。当微服务app启动后，告诉其他服务自己的ip和端口，这里的其他服务就是Eureka Server和Eureka Client，这样其他服务就知道这个服务有多少实例在线，都在哪些地方，方便去负载均衡和调用。</p>\n<p>Eureka属于客户端发现模式，客户端负责决定相应服务实例的网络位置，并且对请求实现负载均衡。客户端从一个服务注册服务中查询所有可用服务实例的库，并缓存到本地。服务调用时，客户端使用负载均衡算法从多个后端服务实例中选择出一个，然后发出请求。Eureka分为Eureka Server和Eureka client， Eureka Server是一个服务注册中心，为服务实例注册管理和查询可用实例提供了REST API，并可以用其定位、负载均衡、故障恢复后端服务的中间层服务。在服务启动后，Eureka Client向服务注册中心注册服务同时会拉去注册中心注册表副本；在服务停止的时候，Eureka Client向服务注册中心注销服务；服务注册后，Eureka Client会定时的发送心跳来刷新服务的最新状态。</p>\n<p>客户端发现模式的优点是服务调用、负载均衡不需要和Eureka Server通信，直接使用本地注册表副本，因此Eureka Server不可用时是不会影响正常的服务调用，性能也不会因为网络延迟和服务端延迟受到影响。但其缺点也很明显，但某个服务不可用时，各个Eureka Client不能及时的知道，需要1~3个心跳周期才能感知，但是，由于基于Netflix的服务调用端都会使用Hystrix来容错和降级，当服务调用不可用时Hystrix也能及时感知到，通过熔断机制来降级服务调用，因此弥补了基于客户端服务发现的时效性的缺点。</p>\n<p>Eureka Server采用的是对等通信(P2P),无中心化的架构，无master/slave区分，每一个server都是对等的，既是Server又是Client,所以其集群方式可以自由发挥，可以各点互连，也可以接力互连。Eureka Server通过运行多个实例以及彼此之间互相注册来提高可用性，每个节点需要添加一个或多个有效的serviceUrl指向另一个节点。利用Eureka Server这种架构特性， 我在Eureka Server Cluster的部署时采用了三角形通信模型，三角形是一个很好的均衡模型，既是各点互连，又是接力互连，三角形本身就是一个稳定性几何形状，有着稳固、坚定搜索、耐压的特点，家具、建筑、交通等各种行业都有应用。如下图所示，Eureka Cluster的每个实例都和另外2个实例通信交互。<br><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/eureka_cluster.png\" alt=\"\"></p>\n"},{"title":"微服务Eureka Server原理","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/xinglonghu_l.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30","date":"2017-03-26T11:20:00.000Z","keywords":"微服务,Eureka Server, Spring Cloud","description":null,"_content":" \n \n\nEureka的相关知识，在之前的《微服务之Eureka服务发现》中已经讲了很多，这里不再重复，本文主要通过Eureka Server源码和配置来阐述Eureka Server的工作原理。\n\nEureka提供了一系列REST的API，供Eureka Client来调用，实现服务注册，注销，心跳，状态更新等等操作，参考官网[EurekaREst操作](<https://github.com/Netflix/eureka/wiki/Eureka-REST-operations>)。\n\n\n```\nREST API <Jersey>\nResponse Cache <com.google.common.cache.LoadingCache>\nInstanceRegistry <ConcurrentHashMap>\n\nEvictionTimer<java.util.Timer>\nCacheUpdateTask<java.util.Timer>\n\n```\n\n## REST API \n\n基于Jersey实现，主要以appId[appname]和instanceId为操作维度，内容可以是xml或者json。相关的实现可以在`com.netflix.eureka.resources`包中找到。基于appId和instanceId和各种操作组合的实现，可以认为是InstanceRegistry的操作入口。\n\n## InstanceRegistry\n\nRegistry是Eureka Server的核心，服务发现就是围绕Registry来实现。以下提到的类都可以在`com.netflix.eureka.registry`包中找到。\n\n\n整个Registry由4个接口组成：\n\n* LeaseManager: register,cacel,renew,evict等基本操作\n* LookupService: 这个抽象是要是client和server端共用，EurekaClient也继承了该接口，主要用来查找服务和服务实例。\n* InstanceRegistry: 提供了实例相关的丰富的操作。\n* PeerAwareInstanceRegistry: eureka server之间的注册信息复制\n\n如下是类关系图：\n\n![](<http://7xiovs.com1.z0.glb.clouddn.com/eureka_registry.png>)\n\n\n## 几个重要的定时任务\n\n### 心跳补偿任务EvictionTask\n\n```\n[com.netflix.eureka.registry.AbstractInstanceRegistry.EvictionTask]\n```\n\n主要是用来做心跳补偿，目的是用来取消或清理过期的注册信息，通常是eureka client在停止前未成功发送cacel请求。例如eureka client停止时网络不通了、eureka client进程奔溃了等等。\n\n这个定时任务是通过`eureka.server.eviction-interval-timer-in-ms`参数来配置处理间隔，默认是60s。\n\n补偿时间=当前时间-该任务最后执行时间-执行间隔\n其中`该任务最后执行时间-执行间隔`主要是计算出实际执行时间的细微差别，也为后面的`补偿时间>0`埋下伏笔。\n\n`补偿时间>0`或者`最后更新时间 + leaseDuration[默认是90s，客户端durationInSecs]+补偿时间<当前时间` 时会执行evict清理过期实例。\n\n**补偿时间>0,** 即就是当前任务执行和上次执行的时间间隔大于配置的时间间隔，正常情况补偿时间应该很小。\n\n**最后更新时间+leaseDuration+补偿时间<当前时间**，即就是最后一次成功心跳到当前时间的间隔比eureka client配置的间隔大。\n\n其中**leaseDuration**: 在eureka client中通过`eureka.instance.lease-expiration-duration-in-seconds[leaseExpirationDurationInSeconds]`参数来配置，默认是90s。\n\n下面是源代码：\n\n**计算补偿时间：**\n\n```java\nlong getCompensationTimeMs() {\n            long currNanos = getCurrentTimeNano();\n            long lastNanos = lastExecutionNanosRef.getAndSet(currNanos);\n            if (lastNanos == 0l) {\n                return 0l;\n            }\n\n            long elapsedMs = TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);\n            long compensationTime = elapsedMs - serverConfig.getEvictionIntervalTimerInMs();\n            return compensationTime <= 0l ? 0l : compensationTime;\n        }\n```\n\n**这个是补偿清理逻辑：**\n\n```java\npublic void evict(long additionalLeaseMs) {\n        logger.debug(\"Running the evict task\");\n\n        if (!isLeaseExpirationEnabled()) {\n            logger.debug(\"DS: lease expiration is currently disabled.\");\n            return;\n        }\n\n        // We collect first all expired items, to evict them in random order. For large eviction sets,\n        // if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,\n        // the impact should be evenly distributed across all applications.\n        List<Lease<InstanceInfo>> expiredLeases = new ArrayList<>();\n        for (Entry<String, Map<String, Lease<InstanceInfo>>> groupEntry : registry.entrySet()) {\n            Map<String, Lease<InstanceInfo>> leaseMap = groupEntry.getValue();\n            if (leaseMap != null) {\n                for (Entry<String, Lease<InstanceInfo>> leaseEntry : leaseMap.entrySet()) {\n                    Lease<InstanceInfo> lease = leaseEntry.getValue();\n                    if (lease.isExpired(additionalLeaseMs) && lease.getHolder() != null) {\n                        expiredLeases.add(lease);\n                    }\n                }\n            }\n        }\n\n        // To compensate for GC pauses or drifting local time, we need to use current registry size as a base for\n        // triggering self-preservation. Without that we would wipe out full registry.\n        int registrySize = (int) getLocalRegistrySize();\n        int registrySizeThreshold = (int) (registrySize * serverConfig.getRenewalPercentThreshold());\n        int evictionLimit = registrySize - registrySizeThreshold;\n\n        int toEvict = Math.min(expiredLeases.size(), evictionLimit);\n        if (toEvict > 0) {\n            logger.info(\"Evicting {} items (expired={}, evictionLimit={})\", toEvict, expiredLeases.size(), evictionLimit);\n\n            Random random = new Random(System.currentTimeMillis());\n            for (int i = 0; i < toEvict; i++) {\n                // Pick a random item (Knuth shuffle algorithm)\n                int next = i + random.nextInt(expiredLeases.size() - i);\n                Collections.swap(expiredLeases, i, next);\n                Lease<InstanceInfo> lease = expiredLeases.get(i);\n\n                String appName = lease.getHolder().getAppName();\n                String id = lease.getHolder().getId();\n                EXPIRED.increment();\n                logger.warn(\"DS: Registry: expired lease for {}/{}\", appName, id);\n                internalCancel(appName, id, false);\n            }\n        }\n    }\n```\n\n\n\n从上面的逻辑上看，配置的时间间隔有2个：\n\n- eureka server端：`eviction-interval-timer-in-ms`\n- eureka client端：`lease-expiration-duration-in-seconds`\n\n这2个参数同时作用着清理逻辑，配置时就要注意，`eviction-interval-timer-in-ms`要比`lease-expiration-duration-in-seconds`配置的要小，产生的结果就完全不一样。\n\n\n\n## ResponseCache\n通过readOnlyCache和readWriteCache实现：\n\n- readOnlyCache: java.util.concurrent.ConcurrentMap\n- readWriteCache: com.google.common.cache.LoadingCache\n\nreadWriteCache会自动从registry中更新。\n\n这个缓存只作用于获取整个注册表和app的实例注册信息。\n\n### 缓存更新CacheUpdateTask\n\n这个任务用来定期更新只读缓存,逻辑上比较简单，定期从读写缓存中取出K/V，比较是否一致，不一致更新。\n\n更新间隔通过参数`eureka.server.response-cache-update-interval-ms`来配置，默认是30s。\n\n\n### readWriteCache\n\n过期时间通过参数`eureka.server.response-cache-auto-expiration-in-seconds`来配置，默认是180s。\n\n## eureka Server几个重要的配置\n\n\n\n\n\neureka.server.enable-self-preservation\n\n是否开启自我保护模式，默认为true。\n\n在开启状态下，Eureka Server会保持\n\n默认情况下，如果Eureka Server在一定时间内没有接收到某个微服务实例的心跳，Eureka Server将会注销该实例（默认90秒）。但是当网络分区故障发生时，微服务与Eureka Server之间无法正常通信，以上行为可能变得非常危险了——因为微服务本身其实是健康的，此时本不应该注销这个微服务。\n\nEureka通过“自我保护模式”来解决这个问题——当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。一旦进入该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该Eureka Server节点会自动退出自我保护模式。\n\n综上，自我保护模式是一种应对网络异常的安全保护措施。它的架构哲学是宁可同时保留所有微服务（健康的微服务和不健康的微服务都会保留），也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加的健壮、稳定。\n\n \n```\n    #是否开启自我保护模式，默认为true。\n    enableSelfPreservation: true\n    #默认是85%\n    renewal-percent-threshold: 0.85\n    #默认是15分钟\n    renewal-threshold-update-interval-ms: 15\n    #缓存更新时间，默认30s\n    response-cache-update-interval-ms: 10\n    #缓存过期时间，默认180s\n    response-cache-auto-expiration-in-seconds: 30\n    # 实例过期清理时间间隔，默认60秒\n    eviction-interval-timer-in-ms: 10\n\n```\n\n## eureka client几个重要的配置\n\neureka.client.registry-fetch-interval-seconds\n\n表示eureka client间隔多久去拉取服务注册信息，默认为30秒，对于api-gateway，如果要迅速获取服务注册状态，可以缩小该值，比如5秒\n\neureka.instance.lease-expiration-duration-in-seconds\n\nleaseExpirationDurationInSeconds，表示eureka server至上一次收到client的心跳之后，等待下一次心跳的超时时间，在这个时间内若没收到下一次心跳，则将移除该instance。\n\n默认为90秒\n如果该值太大，则很可能将流量转发过去的时候，该instance已经不存活了。\n如果该值设置太小了，则instance则很可能因为临时的网络抖动而被摘除掉。\n该值至少应该大于leaseRenewalIntervalInSeconds\neureka.instance.lease-renewal-interval-in-seconds\n\nleaseRenewalIntervalInSeconds，表示eureka client发送心跳给server端的频率。如果在leaseExpirationDurationInSeconds后，server端没有收到client的心跳，则将摘除该instance。除此之外，如果该instance实现了HealthCheckCallback，并决定让自己unavailable的话，则该instance也不会接收到流量。\n\n\n\n\n\n\n\n \n\n\n\n ","source":"_posts/微服务/微服务之EurekaServer原理.md","raw":"---\ntitle: 微服务Eureka Server原理\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/xinglonghu_l.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30'\ndate: 2017-03-26 19:20:00\ncategories:\n\t- 微服务 \ntags:\n\t- 微服务\n\t- Eureka\n\t- Spring Cloud\nkeywords: 微服务,Eureka Server, Spring Cloud\ndescription:\n---\n \n \n\nEureka的相关知识，在之前的《微服务之Eureka服务发现》中已经讲了很多，这里不再重复，本文主要通过Eureka Server源码和配置来阐述Eureka Server的工作原理。\n\nEureka提供了一系列REST的API，供Eureka Client来调用，实现服务注册，注销，心跳，状态更新等等操作，参考官网[EurekaREst操作](<https://github.com/Netflix/eureka/wiki/Eureka-REST-operations>)。\n\n\n```\nREST API <Jersey>\nResponse Cache <com.google.common.cache.LoadingCache>\nInstanceRegistry <ConcurrentHashMap>\n\nEvictionTimer<java.util.Timer>\nCacheUpdateTask<java.util.Timer>\n\n```\n\n## REST API \n\n基于Jersey实现，主要以appId[appname]和instanceId为操作维度，内容可以是xml或者json。相关的实现可以在`com.netflix.eureka.resources`包中找到。基于appId和instanceId和各种操作组合的实现，可以认为是InstanceRegistry的操作入口。\n\n## InstanceRegistry\n\nRegistry是Eureka Server的核心，服务发现就是围绕Registry来实现。以下提到的类都可以在`com.netflix.eureka.registry`包中找到。\n\n\n整个Registry由4个接口组成：\n\n* LeaseManager: register,cacel,renew,evict等基本操作\n* LookupService: 这个抽象是要是client和server端共用，EurekaClient也继承了该接口，主要用来查找服务和服务实例。\n* InstanceRegistry: 提供了实例相关的丰富的操作。\n* PeerAwareInstanceRegistry: eureka server之间的注册信息复制\n\n如下是类关系图：\n\n![](<http://7xiovs.com1.z0.glb.clouddn.com/eureka_registry.png>)\n\n\n## 几个重要的定时任务\n\n### 心跳补偿任务EvictionTask\n\n```\n[com.netflix.eureka.registry.AbstractInstanceRegistry.EvictionTask]\n```\n\n主要是用来做心跳补偿，目的是用来取消或清理过期的注册信息，通常是eureka client在停止前未成功发送cacel请求。例如eureka client停止时网络不通了、eureka client进程奔溃了等等。\n\n这个定时任务是通过`eureka.server.eviction-interval-timer-in-ms`参数来配置处理间隔，默认是60s。\n\n补偿时间=当前时间-该任务最后执行时间-执行间隔\n其中`该任务最后执行时间-执行间隔`主要是计算出实际执行时间的细微差别，也为后面的`补偿时间>0`埋下伏笔。\n\n`补偿时间>0`或者`最后更新时间 + leaseDuration[默认是90s，客户端durationInSecs]+补偿时间<当前时间` 时会执行evict清理过期实例。\n\n**补偿时间>0,** 即就是当前任务执行和上次执行的时间间隔大于配置的时间间隔，正常情况补偿时间应该很小。\n\n**最后更新时间+leaseDuration+补偿时间<当前时间**，即就是最后一次成功心跳到当前时间的间隔比eureka client配置的间隔大。\n\n其中**leaseDuration**: 在eureka client中通过`eureka.instance.lease-expiration-duration-in-seconds[leaseExpirationDurationInSeconds]`参数来配置，默认是90s。\n\n下面是源代码：\n\n**计算补偿时间：**\n\n```java\nlong getCompensationTimeMs() {\n            long currNanos = getCurrentTimeNano();\n            long lastNanos = lastExecutionNanosRef.getAndSet(currNanos);\n            if (lastNanos == 0l) {\n                return 0l;\n            }\n\n            long elapsedMs = TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);\n            long compensationTime = elapsedMs - serverConfig.getEvictionIntervalTimerInMs();\n            return compensationTime <= 0l ? 0l : compensationTime;\n        }\n```\n\n**这个是补偿清理逻辑：**\n\n```java\npublic void evict(long additionalLeaseMs) {\n        logger.debug(\"Running the evict task\");\n\n        if (!isLeaseExpirationEnabled()) {\n            logger.debug(\"DS: lease expiration is currently disabled.\");\n            return;\n        }\n\n        // We collect first all expired items, to evict them in random order. For large eviction sets,\n        // if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,\n        // the impact should be evenly distributed across all applications.\n        List<Lease<InstanceInfo>> expiredLeases = new ArrayList<>();\n        for (Entry<String, Map<String, Lease<InstanceInfo>>> groupEntry : registry.entrySet()) {\n            Map<String, Lease<InstanceInfo>> leaseMap = groupEntry.getValue();\n            if (leaseMap != null) {\n                for (Entry<String, Lease<InstanceInfo>> leaseEntry : leaseMap.entrySet()) {\n                    Lease<InstanceInfo> lease = leaseEntry.getValue();\n                    if (lease.isExpired(additionalLeaseMs) && lease.getHolder() != null) {\n                        expiredLeases.add(lease);\n                    }\n                }\n            }\n        }\n\n        // To compensate for GC pauses or drifting local time, we need to use current registry size as a base for\n        // triggering self-preservation. Without that we would wipe out full registry.\n        int registrySize = (int) getLocalRegistrySize();\n        int registrySizeThreshold = (int) (registrySize * serverConfig.getRenewalPercentThreshold());\n        int evictionLimit = registrySize - registrySizeThreshold;\n\n        int toEvict = Math.min(expiredLeases.size(), evictionLimit);\n        if (toEvict > 0) {\n            logger.info(\"Evicting {} items (expired={}, evictionLimit={})\", toEvict, expiredLeases.size(), evictionLimit);\n\n            Random random = new Random(System.currentTimeMillis());\n            for (int i = 0; i < toEvict; i++) {\n                // Pick a random item (Knuth shuffle algorithm)\n                int next = i + random.nextInt(expiredLeases.size() - i);\n                Collections.swap(expiredLeases, i, next);\n                Lease<InstanceInfo> lease = expiredLeases.get(i);\n\n                String appName = lease.getHolder().getAppName();\n                String id = lease.getHolder().getId();\n                EXPIRED.increment();\n                logger.warn(\"DS: Registry: expired lease for {}/{}\", appName, id);\n                internalCancel(appName, id, false);\n            }\n        }\n    }\n```\n\n\n\n从上面的逻辑上看，配置的时间间隔有2个：\n\n- eureka server端：`eviction-interval-timer-in-ms`\n- eureka client端：`lease-expiration-duration-in-seconds`\n\n这2个参数同时作用着清理逻辑，配置时就要注意，`eviction-interval-timer-in-ms`要比`lease-expiration-duration-in-seconds`配置的要小，产生的结果就完全不一样。\n\n\n\n## ResponseCache\n通过readOnlyCache和readWriteCache实现：\n\n- readOnlyCache: java.util.concurrent.ConcurrentMap\n- readWriteCache: com.google.common.cache.LoadingCache\n\nreadWriteCache会自动从registry中更新。\n\n这个缓存只作用于获取整个注册表和app的实例注册信息。\n\n### 缓存更新CacheUpdateTask\n\n这个任务用来定期更新只读缓存,逻辑上比较简单，定期从读写缓存中取出K/V，比较是否一致，不一致更新。\n\n更新间隔通过参数`eureka.server.response-cache-update-interval-ms`来配置，默认是30s。\n\n\n### readWriteCache\n\n过期时间通过参数`eureka.server.response-cache-auto-expiration-in-seconds`来配置，默认是180s。\n\n## eureka Server几个重要的配置\n\n\n\n\n\neureka.server.enable-self-preservation\n\n是否开启自我保护模式，默认为true。\n\n在开启状态下，Eureka Server会保持\n\n默认情况下，如果Eureka Server在一定时间内没有接收到某个微服务实例的心跳，Eureka Server将会注销该实例（默认90秒）。但是当网络分区故障发生时，微服务与Eureka Server之间无法正常通信，以上行为可能变得非常危险了——因为微服务本身其实是健康的，此时本不应该注销这个微服务。\n\nEureka通过“自我保护模式”来解决这个问题——当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。一旦进入该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该Eureka Server节点会自动退出自我保护模式。\n\n综上，自我保护模式是一种应对网络异常的安全保护措施。它的架构哲学是宁可同时保留所有微服务（健康的微服务和不健康的微服务都会保留），也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加的健壮、稳定。\n\n \n```\n    #是否开启自我保护模式，默认为true。\n    enableSelfPreservation: true\n    #默认是85%\n    renewal-percent-threshold: 0.85\n    #默认是15分钟\n    renewal-threshold-update-interval-ms: 15\n    #缓存更新时间，默认30s\n    response-cache-update-interval-ms: 10\n    #缓存过期时间，默认180s\n    response-cache-auto-expiration-in-seconds: 30\n    # 实例过期清理时间间隔，默认60秒\n    eviction-interval-timer-in-ms: 10\n\n```\n\n## eureka client几个重要的配置\n\neureka.client.registry-fetch-interval-seconds\n\n表示eureka client间隔多久去拉取服务注册信息，默认为30秒，对于api-gateway，如果要迅速获取服务注册状态，可以缩小该值，比如5秒\n\neureka.instance.lease-expiration-duration-in-seconds\n\nleaseExpirationDurationInSeconds，表示eureka server至上一次收到client的心跳之后，等待下一次心跳的超时时间，在这个时间内若没收到下一次心跳，则将移除该instance。\n\n默认为90秒\n如果该值太大，则很可能将流量转发过去的时候，该instance已经不存活了。\n如果该值设置太小了，则instance则很可能因为临时的网络抖动而被摘除掉。\n该值至少应该大于leaseRenewalIntervalInSeconds\neureka.instance.lease-renewal-interval-in-seconds\n\nleaseRenewalIntervalInSeconds，表示eureka client发送心跳给server端的频率。如果在leaseExpirationDurationInSeconds后，server端没有收到client的心跳，则将摘除该instance。除此之外，如果该instance实现了HealthCheckCallback，并决定让自己unavailable的话，则该instance也不会接收到流量。\n\n\n\n\n\n\n\n \n\n\n\n ","slug":"微服务/微服务之EurekaServer原理","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0v002dz29kzw4rqd68","content":"<p>Eureka的相关知识，在之前的《微服务之Eureka服务发现》中已经讲了很多，这里不再重复，本文主要通过Eureka Server源码和配置来阐述Eureka Server的工作原理。</p>\n<p>Eureka提供了一系列REST的API，供Eureka Client来调用，实现服务注册，注销，心跳，状态更新等等操作，参考官网<a href=\"https://github.com/Netflix/eureka/wiki/Eureka-REST-operations\" target=\"_blank\" rel=\"external\">EurekaREst操作</a>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">REST API &lt;Jersey&gt;</div><div class=\"line\">Response Cache &lt;com.google.common.cache.LoadingCache&gt;</div><div class=\"line\">InstanceRegistry &lt;ConcurrentHashMap&gt;</div><div class=\"line\"></div><div class=\"line\">EvictionTimer&lt;java.util.Timer&gt;</div><div class=\"line\">CacheUpdateTask&lt;java.util.Timer&gt;</div></pre></td></tr></table></figure>\n<h2 id=\"REST-API\"><a href=\"#REST-API\" class=\"headerlink\" title=\"REST API\"></a>REST API</h2><p>基于Jersey实现，主要以appId[appname]和instanceId为操作维度，内容可以是xml或者json。相关的实现可以在<code>com.netflix.eureka.resources</code>包中找到。基于appId和instanceId和各种操作组合的实现，可以认为是InstanceRegistry的操作入口。</p>\n<h2 id=\"InstanceRegistry\"><a href=\"#InstanceRegistry\" class=\"headerlink\" title=\"InstanceRegistry\"></a>InstanceRegistry</h2><p>Registry是Eureka Server的核心，服务发现就是围绕Registry来实现。以下提到的类都可以在<code>com.netflix.eureka.registry</code>包中找到。</p>\n<p>整个Registry由4个接口组成：</p>\n<ul>\n<li>LeaseManager: register,cacel,renew,evict等基本操作</li>\n<li>LookupService: 这个抽象是要是client和server端共用，EurekaClient也继承了该接口，主要用来查找服务和服务实例。</li>\n<li>InstanceRegistry: 提供了实例相关的丰富的操作。</li>\n<li>PeerAwareInstanceRegistry: eureka server之间的注册信息复制</li>\n</ul>\n<p>如下是类关系图：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/eureka_registry.png\" alt=\"\"></p>\n<h2 id=\"几个重要的定时任务\"><a href=\"#几个重要的定时任务\" class=\"headerlink\" title=\"几个重要的定时任务\"></a>几个重要的定时任务</h2><h3 id=\"心跳补偿任务EvictionTask\"><a href=\"#心跳补偿任务EvictionTask\" class=\"headerlink\" title=\"心跳补偿任务EvictionTask\"></a>心跳补偿任务EvictionTask</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[com.netflix.eureka.registry.AbstractInstanceRegistry.EvictionTask]</div></pre></td></tr></table></figure>\n<p>主要是用来做心跳补偿，目的是用来取消或清理过期的注册信息，通常是eureka client在停止前未成功发送cacel请求。例如eureka client停止时网络不通了、eureka client进程奔溃了等等。</p>\n<p>这个定时任务是通过<code>eureka.server.eviction-interval-timer-in-ms</code>参数来配置处理间隔，默认是60s。</p>\n<p>补偿时间=当前时间-该任务最后执行时间-执行间隔<br>其中<code>该任务最后执行时间-执行间隔</code>主要是计算出实际执行时间的细微差别，也为后面的<code>补偿时间&gt;0</code>埋下伏笔。</p>\n<p><code>补偿时间&gt;0</code>或者<code>最后更新时间 + leaseDuration[默认是90s，客户端durationInSecs]+补偿时间&lt;当前时间</code> 时会执行evict清理过期实例。</p>\n<p><strong>补偿时间&gt;0,</strong> 即就是当前任务执行和上次执行的时间间隔大于配置的时间间隔，正常情况补偿时间应该很小。</p>\n<p><strong>最后更新时间+leaseDuration+补偿时间&lt;当前时间</strong>，即就是最后一次成功心跳到当前时间的间隔比eureka client配置的间隔大。</p>\n<p>其中<strong>leaseDuration</strong>: 在eureka client中通过<code>eureka.instance.lease-expiration-duration-in-seconds[leaseExpirationDurationInSeconds]</code>参数来配置，默认是90s。</p>\n<p>下面是源代码：</p>\n<p><strong>计算补偿时间：</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">getCompensationTimeMs</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">long</span> currNanos = getCurrentTimeNano();</div><div class=\"line\">            <span class=\"keyword\">long</span> lastNanos = lastExecutionNanosRef.getAndSet(currNanos);</div><div class=\"line\">            <span class=\"keyword\">if</span> (lastNanos == <span class=\"number\">0l</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"number\">0l</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"keyword\">long</span> elapsedMs = TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);</div><div class=\"line\">            <span class=\"keyword\">long</span> compensationTime = elapsedMs - serverConfig.getEvictionIntervalTimerInMs();</div><div class=\"line\">            <span class=\"keyword\">return</span> compensationTime &lt;= <span class=\"number\">0l</span> ? <span class=\"number\">0l</span> : compensationTime;</div><div class=\"line\">        &#125;</div></pre></td></tr></table></figure>\n<p><strong>这个是补偿清理逻辑：</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">evict</span><span class=\"params\">(<span class=\"keyword\">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class=\"line\">        logger.debug(<span class=\"string\">\"Running the evict task\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (!isLeaseExpirationEnabled()) &#123;</div><div class=\"line\">            logger.debug(<span class=\"string\">\"DS: lease expiration is currently disabled.\"</span>);</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// We collect first all expired items, to evict them in random order. For large eviction sets,</span></div><div class=\"line\">        <span class=\"comment\">// if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,</span></div><div class=\"line\">        <span class=\"comment\">// the impact should be evenly distributed across all applications.</span></div><div class=\"line\">        List&lt;Lease&lt;InstanceInfo&gt;&gt; expiredLeases = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\">        <span class=\"keyword\">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; groupEntry : registry.entrySet()) &#123;</div><div class=\"line\">            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseMap = groupEntry.getValue();</div><div class=\"line\">            <span class=\"keyword\">if</span> (leaseMap != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseEntry : leaseMap.entrySet()) &#123;</div><div class=\"line\">                    Lease&lt;InstanceInfo&gt; lease = leaseEntry.getValue();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (lease.isExpired(additionalLeaseMs) &amp;&amp; lease.getHolder() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        expiredLeases.add(lease);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// To compensate for GC pauses or drifting local time, we need to use current registry size as a base for</span></div><div class=\"line\">        <span class=\"comment\">// triggering self-preservation. Without that we would wipe out full registry.</span></div><div class=\"line\">        <span class=\"keyword\">int</span> registrySize = (<span class=\"keyword\">int</span>) getLocalRegistrySize();</div><div class=\"line\">        <span class=\"keyword\">int</span> registrySizeThreshold = (<span class=\"keyword\">int</span>) (registrySize * serverConfig.getRenewalPercentThreshold());</div><div class=\"line\">        <span class=\"keyword\">int</span> evictionLimit = registrySize - registrySizeThreshold;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">int</span> toEvict = Math.min(expiredLeases.size(), evictionLimit);</div><div class=\"line\">        <span class=\"keyword\">if</span> (toEvict &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            logger.info(<span class=\"string\">\"Evicting &#123;&#125; items (expired=&#123;&#125;, evictionLimit=&#123;&#125;)\"</span>, toEvict, expiredLeases.size(), evictionLimit);</div><div class=\"line\"></div><div class=\"line\">            Random random = <span class=\"keyword\">new</span> Random(System.currentTimeMillis());</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; toEvict; i++) &#123;</div><div class=\"line\">                <span class=\"comment\">// Pick a random item (Knuth shuffle algorithm)</span></div><div class=\"line\">                <span class=\"keyword\">int</span> next = i + random.nextInt(expiredLeases.size() - i);</div><div class=\"line\">                Collections.swap(expiredLeases, i, next);</div><div class=\"line\">                Lease&lt;InstanceInfo&gt; lease = expiredLeases.get(i);</div><div class=\"line\"></div><div class=\"line\">                String appName = lease.getHolder().getAppName();</div><div class=\"line\">                String id = lease.getHolder().getId();</div><div class=\"line\">                EXPIRED.increment();</div><div class=\"line\">                logger.warn(<span class=\"string\">\"DS: Registry: expired lease for &#123;&#125;/&#123;&#125;\"</span>, appName, id);</div><div class=\"line\">                internalCancel(appName, id, <span class=\"keyword\">false</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>从上面的逻辑上看，配置的时间间隔有2个：</p>\n<ul>\n<li>eureka server端：<code>eviction-interval-timer-in-ms</code></li>\n<li>eureka client端：<code>lease-expiration-duration-in-seconds</code></li>\n</ul>\n<p>这2个参数同时作用着清理逻辑，配置时就要注意，<code>eviction-interval-timer-in-ms</code>要比<code>lease-expiration-duration-in-seconds</code>配置的要小，产生的结果就完全不一样。</p>\n<h2 id=\"ResponseCache\"><a href=\"#ResponseCache\" class=\"headerlink\" title=\"ResponseCache\"></a>ResponseCache</h2><p>通过readOnlyCache和readWriteCache实现：</p>\n<ul>\n<li>readOnlyCache: java.util.concurrent.ConcurrentMap</li>\n<li>readWriteCache: com.google.common.cache.LoadingCache</li>\n</ul>\n<p>readWriteCache会自动从registry中更新。</p>\n<p>这个缓存只作用于获取整个注册表和app的实例注册信息。</p>\n<h3 id=\"缓存更新CacheUpdateTask\"><a href=\"#缓存更新CacheUpdateTask\" class=\"headerlink\" title=\"缓存更新CacheUpdateTask\"></a>缓存更新CacheUpdateTask</h3><p>这个任务用来定期更新只读缓存,逻辑上比较简单，定期从读写缓存中取出K/V，比较是否一致，不一致更新。</p>\n<p>更新间隔通过参数<code>eureka.server.response-cache-update-interval-ms</code>来配置，默认是30s。</p>\n<h3 id=\"readWriteCache\"><a href=\"#readWriteCache\" class=\"headerlink\" title=\"readWriteCache\"></a>readWriteCache</h3><p>过期时间通过参数<code>eureka.server.response-cache-auto-expiration-in-seconds</code>来配置，默认是180s。</p>\n<h2 id=\"eureka-Server几个重要的配置\"><a href=\"#eureka-Server几个重要的配置\" class=\"headerlink\" title=\"eureka Server几个重要的配置\"></a>eureka Server几个重要的配置</h2><p>eureka.server.enable-self-preservation</p>\n<p>是否开启自我保护模式，默认为true。</p>\n<p>在开启状态下，Eureka Server会保持</p>\n<p>默认情况下，如果Eureka Server在一定时间内没有接收到某个微服务实例的心跳，Eureka Server将会注销该实例（默认90秒）。但是当网络分区故障发生时，微服务与Eureka Server之间无法正常通信，以上行为可能变得非常危险了——因为微服务本身其实是健康的，此时本不应该注销这个微服务。</p>\n<p>Eureka通过“自我保护模式”来解决这个问题——当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。一旦进入该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该Eureka Server节点会自动退出自我保护模式。</p>\n<p>综上，自我保护模式是一种应对网络异常的安全保护措施。它的架构哲学是宁可同时保留所有微服务（健康的微服务和不健康的微服务都会保留），也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加的健壮、稳定。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">#是否开启自我保护模式，默认为true。</div><div class=\"line\">enableSelfPreservation: true</div><div class=\"line\">#默认是85%</div><div class=\"line\">renewal-percent-threshold: 0.85</div><div class=\"line\">#默认是15分钟</div><div class=\"line\">renewal-threshold-update-interval-ms: 15</div><div class=\"line\">#缓存更新时间，默认30s</div><div class=\"line\">response-cache-update-interval-ms: 10</div><div class=\"line\">#缓存过期时间，默认180s</div><div class=\"line\">response-cache-auto-expiration-in-seconds: 30</div><div class=\"line\"># 实例过期清理时间间隔，默认60秒</div><div class=\"line\">eviction-interval-timer-in-ms: 10</div></pre></td></tr></table></figure>\n<h2 id=\"eureka-client几个重要的配置\"><a href=\"#eureka-client几个重要的配置\" class=\"headerlink\" title=\"eureka client几个重要的配置\"></a>eureka client几个重要的配置</h2><p>eureka.client.registry-fetch-interval-seconds</p>\n<p>表示eureka client间隔多久去拉取服务注册信息，默认为30秒，对于api-gateway，如果要迅速获取服务注册状态，可以缩小该值，比如5秒</p>\n<p>eureka.instance.lease-expiration-duration-in-seconds</p>\n<p>leaseExpirationDurationInSeconds，表示eureka server至上一次收到client的心跳之后，等待下一次心跳的超时时间，在这个时间内若没收到下一次心跳，则将移除该instance。</p>\n<p>默认为90秒<br>如果该值太大，则很可能将流量转发过去的时候，该instance已经不存活了。<br>如果该值设置太小了，则instance则很可能因为临时的网络抖动而被摘除掉。<br>该值至少应该大于leaseRenewalIntervalInSeconds<br>eureka.instance.lease-renewal-interval-in-seconds</p>\n<p>leaseRenewalIntervalInSeconds，表示eureka client发送心跳给server端的频率。如果在leaseExpirationDurationInSeconds后，server端没有收到client的心跳，则将摘除该instance。除此之外，如果该instance实现了HealthCheckCallback，并决定让自己unavailable的话，则该instance也不会接收到流量。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Eureka的相关知识，在之前的《微服务之Eureka服务发现》中已经讲了很多，这里不再重复，本文主要通过Eureka Server源码和配置来阐述Eureka Server的工作原理。</p>\n<p>Eureka提供了一系列REST的API，供Eureka Client来调用，实现服务注册，注销，心跳，状态更新等等操作，参考官网<a href=\"https://github.com/Netflix/eureka/wiki/Eureka-REST-operations\" target=\"_blank\" rel=\"external\">EurekaREst操作</a>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">REST API &lt;Jersey&gt;</div><div class=\"line\">Response Cache &lt;com.google.common.cache.LoadingCache&gt;</div><div class=\"line\">InstanceRegistry &lt;ConcurrentHashMap&gt;</div><div class=\"line\"></div><div class=\"line\">EvictionTimer&lt;java.util.Timer&gt;</div><div class=\"line\">CacheUpdateTask&lt;java.util.Timer&gt;</div></pre></td></tr></table></figure>\n<h2 id=\"REST-API\"><a href=\"#REST-API\" class=\"headerlink\" title=\"REST API\"></a>REST API</h2><p>基于Jersey实现，主要以appId[appname]和instanceId为操作维度，内容可以是xml或者json。相关的实现可以在<code>com.netflix.eureka.resources</code>包中找到。基于appId和instanceId和各种操作组合的实现，可以认为是InstanceRegistry的操作入口。</p>\n<h2 id=\"InstanceRegistry\"><a href=\"#InstanceRegistry\" class=\"headerlink\" title=\"InstanceRegistry\"></a>InstanceRegistry</h2><p>Registry是Eureka Server的核心，服务发现就是围绕Registry来实现。以下提到的类都可以在<code>com.netflix.eureka.registry</code>包中找到。</p>\n<p>整个Registry由4个接口组成：</p>\n<ul>\n<li>LeaseManager: register,cacel,renew,evict等基本操作</li>\n<li>LookupService: 这个抽象是要是client和server端共用，EurekaClient也继承了该接口，主要用来查找服务和服务实例。</li>\n<li>InstanceRegistry: 提供了实例相关的丰富的操作。</li>\n<li>PeerAwareInstanceRegistry: eureka server之间的注册信息复制</li>\n</ul>\n<p>如下是类关系图：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/eureka_registry.png\" alt=\"\"></p>\n<h2 id=\"几个重要的定时任务\"><a href=\"#几个重要的定时任务\" class=\"headerlink\" title=\"几个重要的定时任务\"></a>几个重要的定时任务</h2><h3 id=\"心跳补偿任务EvictionTask\"><a href=\"#心跳补偿任务EvictionTask\" class=\"headerlink\" title=\"心跳补偿任务EvictionTask\"></a>心跳补偿任务EvictionTask</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[com.netflix.eureka.registry.AbstractInstanceRegistry.EvictionTask]</div></pre></td></tr></table></figure>\n<p>主要是用来做心跳补偿，目的是用来取消或清理过期的注册信息，通常是eureka client在停止前未成功发送cacel请求。例如eureka client停止时网络不通了、eureka client进程奔溃了等等。</p>\n<p>这个定时任务是通过<code>eureka.server.eviction-interval-timer-in-ms</code>参数来配置处理间隔，默认是60s。</p>\n<p>补偿时间=当前时间-该任务最后执行时间-执行间隔<br>其中<code>该任务最后执行时间-执行间隔</code>主要是计算出实际执行时间的细微差别，也为后面的<code>补偿时间&gt;0</code>埋下伏笔。</p>\n<p><code>补偿时间&gt;0</code>或者<code>最后更新时间 + leaseDuration[默认是90s，客户端durationInSecs]+补偿时间&lt;当前时间</code> 时会执行evict清理过期实例。</p>\n<p><strong>补偿时间&gt;0,</strong> 即就是当前任务执行和上次执行的时间间隔大于配置的时间间隔，正常情况补偿时间应该很小。</p>\n<p><strong>最后更新时间+leaseDuration+补偿时间&lt;当前时间</strong>，即就是最后一次成功心跳到当前时间的间隔比eureka client配置的间隔大。</p>\n<p>其中<strong>leaseDuration</strong>: 在eureka client中通过<code>eureka.instance.lease-expiration-duration-in-seconds[leaseExpirationDurationInSeconds]</code>参数来配置，默认是90s。</p>\n<p>下面是源代码：</p>\n<p><strong>计算补偿时间：</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">getCompensationTimeMs</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">            <span class=\"keyword\">long</span> currNanos = getCurrentTimeNano();</div><div class=\"line\">            <span class=\"keyword\">long</span> lastNanos = lastExecutionNanosRef.getAndSet(currNanos);</div><div class=\"line\">            <span class=\"keyword\">if</span> (lastNanos == <span class=\"number\">0l</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"number\">0l</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\"></div><div class=\"line\">            <span class=\"keyword\">long</span> elapsedMs = TimeUnit.NANOSECONDS.toMillis(currNanos - lastNanos);</div><div class=\"line\">            <span class=\"keyword\">long</span> compensationTime = elapsedMs - serverConfig.getEvictionIntervalTimerInMs();</div><div class=\"line\">            <span class=\"keyword\">return</span> compensationTime &lt;= <span class=\"number\">0l</span> ? <span class=\"number\">0l</span> : compensationTime;</div><div class=\"line\">        &#125;</div></pre></td></tr></table></figure>\n<p><strong>这个是补偿清理逻辑：</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">evict</span><span class=\"params\">(<span class=\"keyword\">long</span> additionalLeaseMs)</span> </span>&#123;</div><div class=\"line\">        logger.debug(<span class=\"string\">\"Running the evict task\"</span>);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (!isLeaseExpirationEnabled()) &#123;</div><div class=\"line\">            logger.debug(<span class=\"string\">\"DS: lease expiration is currently disabled.\"</span>);</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// We collect first all expired items, to evict them in random order. For large eviction sets,</span></div><div class=\"line\">        <span class=\"comment\">// if we do not that, we might wipe out whole apps before self preservation kicks in. By randomizing it,</span></div><div class=\"line\">        <span class=\"comment\">// the impact should be evenly distributed across all applications.</span></div><div class=\"line\">        List&lt;Lease&lt;InstanceInfo&gt;&gt; expiredLeases = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</div><div class=\"line\">        <span class=\"keyword\">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; groupEntry : registry.entrySet()) &#123;</div><div class=\"line\">            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseMap = groupEntry.getValue();</div><div class=\"line\">            <span class=\"keyword\">if</span> (leaseMap != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseEntry : leaseMap.entrySet()) &#123;</div><div class=\"line\">                    Lease&lt;InstanceInfo&gt; lease = leaseEntry.getValue();</div><div class=\"line\">                    <span class=\"keyword\">if</span> (lease.isExpired(additionalLeaseMs) &amp;&amp; lease.getHolder() != <span class=\"keyword\">null</span>) &#123;</div><div class=\"line\">                        expiredLeases.add(lease);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// To compensate for GC pauses or drifting local time, we need to use current registry size as a base for</span></div><div class=\"line\">        <span class=\"comment\">// triggering self-preservation. Without that we would wipe out full registry.</span></div><div class=\"line\">        <span class=\"keyword\">int</span> registrySize = (<span class=\"keyword\">int</span>) getLocalRegistrySize();</div><div class=\"line\">        <span class=\"keyword\">int</span> registrySizeThreshold = (<span class=\"keyword\">int</span>) (registrySize * serverConfig.getRenewalPercentThreshold());</div><div class=\"line\">        <span class=\"keyword\">int</span> evictionLimit = registrySize - registrySizeThreshold;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">int</span> toEvict = Math.min(expiredLeases.size(), evictionLimit);</div><div class=\"line\">        <span class=\"keyword\">if</span> (toEvict &gt; <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            logger.info(<span class=\"string\">\"Evicting &#123;&#125; items (expired=&#123;&#125;, evictionLimit=&#123;&#125;)\"</span>, toEvict, expiredLeases.size(), evictionLimit);</div><div class=\"line\"></div><div class=\"line\">            Random random = <span class=\"keyword\">new</span> Random(System.currentTimeMillis());</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; toEvict; i++) &#123;</div><div class=\"line\">                <span class=\"comment\">// Pick a random item (Knuth shuffle algorithm)</span></div><div class=\"line\">                <span class=\"keyword\">int</span> next = i + random.nextInt(expiredLeases.size() - i);</div><div class=\"line\">                Collections.swap(expiredLeases, i, next);</div><div class=\"line\">                Lease&lt;InstanceInfo&gt; lease = expiredLeases.get(i);</div><div class=\"line\"></div><div class=\"line\">                String appName = lease.getHolder().getAppName();</div><div class=\"line\">                String id = lease.getHolder().getId();</div><div class=\"line\">                EXPIRED.increment();</div><div class=\"line\">                logger.warn(<span class=\"string\">\"DS: Registry: expired lease for &#123;&#125;/&#123;&#125;\"</span>, appName, id);</div><div class=\"line\">                internalCancel(appName, id, <span class=\"keyword\">false</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>从上面的逻辑上看，配置的时间间隔有2个：</p>\n<ul>\n<li>eureka server端：<code>eviction-interval-timer-in-ms</code></li>\n<li>eureka client端：<code>lease-expiration-duration-in-seconds</code></li>\n</ul>\n<p>这2个参数同时作用着清理逻辑，配置时就要注意，<code>eviction-interval-timer-in-ms</code>要比<code>lease-expiration-duration-in-seconds</code>配置的要小，产生的结果就完全不一样。</p>\n<h2 id=\"ResponseCache\"><a href=\"#ResponseCache\" class=\"headerlink\" title=\"ResponseCache\"></a>ResponseCache</h2><p>通过readOnlyCache和readWriteCache实现：</p>\n<ul>\n<li>readOnlyCache: java.util.concurrent.ConcurrentMap</li>\n<li>readWriteCache: com.google.common.cache.LoadingCache</li>\n</ul>\n<p>readWriteCache会自动从registry中更新。</p>\n<p>这个缓存只作用于获取整个注册表和app的实例注册信息。</p>\n<h3 id=\"缓存更新CacheUpdateTask\"><a href=\"#缓存更新CacheUpdateTask\" class=\"headerlink\" title=\"缓存更新CacheUpdateTask\"></a>缓存更新CacheUpdateTask</h3><p>这个任务用来定期更新只读缓存,逻辑上比较简单，定期从读写缓存中取出K/V，比较是否一致，不一致更新。</p>\n<p>更新间隔通过参数<code>eureka.server.response-cache-update-interval-ms</code>来配置，默认是30s。</p>\n<h3 id=\"readWriteCache\"><a href=\"#readWriteCache\" class=\"headerlink\" title=\"readWriteCache\"></a>readWriteCache</h3><p>过期时间通过参数<code>eureka.server.response-cache-auto-expiration-in-seconds</code>来配置，默认是180s。</p>\n<h2 id=\"eureka-Server几个重要的配置\"><a href=\"#eureka-Server几个重要的配置\" class=\"headerlink\" title=\"eureka Server几个重要的配置\"></a>eureka Server几个重要的配置</h2><p>eureka.server.enable-self-preservation</p>\n<p>是否开启自我保护模式，默认为true。</p>\n<p>在开启状态下，Eureka Server会保持</p>\n<p>默认情况下，如果Eureka Server在一定时间内没有接收到某个微服务实例的心跳，Eureka Server将会注销该实例（默认90秒）。但是当网络分区故障发生时，微服务与Eureka Server之间无法正常通信，以上行为可能变得非常危险了——因为微服务本身其实是健康的，此时本不应该注销这个微服务。</p>\n<p>Eureka通过“自我保护模式”来解决这个问题——当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。一旦进入该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该Eureka Server节点会自动退出自我保护模式。</p>\n<p>综上，自我保护模式是一种应对网络异常的安全保护措施。它的架构哲学是宁可同时保留所有微服务（健康的微服务和不健康的微服务都会保留），也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加的健壮、稳定。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">#是否开启自我保护模式，默认为true。</div><div class=\"line\">enableSelfPreservation: true</div><div class=\"line\">#默认是85%</div><div class=\"line\">renewal-percent-threshold: 0.85</div><div class=\"line\">#默认是15分钟</div><div class=\"line\">renewal-threshold-update-interval-ms: 15</div><div class=\"line\">#缓存更新时间，默认30s</div><div class=\"line\">response-cache-update-interval-ms: 10</div><div class=\"line\">#缓存过期时间，默认180s</div><div class=\"line\">response-cache-auto-expiration-in-seconds: 30</div><div class=\"line\"># 实例过期清理时间间隔，默认60秒</div><div class=\"line\">eviction-interval-timer-in-ms: 10</div></pre></td></tr></table></figure>\n<h2 id=\"eureka-client几个重要的配置\"><a href=\"#eureka-client几个重要的配置\" class=\"headerlink\" title=\"eureka client几个重要的配置\"></a>eureka client几个重要的配置</h2><p>eureka.client.registry-fetch-interval-seconds</p>\n<p>表示eureka client间隔多久去拉取服务注册信息，默认为30秒，对于api-gateway，如果要迅速获取服务注册状态，可以缩小该值，比如5秒</p>\n<p>eureka.instance.lease-expiration-duration-in-seconds</p>\n<p>leaseExpirationDurationInSeconds，表示eureka server至上一次收到client的心跳之后，等待下一次心跳的超时时间，在这个时间内若没收到下一次心跳，则将移除该instance。</p>\n<p>默认为90秒<br>如果该值太大，则很可能将流量转发过去的时候，该instance已经不存活了。<br>如果该值设置太小了，则instance则很可能因为临时的网络抖动而被摘除掉。<br>该值至少应该大于leaseRenewalIntervalInSeconds<br>eureka.instance.lease-renewal-interval-in-seconds</p>\n<p>leaseRenewalIntervalInSeconds，表示eureka client发送心跳给server端的频率。如果在leaseExpirationDurationInSeconds后，server端没有收到client的心跳，则将摘除该instance。除此之外，如果该instance实现了HealthCheckCallback，并决定让自己unavailable的话，则该instance也不会接收到流量。</p>\n"},{"title":"微服务之spring-cloud分布式外部化和中心化配置管理","thumbnail":"images/m1.jpg","date":"2016-09-08T11:22:47.000Z","keywords":["微服务","Spring Cloud","Spring Boot","分布式配置管理"],"description":null,"_content":"\n![DPP_0001.jpg](http://upload-images.jianshu.io/upload_images/2519252-16f4dd62aebd0502.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n微服务化之后，应用的数量剧增，零时需要调整配置参数时，无论是运维直接在服务器上修改还是工程中修改配置后重新打包部署，对运维来说工作量是巨大的，而且人为的操作会加大出错的几率，那么外化和中心化配置可以更好的解决分布式环境的配置问题。Spring Cloud提供了2种方式的外化配置：\n\n1. Spring Cloud Config 通过本地文件系统，git/svn仓库来管理配置文件，可以满足基本外化需求，但不能精细的管理配置项。\n2. Spring Cloud Zookeeper Config 通过Zookeeper分级命名空间来储存配置项数据，并且支持基础上下文和profile命名空间，另外Zookeeper可以实时监听节点变化和通知机制，应该是首选。\n\nSpring Cloud Zookeeper Config提供的功能：\n\n- 和Spring Boot无缝集成，能完全无缝替代properties或yml文件的配置。\n- 支持默认上下文命名空间。\n- 支持profile命名空间。\n- 支持应用名称命名空间。\n- 命名空间上支持配置的继承。\n- 支持更改实时通知和endpoint `/refresh`被动刷新，该特性不太好用。\n\nSpring Cloud Zookeeper Config 基本能满足要求了，但其实时通知机制会造成应用暂停体验不好，需要初始化操作的配置（比如数据库连接池，http连接池等）实时更新的意义不大。需要实时更新的是那些在运行时从配置缓存中实时获取的参数，因此在此基础上增加基于Spring Cloud Zookeeper Config和CuratorFramework的实时通知组件，基本设计思路是这样的：\n\n1. 每一个需要动态更新的节点下增加push_status节点，任意值。\n2. 监听push_status节点的值变事件（NodeDataChanged）。\n3. 当修改push_status节点值时，会通知所有监听该节点的应用端。\n4. 应用端收到NodeDataChanged事件，递归获取push_status节点下所有的节点数据，并更新配置缓存。\n","source":"_posts/微服务/微服务之spring-cloud分布式外部化和中心化配置管理.md","raw":"---\ntitle: 微服务之spring-cloud分布式外部化和中心化配置管理\nthumbnail: 'images/m1.jpg'\ndate: 2016-09-08 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- spring-cloud\n\t- 微服务\n\t- Spring Boot\n\t- 分布式配置管理\nkeywords:\n\t- 微服务\n\t- Spring Cloud\n\t- Spring Boot\n\t- 分布式配置管理\ndescription:\n---\n\n![DPP_0001.jpg](http://upload-images.jianshu.io/upload_images/2519252-16f4dd62aebd0502.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n微服务化之后，应用的数量剧增，零时需要调整配置参数时，无论是运维直接在服务器上修改还是工程中修改配置后重新打包部署，对运维来说工作量是巨大的，而且人为的操作会加大出错的几率，那么外化和中心化配置可以更好的解决分布式环境的配置问题。Spring Cloud提供了2种方式的外化配置：\n\n1. Spring Cloud Config 通过本地文件系统，git/svn仓库来管理配置文件，可以满足基本外化需求，但不能精细的管理配置项。\n2. Spring Cloud Zookeeper Config 通过Zookeeper分级命名空间来储存配置项数据，并且支持基础上下文和profile命名空间，另外Zookeeper可以实时监听节点变化和通知机制，应该是首选。\n\nSpring Cloud Zookeeper Config提供的功能：\n\n- 和Spring Boot无缝集成，能完全无缝替代properties或yml文件的配置。\n- 支持默认上下文命名空间。\n- 支持profile命名空间。\n- 支持应用名称命名空间。\n- 命名空间上支持配置的继承。\n- 支持更改实时通知和endpoint `/refresh`被动刷新，该特性不太好用。\n\nSpring Cloud Zookeeper Config 基本能满足要求了，但其实时通知机制会造成应用暂停体验不好，需要初始化操作的配置（比如数据库连接池，http连接池等）实时更新的意义不大。需要实时更新的是那些在运行时从配置缓存中实时获取的参数，因此在此基础上增加基于Spring Cloud Zookeeper Config和CuratorFramework的实时通知组件，基本设计思路是这样的：\n\n1. 每一个需要动态更新的节点下增加push_status节点，任意值。\n2. 监听push_status节点的值变事件（NodeDataChanged）。\n3. 当修改push_status节点值时，会通知所有监听该节点的应用端。\n4. 应用端收到NodeDataChanged事件，递归获取push_status节点下所有的节点数据，并更新配置缓存。\n","slug":"微服务/微服务之spring-cloud分布式外部化和中心化配置管理","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0w002iz29kdbgmz76o","content":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-16f4dd62aebd0502.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"DPP_0001.jpg\"></p>\n<p>微服务化之后，应用的数量剧增，零时需要调整配置参数时，无论是运维直接在服务器上修改还是工程中修改配置后重新打包部署，对运维来说工作量是巨大的，而且人为的操作会加大出错的几率，那么外化和中心化配置可以更好的解决分布式环境的配置问题。Spring Cloud提供了2种方式的外化配置：</p>\n<ol>\n<li>Spring Cloud Config 通过本地文件系统，git/svn仓库来管理配置文件，可以满足基本外化需求，但不能精细的管理配置项。</li>\n<li>Spring Cloud Zookeeper Config 通过Zookeeper分级命名空间来储存配置项数据，并且支持基础上下文和profile命名空间，另外Zookeeper可以实时监听节点变化和通知机制，应该是首选。</li>\n</ol>\n<p>Spring Cloud Zookeeper Config提供的功能：</p>\n<ul>\n<li>和Spring Boot无缝集成，能完全无缝替代properties或yml文件的配置。</li>\n<li>支持默认上下文命名空间。</li>\n<li>支持profile命名空间。</li>\n<li>支持应用名称命名空间。</li>\n<li>命名空间上支持配置的继承。</li>\n<li>支持更改实时通知和endpoint <code>/refresh</code>被动刷新，该特性不太好用。</li>\n</ul>\n<p>Spring Cloud Zookeeper Config 基本能满足要求了，但其实时通知机制会造成应用暂停体验不好，需要初始化操作的配置（比如数据库连接池，http连接池等）实时更新的意义不大。需要实时更新的是那些在运行时从配置缓存中实时获取的参数，因此在此基础上增加基于Spring Cloud Zookeeper Config和CuratorFramework的实时通知组件，基本设计思路是这样的：</p>\n<ol>\n<li>每一个需要动态更新的节点下增加push_status节点，任意值。</li>\n<li>监听push_status节点的值变事件（NodeDataChanged）。</li>\n<li>当修改push_status节点值时，会通知所有监听该节点的应用端。</li>\n<li>应用端收到NodeDataChanged事件，递归获取push_status节点下所有的节点数据，并更新配置缓存。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-16f4dd62aebd0502.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"DPP_0001.jpg\"></p>\n<p>微服务化之后，应用的数量剧增，零时需要调整配置参数时，无论是运维直接在服务器上修改还是工程中修改配置后重新打包部署，对运维来说工作量是巨大的，而且人为的操作会加大出错的几率，那么外化和中心化配置可以更好的解决分布式环境的配置问题。Spring Cloud提供了2种方式的外化配置：</p>\n<ol>\n<li>Spring Cloud Config 通过本地文件系统，git/svn仓库来管理配置文件，可以满足基本外化需求，但不能精细的管理配置项。</li>\n<li>Spring Cloud Zookeeper Config 通过Zookeeper分级命名空间来储存配置项数据，并且支持基础上下文和profile命名空间，另外Zookeeper可以实时监听节点变化和通知机制，应该是首选。</li>\n</ol>\n<p>Spring Cloud Zookeeper Config提供的功能：</p>\n<ul>\n<li>和Spring Boot无缝集成，能完全无缝替代properties或yml文件的配置。</li>\n<li>支持默认上下文命名空间。</li>\n<li>支持profile命名空间。</li>\n<li>支持应用名称命名空间。</li>\n<li>命名空间上支持配置的继承。</li>\n<li>支持更改实时通知和endpoint <code>/refresh</code>被动刷新，该特性不太好用。</li>\n</ul>\n<p>Spring Cloud Zookeeper Config 基本能满足要求了，但其实时通知机制会造成应用暂停体验不好，需要初始化操作的配置（比如数据库连接池，http连接池等）实时更新的意义不大。需要实时更新的是那些在运行时从配置缓存中实时获取的参数，因此在此基础上增加基于Spring Cloud Zookeeper Config和CuratorFramework的实时通知组件，基本设计思路是这样的：</p>\n<ol>\n<li>每一个需要动态更新的节点下增加push_status节点，任意值。</li>\n<li>监听push_status节点的值变事件（NodeDataChanged）。</li>\n<li>当修改push_status节点值时，会通知所有监听该节点的应用端。</li>\n<li>应用端收到NodeDataChanged事件，递归获取push_status节点下所有的节点数据，并更新配置缓存。</li>\n</ol>\n"},{"title":"微服务之微","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60606-200127.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30","date":"2016-06-02T01:20:00.000Z","keywords":null,"description":null,"_content":" \n \n\n\n 单一职责\n","source":"_posts/微服务/微服务之微.md","raw":"---\ntitle: 微服务之微\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60606-200127.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30'\ndate: 2016-06-02 09:20:00\ncategories:\n\t- 微服务 \ntags:\n\t- 微服务\nkeywords:\ndescription:\n---\n \n \n\n\n 单一职责\n","slug":"微服务/微服务之微","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc0y002pz29kpu2h00zd","content":"<p> 单一职责</p>\n","site":{"data":{}},"excerpt":"","more":"<p> 单一职责</p>\n"},{"title":"微服务优缺点论述","thumbnail":"images/m1.jpg","date":"2016-09-10T11:22:47.000Z","keywords":["微服务","Spring Cloud","Spring Boot"],"description":null,"_content":"\n![IMG_20161026_142532.jpg](http://upload-images.jianshu.io/upload_images/2519252-a51def43c01ae44e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)\n\n随着业务发展，业务功能的堆叠和复杂化，团队壮大，代码量也增加，各种问题开始凸显：\n\n* 代码结构开始变得混乱，难以管理，提交冲突，改一处引多处。\n* 沟通成本变高。\n* 代码维护难：“修复越多，缺陷越多”。\n* 引入和集成技术变得困难，依赖版本冲突，新特性无法使用。\n\n最后开发效率也开始下降，代码维护的成本提高。\n\n上线后稳定性不高，更大几率的影响可靠性和可用性，所有功能都运行在一个进程中，任何一个功能中出现bug，比如内存泄露，逻辑死循环耗尽CPU等，可以导致整个应用挂掉。\n其中几个高并发功能，也不得不部署将所有功能增加部署实例，内存和CPU利用不够充分，灵活性也变差。\n\n其缺点也很明显：\n\n- 运维工作量增加，应用运维管理复杂。\n- 代码重复率增加，团队自治带来的重复劳动。\n- 分布式系统固有的复杂性和缺点：网络延迟，不可靠，负载均衡，调用，事务等等\n\n微服务架构可以从一定程度上解决或缓解上述问题，但它也不是万能的，但也带来了一系列的非功能性需求，比如说分布式事务、自动化运维，服务发现，服务路由等额外需求，但其带来的好处以及克服其缺点总结如下：\n\n- 服务发现带来很多自运维特性。\n- 单一职责原则在各种各种场景的解耦合\n- 业务开发：只关注小团队所熟悉和负责的业务，做到专而精，并且容易实现持续交付。\n- 代码管理：无论多git repository还是多maven module都可以做到一般的代码隔离，尤其是积累很多年的代码，拆分后更清晰不混乱，易管理。\n- 技术实现：处理的业务不同，可能会采取不同的技术栈，如果是单体，依赖有冲突的时候不得不花时间fix冲突或者妥协放弃集成。微服务拆分后，相互独立，集成新技术更容易。\n- 测试：尤其是对单元测试和自动化测试更有好处，但对于整个集成测试却带来了挑战，通过可视化运维系统和一个完整的测试环境搭建，以及架构上适当调整，成熟化测试环境后，可以弥补这种不便。\n- 独立部署，快速而出错几率比较低，但运维量比较大，但通过可视化自动运维系统来克服。\n- 运行时的隔离，这个是显而易见的，就跟汽车道路一样，谁跑谁的道，互补干扰。\n- 分布式事务也有很多成熟的参考方案来解决：补偿型，可靠事件型，TCC型等。\n- 服务调用上，可以通过超时、隔离、服务发现负载均衡提高可用性和可靠性。\n- 网络延迟，可以采用轻量级协议和连接池技术等来弥补。\n","source":"_posts/微服务/微服务优缺点论述.md","raw":"---\ntitle: 微服务优缺点论述\nthumbnail: 'images/m1.jpg'\ndate: 2016-09-10 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- spring-cloud\n\t- 微服务\n\t- Spring Boot\nkeywords:\n\t- 微服务\n\t- Spring Cloud\n\t- Spring Boot\ndescription:\n---\n\n![IMG_20161026_142532.jpg](http://upload-images.jianshu.io/upload_images/2519252-a51def43c01ae44e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)\n\n随着业务发展，业务功能的堆叠和复杂化，团队壮大，代码量也增加，各种问题开始凸显：\n\n* 代码结构开始变得混乱，难以管理，提交冲突，改一处引多处。\n* 沟通成本变高。\n* 代码维护难：“修复越多，缺陷越多”。\n* 引入和集成技术变得困难，依赖版本冲突，新特性无法使用。\n\n最后开发效率也开始下降，代码维护的成本提高。\n\n上线后稳定性不高，更大几率的影响可靠性和可用性，所有功能都运行在一个进程中，任何一个功能中出现bug，比如内存泄露，逻辑死循环耗尽CPU等，可以导致整个应用挂掉。\n其中几个高并发功能，也不得不部署将所有功能增加部署实例，内存和CPU利用不够充分，灵活性也变差。\n\n其缺点也很明显：\n\n- 运维工作量增加，应用运维管理复杂。\n- 代码重复率增加，团队自治带来的重复劳动。\n- 分布式系统固有的复杂性和缺点：网络延迟，不可靠，负载均衡，调用，事务等等\n\n微服务架构可以从一定程度上解决或缓解上述问题，但它也不是万能的，但也带来了一系列的非功能性需求，比如说分布式事务、自动化运维，服务发现，服务路由等额外需求，但其带来的好处以及克服其缺点总结如下：\n\n- 服务发现带来很多自运维特性。\n- 单一职责原则在各种各种场景的解耦合\n- 业务开发：只关注小团队所熟悉和负责的业务，做到专而精，并且容易实现持续交付。\n- 代码管理：无论多git repository还是多maven module都可以做到一般的代码隔离，尤其是积累很多年的代码，拆分后更清晰不混乱，易管理。\n- 技术实现：处理的业务不同，可能会采取不同的技术栈，如果是单体，依赖有冲突的时候不得不花时间fix冲突或者妥协放弃集成。微服务拆分后，相互独立，集成新技术更容易。\n- 测试：尤其是对单元测试和自动化测试更有好处，但对于整个集成测试却带来了挑战，通过可视化运维系统和一个完整的测试环境搭建，以及架构上适当调整，成熟化测试环境后，可以弥补这种不便。\n- 独立部署，快速而出错几率比较低，但运维量比较大，但通过可视化自动运维系统来克服。\n- 运行时的隔离，这个是显而易见的，就跟汽车道路一样，谁跑谁的道，互补干扰。\n- 分布式事务也有很多成熟的参考方案来解决：补偿型，可靠事件型，TCC型等。\n- 服务调用上，可以通过超时、隔离、服务发现负载均衡提高可用性和可靠性。\n- 网络延迟，可以采用轻量级协议和连接池技术等来弥补。\n","slug":"微服务/微服务优缺点论述","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc10002sz29k0deo29cd","content":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-a51def43c01ae44e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400\" alt=\"IMG_20161026_142532.jpg\"></p>\n<p>随着业务发展，业务功能的堆叠和复杂化，团队壮大，代码量也增加，各种问题开始凸显：</p>\n<ul>\n<li>代码结构开始变得混乱，难以管理，提交冲突，改一处引多处。</li>\n<li>沟通成本变高。</li>\n<li>代码维护难：“修复越多，缺陷越多”。</li>\n<li>引入和集成技术变得困难，依赖版本冲突，新特性无法使用。</li>\n</ul>\n<p>最后开发效率也开始下降，代码维护的成本提高。</p>\n<p>上线后稳定性不高，更大几率的影响可靠性和可用性，所有功能都运行在一个进程中，任何一个功能中出现bug，比如内存泄露，逻辑死循环耗尽CPU等，可以导致整个应用挂掉。<br>其中几个高并发功能，也不得不部署将所有功能增加部署实例，内存和CPU利用不够充分，灵活性也变差。</p>\n<p>其缺点也很明显：</p>\n<ul>\n<li>运维工作量增加，应用运维管理复杂。</li>\n<li>代码重复率增加，团队自治带来的重复劳动。</li>\n<li>分布式系统固有的复杂性和缺点：网络延迟，不可靠，负载均衡，调用，事务等等</li>\n</ul>\n<p>微服务架构可以从一定程度上解决或缓解上述问题，但它也不是万能的，但也带来了一系列的非功能性需求，比如说分布式事务、自动化运维，服务发现，服务路由等额外需求，但其带来的好处以及克服其缺点总结如下：</p>\n<ul>\n<li>服务发现带来很多自运维特性。</li>\n<li>单一职责原则在各种各种场景的解耦合</li>\n<li>业务开发：只关注小团队所熟悉和负责的业务，做到专而精，并且容易实现持续交付。</li>\n<li>代码管理：无论多git repository还是多maven module都可以做到一般的代码隔离，尤其是积累很多年的代码，拆分后更清晰不混乱，易管理。</li>\n<li>技术实现：处理的业务不同，可能会采取不同的技术栈，如果是单体，依赖有冲突的时候不得不花时间fix冲突或者妥协放弃集成。微服务拆分后，相互独立，集成新技术更容易。</li>\n<li>测试：尤其是对单元测试和自动化测试更有好处，但对于整个集成测试却带来了挑战，通过可视化运维系统和一个完整的测试环境搭建，以及架构上适当调整，成熟化测试环境后，可以弥补这种不便。</li>\n<li>独立部署，快速而出错几率比较低，但运维量比较大，但通过可视化自动运维系统来克服。</li>\n<li>运行时的隔离，这个是显而易见的，就跟汽车道路一样，谁跑谁的道，互补干扰。</li>\n<li>分布式事务也有很多成熟的参考方案来解决：补偿型，可靠事件型，TCC型等。</li>\n<li>服务调用上，可以通过超时、隔离、服务发现负载均衡提高可用性和可靠性。</li>\n<li>网络延迟，可以采用轻量级协议和连接池技术等来弥补。</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-a51def43c01ae44e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400\" alt=\"IMG_20161026_142532.jpg\"></p>\n<p>随着业务发展，业务功能的堆叠和复杂化，团队壮大，代码量也增加，各种问题开始凸显：</p>\n<ul>\n<li>代码结构开始变得混乱，难以管理，提交冲突，改一处引多处。</li>\n<li>沟通成本变高。</li>\n<li>代码维护难：“修复越多，缺陷越多”。</li>\n<li>引入和集成技术变得困难，依赖版本冲突，新特性无法使用。</li>\n</ul>\n<p>最后开发效率也开始下降，代码维护的成本提高。</p>\n<p>上线后稳定性不高，更大几率的影响可靠性和可用性，所有功能都运行在一个进程中，任何一个功能中出现bug，比如内存泄露，逻辑死循环耗尽CPU等，可以导致整个应用挂掉。<br>其中几个高并发功能，也不得不部署将所有功能增加部署实例，内存和CPU利用不够充分，灵活性也变差。</p>\n<p>其缺点也很明显：</p>\n<ul>\n<li>运维工作量增加，应用运维管理复杂。</li>\n<li>代码重复率增加，团队自治带来的重复劳动。</li>\n<li>分布式系统固有的复杂性和缺点：网络延迟，不可靠，负载均衡，调用，事务等等</li>\n</ul>\n<p>微服务架构可以从一定程度上解决或缓解上述问题，但它也不是万能的，但也带来了一系列的非功能性需求，比如说分布式事务、自动化运维，服务发现，服务路由等额外需求，但其带来的好处以及克服其缺点总结如下：</p>\n<ul>\n<li>服务发现带来很多自运维特性。</li>\n<li>单一职责原则在各种各种场景的解耦合</li>\n<li>业务开发：只关注小团队所熟悉和负责的业务，做到专而精，并且容易实现持续交付。</li>\n<li>代码管理：无论多git repository还是多maven module都可以做到一般的代码隔离，尤其是积累很多年的代码，拆分后更清晰不混乱，易管理。</li>\n<li>技术实现：处理的业务不同，可能会采取不同的技术栈，如果是单体，依赖有冲突的时候不得不花时间fix冲突或者妥协放弃集成。微服务拆分后，相互独立，集成新技术更容易。</li>\n<li>测试：尤其是对单元测试和自动化测试更有好处，但对于整个集成测试却带来了挑战，通过可视化运维系统和一个完整的测试环境搭建，以及架构上适当调整，成熟化测试环境后，可以弥补这种不便。</li>\n<li>独立部署，快速而出错几率比较低，但运维量比较大，但通过可视化自动运维系统来克服。</li>\n<li>运行时的隔离，这个是显而易见的，就跟汽车道路一样，谁跑谁的道，互补干扰。</li>\n<li>分布式事务也有很多成熟的参考方案来解决：补偿型，可靠事件型，TCC型等。</li>\n<li>服务调用上，可以通过超时、隔离、服务发现负载均衡提高可用性和可靠性。</li>\n<li>网络延迟，可以采用轻量级协议和连接池技术等来弥补。</li>\n</ul>\n"},{"title":"微服务实施spring-cloud中踩过的坑","thumbnail":"images/m1.jpg","date":"2016-09-08T11:22:47.000Z","keywords":["微服务","Spring Cloud","Spring Boot"],"description":null,"_content":"\n![P61023-131735-01.jpg](http://upload-images.jianshu.io/upload_images/2519252-d2cc7d03dc185c51.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n## 注册IP问题\n\n早期的Spring Cloud Eureka在注册获取网卡IP时，不能区分外网网卡和内网网卡，如果安装了虚拟机和docker也不能区分虚拟网卡，每次启动注册的IP都有可能不一样，如果要注册为外网网卡IP，那运行带宽就不够，这个bug应该说是比较严重的问题，因此重写了网卡IP获取的逻辑来解决，同时也反馈给了spring cloud团队，再后期的版本中添加了网卡接口排序和通过名称过滤的功能来得到解决。\n\n## HealthCheck的问题\n\n在一些极小概率的情况下，会导致Eureka Server 下线微服务实例，出现“Remote status from Eureka server is down”的问题，即便是重启微服务也无济于事，不过已经有码友在spring cloud 官方github贴出了解决方法的issue。\n\n## Zookeeper版本带来的性能问题\n\n现象是一个团队在实施微服务时，发现部署到服务器上的微服务，在没有任何请求时，仍然CPU占用20~30%；匪夷所思的是，同样的微服务包在本地开发机器、本地物理机、本地虚拟机运行并未出现。通过jvisualvm观察,如下图：\n\n![](<http://7xiovs.com1.z0.glb.clouddn.com/zk_jvisualvm.png>)\n\n可以看到和Zookeeper有关，同时我的另一个Demo微服务在任何环境下却未出现该问题。比较jar中依赖包之后发现，2个包中唯一不一样的是Apache Curator版本，一个是2.8.0, spring cloud默认依赖的版本；没问题的是Apache Curator 2.9.1。**Apache Curator 2.8.0 BUG！！！**在[Apache Curator 2.9.1 Release Notes](<https://issues.apache.org/jira/secure/ReleaseNote.jspa?projectId=12314425&version= 12332392>也发现了对此bug的描述。升级到2.9.1问题解决，皆大欢喜。同时上报此bug给Spring Cloud团队，升级Apache Curator版本。\n\n## Feign使用不当带来的性能问题\n\nFeign在Spring容器中使用了独立应用上下文，要注意命名空间上隔离，详情参考：[**Feign正确的使用方法和性能优化注意事项**](<http://tietang.wang/2016/09/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Feign%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/>) |http://www.jianshu.com/p/191d45210d16来绕过坑。\n\n这几个坑是不能容忍的，踩过其他小坑就不计其数了，但都不伤大雅，可以替代。\n","source":"_posts/微服务/微服务实施spring-cloud中踩过的坑.md","raw":"---\ntitle: 微服务实施spring-cloud中踩过的坑\nthumbnail: 'images/m1.jpg'\ndate: 2016-09-08 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- spring-cloud\n\t- 微服务\n\t- Spring Boot\nkeywords:\n\t- 微服务\n\t- Spring Cloud\n\t- Spring Boot\ndescription:\n---\n\n![P61023-131735-01.jpg](http://upload-images.jianshu.io/upload_images/2519252-d2cc7d03dc185c51.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\n\n\n## 注册IP问题\n\n早期的Spring Cloud Eureka在注册获取网卡IP时，不能区分外网网卡和内网网卡，如果安装了虚拟机和docker也不能区分虚拟网卡，每次启动注册的IP都有可能不一样，如果要注册为外网网卡IP，那运行带宽就不够，这个bug应该说是比较严重的问题，因此重写了网卡IP获取的逻辑来解决，同时也反馈给了spring cloud团队，再后期的版本中添加了网卡接口排序和通过名称过滤的功能来得到解决。\n\n## HealthCheck的问题\n\n在一些极小概率的情况下，会导致Eureka Server 下线微服务实例，出现“Remote status from Eureka server is down”的问题，即便是重启微服务也无济于事，不过已经有码友在spring cloud 官方github贴出了解决方法的issue。\n\n## Zookeeper版本带来的性能问题\n\n现象是一个团队在实施微服务时，发现部署到服务器上的微服务，在没有任何请求时，仍然CPU占用20~30%；匪夷所思的是，同样的微服务包在本地开发机器、本地物理机、本地虚拟机运行并未出现。通过jvisualvm观察,如下图：\n\n![](<http://7xiovs.com1.z0.glb.clouddn.com/zk_jvisualvm.png>)\n\n可以看到和Zookeeper有关，同时我的另一个Demo微服务在任何环境下却未出现该问题。比较jar中依赖包之后发现，2个包中唯一不一样的是Apache Curator版本，一个是2.8.0, spring cloud默认依赖的版本；没问题的是Apache Curator 2.9.1。**Apache Curator 2.8.0 BUG！！！**在[Apache Curator 2.9.1 Release Notes](<https://issues.apache.org/jira/secure/ReleaseNote.jspa?projectId=12314425&version= 12332392>也发现了对此bug的描述。升级到2.9.1问题解决，皆大欢喜。同时上报此bug给Spring Cloud团队，升级Apache Curator版本。\n\n## Feign使用不当带来的性能问题\n\nFeign在Spring容器中使用了独立应用上下文，要注意命名空间上隔离，详情参考：[**Feign正确的使用方法和性能优化注意事项**](<http://tietang.wang/2016/09/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Feign%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/>) |http://www.jianshu.com/p/191d45210d16来绕过坑。\n\n这几个坑是不能容忍的，踩过其他小坑就不计其数了，但都不伤大雅，可以替代。\n","slug":"微服务/微服务实施spring-cloud中踩过的坑","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc11002xz29ky6q0uck5","content":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-d2cc7d03dc185c51.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"P61023-131735-01.jpg\"></p>\n<h2 id=\"注册IP问题\"><a href=\"#注册IP问题\" class=\"headerlink\" title=\"注册IP问题\"></a>注册IP问题</h2><p>早期的Spring Cloud Eureka在注册获取网卡IP时，不能区分外网网卡和内网网卡，如果安装了虚拟机和docker也不能区分虚拟网卡，每次启动注册的IP都有可能不一样，如果要注册为外网网卡IP，那运行带宽就不够，这个bug应该说是比较严重的问题，因此重写了网卡IP获取的逻辑来解决，同时也反馈给了spring cloud团队，再后期的版本中添加了网卡接口排序和通过名称过滤的功能来得到解决。</p>\n<h2 id=\"HealthCheck的问题\"><a href=\"#HealthCheck的问题\" class=\"headerlink\" title=\"HealthCheck的问题\"></a>HealthCheck的问题</h2><p>在一些极小概率的情况下，会导致Eureka Server 下线微服务实例，出现“Remote status from Eureka server is down”的问题，即便是重启微服务也无济于事，不过已经有码友在spring cloud 官方github贴出了解决方法的issue。</p>\n<h2 id=\"Zookeeper版本带来的性能问题\"><a href=\"#Zookeeper版本带来的性能问题\" class=\"headerlink\" title=\"Zookeeper版本带来的性能问题\"></a>Zookeeper版本带来的性能问题</h2><p>现象是一个团队在实施微服务时，发现部署到服务器上的微服务，在没有任何请求时，仍然CPU占用20~30%；匪夷所思的是，同样的微服务包在本地开发机器、本地物理机、本地虚拟机运行并未出现。通过jvisualvm观察,如下图：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/zk_jvisualvm.png\" alt=\"\"></p>\n<p>可以看到和Zookeeper有关，同时我的另一个Demo微服务在任何环境下却未出现该问题。比较jar中依赖包之后发现，2个包中唯一不一样的是Apache Curator版本，一个是2.8.0, spring cloud默认依赖的版本；没问题的是Apache Curator 2.9.1。<strong>Apache Curator 2.8.0 BUG！！！</strong>在[Apache Curator 2.9.1 Release Notes](<https: 12332392=\"\" issues.apache.org=\"\" jira=\"\" secure=\"\" releasenote.jspa?projectid=\"12314425&version=\">也发现了对此bug的描述。升级到2.9.1问题解决，皆大欢喜。同时上报此bug给Spring Cloud团队，升级Apache Curator版本。</https:></p>\n<h2 id=\"Feign使用不当带来的性能问题\"><a href=\"#Feign使用不当带来的性能问题\" class=\"headerlink\" title=\"Feign使用不当带来的性能问题\"></a>Feign使用不当带来的性能问题</h2><p>Feign在Spring容器中使用了独立应用上下文，要注意命名空间上隔离，详情参考：<a href=\"http://tietang.wang/2016/09/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Feign%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/\"><strong>Feign正确的使用方法和性能优化注意事项</strong></a> |<a href=\"http://www.jianshu.com/p/191d45210d16来绕过坑。\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/p/191d45210d16来绕过坑。</a></p>\n<p>这几个坑是不能容忍的，踩过其他小坑就不计其数了，但都不伤大雅，可以替代。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-d2cc7d03dc185c51.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240\" alt=\"P61023-131735-01.jpg\"></p>\n<h2 id=\"注册IP问题\"><a href=\"#注册IP问题\" class=\"headerlink\" title=\"注册IP问题\"></a>注册IP问题</h2><p>早期的Spring Cloud Eureka在注册获取网卡IP时，不能区分外网网卡和内网网卡，如果安装了虚拟机和docker也不能区分虚拟网卡，每次启动注册的IP都有可能不一样，如果要注册为外网网卡IP，那运行带宽就不够，这个bug应该说是比较严重的问题，因此重写了网卡IP获取的逻辑来解决，同时也反馈给了spring cloud团队，再后期的版本中添加了网卡接口排序和通过名称过滤的功能来得到解决。</p>\n<h2 id=\"HealthCheck的问题\"><a href=\"#HealthCheck的问题\" class=\"headerlink\" title=\"HealthCheck的问题\"></a>HealthCheck的问题</h2><p>在一些极小概率的情况下，会导致Eureka Server 下线微服务实例，出现“Remote status from Eureka server is down”的问题，即便是重启微服务也无济于事，不过已经有码友在spring cloud 官方github贴出了解决方法的issue。</p>\n<h2 id=\"Zookeeper版本带来的性能问题\"><a href=\"#Zookeeper版本带来的性能问题\" class=\"headerlink\" title=\"Zookeeper版本带来的性能问题\"></a>Zookeeper版本带来的性能问题</h2><p>现象是一个团队在实施微服务时，发现部署到服务器上的微服务，在没有任何请求时，仍然CPU占用20~30%；匪夷所思的是，同样的微服务包在本地开发机器、本地物理机、本地虚拟机运行并未出现。通过jvisualvm观察,如下图：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/zk_jvisualvm.png\" alt=\"\"></p>\n<p>可以看到和Zookeeper有关，同时我的另一个Demo微服务在任何环境下却未出现该问题。比较jar中依赖包之后发现，2个包中唯一不一样的是Apache Curator版本，一个是2.8.0, spring cloud默认依赖的版本；没问题的是Apache Curator 2.9.1。<strong>Apache Curator 2.8.0 BUG！！！</strong>在[Apache Curator 2.9.1 Release Notes](<https: 12332392=\"\" issues.apache.org=\"\" jira=\"\" secure=\"\" releasenote.jspa?projectid=\"12314425&version=\">也发现了对此bug的描述。升级到2.9.1问题解决，皆大欢喜。同时上报此bug给Spring Cloud团队，升级Apache Curator版本。</https:></p>\n<h2 id=\"Feign使用不当带来的性能问题\"><a href=\"#Feign使用不当带来的性能问题\" class=\"headerlink\" title=\"Feign使用不当带来的性能问题\"></a>Feign使用不当带来的性能问题</h2><p>Feign在Spring容器中使用了独立应用上下文，要注意命名空间上隔离，详情参考：<a href=\"http://tietang.wang/2016/09/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Feign%E4%BD%BF%E7%94%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/\"><strong>Feign正确的使用方法和性能优化注意事项</strong></a> |<a href=\"http://www.jianshu.com/p/191d45210d16来绕过坑。\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/p/191d45210d16来绕过坑。</a></p>\n<p>这几个坑是不能容忍的，踩过其他小坑就不计其数了，但都不伤大雅，可以替代。</p>\n"},{"title":"微服务拆分实践","thumbnail":"images/m1.jpg","date":"2016-09-08T11:22:47.000Z","keywords":["微服务","Spring Cloud","Spring Boot"],"description":null,"_content":"![IMG_20161026_144514.jpg](http://upload-images.jianshu.io/upload_images/2519252-54c30064a539893e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n\n说到微服务就不得不说拆分了，服务拆分要有一些指导依据。\n\n\n### 拆分依据\n\n微服务的理论知识有大量的分享，这里是我对微服务理论基础认识的一些观点：\n\n* 小，且专注于做一件事情，即满足[单一职责原则](<http://www.infoq.com/cn/articles/single-responsibility-in-software-development>)。 关于单一职责可以阅读我的另一篇文章[《软件开发中的单一职责》](<http://www.infoq.com/cn/articles/single-responsibility-in-software-development>)\n* 运行在独立的进程中。\n* 轻量级的通信机制，RPC或者HTTP或者MQ。\n* 松耦合，独立部署。\n* 康威定律：设计系统的组织，其产生的设计等同于组织之内、组织之间的沟通结构。\n\n\n**服务拆分依据结合上面的理论基础充分考虑了以下因素：**\n\n- 业务和领域模型\n- 技术、业务量等其他因素\n- 团队\n\n业务应该说是最实在的，也是最好理解而且最容易把握的。虽然领域的有界上下文从理论上能指导拆分，但是万万需要拆分的不是一个全新的系统，而是一个在线上稳定运行了很长时间的，很多人一砖一瓦堆砌起来的，并且仍然在持续添砖加瓦，不管是桥梁，还是高楼，我们的目的是让系统运行的更健壮，而不是拆成七零八碎，所对于这样的老系统，用领域拆分需要结合团队现状，理论结合实际，事半功倍。\n\t\t\n运行时隔离也是很重要的拆分依据，会根据一些具有特定功能的API单独拆分出来作为一个微服务，和其他微服务隔离，避免相互影响，避免一个老鼠害了一锅汤。比如一些文件上传一类的API，特征是响应时间长，对IO依赖比较多，其线程池需要特殊配置；比如多线程利用CPU来换取响应时间的等等。\n\n对于康威定理，究竟是团队影响拆分，还是拆分影响团队，那就需要均衡利弊了。如果是因为拆分微服务，而拆分了团队，那势必会影响到团队的稳定性和团队成员的归属感，尤其是一个组建很久的老团队。反之，团队负责多种业务，也没有明显的职责区分，就要考虑是否拆分团队，明确拆分后的团队职责。\n\t\n对于正在运行的系统，如何拆分和拆分为多大的粒度，事实上是不能有太过理论化理想化，更需要深入项目本身和该项目团队，了解业务，人和代码。不能是拆迁队，也不是修缮，应该是拆成各种形状的合理大小的积木。\n\n孰重孰轻很难说明白，团队不一样项目不一样，实践就不一样，找到适合自己团队的方法。\n\n### 拆分粒度\n\n拆分粒度不应该过分追求细粒度，要考虑适中不能过大或过小。按照单一职责原则和康威定律，在业务域、团队还有技术上平衡粒度。拆分后的代码应该是易控制，易维护的，业务职责也是明确单一的。 \n\n### 拆分过程实践\n\n在拆分过程不得不考虑的是业务在跑，砖在砌，不能停，而且拆分工作也必须得进行，过程上不能一部到位，必须一步一步走，也由于此拆分后落地上线也要稳妥。所以，过程上，我也采用了比较稳妥的战术，**先拆分为maven module，然后在拆分为微服务可部署构件**。这样的好处是，拆分过程不影响业务迭代，而且可以随意组合成单体应用和微服务app，并且还可以事先测试和验证拆分，最大限度的降低微服务化实施的风险。\n\n**下面是拆分代码过程实践经验：**\n \n1). **设计module骨架**\n\nmodule骨架的设计是基础，影响最终拆分结果，拆分成功的向导。按照技术，业务，部署打包，测试这几个维度来规划设计，下面是一个参考。\n\n**最终骨架模型：**\n\n```\nroot web app\n\twebapp  //war module，打包为单体war，整体部署\n\tmicro-services //微服务pom module\n\t\tuser-service\n\t\tcustomer-service\n\t\torder-service\n\t\tother-service\n\t\tapi-gateway\n\tbiz //业务相关的module\n\t\tentitys \t\t\t//所有实体类\n\t\tbiz-base\t\t\t//一些无法拆分的代码上有依赖的服务\n\t\tbiz-user\t\t\t//用户业务\n\t\tbiz-customer\t\t//客户业务\n\t\tbiz-order\t\t\t//订单业务\n\t\t...\t\t\t\t\t\n\tcommons\n\t\tasync-framework  //一部框架\n\t\tutils\t\t\t\t//工具类\n\n```\n\n2). **拆分技术commons**\n\n作为第一步，先对整个工程按业务和功能进行了maven多module的拆分。拆分过程没有技巧可言，一步一步走，一步一个脚印。首先是分离出技术上的commons，感觉这应该是最好拆分的了，把相关的类重构到一个包里，在分离出一个module即可。实际过程并非如此，因为是老项目，这类commons也并没有想象的容易，经过很多人的添砖加瓦，并没有完全按照[单一职责原则](<http://www.infoq.com/cn/articles/single-responsibility-in-software-development>)来砌，根本就是把业务特征的代码也放到了技术类代码中，不过review代码后感觉还好，微遵循的毕竟是少数，那就先重构代码，把业务特性的砖从类里移出去。\n\n3). **拆分entity**\n\n很多在业务代码上都会共享entity类，通常没法也没法把entity类分门别类，最简单就是把所有的entity类放到一个module，谁需要谁依赖的原则。entity类也没有太多jar依赖和业务依赖，也不会形成污染源。\n\n4). **公共业务**\n\n同commons和entity方法，不在复述，也被各个业务依赖，这种业务大部分是过渡性的，在未来迭代演进时可以通过其他方式抽象集成。\n\n5). **拆分业务代码**\n\n拆分业务是最痛苦的事情了，这个要看原来的代码整洁度和互相依赖程度，一般采取2中方法：\n\n- 新建业务module，加入基础module的pom依赖，再从源module复制和该业务module相关的代码（包括单元测试代码）过来，解决编译错误和单元测试错误，完成本业务拆分。\n- 从源module复制一个新业务module，保持代码一致，先删除和本义务无关的代码（包括单元测试代码），再删除无关的pom依赖，解决编译错误和单元测试错误，完成本业务拆分。\n\n选择哪种方法，可以根据代码整洁度和互相依赖程度，如果代码很整洁且相互依赖较弱，可以采取前者，否则就采取后者。\n\n6). **拆分微服务**\n\n有了以上的拆分基础，可以在合适的业务迭代将各个微服务module迁移到不同的代码仓库，完成进一步隔离管理。\n","source":"_posts/微服务/微服务拆分实践.md","raw":"---\ntitle: 微服务拆分实践\nthumbnail: 'images/m1.jpg'\ndate: 2016-09-08 19:22:47\ncategories:\n\t- 微服务\ntags:\n\t- spring-cloud\n\t- 微服务\n\t- Spring Boot\nkeywords:\n\t- 微服务\n\t- Spring Cloud\n\t- Spring Boot\ndescription:\n---\n![IMG_20161026_144514.jpg](http://upload-images.jianshu.io/upload_images/2519252-54c30064a539893e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)\n\n\n说到微服务就不得不说拆分了，服务拆分要有一些指导依据。\n\n\n### 拆分依据\n\n微服务的理论知识有大量的分享，这里是我对微服务理论基础认识的一些观点：\n\n* 小，且专注于做一件事情，即满足[单一职责原则](<http://www.infoq.com/cn/articles/single-responsibility-in-software-development>)。 关于单一职责可以阅读我的另一篇文章[《软件开发中的单一职责》](<http://www.infoq.com/cn/articles/single-responsibility-in-software-development>)\n* 运行在独立的进程中。\n* 轻量级的通信机制，RPC或者HTTP或者MQ。\n* 松耦合，独立部署。\n* 康威定律：设计系统的组织，其产生的设计等同于组织之内、组织之间的沟通结构。\n\n\n**服务拆分依据结合上面的理论基础充分考虑了以下因素：**\n\n- 业务和领域模型\n- 技术、业务量等其他因素\n- 团队\n\n业务应该说是最实在的，也是最好理解而且最容易把握的。虽然领域的有界上下文从理论上能指导拆分，但是万万需要拆分的不是一个全新的系统，而是一个在线上稳定运行了很长时间的，很多人一砖一瓦堆砌起来的，并且仍然在持续添砖加瓦，不管是桥梁，还是高楼，我们的目的是让系统运行的更健壮，而不是拆成七零八碎，所对于这样的老系统，用领域拆分需要结合团队现状，理论结合实际，事半功倍。\n\t\t\n运行时隔离也是很重要的拆分依据，会根据一些具有特定功能的API单独拆分出来作为一个微服务，和其他微服务隔离，避免相互影响，避免一个老鼠害了一锅汤。比如一些文件上传一类的API，特征是响应时间长，对IO依赖比较多，其线程池需要特殊配置；比如多线程利用CPU来换取响应时间的等等。\n\n对于康威定理，究竟是团队影响拆分，还是拆分影响团队，那就需要均衡利弊了。如果是因为拆分微服务，而拆分了团队，那势必会影响到团队的稳定性和团队成员的归属感，尤其是一个组建很久的老团队。反之，团队负责多种业务，也没有明显的职责区分，就要考虑是否拆分团队，明确拆分后的团队职责。\n\t\n对于正在运行的系统，如何拆分和拆分为多大的粒度，事实上是不能有太过理论化理想化，更需要深入项目本身和该项目团队，了解业务，人和代码。不能是拆迁队，也不是修缮，应该是拆成各种形状的合理大小的积木。\n\n孰重孰轻很难说明白，团队不一样项目不一样，实践就不一样，找到适合自己团队的方法。\n\n### 拆分粒度\n\n拆分粒度不应该过分追求细粒度，要考虑适中不能过大或过小。按照单一职责原则和康威定律，在业务域、团队还有技术上平衡粒度。拆分后的代码应该是易控制，易维护的，业务职责也是明确单一的。 \n\n### 拆分过程实践\n\n在拆分过程不得不考虑的是业务在跑，砖在砌，不能停，而且拆分工作也必须得进行，过程上不能一部到位，必须一步一步走，也由于此拆分后落地上线也要稳妥。所以，过程上，我也采用了比较稳妥的战术，**先拆分为maven module，然后在拆分为微服务可部署构件**。这样的好处是，拆分过程不影响业务迭代，而且可以随意组合成单体应用和微服务app，并且还可以事先测试和验证拆分，最大限度的降低微服务化实施的风险。\n\n**下面是拆分代码过程实践经验：**\n \n1). **设计module骨架**\n\nmodule骨架的设计是基础，影响最终拆分结果，拆分成功的向导。按照技术，业务，部署打包，测试这几个维度来规划设计，下面是一个参考。\n\n**最终骨架模型：**\n\n```\nroot web app\n\twebapp  //war module，打包为单体war，整体部署\n\tmicro-services //微服务pom module\n\t\tuser-service\n\t\tcustomer-service\n\t\torder-service\n\t\tother-service\n\t\tapi-gateway\n\tbiz //业务相关的module\n\t\tentitys \t\t\t//所有实体类\n\t\tbiz-base\t\t\t//一些无法拆分的代码上有依赖的服务\n\t\tbiz-user\t\t\t//用户业务\n\t\tbiz-customer\t\t//客户业务\n\t\tbiz-order\t\t\t//订单业务\n\t\t...\t\t\t\t\t\n\tcommons\n\t\tasync-framework  //一部框架\n\t\tutils\t\t\t\t//工具类\n\n```\n\n2). **拆分技术commons**\n\n作为第一步，先对整个工程按业务和功能进行了maven多module的拆分。拆分过程没有技巧可言，一步一步走，一步一个脚印。首先是分离出技术上的commons，感觉这应该是最好拆分的了，把相关的类重构到一个包里，在分离出一个module即可。实际过程并非如此，因为是老项目，这类commons也并没有想象的容易，经过很多人的添砖加瓦，并没有完全按照[单一职责原则](<http://www.infoq.com/cn/articles/single-responsibility-in-software-development>)来砌，根本就是把业务特征的代码也放到了技术类代码中，不过review代码后感觉还好，微遵循的毕竟是少数，那就先重构代码，把业务特性的砖从类里移出去。\n\n3). **拆分entity**\n\n很多在业务代码上都会共享entity类，通常没法也没法把entity类分门别类，最简单就是把所有的entity类放到一个module，谁需要谁依赖的原则。entity类也没有太多jar依赖和业务依赖，也不会形成污染源。\n\n4). **公共业务**\n\n同commons和entity方法，不在复述，也被各个业务依赖，这种业务大部分是过渡性的，在未来迭代演进时可以通过其他方式抽象集成。\n\n5). **拆分业务代码**\n\n拆分业务是最痛苦的事情了，这个要看原来的代码整洁度和互相依赖程度，一般采取2中方法：\n\n- 新建业务module，加入基础module的pom依赖，再从源module复制和该业务module相关的代码（包括单元测试代码）过来，解决编译错误和单元测试错误，完成本业务拆分。\n- 从源module复制一个新业务module，保持代码一致，先删除和本义务无关的代码（包括单元测试代码），再删除无关的pom依赖，解决编译错误和单元测试错误，完成本业务拆分。\n\n选择哪种方法，可以根据代码整洁度和互相依赖程度，如果代码很整洁且相互依赖较弱，可以采取前者，否则就采取后者。\n\n6). **拆分微服务**\n\n有了以上的拆分基础，可以在合适的业务迭代将各个微服务module迁移到不同的代码仓库，完成进一步隔离管理。\n","slug":"微服务/微服务拆分实践","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc130032z29k9lz67tx4","content":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-54c30064a539893e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"IMG_20161026_144514.jpg\"></p>\n<p>说到微服务就不得不说拆分了，服务拆分要有一些指导依据。</p>\n<h3 id=\"拆分依据\"><a href=\"#拆分依据\" class=\"headerlink\" title=\"拆分依据\"></a>拆分依据</h3><p>微服务的理论知识有大量的分享，这里是我对微服务理论基础认识的一些观点：</p>\n<ul>\n<li>小，且专注于做一件事情，即满足<a href=\"http://www.infoq.com/cn/articles/single-responsibility-in-software-development\" target=\"_blank\" rel=\"external\">单一职责原则</a>。 关于单一职责可以阅读我的另一篇文章<a href=\"http://www.infoq.com/cn/articles/single-responsibility-in-software-development\" target=\"_blank\" rel=\"external\">《软件开发中的单一职责》</a></li>\n<li>运行在独立的进程中。</li>\n<li>轻量级的通信机制，RPC或者HTTP或者MQ。</li>\n<li>松耦合，独立部署。</li>\n<li>康威定律：设计系统的组织，其产生的设计等同于组织之内、组织之间的沟通结构。</li>\n</ul>\n<p><strong>服务拆分依据结合上面的理论基础充分考虑了以下因素：</strong></p>\n<ul>\n<li>业务和领域模型</li>\n<li>技术、业务量等其他因素</li>\n<li>团队</li>\n</ul>\n<p>业务应该说是最实在的，也是最好理解而且最容易把握的。虽然领域的有界上下文从理论上能指导拆分，但是万万需要拆分的不是一个全新的系统，而是一个在线上稳定运行了很长时间的，很多人一砖一瓦堆砌起来的，并且仍然在持续添砖加瓦，不管是桥梁，还是高楼，我们的目的是让系统运行的更健壮，而不是拆成七零八碎，所对于这样的老系统，用领域拆分需要结合团队现状，理论结合实际，事半功倍。</p>\n<p>运行时隔离也是很重要的拆分依据，会根据一些具有特定功能的API单独拆分出来作为一个微服务，和其他微服务隔离，避免相互影响，避免一个老鼠害了一锅汤。比如一些文件上传一类的API，特征是响应时间长，对IO依赖比较多，其线程池需要特殊配置；比如多线程利用CPU来换取响应时间的等等。</p>\n<p>对于康威定理，究竟是团队影响拆分，还是拆分影响团队，那就需要均衡利弊了。如果是因为拆分微服务，而拆分了团队，那势必会影响到团队的稳定性和团队成员的归属感，尤其是一个组建很久的老团队。反之，团队负责多种业务，也没有明显的职责区分，就要考虑是否拆分团队，明确拆分后的团队职责。</p>\n<p>对于正在运行的系统，如何拆分和拆分为多大的粒度，事实上是不能有太过理论化理想化，更需要深入项目本身和该项目团队，了解业务，人和代码。不能是拆迁队，也不是修缮，应该是拆成各种形状的合理大小的积木。</p>\n<p>孰重孰轻很难说明白，团队不一样项目不一样，实践就不一样，找到适合自己团队的方法。</p>\n<h3 id=\"拆分粒度\"><a href=\"#拆分粒度\" class=\"headerlink\" title=\"拆分粒度\"></a>拆分粒度</h3><p>拆分粒度不应该过分追求细粒度，要考虑适中不能过大或过小。按照单一职责原则和康威定律，在业务域、团队还有技术上平衡粒度。拆分后的代码应该是易控制，易维护的，业务职责也是明确单一的。 </p>\n<h3 id=\"拆分过程实践\"><a href=\"#拆分过程实践\" class=\"headerlink\" title=\"拆分过程实践\"></a>拆分过程实践</h3><p>在拆分过程不得不考虑的是业务在跑，砖在砌，不能停，而且拆分工作也必须得进行，过程上不能一部到位，必须一步一步走，也由于此拆分后落地上线也要稳妥。所以，过程上，我也采用了比较稳妥的战术，<strong>先拆分为maven module，然后在拆分为微服务可部署构件</strong>。这样的好处是，拆分过程不影响业务迭代，而且可以随意组合成单体应用和微服务app，并且还可以事先测试和验证拆分，最大限度的降低微服务化实施的风险。</p>\n<p><strong>下面是拆分代码过程实践经验：</strong></p>\n<p>1). <strong>设计module骨架</strong></p>\n<p>module骨架的设计是基础，影响最终拆分结果，拆分成功的向导。按照技术，业务，部署打包，测试这几个维度来规划设计，下面是一个参考。</p>\n<p><strong>最终骨架模型：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">root web app</div><div class=\"line\">\twebapp  //war module，打包为单体war，整体部署</div><div class=\"line\">\tmicro-services //微服务pom module</div><div class=\"line\">\t\tuser-service</div><div class=\"line\">\t\tcustomer-service</div><div class=\"line\">\t\torder-service</div><div class=\"line\">\t\tother-service</div><div class=\"line\">\t\tapi-gateway</div><div class=\"line\">\tbiz //业务相关的module</div><div class=\"line\">\t\tentitys \t\t\t//所有实体类</div><div class=\"line\">\t\tbiz-base\t\t\t//一些无法拆分的代码上有依赖的服务</div><div class=\"line\">\t\tbiz-user\t\t\t//用户业务</div><div class=\"line\">\t\tbiz-customer\t\t//客户业务</div><div class=\"line\">\t\tbiz-order\t\t\t//订单业务</div><div class=\"line\">\t\t...\t\t\t\t\t</div><div class=\"line\">\tcommons</div><div class=\"line\">\t\tasync-framework  //一部框架</div><div class=\"line\">\t\tutils\t\t\t\t//工具类</div></pre></td></tr></table></figure>\n<p>2). <strong>拆分技术commons</strong></p>\n<p>作为第一步，先对整个工程按业务和功能进行了maven多module的拆分。拆分过程没有技巧可言，一步一步走，一步一个脚印。首先是分离出技术上的commons，感觉这应该是最好拆分的了，把相关的类重构到一个包里，在分离出一个module即可。实际过程并非如此，因为是老项目，这类commons也并没有想象的容易，经过很多人的添砖加瓦，并没有完全按照<a href=\"http://www.infoq.com/cn/articles/single-responsibility-in-software-development\" target=\"_blank\" rel=\"external\">单一职责原则</a>来砌，根本就是把业务特征的代码也放到了技术类代码中，不过review代码后感觉还好，微遵循的毕竟是少数，那就先重构代码，把业务特性的砖从类里移出去。</p>\n<p>3). <strong>拆分entity</strong></p>\n<p>很多在业务代码上都会共享entity类，通常没法也没法把entity类分门别类，最简单就是把所有的entity类放到一个module，谁需要谁依赖的原则。entity类也没有太多jar依赖和业务依赖，也不会形成污染源。</p>\n<p>4). <strong>公共业务</strong></p>\n<p>同commons和entity方法，不在复述，也被各个业务依赖，这种业务大部分是过渡性的，在未来迭代演进时可以通过其他方式抽象集成。</p>\n<p>5). <strong>拆分业务代码</strong></p>\n<p>拆分业务是最痛苦的事情了，这个要看原来的代码整洁度和互相依赖程度，一般采取2中方法：</p>\n<ul>\n<li>新建业务module，加入基础module的pom依赖，再从源module复制和该业务module相关的代码（包括单元测试代码）过来，解决编译错误和单元测试错误，完成本业务拆分。</li>\n<li>从源module复制一个新业务module，保持代码一致，先删除和本义务无关的代码（包括单元测试代码），再删除无关的pom依赖，解决编译错误和单元测试错误，完成本业务拆分。</li>\n</ul>\n<p>选择哪种方法，可以根据代码整洁度和互相依赖程度，如果代码很整洁且相互依赖较弱，可以采取前者，否则就采取后者。</p>\n<p>6). <strong>拆分微服务</strong></p>\n<p>有了以上的拆分基础，可以在合适的业务迭代将各个微服务module迁移到不同的代码仓库，完成进一步隔离管理。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://upload-images.jianshu.io/upload_images/2519252-54c30064a539893e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600\" alt=\"IMG_20161026_144514.jpg\"></p>\n<p>说到微服务就不得不说拆分了，服务拆分要有一些指导依据。</p>\n<h3 id=\"拆分依据\"><a href=\"#拆分依据\" class=\"headerlink\" title=\"拆分依据\"></a>拆分依据</h3><p>微服务的理论知识有大量的分享，这里是我对微服务理论基础认识的一些观点：</p>\n<ul>\n<li>小，且专注于做一件事情，即满足<a href=\"http://www.infoq.com/cn/articles/single-responsibility-in-software-development\" target=\"_blank\" rel=\"external\">单一职责原则</a>。 关于单一职责可以阅读我的另一篇文章<a href=\"http://www.infoq.com/cn/articles/single-responsibility-in-software-development\" target=\"_blank\" rel=\"external\">《软件开发中的单一职责》</a></li>\n<li>运行在独立的进程中。</li>\n<li>轻量级的通信机制，RPC或者HTTP或者MQ。</li>\n<li>松耦合，独立部署。</li>\n<li>康威定律：设计系统的组织，其产生的设计等同于组织之内、组织之间的沟通结构。</li>\n</ul>\n<p><strong>服务拆分依据结合上面的理论基础充分考虑了以下因素：</strong></p>\n<ul>\n<li>业务和领域模型</li>\n<li>技术、业务量等其他因素</li>\n<li>团队</li>\n</ul>\n<p>业务应该说是最实在的，也是最好理解而且最容易把握的。虽然领域的有界上下文从理论上能指导拆分，但是万万需要拆分的不是一个全新的系统，而是一个在线上稳定运行了很长时间的，很多人一砖一瓦堆砌起来的，并且仍然在持续添砖加瓦，不管是桥梁，还是高楼，我们的目的是让系统运行的更健壮，而不是拆成七零八碎，所对于这样的老系统，用领域拆分需要结合团队现状，理论结合实际，事半功倍。</p>\n<p>运行时隔离也是很重要的拆分依据，会根据一些具有特定功能的API单独拆分出来作为一个微服务，和其他微服务隔离，避免相互影响，避免一个老鼠害了一锅汤。比如一些文件上传一类的API，特征是响应时间长，对IO依赖比较多，其线程池需要特殊配置；比如多线程利用CPU来换取响应时间的等等。</p>\n<p>对于康威定理，究竟是团队影响拆分，还是拆分影响团队，那就需要均衡利弊了。如果是因为拆分微服务，而拆分了团队，那势必会影响到团队的稳定性和团队成员的归属感，尤其是一个组建很久的老团队。反之，团队负责多种业务，也没有明显的职责区分，就要考虑是否拆分团队，明确拆分后的团队职责。</p>\n<p>对于正在运行的系统，如何拆分和拆分为多大的粒度，事实上是不能有太过理论化理想化，更需要深入项目本身和该项目团队，了解业务，人和代码。不能是拆迁队，也不是修缮，应该是拆成各种形状的合理大小的积木。</p>\n<p>孰重孰轻很难说明白，团队不一样项目不一样，实践就不一样，找到适合自己团队的方法。</p>\n<h3 id=\"拆分粒度\"><a href=\"#拆分粒度\" class=\"headerlink\" title=\"拆分粒度\"></a>拆分粒度</h3><p>拆分粒度不应该过分追求细粒度，要考虑适中不能过大或过小。按照单一职责原则和康威定律，在业务域、团队还有技术上平衡粒度。拆分后的代码应该是易控制，易维护的，业务职责也是明确单一的。 </p>\n<h3 id=\"拆分过程实践\"><a href=\"#拆分过程实践\" class=\"headerlink\" title=\"拆分过程实践\"></a>拆分过程实践</h3><p>在拆分过程不得不考虑的是业务在跑，砖在砌，不能停，而且拆分工作也必须得进行，过程上不能一部到位，必须一步一步走，也由于此拆分后落地上线也要稳妥。所以，过程上，我也采用了比较稳妥的战术，<strong>先拆分为maven module，然后在拆分为微服务可部署构件</strong>。这样的好处是，拆分过程不影响业务迭代，而且可以随意组合成单体应用和微服务app，并且还可以事先测试和验证拆分，最大限度的降低微服务化实施的风险。</p>\n<p><strong>下面是拆分代码过程实践经验：</strong></p>\n<p>1). <strong>设计module骨架</strong></p>\n<p>module骨架的设计是基础，影响最终拆分结果，拆分成功的向导。按照技术，业务，部署打包，测试这几个维度来规划设计，下面是一个参考。</p>\n<p><strong>最终骨架模型：</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">root web app</div><div class=\"line\">\twebapp  //war module，打包为单体war，整体部署</div><div class=\"line\">\tmicro-services //微服务pom module</div><div class=\"line\">\t\tuser-service</div><div class=\"line\">\t\tcustomer-service</div><div class=\"line\">\t\torder-service</div><div class=\"line\">\t\tother-service</div><div class=\"line\">\t\tapi-gateway</div><div class=\"line\">\tbiz //业务相关的module</div><div class=\"line\">\t\tentitys \t\t\t//所有实体类</div><div class=\"line\">\t\tbiz-base\t\t\t//一些无法拆分的代码上有依赖的服务</div><div class=\"line\">\t\tbiz-user\t\t\t//用户业务</div><div class=\"line\">\t\tbiz-customer\t\t//客户业务</div><div class=\"line\">\t\tbiz-order\t\t\t//订单业务</div><div class=\"line\">\t\t...\t\t\t\t\t</div><div class=\"line\">\tcommons</div><div class=\"line\">\t\tasync-framework  //一部框架</div><div class=\"line\">\t\tutils\t\t\t\t//工具类</div></pre></td></tr></table></figure>\n<p>2). <strong>拆分技术commons</strong></p>\n<p>作为第一步，先对整个工程按业务和功能进行了maven多module的拆分。拆分过程没有技巧可言，一步一步走，一步一个脚印。首先是分离出技术上的commons，感觉这应该是最好拆分的了，把相关的类重构到一个包里，在分离出一个module即可。实际过程并非如此，因为是老项目，这类commons也并没有想象的容易，经过很多人的添砖加瓦，并没有完全按照<a href=\"http://www.infoq.com/cn/articles/single-responsibility-in-software-development\" target=\"_blank\" rel=\"external\">单一职责原则</a>来砌，根本就是把业务特征的代码也放到了技术类代码中，不过review代码后感觉还好，微遵循的毕竟是少数，那就先重构代码，把业务特性的砖从类里移出去。</p>\n<p>3). <strong>拆分entity</strong></p>\n<p>很多在业务代码上都会共享entity类，通常没法也没法把entity类分门别类，最简单就是把所有的entity类放到一个module，谁需要谁依赖的原则。entity类也没有太多jar依赖和业务依赖，也不会形成污染源。</p>\n<p>4). <strong>公共业务</strong></p>\n<p>同commons和entity方法，不在复述，也被各个业务依赖，这种业务大部分是过渡性的，在未来迭代演进时可以通过其他方式抽象集成。</p>\n<p>5). <strong>拆分业务代码</strong></p>\n<p>拆分业务是最痛苦的事情了，这个要看原来的代码整洁度和互相依赖程度，一般采取2中方法：</p>\n<ul>\n<li>新建业务module，加入基础module的pom依赖，再从源module复制和该业务module相关的代码（包括单元测试代码）过来，解决编译错误和单元测试错误，完成本业务拆分。</li>\n<li>从源module复制一个新业务module，保持代码一致，先删除和本义务无关的代码（包括单元测试代码），再删除无关的pom依赖，解决编译错误和单元测试错误，完成本业务拆分。</li>\n</ul>\n<p>选择哪种方法，可以根据代码整洁度和互相依赖程度，如果代码很整洁且相互依赖较弱，可以采取前者，否则就采取后者。</p>\n<p>6). <strong>拆分微服务</strong></p>\n<p>有了以上的拆分基础，可以在合适的业务迭代将各个微服务module迁移到不同的代码仓库，完成进一步隔离管理。</p>\n"},{"title":"Hystrix semaphore和thread隔离策略的区别及配置参考","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo.png","date":"2016-11-18T11:22:47.000Z","keywords":["技术","Hystrix","semaphore"],"description":null,"_content":"\n\n\n# Hystrix semaphore和thread隔离策略的区别及配置参考\n\n## 通用设置说明\n\nHystrix所有的配置都是`hystrix.command.[HystrixCommandKey]`开头,其中`[HystrixCommandKey]`是可变的，默认是`default`,即`hystrix.command.default`；另外Hystrix内置了默认参数，如果没有配置Hystrix属性，默认参数就会被设置，其优先级：\n\n- hystrix.command.[HystrixCommandKey].`XXX`\n- hystrix.command.default.`XXX`\n- Hystrix代码内置属性参数值\n\n\n## Hystrix隔离策略相关的参数\n\n### 策略参数设置\n\n> execution.isolation.strategy= THREAD|SEMAPHORE\n\n### execution.isolation.thread.timeoutInMilliseconds\n\n`hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds `用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。\n\n\n- 建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。\n- 建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：`hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds`\n\n这个超时时间要根据`CommandKey`所对应的业务和服务器所能承受的负载来设置，要根据`CommandKey`业务的平均响应时间设置，一般是大于平均响应时间的`20%~100%`,最好是根据压力测试结果来评估，这个值设置太大，会导致线程不够用而会导致太多的任务被fallback；设置太小，一些特殊的慢业务失败率提升，甚至会造成这个业务一直无法成功，在重试机制存在的情况下，反而会加重后端服务压力。\n\n根据微服务实际情况来定：\n\n- **太小：**会导致很多正常业务失败\n- **太大：**会导致实际的熔断效果很差，严重会导致雪崩。\n\n一般实际大小为：\n\n- 要保证该服务的可用性为几个9？99.5 99.9 99.99 \n- 要保证的N个9的最大响应时间。\n\n### execution.isolation.semaphore.maxConcurrentRequests\n\n这个值并非`TPS`、`QPS`、`RPS`等都是相对值，指的是1秒时间窗口内的事务/查询/请求，`semaphore.maxConcurrentRequests`是一个绝对值，无时间窗口，相当于亚毫秒级的，指任意时间点允许的并发数。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。\n\n \n\n### execution.timeout.enabled\n\n是否开启超时，默认是true，开启。\n\n\n### execution.isolation.thread.interruptOnTimeout\n\n发生超时是是否中断线程，默认是true。\n\n### execution.isolation.thread.interruptOnCancel\n\n取消时是否中断线程，默认是false。\n\n\n\n\n\n\n \n ","source":"_posts/hystrix/Hystrix semaphore和thread隔离的区别.md","raw":"---\ntitle: Hystrix semaphore和thread隔离策略的区别及配置参考\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo.png'\ndate: 2016-11-18 19:22:47\ncategories:\n\t- 技术\n\t- Hystrix\ntags:\n\t- spring cloud\n\t- Hystrix\n\t- semaphore\nkeywords:\n\t- 技术\n\t- Hystrix\n\t- semaphore\ndescription:\n---\n\n\n\n# Hystrix semaphore和thread隔离策略的区别及配置参考\n\n## 通用设置说明\n\nHystrix所有的配置都是`hystrix.command.[HystrixCommandKey]`开头,其中`[HystrixCommandKey]`是可变的，默认是`default`,即`hystrix.command.default`；另外Hystrix内置了默认参数，如果没有配置Hystrix属性，默认参数就会被设置，其优先级：\n\n- hystrix.command.[HystrixCommandKey].`XXX`\n- hystrix.command.default.`XXX`\n- Hystrix代码内置属性参数值\n\n\n## Hystrix隔离策略相关的参数\n\n### 策略参数设置\n\n> execution.isolation.strategy= THREAD|SEMAPHORE\n\n### execution.isolation.thread.timeoutInMilliseconds\n\n`hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds `用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。\n\n\n- 建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。\n- 建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：`hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds`\n\n这个超时时间要根据`CommandKey`所对应的业务和服务器所能承受的负载来设置，要根据`CommandKey`业务的平均响应时间设置，一般是大于平均响应时间的`20%~100%`,最好是根据压力测试结果来评估，这个值设置太大，会导致线程不够用而会导致太多的任务被fallback；设置太小，一些特殊的慢业务失败率提升，甚至会造成这个业务一直无法成功，在重试机制存在的情况下，反而会加重后端服务压力。\n\n根据微服务实际情况来定：\n\n- **太小：**会导致很多正常业务失败\n- **太大：**会导致实际的熔断效果很差，严重会导致雪崩。\n\n一般实际大小为：\n\n- 要保证该服务的可用性为几个9？99.5 99.9 99.99 \n- 要保证的N个9的最大响应时间。\n\n### execution.isolation.semaphore.maxConcurrentRequests\n\n这个值并非`TPS`、`QPS`、`RPS`等都是相对值，指的是1秒时间窗口内的事务/查询/请求，`semaphore.maxConcurrentRequests`是一个绝对值，无时间窗口，相当于亚毫秒级的，指任意时间点允许的并发数。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。\n\n \n\n### execution.timeout.enabled\n\n是否开启超时，默认是true，开启。\n\n\n### execution.isolation.thread.interruptOnTimeout\n\n发生超时是是否中断线程，默认是true。\n\n### execution.isolation.thread.interruptOnCancel\n\n取消时是否中断线程，默认是false。\n\n\n\n\n\n\n \n ","slug":"hystrix/Hystrix semaphore和thread隔离的区别","published":1,"updated":"2017-05-21T04:43:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc170037z29kumm9y09h","content":"<h1 id=\"Hystrix-semaphore和thread隔离策略的区别及配置参考\"><a href=\"#Hystrix-semaphore和thread隔离策略的区别及配置参考\" class=\"headerlink\" title=\"Hystrix semaphore和thread隔离策略的区别及配置参考\"></a>Hystrix semaphore和thread隔离策略的区别及配置参考</h1><h2 id=\"通用设置说明\"><a href=\"#通用设置说明\" class=\"headerlink\" title=\"通用设置说明\"></a>通用设置说明</h2><p>Hystrix所有的配置都是<code>hystrix.command.[HystrixCommandKey]</code>开头,其中<code>[HystrixCommandKey]</code>是可变的，默认是<code>default</code>,即<code>hystrix.command.default</code>；另外Hystrix内置了默认参数，如果没有配置Hystrix属性，默认参数就会被设置，其优先级：</p>\n<ul>\n<li>hystrix.command.[HystrixCommandKey].<code>XXX</code></li>\n<li>hystrix.command.default.<code>XXX</code></li>\n<li>Hystrix代码内置属性参数值</li>\n</ul>\n<h2 id=\"Hystrix隔离策略相关的参数\"><a href=\"#Hystrix隔离策略相关的参数\" class=\"headerlink\" title=\"Hystrix隔离策略相关的参数\"></a>Hystrix隔离策略相关的参数</h2><h3 id=\"策略参数设置\"><a href=\"#策略参数设置\" class=\"headerlink\" title=\"策略参数设置\"></a>策略参数设置</h3><blockquote>\n<p>execution.isolation.strategy= THREAD|SEMAPHORE</p>\n</blockquote>\n<h3 id=\"execution-isolation-thread-timeoutInMilliseconds\"><a href=\"#execution-isolation-thread-timeoutInMilliseconds\" class=\"headerlink\" title=\"execution.isolation.thread.timeoutInMilliseconds\"></a>execution.isolation.thread.timeoutInMilliseconds</h3><p><code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code>用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。</p>\n<ul>\n<li>建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。</li>\n<li>建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：<code>hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds</code></li>\n</ul>\n<p>这个超时时间要根据<code>CommandKey</code>所对应的业务和服务器所能承受的负载来设置，要根据<code>CommandKey</code>业务的平均响应时间设置，一般是大于平均响应时间的<code>20%~100%</code>,最好是根据压力测试结果来评估，这个值设置太大，会导致线程不够用而会导致太多的任务被fallback；设置太小，一些特殊的慢业务失败率提升，甚至会造成这个业务一直无法成功，在重试机制存在的情况下，反而会加重后端服务压力。</p>\n<p>根据微服务实际情况来定：</p>\n<ul>\n<li><strong>太小：</strong>会导致很多正常业务失败</li>\n<li><strong>太大：</strong>会导致实际的熔断效果很差，严重会导致雪崩。</li>\n</ul>\n<p>一般实际大小为：</p>\n<ul>\n<li>要保证该服务的可用性为几个9？99.5 99.9 99.99 </li>\n<li>要保证的N个9的最大响应时间。</li>\n</ul>\n<h3 id=\"execution-isolation-semaphore-maxConcurrentRequests\"><a href=\"#execution-isolation-semaphore-maxConcurrentRequests\" class=\"headerlink\" title=\"execution.isolation.semaphore.maxConcurrentRequests\"></a>execution.isolation.semaphore.maxConcurrentRequests</h3><p>这个值并非<code>TPS</code>、<code>QPS</code>、<code>RPS</code>等都是相对值，指的是1秒时间窗口内的事务/查询/请求，<code>semaphore.maxConcurrentRequests</code>是一个绝对值，无时间窗口，相当于亚毫秒级的，指任意时间点允许的并发数。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。</p>\n<h3 id=\"execution-timeout-enabled\"><a href=\"#execution-timeout-enabled\" class=\"headerlink\" title=\"execution.timeout.enabled\"></a>execution.timeout.enabled</h3><p>是否开启超时，默认是true，开启。</p>\n<h3 id=\"execution-isolation-thread-interruptOnTimeout\"><a href=\"#execution-isolation-thread-interruptOnTimeout\" class=\"headerlink\" title=\"execution.isolation.thread.interruptOnTimeout\"></a>execution.isolation.thread.interruptOnTimeout</h3><p>发生超时是是否中断线程，默认是true。</p>\n<h3 id=\"execution-isolation-thread-interruptOnCancel\"><a href=\"#execution-isolation-thread-interruptOnCancel\" class=\"headerlink\" title=\"execution.isolation.thread.interruptOnCancel\"></a>execution.isolation.thread.interruptOnCancel</h3><p>取消时是否中断线程，默认是false。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Hystrix-semaphore和thread隔离策略的区别及配置参考\"><a href=\"#Hystrix-semaphore和thread隔离策略的区别及配置参考\" class=\"headerlink\" title=\"Hystrix semaphore和thread隔离策略的区别及配置参考\"></a>Hystrix semaphore和thread隔离策略的区别及配置参考</h1><h2 id=\"通用设置说明\"><a href=\"#通用设置说明\" class=\"headerlink\" title=\"通用设置说明\"></a>通用设置说明</h2><p>Hystrix所有的配置都是<code>hystrix.command.[HystrixCommandKey]</code>开头,其中<code>[HystrixCommandKey]</code>是可变的，默认是<code>default</code>,即<code>hystrix.command.default</code>；另外Hystrix内置了默认参数，如果没有配置Hystrix属性，默认参数就会被设置，其优先级：</p>\n<ul>\n<li>hystrix.command.[HystrixCommandKey].<code>XXX</code></li>\n<li>hystrix.command.default.<code>XXX</code></li>\n<li>Hystrix代码内置属性参数值</li>\n</ul>\n<h2 id=\"Hystrix隔离策略相关的参数\"><a href=\"#Hystrix隔离策略相关的参数\" class=\"headerlink\" title=\"Hystrix隔离策略相关的参数\"></a>Hystrix隔离策略相关的参数</h2><h3 id=\"策略参数设置\"><a href=\"#策略参数设置\" class=\"headerlink\" title=\"策略参数设置\"></a>策略参数设置</h3><blockquote>\n<p>execution.isolation.strategy= THREAD|SEMAPHORE</p>\n</blockquote>\n<h3 id=\"execution-isolation-thread-timeoutInMilliseconds\"><a href=\"#execution-isolation-thread-timeoutInMilliseconds\" class=\"headerlink\" title=\"execution.isolation.thread.timeoutInMilliseconds\"></a>execution.isolation.thread.timeoutInMilliseconds</h3><p><code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code>用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。</p>\n<ul>\n<li>建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。</li>\n<li>建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：<code>hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds</code></li>\n</ul>\n<p>这个超时时间要根据<code>CommandKey</code>所对应的业务和服务器所能承受的负载来设置，要根据<code>CommandKey</code>业务的平均响应时间设置，一般是大于平均响应时间的<code>20%~100%</code>,最好是根据压力测试结果来评估，这个值设置太大，会导致线程不够用而会导致太多的任务被fallback；设置太小，一些特殊的慢业务失败率提升，甚至会造成这个业务一直无法成功，在重试机制存在的情况下，反而会加重后端服务压力。</p>\n<p>根据微服务实际情况来定：</p>\n<ul>\n<li><strong>太小：</strong>会导致很多正常业务失败</li>\n<li><strong>太大：</strong>会导致实际的熔断效果很差，严重会导致雪崩。</li>\n</ul>\n<p>一般实际大小为：</p>\n<ul>\n<li>要保证该服务的可用性为几个9？99.5 99.9 99.99 </li>\n<li>要保证的N个9的最大响应时间。</li>\n</ul>\n<h3 id=\"execution-isolation-semaphore-maxConcurrentRequests\"><a href=\"#execution-isolation-semaphore-maxConcurrentRequests\" class=\"headerlink\" title=\"execution.isolation.semaphore.maxConcurrentRequests\"></a>execution.isolation.semaphore.maxConcurrentRequests</h3><p>这个值并非<code>TPS</code>、<code>QPS</code>、<code>RPS</code>等都是相对值，指的是1秒时间窗口内的事务/查询/请求，<code>semaphore.maxConcurrentRequests</code>是一个绝对值，无时间窗口，相当于亚毫秒级的，指任意时间点允许的并发数。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。</p>\n<h3 id=\"execution-timeout-enabled\"><a href=\"#execution-timeout-enabled\" class=\"headerlink\" title=\"execution.timeout.enabled\"></a>execution.timeout.enabled</h3><p>是否开启超时，默认是true，开启。</p>\n<h3 id=\"execution-isolation-thread-interruptOnTimeout\"><a href=\"#execution-isolation-thread-interruptOnTimeout\" class=\"headerlink\" title=\"execution.isolation.thread.interruptOnTimeout\"></a>execution.isolation.thread.interruptOnTimeout</h3><p>发生超时是是否中断线程，默认是true。</p>\n<h3 id=\"execution-isolation-thread-interruptOnCancel\"><a href=\"#execution-isolation-thread-interruptOnCancel\" class=\"headerlink\" title=\"execution.isolation.thread.interruptOnCancel\"></a>execution.isolation.thread.interruptOnCancel</h3><p>取消时是否中断线程，默认是false。</p>\n"},{"title":"Hystrix 参数详解","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/DPP_0004.JPG","date":"2016-02-25T01:20:00.000Z","keywords":null,"description":null,"_content":"\nhystrix.command.default和hystrix.threadpool.default中的default为默认CommandKey\n\n# Command Properties\n\n## Execution相关的属性的配置：\n\n* hystrix.command.default.execution.isolation.strategy 隔离策略，默认是Thread, 可选Thread｜Semaphore\n\t- thread 通过线程数量来限制并发请求数，可以提供额外的保护，但有一定的延迟。一般用于网络调用\n\t- semaphore 通过semaphore count来限制并发请求数，适用于无网络的高并发请求\n\n* hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds  命令执行超时时间，默认1000ms\n* hystrix.command.default.execution.timeout.enabled 执行是否启用超时，默认启用true\n* hystrix.command.default.execution.isolation.thread.interruptOnTimeout 发生超时是是否中断，默认true\n* hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests 最大并发请求数，默认10，该参数当使用ExecutionIsolationStrategy.SEMAPHORE策略时才有效。如果达到最大并发请求数，请求会被拒绝。理论上选择semaphore size的原则和选择thread size一致，但选用semaphore时每次执行的单元要比较小且执行速度快（ms级别），否则的话应该用thread。\nsemaphore应该占整个容器（tomcat）的线程池的一小部分。\n\n\n## Fallback相关的属性\n\n这些参数可以应用于Hystrix的THREAD和SEMAPHORE策略\n\n* hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests  如果并发数达到该设置值，请求会被拒绝和抛出异常并且fallback不会被调用。默认10\n* hystrix.command.default.fallback.enabled 当执行失败或者请求被拒绝，是否会尝试调用hystrixCommand.getFallback() 。默认true\n\n\n## Circuit Breaker相关的属性\n\n* hystrix.command.default.circuitBreaker.enabled 用来跟踪circuit的健康性，如果未达标则让request短路。默认true\n* hystrix.command.default.circuitBreaker.requestVolumeThreshold  一个rolling window内最小的请求数。如果设为20，那么当一个rolling window的时间内（比如说1个rolling window是10秒）收到19个请求，即使19个请求都失败，也不会触发circuit break。默认20\n* hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds 触发短路的时间值，当该值设为5000时，则当触发circuit break后的5000毫秒内都会拒绝request，也就是5000毫秒后才会关闭circuit。默认5000\n* hystrix.command.default.circuitBreaker.errorThresholdPercentage错误比率阀值，如果错误率>=该值，circuit会被打开，并短路所有请求触发fallback。默认50\n* hystrix.command.default.circuitBreaker.forceOpen 强制打开熔断器，如果打开这个开关，那么拒绝所有request，默认false\n* hystrix.command.default.circuitBreaker.forceClosed 强制关闭熔断器   如果这个开关打开，circuit将一直关闭且忽略circuitBreaker.errorThresholdPercentage\n\n## Metrics相关参数\n\n* hystrix.command.default.metrics.rollingStats.timeInMilliseconds 设置统计的时间窗口值的，毫秒值，circuit break 的打开会根据1个rolling window的统计来计算。若rolling window被设为10000毫秒，则rolling window会被分成n个buckets，每个bucket包含success，failure，timeout，rejection的次数的统计信息。默认10000\n* hystrix.command.default.metrics.rollingStats.numBuckets 设置一个rolling window被划分的数量，若numBuckets＝10，rolling window＝10000，那么一个bucket的时间即1秒。必须符合rolling window % numberBuckets == 0。默认10\n* hystrix.command.default.metrics.rollingPercentile.enabled 执行时是否enable指标的计算和跟踪，默认true\n* hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds  设置rolling percentile window的时间，默认60000\n* hystrix.command.default.metrics.rollingPercentile.numBuckets 设置rolling percentile window的numberBuckets。逻辑同上。默认6\n* hystrix.command.default.metrics.rollingPercentile.bucketSize 如果bucket size＝100，window＝10s，若这10s里有500次执行，只有最后100次执行会被统计到bucket里去。增加该值会增加内存开销以及排序的开销。默认100\n* hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds  记录health 快照（用来统计成功和错误绿）的间隔，默认500ms\n\n## Request Context 相关参数\n\nhystrix.command.default.requestCache.enabled 默认true，需要重载getCacheKey()，返回null时不缓存\nhystrix.command.default.requestLog.enabled  记录日志到HystrixRequestLog，默认true\n\n# Collapser Properties 相关参数\n\nhystrix.collapser.default.maxRequestsInBatch 单次批处理的最大请求数，达到该数量触发批处理，默认Integer.MAX_VALUE\nhystrix.collapser.default.timerDelayInMilliseconds 触发批处理的延迟，也可以为创建批处理的时间＋该值，默认10\nhystrix.collapser.default.requestCache.enabled  是否对HystrixCollapser.execute() and HystrixCollapser.queue()的cache，默认true\n\n# ThreadPool 相关参数\n\n线程数默认值10适用于大部分情况（有时可以设置得更小），如果需要设置得更大，那有个基本得公式可以follow：\nrequests per second at peak when healthy × 99th percentile latency in seconds + some breathing room\n每秒最大支撑的请求数 * (99%平均响应时间 + 缓存值)\n比如：每秒能处理1000个请求，99%的请求响应时间是60ms，那么公式是：\n 1000 *（0.060+0.012）\n\n基本得原则时保持线程池尽可能小，他主要是为了释放压力，防止资源被阻塞。\n当一切都是正常的时候，线程池一般仅会有1到2个线程激活来提供服务\n \n* hystrix.threadpool.default.coreSize  并发执行的最大线程数，默认10\n* hystrix.threadpool.default.maxQueueSize BlockingQueue的最大队列数，当设为－1，会使用SynchronousQueue，值为正时使用LinkedBlcokingQueue。该设置只会在初始化时有效，之后不能修改threadpool的queue size，除非reinitialising thread executor。默认－1。\n* hystrix.threadpool.default.queueSizeRejectionThreshold  即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝。因为maxQueueSize不能被动态修改，这个参数将允许我们动态设置该值。if maxQueueSize == -1，该字段将不起作用\n* hystrix.threadpool.default.keepAliveTimeMinutes 如果corePoolSize和maxPoolSize设成一样（默认实现）该设置无效。如果通过plugin（https://github.com/Netflix/Hystrix/wiki/Plugins）使用自定义实现，该设置才有用，默认1.\n* hystrix.threadpool.default.metrics.rollingStats.timeInMilliseconds 线程池统计指标的时间，默认10000\n* hystrix.threadpool.default.metrics.rollingStats.numBuckets  将rolling window划分为n个buckets，默认10\n\n\n ","source":"_posts/hystrix/Hystrix参数详解.md","raw":"---\ntitle: Hystrix 参数详解\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/DPP_0004.JPG'\ndate: 2016-02-25 09:20:00\ncategories:\n\t- 技术\n\t- Hystrix\ntags:\n\t- hystrix\n\t- Circuit Breaker\nkeywords:\ndescription:\n---\n\nhystrix.command.default和hystrix.threadpool.default中的default为默认CommandKey\n\n# Command Properties\n\n## Execution相关的属性的配置：\n\n* hystrix.command.default.execution.isolation.strategy 隔离策略，默认是Thread, 可选Thread｜Semaphore\n\t- thread 通过线程数量来限制并发请求数，可以提供额外的保护，但有一定的延迟。一般用于网络调用\n\t- semaphore 通过semaphore count来限制并发请求数，适用于无网络的高并发请求\n\n* hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds  命令执行超时时间，默认1000ms\n* hystrix.command.default.execution.timeout.enabled 执行是否启用超时，默认启用true\n* hystrix.command.default.execution.isolation.thread.interruptOnTimeout 发生超时是是否中断，默认true\n* hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests 最大并发请求数，默认10，该参数当使用ExecutionIsolationStrategy.SEMAPHORE策略时才有效。如果达到最大并发请求数，请求会被拒绝。理论上选择semaphore size的原则和选择thread size一致，但选用semaphore时每次执行的单元要比较小且执行速度快（ms级别），否则的话应该用thread。\nsemaphore应该占整个容器（tomcat）的线程池的一小部分。\n\n\n## Fallback相关的属性\n\n这些参数可以应用于Hystrix的THREAD和SEMAPHORE策略\n\n* hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests  如果并发数达到该设置值，请求会被拒绝和抛出异常并且fallback不会被调用。默认10\n* hystrix.command.default.fallback.enabled 当执行失败或者请求被拒绝，是否会尝试调用hystrixCommand.getFallback() 。默认true\n\n\n## Circuit Breaker相关的属性\n\n* hystrix.command.default.circuitBreaker.enabled 用来跟踪circuit的健康性，如果未达标则让request短路。默认true\n* hystrix.command.default.circuitBreaker.requestVolumeThreshold  一个rolling window内最小的请求数。如果设为20，那么当一个rolling window的时间内（比如说1个rolling window是10秒）收到19个请求，即使19个请求都失败，也不会触发circuit break。默认20\n* hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds 触发短路的时间值，当该值设为5000时，则当触发circuit break后的5000毫秒内都会拒绝request，也就是5000毫秒后才会关闭circuit。默认5000\n* hystrix.command.default.circuitBreaker.errorThresholdPercentage错误比率阀值，如果错误率>=该值，circuit会被打开，并短路所有请求触发fallback。默认50\n* hystrix.command.default.circuitBreaker.forceOpen 强制打开熔断器，如果打开这个开关，那么拒绝所有request，默认false\n* hystrix.command.default.circuitBreaker.forceClosed 强制关闭熔断器   如果这个开关打开，circuit将一直关闭且忽略circuitBreaker.errorThresholdPercentage\n\n## Metrics相关参数\n\n* hystrix.command.default.metrics.rollingStats.timeInMilliseconds 设置统计的时间窗口值的，毫秒值，circuit break 的打开会根据1个rolling window的统计来计算。若rolling window被设为10000毫秒，则rolling window会被分成n个buckets，每个bucket包含success，failure，timeout，rejection的次数的统计信息。默认10000\n* hystrix.command.default.metrics.rollingStats.numBuckets 设置一个rolling window被划分的数量，若numBuckets＝10，rolling window＝10000，那么一个bucket的时间即1秒。必须符合rolling window % numberBuckets == 0。默认10\n* hystrix.command.default.metrics.rollingPercentile.enabled 执行时是否enable指标的计算和跟踪，默认true\n* hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds  设置rolling percentile window的时间，默认60000\n* hystrix.command.default.metrics.rollingPercentile.numBuckets 设置rolling percentile window的numberBuckets。逻辑同上。默认6\n* hystrix.command.default.metrics.rollingPercentile.bucketSize 如果bucket size＝100，window＝10s，若这10s里有500次执行，只有最后100次执行会被统计到bucket里去。增加该值会增加内存开销以及排序的开销。默认100\n* hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds  记录health 快照（用来统计成功和错误绿）的间隔，默认500ms\n\n## Request Context 相关参数\n\nhystrix.command.default.requestCache.enabled 默认true，需要重载getCacheKey()，返回null时不缓存\nhystrix.command.default.requestLog.enabled  记录日志到HystrixRequestLog，默认true\n\n# Collapser Properties 相关参数\n\nhystrix.collapser.default.maxRequestsInBatch 单次批处理的最大请求数，达到该数量触发批处理，默认Integer.MAX_VALUE\nhystrix.collapser.default.timerDelayInMilliseconds 触发批处理的延迟，也可以为创建批处理的时间＋该值，默认10\nhystrix.collapser.default.requestCache.enabled  是否对HystrixCollapser.execute() and HystrixCollapser.queue()的cache，默认true\n\n# ThreadPool 相关参数\n\n线程数默认值10适用于大部分情况（有时可以设置得更小），如果需要设置得更大，那有个基本得公式可以follow：\nrequests per second at peak when healthy × 99th percentile latency in seconds + some breathing room\n每秒最大支撑的请求数 * (99%平均响应时间 + 缓存值)\n比如：每秒能处理1000个请求，99%的请求响应时间是60ms，那么公式是：\n 1000 *（0.060+0.012）\n\n基本得原则时保持线程池尽可能小，他主要是为了释放压力，防止资源被阻塞。\n当一切都是正常的时候，线程池一般仅会有1到2个线程激活来提供服务\n \n* hystrix.threadpool.default.coreSize  并发执行的最大线程数，默认10\n* hystrix.threadpool.default.maxQueueSize BlockingQueue的最大队列数，当设为－1，会使用SynchronousQueue，值为正时使用LinkedBlcokingQueue。该设置只会在初始化时有效，之后不能修改threadpool的queue size，除非reinitialising thread executor。默认－1。\n* hystrix.threadpool.default.queueSizeRejectionThreshold  即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝。因为maxQueueSize不能被动态修改，这个参数将允许我们动态设置该值。if maxQueueSize == -1，该字段将不起作用\n* hystrix.threadpool.default.keepAliveTimeMinutes 如果corePoolSize和maxPoolSize设成一样（默认实现）该设置无效。如果通过plugin（https://github.com/Netflix/Hystrix/wiki/Plugins）使用自定义实现，该设置才有用，默认1.\n* hystrix.threadpool.default.metrics.rollingStats.timeInMilliseconds 线程池统计指标的时间，默认10000\n* hystrix.threadpool.default.metrics.rollingStats.numBuckets  将rolling window划分为n个buckets，默认10\n\n\n ","slug":"hystrix/Hystrix参数详解","published":1,"updated":"2017-05-21T04:43:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc19003iz29k01p8063b","content":"<p>hystrix.command.default和hystrix.threadpool.default中的default为默认CommandKey</p>\n<h1 id=\"Command-Properties\"><a href=\"#Command-Properties\" class=\"headerlink\" title=\"Command Properties\"></a>Command Properties</h1><h2 id=\"Execution相关的属性的配置：\"><a href=\"#Execution相关的属性的配置：\" class=\"headerlink\" title=\"Execution相关的属性的配置：\"></a>Execution相关的属性的配置：</h2><ul>\n<li><p>hystrix.command.default.execution.isolation.strategy 隔离策略，默认是Thread, 可选Thread｜Semaphore</p>\n<ul>\n<li>thread 通过线程数量来限制并发请求数，可以提供额外的保护，但有一定的延迟。一般用于网络调用</li>\n<li>semaphore 通过semaphore count来限制并发请求数，适用于无网络的高并发请求</li>\n</ul>\n</li>\n<li><p>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds  命令执行超时时间，默认1000ms</p>\n</li>\n<li>hystrix.command.default.execution.timeout.enabled 执行是否启用超时，默认启用true</li>\n<li>hystrix.command.default.execution.isolation.thread.interruptOnTimeout 发生超时是是否中断，默认true</li>\n<li>hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests 最大并发请求数，默认10，该参数当使用ExecutionIsolationStrategy.SEMAPHORE策略时才有效。如果达到最大并发请求数，请求会被拒绝。理论上选择semaphore size的原则和选择thread size一致，但选用semaphore时每次执行的单元要比较小且执行速度快（ms级别），否则的话应该用thread。<br>semaphore应该占整个容器（tomcat）的线程池的一小部分。</li>\n</ul>\n<h2 id=\"Fallback相关的属性\"><a href=\"#Fallback相关的属性\" class=\"headerlink\" title=\"Fallback相关的属性\"></a>Fallback相关的属性</h2><p>这些参数可以应用于Hystrix的THREAD和SEMAPHORE策略</p>\n<ul>\n<li>hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests  如果并发数达到该设置值，请求会被拒绝和抛出异常并且fallback不会被调用。默认10</li>\n<li>hystrix.command.default.fallback.enabled 当执行失败或者请求被拒绝，是否会尝试调用hystrixCommand.getFallback() 。默认true</li>\n</ul>\n<h2 id=\"Circuit-Breaker相关的属性\"><a href=\"#Circuit-Breaker相关的属性\" class=\"headerlink\" title=\"Circuit Breaker相关的属性\"></a>Circuit Breaker相关的属性</h2><ul>\n<li>hystrix.command.default.circuitBreaker.enabled 用来跟踪circuit的健康性，如果未达标则让request短路。默认true</li>\n<li>hystrix.command.default.circuitBreaker.requestVolumeThreshold  一个rolling window内最小的请求数。如果设为20，那么当一个rolling window的时间内（比如说1个rolling window是10秒）收到19个请求，即使19个请求都失败，也不会触发circuit break。默认20</li>\n<li>hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds 触发短路的时间值，当该值设为5000时，则当触发circuit break后的5000毫秒内都会拒绝request，也就是5000毫秒后才会关闭circuit。默认5000</li>\n<li>hystrix.command.default.circuitBreaker.errorThresholdPercentage错误比率阀值，如果错误率&gt;=该值，circuit会被打开，并短路所有请求触发fallback。默认50</li>\n<li>hystrix.command.default.circuitBreaker.forceOpen 强制打开熔断器，如果打开这个开关，那么拒绝所有request，默认false</li>\n<li>hystrix.command.default.circuitBreaker.forceClosed 强制关闭熔断器   如果这个开关打开，circuit将一直关闭且忽略circuitBreaker.errorThresholdPercentage</li>\n</ul>\n<h2 id=\"Metrics相关参数\"><a href=\"#Metrics相关参数\" class=\"headerlink\" title=\"Metrics相关参数\"></a>Metrics相关参数</h2><ul>\n<li>hystrix.command.default.metrics.rollingStats.timeInMilliseconds 设置统计的时间窗口值的，毫秒值，circuit break 的打开会根据1个rolling window的统计来计算。若rolling window被设为10000毫秒，则rolling window会被分成n个buckets，每个bucket包含success，failure，timeout，rejection的次数的统计信息。默认10000</li>\n<li>hystrix.command.default.metrics.rollingStats.numBuckets 设置一个rolling window被划分的数量，若numBuckets＝10，rolling window＝10000，那么一个bucket的时间即1秒。必须符合rolling window % numberBuckets == 0。默认10</li>\n<li>hystrix.command.default.metrics.rollingPercentile.enabled 执行时是否enable指标的计算和跟踪，默认true</li>\n<li>hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds  设置rolling percentile window的时间，默认60000</li>\n<li>hystrix.command.default.metrics.rollingPercentile.numBuckets 设置rolling percentile window的numberBuckets。逻辑同上。默认6</li>\n<li>hystrix.command.default.metrics.rollingPercentile.bucketSize 如果bucket size＝100，window＝10s，若这10s里有500次执行，只有最后100次执行会被统计到bucket里去。增加该值会增加内存开销以及排序的开销。默认100</li>\n<li>hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds  记录health 快照（用来统计成功和错误绿）的间隔，默认500ms</li>\n</ul>\n<h2 id=\"Request-Context-相关参数\"><a href=\"#Request-Context-相关参数\" class=\"headerlink\" title=\"Request Context 相关参数\"></a>Request Context 相关参数</h2><p>hystrix.command.default.requestCache.enabled 默认true，需要重载getCacheKey()，返回null时不缓存<br>hystrix.command.default.requestLog.enabled  记录日志到HystrixRequestLog，默认true</p>\n<h1 id=\"Collapser-Properties-相关参数\"><a href=\"#Collapser-Properties-相关参数\" class=\"headerlink\" title=\"Collapser Properties 相关参数\"></a>Collapser Properties 相关参数</h1><p>hystrix.collapser.default.maxRequestsInBatch 单次批处理的最大请求数，达到该数量触发批处理，默认Integer.MAX_VALUE<br>hystrix.collapser.default.timerDelayInMilliseconds 触发批处理的延迟，也可以为创建批处理的时间＋该值，默认10<br>hystrix.collapser.default.requestCache.enabled  是否对HystrixCollapser.execute() and HystrixCollapser.queue()的cache，默认true</p>\n<h1 id=\"ThreadPool-相关参数\"><a href=\"#ThreadPool-相关参数\" class=\"headerlink\" title=\"ThreadPool 相关参数\"></a>ThreadPool 相关参数</h1><p>线程数默认值10适用于大部分情况（有时可以设置得更小），如果需要设置得更大，那有个基本得公式可以follow：<br>requests per second at peak when healthy × 99th percentile latency in seconds + some breathing room<br>每秒最大支撑的请求数 <em> (99%平均响应时间 + 缓存值)<br>比如：每秒能处理1000个请求，99%的请求响应时间是60ms，那么公式是：<br> 1000 </em>（0.060+0.012）</p>\n<p>基本得原则时保持线程池尽可能小，他主要是为了释放压力，防止资源被阻塞。<br>当一切都是正常的时候，线程池一般仅会有1到2个线程激活来提供服务</p>\n<ul>\n<li>hystrix.threadpool.default.coreSize  并发执行的最大线程数，默认10</li>\n<li>hystrix.threadpool.default.maxQueueSize BlockingQueue的最大队列数，当设为－1，会使用SynchronousQueue，值为正时使用LinkedBlcokingQueue。该设置只会在初始化时有效，之后不能修改threadpool的queue size，除非reinitialising thread executor。默认－1。</li>\n<li>hystrix.threadpool.default.queueSizeRejectionThreshold  即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝。因为maxQueueSize不能被动态修改，这个参数将允许我们动态设置该值。if maxQueueSize == -1，该字段将不起作用</li>\n<li>hystrix.threadpool.default.keepAliveTimeMinutes 如果corePoolSize和maxPoolSize设成一样（默认实现）该设置无效。如果通过plugin（<a href=\"https://github.com/Netflix/Hystrix/wiki/Plugins）使用自定义实现，该设置才有用，默认1\" target=\"_blank\" rel=\"external\">https://github.com/Netflix/Hystrix/wiki/Plugins）使用自定义实现，该设置才有用，默认1</a>.</li>\n<li>hystrix.threadpool.default.metrics.rollingStats.timeInMilliseconds 线程池统计指标的时间，默认10000</li>\n<li>hystrix.threadpool.default.metrics.rollingStats.numBuckets  将rolling window划分为n个buckets，默认10</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>hystrix.command.default和hystrix.threadpool.default中的default为默认CommandKey</p>\n<h1 id=\"Command-Properties\"><a href=\"#Command-Properties\" class=\"headerlink\" title=\"Command Properties\"></a>Command Properties</h1><h2 id=\"Execution相关的属性的配置：\"><a href=\"#Execution相关的属性的配置：\" class=\"headerlink\" title=\"Execution相关的属性的配置：\"></a>Execution相关的属性的配置：</h2><ul>\n<li><p>hystrix.command.default.execution.isolation.strategy 隔离策略，默认是Thread, 可选Thread｜Semaphore</p>\n<ul>\n<li>thread 通过线程数量来限制并发请求数，可以提供额外的保护，但有一定的延迟。一般用于网络调用</li>\n<li>semaphore 通过semaphore count来限制并发请求数，适用于无网络的高并发请求</li>\n</ul>\n</li>\n<li><p>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds  命令执行超时时间，默认1000ms</p>\n</li>\n<li>hystrix.command.default.execution.timeout.enabled 执行是否启用超时，默认启用true</li>\n<li>hystrix.command.default.execution.isolation.thread.interruptOnTimeout 发生超时是是否中断，默认true</li>\n<li>hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests 最大并发请求数，默认10，该参数当使用ExecutionIsolationStrategy.SEMAPHORE策略时才有效。如果达到最大并发请求数，请求会被拒绝。理论上选择semaphore size的原则和选择thread size一致，但选用semaphore时每次执行的单元要比较小且执行速度快（ms级别），否则的话应该用thread。<br>semaphore应该占整个容器（tomcat）的线程池的一小部分。</li>\n</ul>\n<h2 id=\"Fallback相关的属性\"><a href=\"#Fallback相关的属性\" class=\"headerlink\" title=\"Fallback相关的属性\"></a>Fallback相关的属性</h2><p>这些参数可以应用于Hystrix的THREAD和SEMAPHORE策略</p>\n<ul>\n<li>hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests  如果并发数达到该设置值，请求会被拒绝和抛出异常并且fallback不会被调用。默认10</li>\n<li>hystrix.command.default.fallback.enabled 当执行失败或者请求被拒绝，是否会尝试调用hystrixCommand.getFallback() 。默认true</li>\n</ul>\n<h2 id=\"Circuit-Breaker相关的属性\"><a href=\"#Circuit-Breaker相关的属性\" class=\"headerlink\" title=\"Circuit Breaker相关的属性\"></a>Circuit Breaker相关的属性</h2><ul>\n<li>hystrix.command.default.circuitBreaker.enabled 用来跟踪circuit的健康性，如果未达标则让request短路。默认true</li>\n<li>hystrix.command.default.circuitBreaker.requestVolumeThreshold  一个rolling window内最小的请求数。如果设为20，那么当一个rolling window的时间内（比如说1个rolling window是10秒）收到19个请求，即使19个请求都失败，也不会触发circuit break。默认20</li>\n<li>hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds 触发短路的时间值，当该值设为5000时，则当触发circuit break后的5000毫秒内都会拒绝request，也就是5000毫秒后才会关闭circuit。默认5000</li>\n<li>hystrix.command.default.circuitBreaker.errorThresholdPercentage错误比率阀值，如果错误率&gt;=该值，circuit会被打开，并短路所有请求触发fallback。默认50</li>\n<li>hystrix.command.default.circuitBreaker.forceOpen 强制打开熔断器，如果打开这个开关，那么拒绝所有request，默认false</li>\n<li>hystrix.command.default.circuitBreaker.forceClosed 强制关闭熔断器   如果这个开关打开，circuit将一直关闭且忽略circuitBreaker.errorThresholdPercentage</li>\n</ul>\n<h2 id=\"Metrics相关参数\"><a href=\"#Metrics相关参数\" class=\"headerlink\" title=\"Metrics相关参数\"></a>Metrics相关参数</h2><ul>\n<li>hystrix.command.default.metrics.rollingStats.timeInMilliseconds 设置统计的时间窗口值的，毫秒值，circuit break 的打开会根据1个rolling window的统计来计算。若rolling window被设为10000毫秒，则rolling window会被分成n个buckets，每个bucket包含success，failure，timeout，rejection的次数的统计信息。默认10000</li>\n<li>hystrix.command.default.metrics.rollingStats.numBuckets 设置一个rolling window被划分的数量，若numBuckets＝10，rolling window＝10000，那么一个bucket的时间即1秒。必须符合rolling window % numberBuckets == 0。默认10</li>\n<li>hystrix.command.default.metrics.rollingPercentile.enabled 执行时是否enable指标的计算和跟踪，默认true</li>\n<li>hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds  设置rolling percentile window的时间，默认60000</li>\n<li>hystrix.command.default.metrics.rollingPercentile.numBuckets 设置rolling percentile window的numberBuckets。逻辑同上。默认6</li>\n<li>hystrix.command.default.metrics.rollingPercentile.bucketSize 如果bucket size＝100，window＝10s，若这10s里有500次执行，只有最后100次执行会被统计到bucket里去。增加该值会增加内存开销以及排序的开销。默认100</li>\n<li>hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds  记录health 快照（用来统计成功和错误绿）的间隔，默认500ms</li>\n</ul>\n<h2 id=\"Request-Context-相关参数\"><a href=\"#Request-Context-相关参数\" class=\"headerlink\" title=\"Request Context 相关参数\"></a>Request Context 相关参数</h2><p>hystrix.command.default.requestCache.enabled 默认true，需要重载getCacheKey()，返回null时不缓存<br>hystrix.command.default.requestLog.enabled  记录日志到HystrixRequestLog，默认true</p>\n<h1 id=\"Collapser-Properties-相关参数\"><a href=\"#Collapser-Properties-相关参数\" class=\"headerlink\" title=\"Collapser Properties 相关参数\"></a>Collapser Properties 相关参数</h1><p>hystrix.collapser.default.maxRequestsInBatch 单次批处理的最大请求数，达到该数量触发批处理，默认Integer.MAX_VALUE<br>hystrix.collapser.default.timerDelayInMilliseconds 触发批处理的延迟，也可以为创建批处理的时间＋该值，默认10<br>hystrix.collapser.default.requestCache.enabled  是否对HystrixCollapser.execute() and HystrixCollapser.queue()的cache，默认true</p>\n<h1 id=\"ThreadPool-相关参数\"><a href=\"#ThreadPool-相关参数\" class=\"headerlink\" title=\"ThreadPool 相关参数\"></a>ThreadPool 相关参数</h1><p>线程数默认值10适用于大部分情况（有时可以设置得更小），如果需要设置得更大，那有个基本得公式可以follow：<br>requests per second at peak when healthy × 99th percentile latency in seconds + some breathing room<br>每秒最大支撑的请求数 <em> (99%平均响应时间 + 缓存值)<br>比如：每秒能处理1000个请求，99%的请求响应时间是60ms，那么公式是：<br> 1000 </em>（0.060+0.012）</p>\n<p>基本得原则时保持线程池尽可能小，他主要是为了释放压力，防止资源被阻塞。<br>当一切都是正常的时候，线程池一般仅会有1到2个线程激活来提供服务</p>\n<ul>\n<li>hystrix.threadpool.default.coreSize  并发执行的最大线程数，默认10</li>\n<li>hystrix.threadpool.default.maxQueueSize BlockingQueue的最大队列数，当设为－1，会使用SynchronousQueue，值为正时使用LinkedBlcokingQueue。该设置只会在初始化时有效，之后不能修改threadpool的queue size，除非reinitialising thread executor。默认－1。</li>\n<li>hystrix.threadpool.default.queueSizeRejectionThreshold  即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝。因为maxQueueSize不能被动态修改，这个参数将允许我们动态设置该值。if maxQueueSize == -1，该字段将不起作用</li>\n<li>hystrix.threadpool.default.keepAliveTimeMinutes 如果corePoolSize和maxPoolSize设成一样（默认实现）该设置无效。如果通过plugin（<a href=\"https://github.com/Netflix/Hystrix/wiki/Plugins）使用自定义实现，该设置才有用，默认1\" target=\"_blank\" rel=\"external\">https://github.com/Netflix/Hystrix/wiki/Plugins）使用自定义实现，该设置才有用，默认1</a>.</li>\n<li>hystrix.threadpool.default.metrics.rollingStats.timeInMilliseconds 线程池统计指标的时间，默认10000</li>\n<li>hystrix.threadpool.default.metrics.rollingStats.numBuckets  将rolling window划分为n个buckets，默认10</li>\n</ul>\n"},{"title":"Hystrix降级模式总结","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png","date":"2016-03-09T01:22:47.000Z","keywords":"hystrix","description":"Hystrix降级","_content":"\n## 失败回退降级模式\n失败回退需要实现HystrixCommand.getFallback方法或者HystrixObservableCommand. HystrixObservableCommand()方法。\n\n* 快速失败Fail Fast\n\t* 如果业务异常，就抛出一个异常\n* 静默失败Fail Silent\n\t* 失败时返回一个空response或者移除业务功能，例如返回null，空字符串，空map，空list等\n* Fallback: Static\n\t* 失败时，返回默认值来替代引起失败的原因\n* Fallback: Stubbed\n\t* 返回替代值，还没理解\n* Fallback: Cache via Network\n\t* 当后端服务失败时，从网络缓存获取返回值\n* Primary + Secondary with Fallback\n\t* 故障转移，当主服务失败时，调用从服务。当从服务也失败时结合其他模式\n* Client Doesn’t Perform Network Access\n\t* \n* Get-Set-Get with Request Cache Invalidation","source":"_posts/hystrix/Hystrix降级模式总结.md","raw":"---\ntitle: Hystrix降级模式总结\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png'\ndate: 2016-03-09 09:22:47\ncategories:\n\t- 技术\n\t- Hystrix\ntags:\n\t- hystrix\nkeywords: hystrix\ndescription: Hystrix降级\n---\n\n## 失败回退降级模式\n失败回退需要实现HystrixCommand.getFallback方法或者HystrixObservableCommand. HystrixObservableCommand()方法。\n\n* 快速失败Fail Fast\n\t* 如果业务异常，就抛出一个异常\n* 静默失败Fail Silent\n\t* 失败时返回一个空response或者移除业务功能，例如返回null，空字符串，空map，空list等\n* Fallback: Static\n\t* 失败时，返回默认值来替代引起失败的原因\n* Fallback: Stubbed\n\t* 返回替代值，还没理解\n* Fallback: Cache via Network\n\t* 当后端服务失败时，从网络缓存获取返回值\n* Primary + Secondary with Fallback\n\t* 故障转移，当主服务失败时，调用从服务。当从服务也失败时结合其他模式\n* Client Doesn’t Perform Network Access\n\t* \n* Get-Set-Get with Request Cache Invalidation","slug":"hystrix/Hystrix降级模式总结","published":1,"updated":"2017-05-21T04:43:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc1e003pz29khn4j5gjf","content":"<h2 id=\"失败回退降级模式\"><a href=\"#失败回退降级模式\" class=\"headerlink\" title=\"失败回退降级模式\"></a>失败回退降级模式</h2><p>失败回退需要实现HystrixCommand.getFallback方法或者HystrixObservableCommand. HystrixObservableCommand()方法。</p>\n<ul>\n<li>快速失败Fail Fast<ul>\n<li>如果业务异常，就抛出一个异常</li>\n</ul>\n</li>\n<li>静默失败Fail Silent<ul>\n<li>失败时返回一个空response或者移除业务功能，例如返回null，空字符串，空map，空list等</li>\n</ul>\n</li>\n<li>Fallback: Static<ul>\n<li>失败时，返回默认值来替代引起失败的原因</li>\n</ul>\n</li>\n<li>Fallback: Stubbed<ul>\n<li>返回替代值，还没理解</li>\n</ul>\n</li>\n<li>Fallback: Cache via Network<ul>\n<li>当后端服务失败时，从网络缓存获取返回值</li>\n</ul>\n</li>\n<li>Primary + Secondary with Fallback<ul>\n<li>故障转移，当主服务失败时，调用从服务。当从服务也失败时结合其他模式</li>\n</ul>\n</li>\n<li>Client Doesn’t Perform Network Access<br>  * </li>\n<li>Get-Set-Get with Request Cache Invalidation</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"失败回退降级模式\"><a href=\"#失败回退降级模式\" class=\"headerlink\" title=\"失败回退降级模式\"></a>失败回退降级模式</h2><p>失败回退需要实现HystrixCommand.getFallback方法或者HystrixObservableCommand. HystrixObservableCommand()方法。</p>\n<ul>\n<li>快速失败Fail Fast<ul>\n<li>如果业务异常，就抛出一个异常</li>\n</ul>\n</li>\n<li>静默失败Fail Silent<ul>\n<li>失败时返回一个空response或者移除业务功能，例如返回null，空字符串，空map，空list等</li>\n</ul>\n</li>\n<li>Fallback: Static<ul>\n<li>失败时，返回默认值来替代引起失败的原因</li>\n</ul>\n</li>\n<li>Fallback: Stubbed<ul>\n<li>返回替代值，还没理解</li>\n</ul>\n</li>\n<li>Fallback: Cache via Network<ul>\n<li>当后端服务失败时，从网络缓存获取返回值</li>\n</ul>\n</li>\n<li>Primary + Secondary with Fallback<ul>\n<li>故障转移，当主服务失败时，调用从服务。当从服务也失败时结合其他模式</li>\n</ul>\n</li>\n<li>Client Doesn’t Perform Network Access<br>  * </li>\n<li>Get-Set-Get with Request Cache Invalidation</li>\n</ul>\n"},{"title":"RestTemplate遇上Hystrix","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/P60828-123503.jpg","date":"2016-09-02T01:20:00.000Z","keywords":null,"description":null,"_content":"\n# RestTemplate遇上Hystrix\n\n\n## RestTemplate集成Hystrix和Robbin\n\n查看RestTemplate源代码，可以看到RestTemplate继承了InterceptingHttpAccessor类，InterceptingHttpAccessor类通过ClientHttpRequestInterceptor接口提供了扩展功能。\n\n实现intercept方法，在该方法中封装HystrixCommand和Ribbon逻辑即可。\n\n下面的代码是集成了HystrixCommand的例子：\n\n```java\n@Override\n    public ClientHttpResponse intercept(\n            final HttpRequest request, final byte[] body,\n            final ClientHttpRequestExecution execution) throws IOException {\n        final URI originalUri = request.getURI();\n        String serviceName = mapCommandKey(originalUri);\n\n        log.info(\"{} :{} {} \", serviceName, request.getMethod().name(), originalUri.toString());\n        return new RestTemplateHystrixCommnad(serviceName, () -> {\n            return execution.execute(request, body);\n        }, hystrixFallback).execute();\n\n    }\n```\n\n下面是集成了HystrixCommand和Ribbon的例子\n\n```java\n@Override\n    public ClientHttpResponse intercept(\n            final HttpRequest request, final byte[] body,\n            final ClientHttpRequestExecution execution) throws IOException {\n        final URI originalUri = request.getURI();\n        String serviceName = mapCommandKey(originalUri);\n\n        log.info(\"{} :{} {} \", serviceName, request.getMethod().name(), originalUri.toString());\n        return new RestTemplateHystrixCommnad(serviceName, () -> {\n            return this.loadBalancer.execute(serviceName, instance -> {\n                HttpRequest serviceRequest = new HystrixLoadBalancerInterceptor.ServiceRequestWrapper(\n                        request,\n                        instance);\n                return execution.execute(serviceRequest, body);\n\n            });\n        }, hystrixFallback).execute();\n    }\n```\n\n2）RestTemplate支持Hystrix异步特性\n\nHystrix的执行在线程隔离模型下是支持异步的，因此也扩展一个RestTemplate异步执行。如下代码所示，通过调用`queue()`方法返回一个Future。\n\n```java\nFuture<String> fs = new CommandHelloWorld(\"World\").queue();\nString s = fs.get(); \n```\n这样可以修改RestOperations接口方法为异步方法：\n\n从：\n\n```java\n<T>  T getForObject(String url, Class<T> responseType, Object... uriVariables) throws RestClientException;\n```\n\n到：\n\n```java\n<T> Future<T> getForObject(String url, Class<T> responseType, Object... uriVariables) throws RestClientException;\n```\n\n然后在原生的RestTemplate做一层代理，在代理层集成Hystrix和Ribbon，无论是JDK动态代理还是硬编码实现代理都变得容易，然后就可以这样来调用了：\n\n```java\nHystrixAsyncRestOperations asyncRestTemplate =null;\n//先依次调用\nFuture<String> future1 = asyncRestTemplate.getForObject(\"http://tietang.wang/\", String.class);\nFuture<String> future2 = asyncRestTemplate.getForObject(\"http://tietang.wang/2016/03/17/hystrix/%E6%80%8E%E6%A0%B7%E4%BD%BF%E7%94%A8Hystrix/\", String.class);\n//再依次获取调用结果\nString html1 = future1.get();\nString html2 = future2.get(100, TimeUnit.MILLISECONDS);//异步超时，建议\n```\n","source":"_posts/hystrix/RestTemplate遇上Hystrix.md","raw":"---\ntitle: RestTemplate遇上Hystrix\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/P60828-123503.jpg'\ndate: 2016-09-02 09:20:00\ncategories:\n\t- 技术\n\t- Hystrix\ntags:\n\t- hystrix\n\t- Circuit Breaker\nkeywords:\ndescription:\n---\n\n# RestTemplate遇上Hystrix\n\n\n## RestTemplate集成Hystrix和Robbin\n\n查看RestTemplate源代码，可以看到RestTemplate继承了InterceptingHttpAccessor类，InterceptingHttpAccessor类通过ClientHttpRequestInterceptor接口提供了扩展功能。\n\n实现intercept方法，在该方法中封装HystrixCommand和Ribbon逻辑即可。\n\n下面的代码是集成了HystrixCommand的例子：\n\n```java\n@Override\n    public ClientHttpResponse intercept(\n            final HttpRequest request, final byte[] body,\n            final ClientHttpRequestExecution execution) throws IOException {\n        final URI originalUri = request.getURI();\n        String serviceName = mapCommandKey(originalUri);\n\n        log.info(\"{} :{} {} \", serviceName, request.getMethod().name(), originalUri.toString());\n        return new RestTemplateHystrixCommnad(serviceName, () -> {\n            return execution.execute(request, body);\n        }, hystrixFallback).execute();\n\n    }\n```\n\n下面是集成了HystrixCommand和Ribbon的例子\n\n```java\n@Override\n    public ClientHttpResponse intercept(\n            final HttpRequest request, final byte[] body,\n            final ClientHttpRequestExecution execution) throws IOException {\n        final URI originalUri = request.getURI();\n        String serviceName = mapCommandKey(originalUri);\n\n        log.info(\"{} :{} {} \", serviceName, request.getMethod().name(), originalUri.toString());\n        return new RestTemplateHystrixCommnad(serviceName, () -> {\n            return this.loadBalancer.execute(serviceName, instance -> {\n                HttpRequest serviceRequest = new HystrixLoadBalancerInterceptor.ServiceRequestWrapper(\n                        request,\n                        instance);\n                return execution.execute(serviceRequest, body);\n\n            });\n        }, hystrixFallback).execute();\n    }\n```\n\n2）RestTemplate支持Hystrix异步特性\n\nHystrix的执行在线程隔离模型下是支持异步的，因此也扩展一个RestTemplate异步执行。如下代码所示，通过调用`queue()`方法返回一个Future。\n\n```java\nFuture<String> fs = new CommandHelloWorld(\"World\").queue();\nString s = fs.get(); \n```\n这样可以修改RestOperations接口方法为异步方法：\n\n从：\n\n```java\n<T>  T getForObject(String url, Class<T> responseType, Object... uriVariables) throws RestClientException;\n```\n\n到：\n\n```java\n<T> Future<T> getForObject(String url, Class<T> responseType, Object... uriVariables) throws RestClientException;\n```\n\n然后在原生的RestTemplate做一层代理，在代理层集成Hystrix和Ribbon，无论是JDK动态代理还是硬编码实现代理都变得容易，然后就可以这样来调用了：\n\n```java\nHystrixAsyncRestOperations asyncRestTemplate =null;\n//先依次调用\nFuture<String> future1 = asyncRestTemplate.getForObject(\"http://tietang.wang/\", String.class);\nFuture<String> future2 = asyncRestTemplate.getForObject(\"http://tietang.wang/2016/03/17/hystrix/%E6%80%8E%E6%A0%B7%E4%BD%BF%E7%94%A8Hystrix/\", String.class);\n//再依次获取调用结果\nString html1 = future1.get();\nString html2 = future2.get(100, TimeUnit.MILLISECONDS);//异步超时，建议\n```\n","slug":"hystrix/RestTemplate遇上Hystrix","published":1,"updated":"2017-05-21T04:43:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc1f003tz29kjus942ef","content":"<h1 id=\"RestTemplate遇上Hystrix\"><a href=\"#RestTemplate遇上Hystrix\" class=\"headerlink\" title=\"RestTemplate遇上Hystrix\"></a>RestTemplate遇上Hystrix</h1><h2 id=\"RestTemplate集成Hystrix和Robbin\"><a href=\"#RestTemplate集成Hystrix和Robbin\" class=\"headerlink\" title=\"RestTemplate集成Hystrix和Robbin\"></a>RestTemplate集成Hystrix和Robbin</h2><p>查看RestTemplate源代码，可以看到RestTemplate继承了InterceptingHttpAccessor类，InterceptingHttpAccessor类通过ClientHttpRequestInterceptor接口提供了扩展功能。</p>\n<p>实现intercept方法，在该方法中封装HystrixCommand和Ribbon逻辑即可。</p>\n<p>下面的代码是集成了HystrixCommand的例子：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ClientHttpResponse <span class=\"title\">intercept</span><span class=\"params\">(</span></span></div><div class=\"line\">            <span class=\"keyword\">final</span> HttpRequest request, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] body,</div><div class=\"line\">            <span class=\"keyword\">final</span> ClientHttpRequestExecution execution) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">        <span class=\"keyword\">final</span> URI originalUri = request.getURI();</div><div class=\"line\">        String serviceName = mapCommandKey(originalUri);</div><div class=\"line\"></div><div class=\"line\">        log.info(<span class=\"string\">\"&#123;&#125; :&#123;&#125; &#123;&#125; \"</span>, serviceName, request.getMethod().name(), originalUri.toString());</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RestTemplateHystrixCommnad(serviceName, () -&gt; &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> execution.execute(request, body);</div><div class=\"line\">        &#125;, hystrixFallback).execute();</div><div class=\"line\"></div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>下面是集成了HystrixCommand和Ribbon的例子</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ClientHttpResponse <span class=\"title\">intercept</span><span class=\"params\">(</span></span></div><div class=\"line\">            <span class=\"keyword\">final</span> HttpRequest request, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] body,</div><div class=\"line\">            <span class=\"keyword\">final</span> ClientHttpRequestExecution execution) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">        <span class=\"keyword\">final</span> URI originalUri = request.getURI();</div><div class=\"line\">        String serviceName = mapCommandKey(originalUri);</div><div class=\"line\"></div><div class=\"line\">        log.info(<span class=\"string\">\"&#123;&#125; :&#123;&#125; &#123;&#125; \"</span>, serviceName, request.getMethod().name(), originalUri.toString());</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RestTemplateHystrixCommnad(serviceName, () -&gt; &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.loadBalancer.execute(serviceName, instance -&gt; &#123;</div><div class=\"line\">                HttpRequest serviceRequest = <span class=\"keyword\">new</span> HystrixLoadBalancerInterceptor.ServiceRequestWrapper(</div><div class=\"line\">                        request,</div><div class=\"line\">                        instance);</div><div class=\"line\">                <span class=\"keyword\">return</span> execution.execute(serviceRequest, body);</div><div class=\"line\"></div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125;, hystrixFallback).execute();</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>2）RestTemplate支持Hystrix异步特性</p>\n<p>Hystrix的执行在线程隔离模型下是支持异步的，因此也扩展一个RestTemplate异步执行。如下代码所示，通过调用<code>queue()</code>方法返回一个Future。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Future&lt;String&gt; fs = <span class=\"keyword\">new</span> CommandHelloWorld(<span class=\"string\">\"World\"</span>).queue();</div><div class=\"line\">String s = fs.get();</div></pre></td></tr></table></figure>\n<p>这样可以修改RestOperations接口方法为异步方法：</p>\n<p>从：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;T&gt;  <span class=\"function\">T <span class=\"title\">getForObject</span><span class=\"params\">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class=\"keyword\">throws</span> RestClientException</span>;</div></pre></td></tr></table></figure>\n<p>到：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;T&gt; <span class=\"function\">Future&lt;T&gt; <span class=\"title\">getForObject</span><span class=\"params\">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class=\"keyword\">throws</span> RestClientException</span>;</div></pre></td></tr></table></figure>\n<p>然后在原生的RestTemplate做一层代理，在代理层集成Hystrix和Ribbon，无论是JDK动态代理还是硬编码实现代理都变得容易，然后就可以这样来调用了：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">HystrixAsyncRestOperations asyncRestTemplate =<span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"comment\">//先依次调用</span></div><div class=\"line\">Future&lt;String&gt; future1 = asyncRestTemplate.getForObject(<span class=\"string\">\"http://tietang.wang/\"</span>, String.class);</div><div class=\"line\">Future&lt;String&gt; future2 = asyncRestTemplate.getForObject(<span class=\"string\">\"http://tietang.wang/2016/03/17/hystrix/%E6%80%8E%E6%A0%B7%E4%BD%BF%E7%94%A8Hystrix/\"</span>, String.class);</div><div class=\"line\"><span class=\"comment\">//再依次获取调用结果</span></div><div class=\"line\">String html1 = future1.get();</div><div class=\"line\">String html2 = future2.get(<span class=\"number\">100</span>, TimeUnit.MILLISECONDS);<span class=\"comment\">//异步超时，建议</span></div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"RestTemplate遇上Hystrix\"><a href=\"#RestTemplate遇上Hystrix\" class=\"headerlink\" title=\"RestTemplate遇上Hystrix\"></a>RestTemplate遇上Hystrix</h1><h2 id=\"RestTemplate集成Hystrix和Robbin\"><a href=\"#RestTemplate集成Hystrix和Robbin\" class=\"headerlink\" title=\"RestTemplate集成Hystrix和Robbin\"></a>RestTemplate集成Hystrix和Robbin</h2><p>查看RestTemplate源代码，可以看到RestTemplate继承了InterceptingHttpAccessor类，InterceptingHttpAccessor类通过ClientHttpRequestInterceptor接口提供了扩展功能。</p>\n<p>实现intercept方法，在该方法中封装HystrixCommand和Ribbon逻辑即可。</p>\n<p>下面的代码是集成了HystrixCommand的例子：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ClientHttpResponse <span class=\"title\">intercept</span><span class=\"params\">(</span></span></div><div class=\"line\">            <span class=\"keyword\">final</span> HttpRequest request, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] body,</div><div class=\"line\">            <span class=\"keyword\">final</span> ClientHttpRequestExecution execution) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">        <span class=\"keyword\">final</span> URI originalUri = request.getURI();</div><div class=\"line\">        String serviceName = mapCommandKey(originalUri);</div><div class=\"line\"></div><div class=\"line\">        log.info(<span class=\"string\">\"&#123;&#125; :&#123;&#125; &#123;&#125; \"</span>, serviceName, request.getMethod().name(), originalUri.toString());</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RestTemplateHystrixCommnad(serviceName, () -&gt; &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> execution.execute(request, body);</div><div class=\"line\">        &#125;, hystrixFallback).execute();</div><div class=\"line\"></div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>下面是集成了HystrixCommand和Ribbon的例子</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ClientHttpResponse <span class=\"title\">intercept</span><span class=\"params\">(</span></span></div><div class=\"line\">            <span class=\"keyword\">final</span> HttpRequest request, <span class=\"keyword\">final</span> <span class=\"keyword\">byte</span>[] body,</div><div class=\"line\">            <span class=\"keyword\">final</span> ClientHttpRequestExecution execution) <span class=\"keyword\">throws</span> IOException &#123;</div><div class=\"line\">        <span class=\"keyword\">final</span> URI originalUri = request.getURI();</div><div class=\"line\">        String serviceName = mapCommandKey(originalUri);</div><div class=\"line\"></div><div class=\"line\">        log.info(<span class=\"string\">\"&#123;&#125; :&#123;&#125; &#123;&#125; \"</span>, serviceName, request.getMethod().name(), originalUri.toString());</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RestTemplateHystrixCommnad(serviceName, () -&gt; &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.loadBalancer.execute(serviceName, instance -&gt; &#123;</div><div class=\"line\">                HttpRequest serviceRequest = <span class=\"keyword\">new</span> HystrixLoadBalancerInterceptor.ServiceRequestWrapper(</div><div class=\"line\">                        request,</div><div class=\"line\">                        instance);</div><div class=\"line\">                <span class=\"keyword\">return</span> execution.execute(serviceRequest, body);</div><div class=\"line\"></div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125;, hystrixFallback).execute();</div><div class=\"line\">    &#125;</div></pre></td></tr></table></figure>\n<p>2）RestTemplate支持Hystrix异步特性</p>\n<p>Hystrix的执行在线程隔离模型下是支持异步的，因此也扩展一个RestTemplate异步执行。如下代码所示，通过调用<code>queue()</code>方法返回一个Future。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Future&lt;String&gt; fs = <span class=\"keyword\">new</span> CommandHelloWorld(<span class=\"string\">\"World\"</span>).queue();</div><div class=\"line\">String s = fs.get();</div></pre></td></tr></table></figure>\n<p>这样可以修改RestOperations接口方法为异步方法：</p>\n<p>从：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;T&gt;  <span class=\"function\">T <span class=\"title\">getForObject</span><span class=\"params\">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class=\"keyword\">throws</span> RestClientException</span>;</div></pre></td></tr></table></figure>\n<p>到：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;T&gt; <span class=\"function\">Future&lt;T&gt; <span class=\"title\">getForObject</span><span class=\"params\">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class=\"keyword\">throws</span> RestClientException</span>;</div></pre></td></tr></table></figure>\n<p>然后在原生的RestTemplate做一层代理，在代理层集成Hystrix和Ribbon，无论是JDK动态代理还是硬编码实现代理都变得容易，然后就可以这样来调用了：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">HystrixAsyncRestOperations asyncRestTemplate =<span class=\"keyword\">null</span>;</div><div class=\"line\"><span class=\"comment\">//先依次调用</span></div><div class=\"line\">Future&lt;String&gt; future1 = asyncRestTemplate.getForObject(<span class=\"string\">\"http://tietang.wang/\"</span>, String.class);</div><div class=\"line\">Future&lt;String&gt; future2 = asyncRestTemplate.getForObject(<span class=\"string\">\"http://tietang.wang/2016/03/17/hystrix/%E6%80%8E%E6%A0%B7%E4%BD%BF%E7%94%A8Hystrix/\"</span>, String.class);</div><div class=\"line\"><span class=\"comment\">//再依次获取调用结果</span></div><div class=\"line\">String html1 = future1.get();</div><div class=\"line\">String html2 = future2.get(<span class=\"number\">100</span>, TimeUnit.MILLISECONDS);<span class=\"comment\">//异步超时，建议</span></div></pre></td></tr></table></figure>\n"},{"title":"Hystrix简介","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png","date":"2016-03-09T01:22:47.000Z","keywords":"hystrix","description":"Hystrix简介","_content":"\n \n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png)\n\n1. <a href=\"#what\">What Is Hystrix?</a>\n1. <a href=\"#purpose\">What Is Hystrix For?</a>\n1. <a href=\"#problem\">What Problem Does Hystrix Solve?</a>\n1. <a href=\"#principles\">What Design Principles Underlie Hystrix?</a>\n1. <a href=\"#how\">How Does Hystrix Accomplish Its Goals?</a>\n\n<a name=\"what\" />\n## Hystrix是什么?\n\n在分布式环境中，不可避免的有许多服务依赖，而且有时候一些服务会失败。Hystrix library通过添加延迟容忍和容错逻辑来控制分布式服务之间的相互影响。Hystrix通过服务之间访问的隔离点阻止连锁故障，并提供了失败回退机制（fallback），来改进系统服务的弹性。\n\n####  Hystrix的历史\n\nHystrix是在2011年由Netflix API 团队的弹性工程演变而来。在2012年，Hystrix日益完善和成熟，在Netflix的许多团队也开始采用。现在，在Netflix，每天有成千上万的线程隔离和数百亿的信号隔离被调用执行。这已经在可用性和弹性上产生了很大的改进。\n\n \n下面的链接提供了围绕Hystrix和挑战，试图解决：\n\n* [&ldquo;Making Netflix API More Resilient&rdquo;](http://techblog.netflix.com/2011/12/making-netflix-api-more-resilient.html)\n* [&ldquo;Fault Tolerance in a High Volume, Distributed System&rdquo;](http://techblog.netflix.com/2012/02/fault-tolerance-in-high-volume.html)\n* [&ldquo;Performance and Fault Tolerance for the Netflix API&rdquo;](https://speakerdeck.com/benjchristensen/performance-and-fault-tolerance-for-the-netflix-api-august-2012)\n* [&ldquo;Application Resilience in a Service-oriented Architecture&rdquo;](http://programming.oreilly.com/2013/06/application-resilience-in-a-service-oriented-architecture.html)\n* [&ldquo;Application Resilience Engineering & Operations at Netflix&rdquo;] (https://speakerdeck.com/benjchristensen/application-resilience-engineering-and-operations-at-netflix)\n\n<a name=\"purpose\" />\n## Hystrix能做什么?\n  \nHystrix被设计为：\n\n- 保护通过第三方客户端库服务依赖访问（通常通过网络），控制其延迟和故障\n- 在复杂的分布式系统中阻止连锁故障反应\n- 快速失败和快速恢复\n- Fallback降级和在可能的情况下优雅地降级\n- 启用近实时监测，报警和操作控制\n\n\n<a name=\"problem\" />\n## Hystrix解决了什么问题?\n\n复杂分布式架构的应用程序有许多依赖，其中每一个在某些时候都会不可避免的发生失败。如果这个主应用没有从那些外部失败隔离，那么就会有被拖垮的风险。\n\n\n例如，1个应用依赖30个服务，每个服务有99.99%可用，那么预期：\n\n> 99.99<sup>30</sup>  =  99.7% uptime  \n> 10亿请求中的0.3%  = 3,000,000 次失败  \n> 即使所有依赖的服务都能达到 99.99% 的可用率，每月大约有2+小时不可用 \n> 随着服务依赖数量的变多，服务不稳定的概率会成指数性提高.\n \n**现实通常会更残酷。**\n\n**如果你没有针对整个系统做快速恢复**，即使所有依赖只有 0.01% 的不可用率，累积起来每个月给系统带来的不可用时间也有数小时之多。\n\n***\n\n \n\n当一切都ok的请求流看起来是这样的：\n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-1-1280.png)\n\n当许多后端系统中的一个成为潜在故障时，可能会阻塞所有用户请求：\n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-2-1280.png)\n\n\n \n一个高并发后端依赖成为潜在危险时，它会在几秒钟中导致所有服务器上的所有的资源耗尽。\n在网络中或者客户端库中运行的每一个app都有可能会导致成为潜在的故障源。比失败更坏的是，这个问题app也可能会导致服务之间的延迟增加，从而备份队列，线程，和其他系统资源，导致更多系统的级联故障。\n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-3-1280.png)\n\n \n\n当通过第三方客户端网络访问时，这些问题会加剧，这个第三方客户端就是一个黑盒，其实现细节是不清楚的，它能随时改变行为，每个客户端库的网络和资源配置是不同的，通常难以监控和修改。\n如果这些网络请求通过第三方客户端发出，问题会变得更加严重，因为这些第三方客户端对于应用来说相当于『黑盒』——无法了解其实现细节，随时可能发生变更，网络/资源配置随客户端的不同而不同，同时又难以监控和修改。同时，应用依赖链中的服务可能非常耗时，或者这些可能导致问题的网络请求根本没有被我们的应用显式地调用！\n\n\n网络连接可能失败或者降级。服务或者服务器可能失效或者变慢。新依赖的库或者部署的服务可能改变行为或性能，亦或是依赖的客户端库本身有bug。\n所有以上这些所描述的失败和延迟都需要被隔离和管理，才不至于因为单个服务失败而导致整个应用活系统垮掉。\n\n\n\n<a name=\"principles\" />\n## What Design Principles Underlie Hystrix?\n\nHystrix works by:\n\n* 防止任何单一依赖耗尽容器（如Tomcat）内的所有用户线程\n* 隔离和减低负载，对无法及时处理时快速失败，而不是排队\n* 提供失败回退（fallback）降级，无论何时都尽可能保护使用者免受破坏。\n* 采用隔离技术（如隔离壁，泳道，和熔断器模式）来限制任何一个依赖性的影响。\n* 通过最近实时metrics、监控和警告来优化以满足近实时性的要求\n* 在 Hystrix许多方面都需要只是配置属性的动态修改并能低延迟传播，提供优化以满足快速恢复的要求\n* 能保护应用不受依赖服务的整个执行过程中失败的影响，而不仅仅是网络请求\n\n\n\n<a name=\"how\" />\n## How Does Hystrix Accomplish Its Goals?\n\nHystrix does this by:\n\n \n- 使用`HystrixCommand`或者`HystrixObservableCommand`包装所有的外部系统（或者依赖服务）调用，每个`HystrixCommand`或者`HystrixObservableCommand`在隔离的线程中/信号下执行（参考这个例子[command pattern](http://en.wikipedia.org/wiki/Command_pattern)）\n\n- 超时机制，调用时间比定义的超时阀值大时超时。除了默认值，通过设置&ldquo;properties&rdquo;给每个依赖服务定义超时阀值,超时时间一般设为比99.5%平均时间略高即可.当调用超时时，直接返回或执行fallback逻辑。\n\n- 为每个依赖维护一个小的线程池（或信号），如果线程池已满调用将被立即拒绝来代替排队方式。\n- 测量成功，失败（抛出异常），超时和线程拒绝。\n- 如果错误比率达到设定的阀值，通过手动或者自动方式平稳的停止一个时间周期调用所有请求。\n- 当请求失败、拒绝，超时或者发生短路时，执行失败回退（fallback）逻辑。\n- 近实时监控度量，动态配置修改\n \n \n\n当使用 Hystrix 包装了你的所有依赖服务的请求后，下面图中所示的系统拓扑将会变成如下形式，每个依赖服务都被隔离开来，Hystrix 会严格控制其在延迟发生时对资源的占用，并在任何失效发生时，执行失败回退逻辑。\n\n \n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-4-isolation-1280.png)\n\n \n\n\n\n","source":"_posts/hystrix/Hystrix简介.md","raw":"---\ntitle: Hystrix简介\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png'\ndate: 2016-03-09 09:22:47\ncategories:\n\t- 技术\n\t- Hystrix\ntags:\n\t- hystrix\nkeywords: hystrix\ndescription: Hystrix简介\n---\n\n \n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png)\n\n1. <a href=\"#what\">What Is Hystrix?</a>\n1. <a href=\"#purpose\">What Is Hystrix For?</a>\n1. <a href=\"#problem\">What Problem Does Hystrix Solve?</a>\n1. <a href=\"#principles\">What Design Principles Underlie Hystrix?</a>\n1. <a href=\"#how\">How Does Hystrix Accomplish Its Goals?</a>\n\n<a name=\"what\" />\n## Hystrix是什么?\n\n在分布式环境中，不可避免的有许多服务依赖，而且有时候一些服务会失败。Hystrix library通过添加延迟容忍和容错逻辑来控制分布式服务之间的相互影响。Hystrix通过服务之间访问的隔离点阻止连锁故障，并提供了失败回退机制（fallback），来改进系统服务的弹性。\n\n####  Hystrix的历史\n\nHystrix是在2011年由Netflix API 团队的弹性工程演变而来。在2012年，Hystrix日益完善和成熟，在Netflix的许多团队也开始采用。现在，在Netflix，每天有成千上万的线程隔离和数百亿的信号隔离被调用执行。这已经在可用性和弹性上产生了很大的改进。\n\n \n下面的链接提供了围绕Hystrix和挑战，试图解决：\n\n* [&ldquo;Making Netflix API More Resilient&rdquo;](http://techblog.netflix.com/2011/12/making-netflix-api-more-resilient.html)\n* [&ldquo;Fault Tolerance in a High Volume, Distributed System&rdquo;](http://techblog.netflix.com/2012/02/fault-tolerance-in-high-volume.html)\n* [&ldquo;Performance and Fault Tolerance for the Netflix API&rdquo;](https://speakerdeck.com/benjchristensen/performance-and-fault-tolerance-for-the-netflix-api-august-2012)\n* [&ldquo;Application Resilience in a Service-oriented Architecture&rdquo;](http://programming.oreilly.com/2013/06/application-resilience-in-a-service-oriented-architecture.html)\n* [&ldquo;Application Resilience Engineering & Operations at Netflix&rdquo;] (https://speakerdeck.com/benjchristensen/application-resilience-engineering-and-operations-at-netflix)\n\n<a name=\"purpose\" />\n## Hystrix能做什么?\n  \nHystrix被设计为：\n\n- 保护通过第三方客户端库服务依赖访问（通常通过网络），控制其延迟和故障\n- 在复杂的分布式系统中阻止连锁故障反应\n- 快速失败和快速恢复\n- Fallback降级和在可能的情况下优雅地降级\n- 启用近实时监测，报警和操作控制\n\n\n<a name=\"problem\" />\n## Hystrix解决了什么问题?\n\n复杂分布式架构的应用程序有许多依赖，其中每一个在某些时候都会不可避免的发生失败。如果这个主应用没有从那些外部失败隔离，那么就会有被拖垮的风险。\n\n\n例如，1个应用依赖30个服务，每个服务有99.99%可用，那么预期：\n\n> 99.99<sup>30</sup>  =  99.7% uptime  \n> 10亿请求中的0.3%  = 3,000,000 次失败  \n> 即使所有依赖的服务都能达到 99.99% 的可用率，每月大约有2+小时不可用 \n> 随着服务依赖数量的变多，服务不稳定的概率会成指数性提高.\n \n**现实通常会更残酷。**\n\n**如果你没有针对整个系统做快速恢复**，即使所有依赖只有 0.01% 的不可用率，累积起来每个月给系统带来的不可用时间也有数小时之多。\n\n***\n\n \n\n当一切都ok的请求流看起来是这样的：\n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-1-1280.png)\n\n当许多后端系统中的一个成为潜在故障时，可能会阻塞所有用户请求：\n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-2-1280.png)\n\n\n \n一个高并发后端依赖成为潜在危险时，它会在几秒钟中导致所有服务器上的所有的资源耗尽。\n在网络中或者客户端库中运行的每一个app都有可能会导致成为潜在的故障源。比失败更坏的是，这个问题app也可能会导致服务之间的延迟增加，从而备份队列，线程，和其他系统资源，导致更多系统的级联故障。\n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-3-1280.png)\n\n \n\n当通过第三方客户端网络访问时，这些问题会加剧，这个第三方客户端就是一个黑盒，其实现细节是不清楚的，它能随时改变行为，每个客户端库的网络和资源配置是不同的，通常难以监控和修改。\n如果这些网络请求通过第三方客户端发出，问题会变得更加严重，因为这些第三方客户端对于应用来说相当于『黑盒』——无法了解其实现细节，随时可能发生变更，网络/资源配置随客户端的不同而不同，同时又难以监控和修改。同时，应用依赖链中的服务可能非常耗时，或者这些可能导致问题的网络请求根本没有被我们的应用显式地调用！\n\n\n网络连接可能失败或者降级。服务或者服务器可能失效或者变慢。新依赖的库或者部署的服务可能改变行为或性能，亦或是依赖的客户端库本身有bug。\n所有以上这些所描述的失败和延迟都需要被隔离和管理，才不至于因为单个服务失败而导致整个应用活系统垮掉。\n\n\n\n<a name=\"principles\" />\n## What Design Principles Underlie Hystrix?\n\nHystrix works by:\n\n* 防止任何单一依赖耗尽容器（如Tomcat）内的所有用户线程\n* 隔离和减低负载，对无法及时处理时快速失败，而不是排队\n* 提供失败回退（fallback）降级，无论何时都尽可能保护使用者免受破坏。\n* 采用隔离技术（如隔离壁，泳道，和熔断器模式）来限制任何一个依赖性的影响。\n* 通过最近实时metrics、监控和警告来优化以满足近实时性的要求\n* 在 Hystrix许多方面都需要只是配置属性的动态修改并能低延迟传播，提供优化以满足快速恢复的要求\n* 能保护应用不受依赖服务的整个执行过程中失败的影响，而不仅仅是网络请求\n\n\n\n<a name=\"how\" />\n## How Does Hystrix Accomplish Its Goals?\n\nHystrix does this by:\n\n \n- 使用`HystrixCommand`或者`HystrixObservableCommand`包装所有的外部系统（或者依赖服务）调用，每个`HystrixCommand`或者`HystrixObservableCommand`在隔离的线程中/信号下执行（参考这个例子[command pattern](http://en.wikipedia.org/wiki/Command_pattern)）\n\n- 超时机制，调用时间比定义的超时阀值大时超时。除了默认值，通过设置&ldquo;properties&rdquo;给每个依赖服务定义超时阀值,超时时间一般设为比99.5%平均时间略高即可.当调用超时时，直接返回或执行fallback逻辑。\n\n- 为每个依赖维护一个小的线程池（或信号），如果线程池已满调用将被立即拒绝来代替排队方式。\n- 测量成功，失败（抛出异常），超时和线程拒绝。\n- 如果错误比率达到设定的阀值，通过手动或者自动方式平稳的停止一个时间周期调用所有请求。\n- 当请求失败、拒绝，超时或者发生短路时，执行失败回退（fallback）逻辑。\n- 近实时监控度量，动态配置修改\n \n \n\n当使用 Hystrix 包装了你的所有依赖服务的请求后，下面图中所示的系统拓扑将会变成如下形式，每个依赖服务都被隔离开来，Hystrix 会严格控制其在延迟发生时对资源的占用，并在任何失效发生时，执行失败回退逻辑。\n\n \n\n![](http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-4-isolation-1280.png)\n\n \n\n\n\n","slug":"hystrix/Hystrix简介","published":1,"updated":"2017-05-21T04:43:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc1i003yz29klctyumk3","content":"<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png\" alt=\"\"></p>\n<ol>\n<li><a href=\"#what\">What Is Hystrix?</a></li>\n<li><a href=\"#purpose\">What Is Hystrix For?</a></li>\n<li><a href=\"#problem\">What Problem Does Hystrix Solve?</a></li>\n<li><a href=\"#principles\">What Design Principles Underlie Hystrix?</a></li>\n<li><a href=\"#how\">How Does Hystrix Accomplish Its Goals?</a></li>\n</ol>\n<p><a name=\"what\"></a></p>\n<h2 id=\"Hystrix是什么\"><a href=\"#Hystrix是什么\" class=\"headerlink\" title=\"Hystrix是什么?\"></a>Hystrix是什么?</h2><p>在分布式环境中，不可避免的有许多服务依赖，而且有时候一些服务会失败。Hystrix library通过添加延迟容忍和容错逻辑来控制分布式服务之间的相互影响。Hystrix通过服务之间访问的隔离点阻止连锁故障，并提供了失败回退机制（fallback），来改进系统服务的弹性。</p>\n<h4 id=\"Hystrix的历史\"><a href=\"#Hystrix的历史\" class=\"headerlink\" title=\"Hystrix的历史\"></a>Hystrix的历史</h4><p>Hystrix是在2011年由Netflix API 团队的弹性工程演变而来。在2012年，Hystrix日益完善和成熟，在Netflix的许多团队也开始采用。现在，在Netflix，每天有成千上万的线程隔离和数百亿的信号隔离被调用执行。这已经在可用性和弹性上产生了很大的改进。</p>\n<p>下面的链接提供了围绕Hystrix和挑战，试图解决：</p>\n<ul>\n<li><a href=\"http://techblog.netflix.com/2011/12/making-netflix-api-more-resilient.html\" target=\"_blank\" rel=\"external\">&ldquo;Making Netflix API More Resilient&rdquo;</a></li>\n<li><a href=\"http://techblog.netflix.com/2012/02/fault-tolerance-in-high-volume.html\" target=\"_blank\" rel=\"external\">&ldquo;Fault Tolerance in a High Volume, Distributed System&rdquo;</a></li>\n<li><a href=\"https://speakerdeck.com/benjchristensen/performance-and-fault-tolerance-for-the-netflix-api-august-2012\" target=\"_blank\" rel=\"external\">&ldquo;Performance and Fault Tolerance for the Netflix API&rdquo;</a></li>\n<li><a href=\"http://programming.oreilly.com/2013/06/application-resilience-in-a-service-oriented-architecture.html\" target=\"_blank\" rel=\"external\">&ldquo;Application Resilience in a Service-oriented Architecture&rdquo;</a></li>\n<li>[&ldquo;Application Resilience Engineering &amp; Operations at Netflix&rdquo;] (<a href=\"https://speakerdeck.com/benjchristensen/application-resilience-engineering-and-operations-at-netflix\" target=\"_blank\" rel=\"external\">https://speakerdeck.com/benjchristensen/application-resilience-engineering-and-operations-at-netflix</a>)</li>\n</ul>\n<p><a name=\"purpose\"></a></p>\n<h2 id=\"Hystrix能做什么\"><a href=\"#Hystrix能做什么\" class=\"headerlink\" title=\"Hystrix能做什么?\"></a>Hystrix能做什么?</h2><p>Hystrix被设计为：</p>\n<ul>\n<li>保护通过第三方客户端库服务依赖访问（通常通过网络），控制其延迟和故障</li>\n<li>在复杂的分布式系统中阻止连锁故障反应</li>\n<li>快速失败和快速恢复</li>\n<li>Fallback降级和在可能的情况下优雅地降级</li>\n<li>启用近实时监测，报警和操作控制</li>\n</ul>\n<p><a name=\"problem\"></a></p>\n<h2 id=\"Hystrix解决了什么问题\"><a href=\"#Hystrix解决了什么问题\" class=\"headerlink\" title=\"Hystrix解决了什么问题?\"></a>Hystrix解决了什么问题?</h2><p>复杂分布式架构的应用程序有许多依赖，其中每一个在某些时候都会不可避免的发生失败。如果这个主应用没有从那些外部失败隔离，那么就会有被拖垮的风险。</p>\n<p>例如，1个应用依赖30个服务，每个服务有99.99%可用，那么预期：</p>\n<blockquote>\n<p>99.99<sup>30</sup>  =  99.7% uptime<br>10亿请求中的0.3%  = 3,000,000 次失败<br>即使所有依赖的服务都能达到 99.99% 的可用率，每月大约有2+小时不可用<br>随着服务依赖数量的变多，服务不稳定的概率会成指数性提高.</p>\n</blockquote>\n<p><strong>现实通常会更残酷。</strong></p>\n<p><strong>如果你没有针对整个系统做快速恢复</strong>，即使所有依赖只有 0.01% 的不可用率，累积起来每个月给系统带来的不可用时间也有数小时之多。</p>\n<hr>\n<p>当一切都ok的请求流看起来是这样的：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-1-1280.png\" alt=\"\"></p>\n<p>当许多后端系统中的一个成为潜在故障时，可能会阻塞所有用户请求：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-2-1280.png\" alt=\"\"></p>\n<p>一个高并发后端依赖成为潜在危险时，它会在几秒钟中导致所有服务器上的所有的资源耗尽。<br>在网络中或者客户端库中运行的每一个app都有可能会导致成为潜在的故障源。比失败更坏的是，这个问题app也可能会导致服务之间的延迟增加，从而备份队列，线程，和其他系统资源，导致更多系统的级联故障。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-3-1280.png\" alt=\"\"></p>\n<p>当通过第三方客户端网络访问时，这些问题会加剧，这个第三方客户端就是一个黑盒，其实现细节是不清楚的，它能随时改变行为，每个客户端库的网络和资源配置是不同的，通常难以监控和修改。<br>如果这些网络请求通过第三方客户端发出，问题会变得更加严重，因为这些第三方客户端对于应用来说相当于『黑盒』——无法了解其实现细节，随时可能发生变更，网络/资源配置随客户端的不同而不同，同时又难以监控和修改。同时，应用依赖链中的服务可能非常耗时，或者这些可能导致问题的网络请求根本没有被我们的应用显式地调用！</p>\n<p>网络连接可能失败或者降级。服务或者服务器可能失效或者变慢。新依赖的库或者部署的服务可能改变行为或性能，亦或是依赖的客户端库本身有bug。<br>所有以上这些所描述的失败和延迟都需要被隔离和管理，才不至于因为单个服务失败而导致整个应用活系统垮掉。</p>\n<p><a name=\"principles\"></a></p>\n<h2 id=\"What-Design-Principles-Underlie-Hystrix\"><a href=\"#What-Design-Principles-Underlie-Hystrix\" class=\"headerlink\" title=\"What Design Principles Underlie Hystrix?\"></a>What Design Principles Underlie Hystrix?</h2><p>Hystrix works by:</p>\n<ul>\n<li>防止任何单一依赖耗尽容器（如Tomcat）内的所有用户线程</li>\n<li>隔离和减低负载，对无法及时处理时快速失败，而不是排队</li>\n<li>提供失败回退（fallback）降级，无论何时都尽可能保护使用者免受破坏。</li>\n<li>采用隔离技术（如隔离壁，泳道，和熔断器模式）来限制任何一个依赖性的影响。</li>\n<li>通过最近实时metrics、监控和警告来优化以满足近实时性的要求</li>\n<li>在 Hystrix许多方面都需要只是配置属性的动态修改并能低延迟传播，提供优化以满足快速恢复的要求</li>\n<li>能保护应用不受依赖服务的整个执行过程中失败的影响，而不仅仅是网络请求</li>\n</ul>\n<p><a name=\"how\"></a></p>\n<h2 id=\"How-Does-Hystrix-Accomplish-Its-Goals\"><a href=\"#How-Does-Hystrix-Accomplish-Its-Goals\" class=\"headerlink\" title=\"How Does Hystrix Accomplish Its Goals?\"></a>How Does Hystrix Accomplish Its Goals?</h2><p>Hystrix does this by:</p>\n<ul>\n<li><p>使用<code>HystrixCommand</code>或者<code>HystrixObservableCommand</code>包装所有的外部系统（或者依赖服务）调用，每个<code>HystrixCommand</code>或者<code>HystrixObservableCommand</code>在隔离的线程中/信号下执行（参考这个例子<a href=\"http://en.wikipedia.org/wiki/Command_pattern\" target=\"_blank\" rel=\"external\">command pattern</a>）</p>\n</li>\n<li><p>超时机制，调用时间比定义的超时阀值大时超时。除了默认值，通过设置&ldquo;properties&rdquo;给每个依赖服务定义超时阀值,超时时间一般设为比99.5%平均时间略高即可.当调用超时时，直接返回或执行fallback逻辑。</p>\n</li>\n<li><p>为每个依赖维护一个小的线程池（或信号），如果线程池已满调用将被立即拒绝来代替排队方式。</p>\n</li>\n<li>测量成功，失败（抛出异常），超时和线程拒绝。</li>\n<li>如果错误比率达到设定的阀值，通过手动或者自动方式平稳的停止一个时间周期调用所有请求。</li>\n<li>当请求失败、拒绝，超时或者发生短路时，执行失败回退（fallback）逻辑。</li>\n<li>近实时监控度量，动态配置修改</li>\n</ul>\n<p>当使用 Hystrix 包装了你的所有依赖服务的请求后，下面图中所示的系统拓扑将会变成如下形式，每个依赖服务都被隔离开来，Hystrix 会严格控制其在延迟发生时对资源的占用，并在任何失效发生时，执行失败回退逻辑。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-4-isolation-1280.png\" alt=\"\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo-tagline-640.png\" alt=\"\"></p>\n<ol>\n<li><a href=\"#what\">What Is Hystrix?</a></li>\n<li><a href=\"#purpose\">What Is Hystrix For?</a></li>\n<li><a href=\"#problem\">What Problem Does Hystrix Solve?</a></li>\n<li><a href=\"#principles\">What Design Principles Underlie Hystrix?</a></li>\n<li><a href=\"#how\">How Does Hystrix Accomplish Its Goals?</a></li>\n</ol>\n<p><a name=\"what\"></a></p>\n<h2 id=\"Hystrix是什么\"><a href=\"#Hystrix是什么\" class=\"headerlink\" title=\"Hystrix是什么?\"></a>Hystrix是什么?</h2><p>在分布式环境中，不可避免的有许多服务依赖，而且有时候一些服务会失败。Hystrix library通过添加延迟容忍和容错逻辑来控制分布式服务之间的相互影响。Hystrix通过服务之间访问的隔离点阻止连锁故障，并提供了失败回退机制（fallback），来改进系统服务的弹性。</p>\n<h4 id=\"Hystrix的历史\"><a href=\"#Hystrix的历史\" class=\"headerlink\" title=\"Hystrix的历史\"></a>Hystrix的历史</h4><p>Hystrix是在2011年由Netflix API 团队的弹性工程演变而来。在2012年，Hystrix日益完善和成熟，在Netflix的许多团队也开始采用。现在，在Netflix，每天有成千上万的线程隔离和数百亿的信号隔离被调用执行。这已经在可用性和弹性上产生了很大的改进。</p>\n<p>下面的链接提供了围绕Hystrix和挑战，试图解决：</p>\n<ul>\n<li><a href=\"http://techblog.netflix.com/2011/12/making-netflix-api-more-resilient.html\" target=\"_blank\" rel=\"external\">&ldquo;Making Netflix API More Resilient&rdquo;</a></li>\n<li><a href=\"http://techblog.netflix.com/2012/02/fault-tolerance-in-high-volume.html\" target=\"_blank\" rel=\"external\">&ldquo;Fault Tolerance in a High Volume, Distributed System&rdquo;</a></li>\n<li><a href=\"https://speakerdeck.com/benjchristensen/performance-and-fault-tolerance-for-the-netflix-api-august-2012\" target=\"_blank\" rel=\"external\">&ldquo;Performance and Fault Tolerance for the Netflix API&rdquo;</a></li>\n<li><a href=\"http://programming.oreilly.com/2013/06/application-resilience-in-a-service-oriented-architecture.html\" target=\"_blank\" rel=\"external\">&ldquo;Application Resilience in a Service-oriented Architecture&rdquo;</a></li>\n<li>[&ldquo;Application Resilience Engineering &amp; Operations at Netflix&rdquo;] (<a href=\"https://speakerdeck.com/benjchristensen/application-resilience-engineering-and-operations-at-netflix\" target=\"_blank\" rel=\"external\">https://speakerdeck.com/benjchristensen/application-resilience-engineering-and-operations-at-netflix</a>)</li>\n</ul>\n<p><a name=\"purpose\"></a></p>\n<h2 id=\"Hystrix能做什么\"><a href=\"#Hystrix能做什么\" class=\"headerlink\" title=\"Hystrix能做什么?\"></a>Hystrix能做什么?</h2><p>Hystrix被设计为：</p>\n<ul>\n<li>保护通过第三方客户端库服务依赖访问（通常通过网络），控制其延迟和故障</li>\n<li>在复杂的分布式系统中阻止连锁故障反应</li>\n<li>快速失败和快速恢复</li>\n<li>Fallback降级和在可能的情况下优雅地降级</li>\n<li>启用近实时监测，报警和操作控制</li>\n</ul>\n<p><a name=\"problem\"></a></p>\n<h2 id=\"Hystrix解决了什么问题\"><a href=\"#Hystrix解决了什么问题\" class=\"headerlink\" title=\"Hystrix解决了什么问题?\"></a>Hystrix解决了什么问题?</h2><p>复杂分布式架构的应用程序有许多依赖，其中每一个在某些时候都会不可避免的发生失败。如果这个主应用没有从那些外部失败隔离，那么就会有被拖垮的风险。</p>\n<p>例如，1个应用依赖30个服务，每个服务有99.99%可用，那么预期：</p>\n<blockquote>\n<p>99.99<sup>30</sup>  =  99.7% uptime<br>10亿请求中的0.3%  = 3,000,000 次失败<br>即使所有依赖的服务都能达到 99.99% 的可用率，每月大约有2+小时不可用<br>随着服务依赖数量的变多，服务不稳定的概率会成指数性提高.</p>\n</blockquote>\n<p><strong>现实通常会更残酷。</strong></p>\n<p><strong>如果你没有针对整个系统做快速恢复</strong>，即使所有依赖只有 0.01% 的不可用率，累积起来每个月给系统带来的不可用时间也有数小时之多。</p>\n<hr>\n<p>当一切都ok的请求流看起来是这样的：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-1-1280.png\" alt=\"\"></p>\n<p>当许多后端系统中的一个成为潜在故障时，可能会阻塞所有用户请求：</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-2-1280.png\" alt=\"\"></p>\n<p>一个高并发后端依赖成为潜在危险时，它会在几秒钟中导致所有服务器上的所有的资源耗尽。<br>在网络中或者客户端库中运行的每一个app都有可能会导致成为潜在的故障源。比失败更坏的是，这个问题app也可能会导致服务之间的延迟增加，从而备份队列，线程，和其他系统资源，导致更多系统的级联故障。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-3-1280.png\" alt=\"\"></p>\n<p>当通过第三方客户端网络访问时，这些问题会加剧，这个第三方客户端就是一个黑盒，其实现细节是不清楚的，它能随时改变行为，每个客户端库的网络和资源配置是不同的，通常难以监控和修改。<br>如果这些网络请求通过第三方客户端发出，问题会变得更加严重，因为这些第三方客户端对于应用来说相当于『黑盒』——无法了解其实现细节，随时可能发生变更，网络/资源配置随客户端的不同而不同，同时又难以监控和修改。同时，应用依赖链中的服务可能非常耗时，或者这些可能导致问题的网络请求根本没有被我们的应用显式地调用！</p>\n<p>网络连接可能失败或者降级。服务或者服务器可能失效或者变慢。新依赖的库或者部署的服务可能改变行为或性能，亦或是依赖的客户端库本身有bug。<br>所有以上这些所描述的失败和延迟都需要被隔离和管理，才不至于因为单个服务失败而导致整个应用活系统垮掉。</p>\n<p><a name=\"principles\"></a></p>\n<h2 id=\"What-Design-Principles-Underlie-Hystrix\"><a href=\"#What-Design-Principles-Underlie-Hystrix\" class=\"headerlink\" title=\"What Design Principles Underlie Hystrix?\"></a>What Design Principles Underlie Hystrix?</h2><p>Hystrix works by:</p>\n<ul>\n<li>防止任何单一依赖耗尽容器（如Tomcat）内的所有用户线程</li>\n<li>隔离和减低负载，对无法及时处理时快速失败，而不是排队</li>\n<li>提供失败回退（fallback）降级，无论何时都尽可能保护使用者免受破坏。</li>\n<li>采用隔离技术（如隔离壁，泳道，和熔断器模式）来限制任何一个依赖性的影响。</li>\n<li>通过最近实时metrics、监控和警告来优化以满足近实时性的要求</li>\n<li>在 Hystrix许多方面都需要只是配置属性的动态修改并能低延迟传播，提供优化以满足快速恢复的要求</li>\n<li>能保护应用不受依赖服务的整个执行过程中失败的影响，而不仅仅是网络请求</li>\n</ul>\n<p><a name=\"how\"></a></p>\n<h2 id=\"How-Does-Hystrix-Accomplish-Its-Goals\"><a href=\"#How-Does-Hystrix-Accomplish-Its-Goals\" class=\"headerlink\" title=\"How Does Hystrix Accomplish Its Goals?\"></a>How Does Hystrix Accomplish Its Goals?</h2><p>Hystrix does this by:</p>\n<ul>\n<li><p>使用<code>HystrixCommand</code>或者<code>HystrixObservableCommand</code>包装所有的外部系统（或者依赖服务）调用，每个<code>HystrixCommand</code>或者<code>HystrixObservableCommand</code>在隔离的线程中/信号下执行（参考这个例子<a href=\"http://en.wikipedia.org/wiki/Command_pattern\" target=\"_blank\" rel=\"external\">command pattern</a>）</p>\n</li>\n<li><p>超时机制，调用时间比定义的超时阀值大时超时。除了默认值，通过设置&ldquo;properties&rdquo;给每个依赖服务定义超时阀值,超时时间一般设为比99.5%平均时间略高即可.当调用超时时，直接返回或执行fallback逻辑。</p>\n</li>\n<li><p>为每个依赖维护一个小的线程池（或信号），如果线程池已满调用将被立即拒绝来代替排队方式。</p>\n</li>\n<li>测量成功，失败（抛出异常），超时和线程拒绝。</li>\n<li>如果错误比率达到设定的阀值，通过手动或者自动方式平稳的停止一个时间周期调用所有请求。</li>\n<li>当请求失败、拒绝，超时或者发生短路时，执行失败回退（fallback）逻辑。</li>\n<li>近实时监控度量，动态配置修改</li>\n</ul>\n<p>当使用 Hystrix 包装了你的所有依赖服务的请求后，下面图中所示的系统拓扑将会变成如下形式，每个依赖服务都被隔离开来，Hystrix 会严格控制其在延迟发生时对资源的占用，并在任何失效发生时，执行失败回退逻辑。</p>\n<p><img src=\"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-soa-4-isolation-1280.png\" alt=\"\"></p>\n"},{"title":"zuul 参数调优","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo.png","date":"2016-11-17T11:22:47.000Z","keywords":["技术","Hystrix","zuul"],"description":null,"_content":"\n\n# zuul 参数调优\n\n适用版本：\nspring-boot: 1.4.x.RELEASE\nspring-cloud：Camden.SR3\nHystrix: 1.5.6\n\n## spring-boot-tomcat 优化参数：\n\n主要只有2个，最大和最小worker线程：\n\n```\nserver.tomcat.max-threads=128 # Maximum amount of worker threads.\nserver.tomcat.min-spare-threads=64 # Minimum amount of worker threads.\n```\n\n## spring-boot-undertow 优化参数：\n\n### ioThreads\n设置IO线程数, 它主要执行非阻塞的任务,它们会负责多个连接,默认取CPU核心数量,最小值为2。\n`Math.max(Runtime.getRuntime().availableProcessors(), 2);`\nspring-boot 参数：`server.undertow.io-threads= `\n\n\n### worker-threads\n阻塞任务线程池, 当执行类似servlet请求阻塞操作, undertow会从这个线程池中取得线程,它的值设置取决于系统的负载，默认值为io-threads*8。\n\nspring-boot 参数：`server.undertow.worker-threads= `\n\n### buffer\n\n**buffer-size:**\n\n每块buffer的空间大小,越小的空间被利用越充分。\n\n**buffers-per-region: **\n\n每个区分配的buffer数量 , 所以pool的大小是buffer-size * buffers-per-region。\n\n**directBuffers**\n\n是否分配的直接内存。\n\n\n\n获取JVM最大可用内存`maxMemory=Runtime.getRuntime().maxMemory();`\n\nmaxMemory<64M,不开启directBuffers， bufferSize = 512,buffersPerRegion = 10;\n\n64<=maxMemory<128M,开启directBuffers， bufferSize = 1024 bytes,buffersPerRegion = 10;\n\nmaxMemory>128M,开启directBuffers， bufferSize = 16*1024 bytes,buffersPerRegion = 20;\n\nspring-boot 参数：\n\n```\n# 最大可用内存<64M,不开启\nserver.undertow.buffer-size= # Size of each buffer in bytes.\nserver.undertow.buffers-per-region= # Number of buffer per region.\nserver.undertow.direct-buffers= # Allocate buffers outside the Java heap.\n//默认值：cpu数量，最小为2\nserver.undertow.io-threads= # Number of I/O threads to create for the worker.\n//默认值：io-threads*8\nserver.undertow.worker-threads= # Number of worker threads.\n```\n\n\n\n## zuul 内置参数\n\n### zuul.host.maxTotalConnections\n\n适用于ApacheHttpClient，如果是okhttp无效。每个服务的http客户端连接池最大连接，默认是200.\n\n### zuul.host.maxPerRouteConnections\n\n适用于ApacheHttpClient，如果是okhttp无效。每个route可用的最大连接数，默认值是20。\n\n### zuul.semaphore.max-semaphores\n\nHystrix最大的并发请求`execution.isolation.semaphore.maxConcurrentRequests`，这个值并非`TPS`、`QPS`、`RPS`等都是相对值，指的是1秒时间窗口内的事务/查询/请求，`semaphore.maxConcurrentRequests`是一个绝对值，无时间窗口，相当于亚毫秒级的。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。参考: [Hystrix semaphore和thread隔离策略的区别及配置参考](<http://www.jianshu.com/p/b8d21248c9b1>)\n\n\n这个参数本来直接可以通过Hystrix的命名规则来设置，但被zuul重新设计了，使得在zuul中semaphores的最大并发请求有4个方法的参数可以设置，如果4个参数都存在优先级（1~4）由高到低：\n\n- [优先级1]zuul.eureka.api.semaphore.maxSemaphores\n- [优先级2]zuul.semaphore.max-semaphores\n- [优先级3]hystrix.command.api.execution.isolation.semaphore.maxConcurrentRequests\n- [优先级4]hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests\n\n需要注意的是：在Camden.SR3版本的zuul中`hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests`设置不会起作用，这是因为在`org.springframework.cloud.netflix.zuul.filters.ZuulProperties.HystrixSemaphore.maxSemaphores=100`设置了默认值100，因此`zuul.semaphore.max-semaphores`的优先级高于`hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests`。\n\n \n\nzuul.eureka.[commandKey].semaphore.maxSemaphores：\n其中commandKey为\n\n参考设置参数：\n\n```\n#\nzuul.host.maxTotalConnections: 200\nzuul.host.maxPerRouteConnections: 10\n#zuul.semaphore.max-semaphores: 128\n# 建议使用这种方式来设置，可以给每个不同的后端微服务设置不同的信号量\nzuul.eureka.[service id].semaphore.maxSemaphores: 128\n\n```\n\n## 其他Hystrix参数：\n\n`hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds `用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。\n\n\n- 建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。\n- 建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：`hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds`\n\n## ribbon参数\n\n\n```\nribbon:\n#  # Max number of next servers to retry (excluding the first server)\n#  MaxAutoRetries: 1\n#  # Whether all operations can be retried for this client\n#  MaxAutoRetriesNextServer: 1\n#  # Interval to refresh the server list from the source\n#  OkToRetryOnAllOperations: true\n#  # Interval to refresh the server list from the source\n#  ServerListRefreshInterval: 2000\n#  # Connect timeout used by Apache HttpClient\n  ConnectTimeout: 3000\n#  # Read timeout used by Apache HttpClient\n  ReadTimeout: 3000\n```\n\n主要是`ConnectTimeout`和`ReadTimeout`2个参数，最终会设置到http Client中。\n\n注意这个参数很重要了，会配合`execution.isolation.thread.timeoutInMilliseconds `一起来用，多少合适要根据微服务实际情况来定：\n\n- **太小：**会导致很多正常业务失败\n- **太大：**会导致实际的熔断效果很差，严重会导致雪崩。\n\n一般实际大小为：\n\n- 要保证该服务的可用性为几个9？99.5 99.9 99.99 \n- 要保证的N个9的最大响应时间。","source":"_posts/hystrix/zuu参数l优化和配置.md","raw":"---\ntitle: zuul 参数调优\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/hystrix-hystrix-logo.png'\ndate: 2016-11-17 19:22:47\ncategories:\n\t- 技术\n\t- Hystrix\ntags:\n\t- spring cloud\n\t- Hystrix\n\t- zuul\nkeywords:\n\t- 技术\n\t- Hystrix\n\t- zuul\ndescription:\n---\n\n\n# zuul 参数调优\n\n适用版本：\nspring-boot: 1.4.x.RELEASE\nspring-cloud：Camden.SR3\nHystrix: 1.5.6\n\n## spring-boot-tomcat 优化参数：\n\n主要只有2个，最大和最小worker线程：\n\n```\nserver.tomcat.max-threads=128 # Maximum amount of worker threads.\nserver.tomcat.min-spare-threads=64 # Minimum amount of worker threads.\n```\n\n## spring-boot-undertow 优化参数：\n\n### ioThreads\n设置IO线程数, 它主要执行非阻塞的任务,它们会负责多个连接,默认取CPU核心数量,最小值为2。\n`Math.max(Runtime.getRuntime().availableProcessors(), 2);`\nspring-boot 参数：`server.undertow.io-threads= `\n\n\n### worker-threads\n阻塞任务线程池, 当执行类似servlet请求阻塞操作, undertow会从这个线程池中取得线程,它的值设置取决于系统的负载，默认值为io-threads*8。\n\nspring-boot 参数：`server.undertow.worker-threads= `\n\n### buffer\n\n**buffer-size:**\n\n每块buffer的空间大小,越小的空间被利用越充分。\n\n**buffers-per-region: **\n\n每个区分配的buffer数量 , 所以pool的大小是buffer-size * buffers-per-region。\n\n**directBuffers**\n\n是否分配的直接内存。\n\n\n\n获取JVM最大可用内存`maxMemory=Runtime.getRuntime().maxMemory();`\n\nmaxMemory<64M,不开启directBuffers， bufferSize = 512,buffersPerRegion = 10;\n\n64<=maxMemory<128M,开启directBuffers， bufferSize = 1024 bytes,buffersPerRegion = 10;\n\nmaxMemory>128M,开启directBuffers， bufferSize = 16*1024 bytes,buffersPerRegion = 20;\n\nspring-boot 参数：\n\n```\n# 最大可用内存<64M,不开启\nserver.undertow.buffer-size= # Size of each buffer in bytes.\nserver.undertow.buffers-per-region= # Number of buffer per region.\nserver.undertow.direct-buffers= # Allocate buffers outside the Java heap.\n//默认值：cpu数量，最小为2\nserver.undertow.io-threads= # Number of I/O threads to create for the worker.\n//默认值：io-threads*8\nserver.undertow.worker-threads= # Number of worker threads.\n```\n\n\n\n## zuul 内置参数\n\n### zuul.host.maxTotalConnections\n\n适用于ApacheHttpClient，如果是okhttp无效。每个服务的http客户端连接池最大连接，默认是200.\n\n### zuul.host.maxPerRouteConnections\n\n适用于ApacheHttpClient，如果是okhttp无效。每个route可用的最大连接数，默认值是20。\n\n### zuul.semaphore.max-semaphores\n\nHystrix最大的并发请求`execution.isolation.semaphore.maxConcurrentRequests`，这个值并非`TPS`、`QPS`、`RPS`等都是相对值，指的是1秒时间窗口内的事务/查询/请求，`semaphore.maxConcurrentRequests`是一个绝对值，无时间窗口，相当于亚毫秒级的。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。参考: [Hystrix semaphore和thread隔离策略的区别及配置参考](<http://www.jianshu.com/p/b8d21248c9b1>)\n\n\n这个参数本来直接可以通过Hystrix的命名规则来设置，但被zuul重新设计了，使得在zuul中semaphores的最大并发请求有4个方法的参数可以设置，如果4个参数都存在优先级（1~4）由高到低：\n\n- [优先级1]zuul.eureka.api.semaphore.maxSemaphores\n- [优先级2]zuul.semaphore.max-semaphores\n- [优先级3]hystrix.command.api.execution.isolation.semaphore.maxConcurrentRequests\n- [优先级4]hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests\n\n需要注意的是：在Camden.SR3版本的zuul中`hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests`设置不会起作用，这是因为在`org.springframework.cloud.netflix.zuul.filters.ZuulProperties.HystrixSemaphore.maxSemaphores=100`设置了默认值100，因此`zuul.semaphore.max-semaphores`的优先级高于`hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests`。\n\n \n\nzuul.eureka.[commandKey].semaphore.maxSemaphores：\n其中commandKey为\n\n参考设置参数：\n\n```\n#\nzuul.host.maxTotalConnections: 200\nzuul.host.maxPerRouteConnections: 10\n#zuul.semaphore.max-semaphores: 128\n# 建议使用这种方式来设置，可以给每个不同的后端微服务设置不同的信号量\nzuul.eureka.[service id].semaphore.maxSemaphores: 128\n\n```\n\n## 其他Hystrix参数：\n\n`hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds `用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。\n\n\n- 建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。\n- 建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：`hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds`\n\n## ribbon参数\n\n\n```\nribbon:\n#  # Max number of next servers to retry (excluding the first server)\n#  MaxAutoRetries: 1\n#  # Whether all operations can be retried for this client\n#  MaxAutoRetriesNextServer: 1\n#  # Interval to refresh the server list from the source\n#  OkToRetryOnAllOperations: true\n#  # Interval to refresh the server list from the source\n#  ServerListRefreshInterval: 2000\n#  # Connect timeout used by Apache HttpClient\n  ConnectTimeout: 3000\n#  # Read timeout used by Apache HttpClient\n  ReadTimeout: 3000\n```\n\n主要是`ConnectTimeout`和`ReadTimeout`2个参数，最终会设置到http Client中。\n\n注意这个参数很重要了，会配合`execution.isolation.thread.timeoutInMilliseconds `一起来用，多少合适要根据微服务实际情况来定：\n\n- **太小：**会导致很多正常业务失败\n- **太大：**会导致实际的熔断效果很差，严重会导致雪崩。\n\n一般实际大小为：\n\n- 要保证该服务的可用性为几个9？99.5 99.9 99.99 \n- 要保证的N个9的最大响应时间。","slug":"hystrix/zuu参数l优化和配置","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc1k0042z29k6e21nzms","content":"<h1 id=\"zuul-参数调优\"><a href=\"#zuul-参数调优\" class=\"headerlink\" title=\"zuul 参数调优\"></a>zuul 参数调优</h1><p>适用版本：<br>spring-boot: 1.4.x.RELEASE<br>spring-cloud：Camden.SR3<br>Hystrix: 1.5.6</p>\n<h2 id=\"spring-boot-tomcat-优化参数：\"><a href=\"#spring-boot-tomcat-优化参数：\" class=\"headerlink\" title=\"spring-boot-tomcat 优化参数：\"></a>spring-boot-tomcat 优化参数：</h2><p>主要只有2个，最大和最小worker线程：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">server.tomcat.max-threads=128 # Maximum amount of worker threads.</div><div class=\"line\">server.tomcat.min-spare-threads=64 # Minimum amount of worker threads.</div></pre></td></tr></table></figure>\n<h2 id=\"spring-boot-undertow-优化参数：\"><a href=\"#spring-boot-undertow-优化参数：\" class=\"headerlink\" title=\"spring-boot-undertow 优化参数：\"></a>spring-boot-undertow 优化参数：</h2><h3 id=\"ioThreads\"><a href=\"#ioThreads\" class=\"headerlink\" title=\"ioThreads\"></a>ioThreads</h3><p>设置IO线程数, 它主要执行非阻塞的任务,它们会负责多个连接,默认取CPU核心数量,最小值为2。<br><code>Math.max(Runtime.getRuntime().availableProcessors(), 2);</code><br>spring-boot 参数：<code>server.undertow.io-threads=</code></p>\n<h3 id=\"worker-threads\"><a href=\"#worker-threads\" class=\"headerlink\" title=\"worker-threads\"></a>worker-threads</h3><p>阻塞任务线程池, 当执行类似servlet请求阻塞操作, undertow会从这个线程池中取得线程,它的值设置取决于系统的负载，默认值为io-threads*8。</p>\n<p>spring-boot 参数：<code>server.undertow.worker-threads=</code></p>\n<h3 id=\"buffer\"><a href=\"#buffer\" class=\"headerlink\" title=\"buffer\"></a>buffer</h3><p><strong>buffer-size:</strong></p>\n<p>每块buffer的空间大小,越小的空间被利用越充分。</p>\n<p><strong>buffers-per-region: </strong></p>\n<p>每个区分配的buffer数量 , 所以pool的大小是buffer-size * buffers-per-region。</p>\n<p><strong>directBuffers</strong></p>\n<p>是否分配的直接内存。</p>\n<p>获取JVM最大可用内存<code>maxMemory=Runtime.getRuntime().maxMemory();</code></p>\n<p>maxMemory&lt;64M,不开启directBuffers， bufferSize = 512,buffersPerRegion = 10;</p>\n<p>64&lt;=maxMemory&lt;128M,开启directBuffers， bufferSize = 1024 bytes,buffersPerRegion = 10;</p>\n<p>maxMemory&gt;128M,开启directBuffers， bufferSize = 16*1024 bytes,buffersPerRegion = 20;</p>\n<p>spring-boot 参数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"># 最大可用内存&lt;64M,不开启</div><div class=\"line\">server.undertow.buffer-size= # Size of each buffer in bytes.</div><div class=\"line\">server.undertow.buffers-per-region= # Number of buffer per region.</div><div class=\"line\">server.undertow.direct-buffers= # Allocate buffers outside the Java heap.</div><div class=\"line\">//默认值：cpu数量，最小为2</div><div class=\"line\">server.undertow.io-threads= # Number of I/O threads to create for the worker.</div><div class=\"line\">//默认值：io-threads*8</div><div class=\"line\">server.undertow.worker-threads= # Number of worker threads.</div></pre></td></tr></table></figure>\n<h2 id=\"zuul-内置参数\"><a href=\"#zuul-内置参数\" class=\"headerlink\" title=\"zuul 内置参数\"></a>zuul 内置参数</h2><h3 id=\"zuul-host-maxTotalConnections\"><a href=\"#zuul-host-maxTotalConnections\" class=\"headerlink\" title=\"zuul.host.maxTotalConnections\"></a>zuul.host.maxTotalConnections</h3><p>适用于ApacheHttpClient，如果是okhttp无效。每个服务的http客户端连接池最大连接，默认是200.</p>\n<h3 id=\"zuul-host-maxPerRouteConnections\"><a href=\"#zuul-host-maxPerRouteConnections\" class=\"headerlink\" title=\"zuul.host.maxPerRouteConnections\"></a>zuul.host.maxPerRouteConnections</h3><p>适用于ApacheHttpClient，如果是okhttp无效。每个route可用的最大连接数，默认值是20。</p>\n<h3 id=\"zuul-semaphore-max-semaphores\"><a href=\"#zuul-semaphore-max-semaphores\" class=\"headerlink\" title=\"zuul.semaphore.max-semaphores\"></a>zuul.semaphore.max-semaphores</h3><p>Hystrix最大的并发请求<code>execution.isolation.semaphore.maxConcurrentRequests</code>，这个值并非<code>TPS</code>、<code>QPS</code>、<code>RPS</code>等都是相对值，指的是1秒时间窗口内的事务/查询/请求，<code>semaphore.maxConcurrentRequests</code>是一个绝对值，无时间窗口，相当于亚毫秒级的。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。参考: <a href=\"http://www.jianshu.com/p/b8d21248c9b1\" target=\"_blank\" rel=\"external\">Hystrix semaphore和thread隔离策略的区别及配置参考</a></p>\n<p>这个参数本来直接可以通过Hystrix的命名规则来设置，但被zuul重新设计了，使得在zuul中semaphores的最大并发请求有4个方法的参数可以设置，如果4个参数都存在优先级（1~4）由高到低：</p>\n<ul>\n<li>[优先级1]zuul.eureka.api.semaphore.maxSemaphores</li>\n<li>[优先级2]zuul.semaphore.max-semaphores</li>\n<li>[优先级3]hystrix.command.api.execution.isolation.semaphore.maxConcurrentRequests</li>\n<li>[优先级4]hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</li>\n</ul>\n<p>需要注意的是：在Camden.SR3版本的zuul中<code>hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</code>设置不会起作用，这是因为在<code>org.springframework.cloud.netflix.zuul.filters.ZuulProperties.HystrixSemaphore.maxSemaphores=100</code>设置了默认值100，因此<code>zuul.semaphore.max-semaphores</code>的优先级高于<code>hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</code>。</p>\n<p>zuul.eureka.[commandKey].semaphore.maxSemaphores：<br>其中commandKey为</p>\n<p>参考设置参数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">#</div><div class=\"line\">zuul.host.maxTotalConnections: 200</div><div class=\"line\">zuul.host.maxPerRouteConnections: 10</div><div class=\"line\">#zuul.semaphore.max-semaphores: 128</div><div class=\"line\"># 建议使用这种方式来设置，可以给每个不同的后端微服务设置不同的信号量</div><div class=\"line\">zuul.eureka.[service id].semaphore.maxSemaphores: 128</div></pre></td></tr></table></figure>\n<h2 id=\"其他Hystrix参数：\"><a href=\"#其他Hystrix参数：\" class=\"headerlink\" title=\"其他Hystrix参数：\"></a>其他Hystrix参数：</h2><p><code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code>用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。</p>\n<ul>\n<li>建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。</li>\n<li>建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：<code>hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds</code></li>\n</ul>\n<h2 id=\"ribbon参数\"><a href=\"#ribbon参数\" class=\"headerlink\" title=\"ribbon参数\"></a>ribbon参数</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">ribbon:</div><div class=\"line\">#  # Max number of next servers to retry (excluding the first server)</div><div class=\"line\">#  MaxAutoRetries: 1</div><div class=\"line\">#  # Whether all operations can be retried for this client</div><div class=\"line\">#  MaxAutoRetriesNextServer: 1</div><div class=\"line\">#  # Interval to refresh the server list from the source</div><div class=\"line\">#  OkToRetryOnAllOperations: true</div><div class=\"line\">#  # Interval to refresh the server list from the source</div><div class=\"line\">#  ServerListRefreshInterval: 2000</div><div class=\"line\">#  # Connect timeout used by Apache HttpClient</div><div class=\"line\">  ConnectTimeout: 3000</div><div class=\"line\">#  # Read timeout used by Apache HttpClient</div><div class=\"line\">  ReadTimeout: 3000</div></pre></td></tr></table></figure>\n<p>主要是<code>ConnectTimeout</code>和<code>ReadTimeout</code>2个参数，最终会设置到http Client中。</p>\n<p>注意这个参数很重要了，会配合<code>execution.isolation.thread.timeoutInMilliseconds</code>一起来用，多少合适要根据微服务实际情况来定：</p>\n<ul>\n<li><strong>太小：</strong>会导致很多正常业务失败</li>\n<li><strong>太大：</strong>会导致实际的熔断效果很差，严重会导致雪崩。</li>\n</ul>\n<p>一般实际大小为：</p>\n<ul>\n<li>要保证该服务的可用性为几个9？99.5 99.9 99.99 </li>\n<li>要保证的N个9的最大响应时间。</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"zuul-参数调优\"><a href=\"#zuul-参数调优\" class=\"headerlink\" title=\"zuul 参数调优\"></a>zuul 参数调优</h1><p>适用版本：<br>spring-boot: 1.4.x.RELEASE<br>spring-cloud：Camden.SR3<br>Hystrix: 1.5.6</p>\n<h2 id=\"spring-boot-tomcat-优化参数：\"><a href=\"#spring-boot-tomcat-优化参数：\" class=\"headerlink\" title=\"spring-boot-tomcat 优化参数：\"></a>spring-boot-tomcat 优化参数：</h2><p>主要只有2个，最大和最小worker线程：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">server.tomcat.max-threads=128 # Maximum amount of worker threads.</div><div class=\"line\">server.tomcat.min-spare-threads=64 # Minimum amount of worker threads.</div></pre></td></tr></table></figure>\n<h2 id=\"spring-boot-undertow-优化参数：\"><a href=\"#spring-boot-undertow-优化参数：\" class=\"headerlink\" title=\"spring-boot-undertow 优化参数：\"></a>spring-boot-undertow 优化参数：</h2><h3 id=\"ioThreads\"><a href=\"#ioThreads\" class=\"headerlink\" title=\"ioThreads\"></a>ioThreads</h3><p>设置IO线程数, 它主要执行非阻塞的任务,它们会负责多个连接,默认取CPU核心数量,最小值为2。<br><code>Math.max(Runtime.getRuntime().availableProcessors(), 2);</code><br>spring-boot 参数：<code>server.undertow.io-threads=</code></p>\n<h3 id=\"worker-threads\"><a href=\"#worker-threads\" class=\"headerlink\" title=\"worker-threads\"></a>worker-threads</h3><p>阻塞任务线程池, 当执行类似servlet请求阻塞操作, undertow会从这个线程池中取得线程,它的值设置取决于系统的负载，默认值为io-threads*8。</p>\n<p>spring-boot 参数：<code>server.undertow.worker-threads=</code></p>\n<h3 id=\"buffer\"><a href=\"#buffer\" class=\"headerlink\" title=\"buffer\"></a>buffer</h3><p><strong>buffer-size:</strong></p>\n<p>每块buffer的空间大小,越小的空间被利用越充分。</p>\n<p><strong>buffers-per-region: </strong></p>\n<p>每个区分配的buffer数量 , 所以pool的大小是buffer-size * buffers-per-region。</p>\n<p><strong>directBuffers</strong></p>\n<p>是否分配的直接内存。</p>\n<p>获取JVM最大可用内存<code>maxMemory=Runtime.getRuntime().maxMemory();</code></p>\n<p>maxMemory&lt;64M,不开启directBuffers， bufferSize = 512,buffersPerRegion = 10;</p>\n<p>64&lt;=maxMemory&lt;128M,开启directBuffers， bufferSize = 1024 bytes,buffersPerRegion = 10;</p>\n<p>maxMemory&gt;128M,开启directBuffers， bufferSize = 16*1024 bytes,buffersPerRegion = 20;</p>\n<p>spring-boot 参数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"># 最大可用内存&lt;64M,不开启</div><div class=\"line\">server.undertow.buffer-size= # Size of each buffer in bytes.</div><div class=\"line\">server.undertow.buffers-per-region= # Number of buffer per region.</div><div class=\"line\">server.undertow.direct-buffers= # Allocate buffers outside the Java heap.</div><div class=\"line\">//默认值：cpu数量，最小为2</div><div class=\"line\">server.undertow.io-threads= # Number of I/O threads to create for the worker.</div><div class=\"line\">//默认值：io-threads*8</div><div class=\"line\">server.undertow.worker-threads= # Number of worker threads.</div></pre></td></tr></table></figure>\n<h2 id=\"zuul-内置参数\"><a href=\"#zuul-内置参数\" class=\"headerlink\" title=\"zuul 内置参数\"></a>zuul 内置参数</h2><h3 id=\"zuul-host-maxTotalConnections\"><a href=\"#zuul-host-maxTotalConnections\" class=\"headerlink\" title=\"zuul.host.maxTotalConnections\"></a>zuul.host.maxTotalConnections</h3><p>适用于ApacheHttpClient，如果是okhttp无效。每个服务的http客户端连接池最大连接，默认是200.</p>\n<h3 id=\"zuul-host-maxPerRouteConnections\"><a href=\"#zuul-host-maxPerRouteConnections\" class=\"headerlink\" title=\"zuul.host.maxPerRouteConnections\"></a>zuul.host.maxPerRouteConnections</h3><p>适用于ApacheHttpClient，如果是okhttp无效。每个route可用的最大连接数，默认值是20。</p>\n<h3 id=\"zuul-semaphore-max-semaphores\"><a href=\"#zuul-semaphore-max-semaphores\" class=\"headerlink\" title=\"zuul.semaphore.max-semaphores\"></a>zuul.semaphore.max-semaphores</h3><p>Hystrix最大的并发请求<code>execution.isolation.semaphore.maxConcurrentRequests</code>，这个值并非<code>TPS</code>、<code>QPS</code>、<code>RPS</code>等都是相对值，指的是1秒时间窗口内的事务/查询/请求，<code>semaphore.maxConcurrentRequests</code>是一个绝对值，无时间窗口，相当于亚毫秒级的。当请求达到或超过该设置值后，其其余就会被拒绝。默认值是100。参考: <a href=\"http://www.jianshu.com/p/b8d21248c9b1\" target=\"_blank\" rel=\"external\">Hystrix semaphore和thread隔离策略的区别及配置参考</a></p>\n<p>这个参数本来直接可以通过Hystrix的命名规则来设置，但被zuul重新设计了，使得在zuul中semaphores的最大并发请求有4个方法的参数可以设置，如果4个参数都存在优先级（1~4）由高到低：</p>\n<ul>\n<li>[优先级1]zuul.eureka.api.semaphore.maxSemaphores</li>\n<li>[优先级2]zuul.semaphore.max-semaphores</li>\n<li>[优先级3]hystrix.command.api.execution.isolation.semaphore.maxConcurrentRequests</li>\n<li>[优先级4]hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</li>\n</ul>\n<p>需要注意的是：在Camden.SR3版本的zuul中<code>hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</code>设置不会起作用，这是因为在<code>org.springframework.cloud.netflix.zuul.filters.ZuulProperties.HystrixSemaphore.maxSemaphores=100</code>设置了默认值100，因此<code>zuul.semaphore.max-semaphores</code>的优先级高于<code>hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</code>。</p>\n<p>zuul.eureka.[commandKey].semaphore.maxSemaphores：<br>其中commandKey为</p>\n<p>参考设置参数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">#</div><div class=\"line\">zuul.host.maxTotalConnections: 200</div><div class=\"line\">zuul.host.maxPerRouteConnections: 10</div><div class=\"line\">#zuul.semaphore.max-semaphores: 128</div><div class=\"line\"># 建议使用这种方式来设置，可以给每个不同的后端微服务设置不同的信号量</div><div class=\"line\">zuul.eureka.[service id].semaphore.maxSemaphores: 128</div></pre></td></tr></table></figure>\n<h2 id=\"其他Hystrix参数：\"><a href=\"#其他Hystrix参数：\" class=\"headerlink\" title=\"其他Hystrix参数：\"></a>其他Hystrix参数：</h2><p><code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code>用来设置thread和semaphore两种隔离策略的超时时间，默认值是1000。</p>\n<ul>\n<li>建议设置这个参数，在Hystrix 1.4.0之前，semaphore-isolated隔离策略是不能超时的，从1.4.0开始semaphore-isolated也支持超时时间了。</li>\n<li>建议通过CommandKey设置不同微服务的超时时间,对于zuul而言，CommandKey就是service id：<code>hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds</code></li>\n</ul>\n<h2 id=\"ribbon参数\"><a href=\"#ribbon参数\" class=\"headerlink\" title=\"ribbon参数\"></a>ribbon参数</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">ribbon:</div><div class=\"line\">#  # Max number of next servers to retry (excluding the first server)</div><div class=\"line\">#  MaxAutoRetries: 1</div><div class=\"line\">#  # Whether all operations can be retried for this client</div><div class=\"line\">#  MaxAutoRetriesNextServer: 1</div><div class=\"line\">#  # Interval to refresh the server list from the source</div><div class=\"line\">#  OkToRetryOnAllOperations: true</div><div class=\"line\">#  # Interval to refresh the server list from the source</div><div class=\"line\">#  ServerListRefreshInterval: 2000</div><div class=\"line\">#  # Connect timeout used by Apache HttpClient</div><div class=\"line\">  ConnectTimeout: 3000</div><div class=\"line\">#  # Read timeout used by Apache HttpClient</div><div class=\"line\">  ReadTimeout: 3000</div></pre></td></tr></table></figure>\n<p>主要是<code>ConnectTimeout</code>和<code>ReadTimeout</code>2个参数，最终会设置到http Client中。</p>\n<p>注意这个参数很重要了，会配合<code>execution.isolation.thread.timeoutInMilliseconds</code>一起来用，多少合适要根据微服务实际情况来定：</p>\n<ul>\n<li><strong>太小：</strong>会导致很多正常业务失败</li>\n<li><strong>太大：</strong>会导致实际的熔断效果很差，严重会导致雪崩。</li>\n</ul>\n<p>一般实际大小为：</p>\n<ul>\n<li>要保证该服务的可用性为几个9？99.5 99.9 99.99 </li>\n<li>要保证的N个9的最大响应时间。</li>\n</ul>\n"},{"title":"JDBC如何开启事务","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/P70430-092839.jpg","date":"2017-04-10T10:22:47.000Z","keywords":["JDBC","事务"],"description":null,"_content":"\n\n面试了很多人，每每问到“JDBC如何开启一个事务？”，大部分人的回答是：“通过openTransaction方法”，有的说是通过Connection，有的是说通过Statement，更有的说通过Connection拿到一个`Transaction`实例，再通过`openTransaction`方法来开启，那么同样关闭事务就有close方法“closeTransaction”。\n\n想必这些人都是被“hibernate”害了还是“不注重java基础”，一上来就被框架误导呢？\n\n先看看一个标准的JDBC例子伪代码：\n\n```java\nConnection conn = DriverManager.getConnection(...);\ntry{\n  con.setAutoCommit(false);\n  Statement stmt = con.createStatement();\n\n   //1 or more queries or updates\n\n   con.commit();\n}catch(Exception e){\n   con.rollback();\n}finally{\n   con.close();\n}\n\n```\n\n所以，看到上面的例子，开启手动事务的关键是`con.setAutoCommit(false)`，JDBC事务默认是开启的，并且是自动提交：\n\n1. 关闭自动提交：`java.sql.Connection.setAutoCommit(false)`\n\t- `setAutoCommit(true)`：每次操作都会被认为是一个事务并且自动提交\n2. 手动提交事务：`con.commit()`;\n3. 出现异常时回滚，不一定在catch语句中，只要在`con.commit()`前需要回滚时执行都可：`con.rollback()`;\n4. 关闭连接：`con.close();`\n5. 设置事务隔离级别: java.sql.Connection#setTransactionIsolation\n\t \n\n\n参考：https://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html","source":"_posts/技术/JDBC如何开启事务.md","raw":"---\ntitle: JDBC如何开启事务\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/P70430-092839.jpg'\ndate: 2017-04-10 18:22:47\ncategories:\n\t- JDBC\ntags:\n\t- JDBC\n\t- 事务\nkeywords:\n\t- JDBC\n\t- 事务\ndescription:\n---\n\n\n面试了很多人，每每问到“JDBC如何开启一个事务？”，大部分人的回答是：“通过openTransaction方法”，有的说是通过Connection，有的是说通过Statement，更有的说通过Connection拿到一个`Transaction`实例，再通过`openTransaction`方法来开启，那么同样关闭事务就有close方法“closeTransaction”。\n\n想必这些人都是被“hibernate”害了还是“不注重java基础”，一上来就被框架误导呢？\n\n先看看一个标准的JDBC例子伪代码：\n\n```java\nConnection conn = DriverManager.getConnection(...);\ntry{\n  con.setAutoCommit(false);\n  Statement stmt = con.createStatement();\n\n   //1 or more queries or updates\n\n   con.commit();\n}catch(Exception e){\n   con.rollback();\n}finally{\n   con.close();\n}\n\n```\n\n所以，看到上面的例子，开启手动事务的关键是`con.setAutoCommit(false)`，JDBC事务默认是开启的，并且是自动提交：\n\n1. 关闭自动提交：`java.sql.Connection.setAutoCommit(false)`\n\t- `setAutoCommit(true)`：每次操作都会被认为是一个事务并且自动提交\n2. 手动提交事务：`con.commit()`;\n3. 出现异常时回滚，不一定在catch语句中，只要在`con.commit()`前需要回滚时执行都可：`con.rollback()`;\n4. 关闭连接：`con.close();`\n5. 设置事务隔离级别: java.sql.Connection#setTransactionIsolation\n\t \n\n\n参考：https://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html","slug":"技术/JDBC如何开启事务","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc1m0049z29kg5i6wed3","content":"<p>面试了很多人，每每问到“JDBC如何开启一个事务？”，大部分人的回答是：“通过openTransaction方法”，有的说是通过Connection，有的是说通过Statement，更有的说通过Connection拿到一个<code>Transaction</code>实例，再通过<code>openTransaction</code>方法来开启，那么同样关闭事务就有close方法“closeTransaction”。</p>\n<p>想必这些人都是被“hibernate”害了还是“不注重java基础”，一上来就被框架误导呢？</p>\n<p>先看看一个标准的JDBC例子伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">Connection conn = DriverManager.getConnection(...);</div><div class=\"line\"><span class=\"keyword\">try</span>&#123;</div><div class=\"line\">  con.setAutoCommit(<span class=\"keyword\">false</span>);</div><div class=\"line\">  Statement stmt = con.createStatement();</div><div class=\"line\"></div><div class=\"line\">   <span class=\"comment\">//1 or more queries or updates</span></div><div class=\"line\"></div><div class=\"line\">   con.commit();</div><div class=\"line\">&#125;<span class=\"keyword\">catch</span>(Exception e)&#123;</div><div class=\"line\">   con.rollback();</div><div class=\"line\">&#125;<span class=\"keyword\">finally</span>&#123;</div><div class=\"line\">   con.close();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>所以，看到上面的例子，开启手动事务的关键是<code>con.setAutoCommit(false)</code>，JDBC事务默认是开启的，并且是自动提交：</p>\n<ol>\n<li>关闭自动提交：<code>java.sql.Connection.setAutoCommit(false)</code><ul>\n<li><code>setAutoCommit(true)</code>：每次操作都会被认为是一个事务并且自动提交</li>\n</ul>\n</li>\n<li>手动提交事务：<code>con.commit()</code>;</li>\n<li>出现异常时回滚，不一定在catch语句中，只要在<code>con.commit()</code>前需要回滚时执行都可：<code>con.rollback()</code>;</li>\n<li>关闭连接：<code>con.close();</code></li>\n<li>设置事务隔离级别: java.sql.Connection#setTransactionIsolation</li>\n</ol>\n<p>参考：<a href=\"https://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html\" target=\"_blank\" rel=\"external\">https://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>面试了很多人，每每问到“JDBC如何开启一个事务？”，大部分人的回答是：“通过openTransaction方法”，有的说是通过Connection，有的是说通过Statement，更有的说通过Connection拿到一个<code>Transaction</code>实例，再通过<code>openTransaction</code>方法来开启，那么同样关闭事务就有close方法“closeTransaction”。</p>\n<p>想必这些人都是被“hibernate”害了还是“不注重java基础”，一上来就被框架误导呢？</p>\n<p>先看看一个标准的JDBC例子伪代码：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">Connection conn = DriverManager.getConnection(...);</div><div class=\"line\"><span class=\"keyword\">try</span>&#123;</div><div class=\"line\">  con.setAutoCommit(<span class=\"keyword\">false</span>);</div><div class=\"line\">  Statement stmt = con.createStatement();</div><div class=\"line\"></div><div class=\"line\">   <span class=\"comment\">//1 or more queries or updates</span></div><div class=\"line\"></div><div class=\"line\">   con.commit();</div><div class=\"line\">&#125;<span class=\"keyword\">catch</span>(Exception e)&#123;</div><div class=\"line\">   con.rollback();</div><div class=\"line\">&#125;<span class=\"keyword\">finally</span>&#123;</div><div class=\"line\">   con.close();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>所以，看到上面的例子，开启手动事务的关键是<code>con.setAutoCommit(false)</code>，JDBC事务默认是开启的，并且是自动提交：</p>\n<ol>\n<li>关闭自动提交：<code>java.sql.Connection.setAutoCommit(false)</code><ul>\n<li><code>setAutoCommit(true)</code>：每次操作都会被认为是一个事务并且自动提交</li>\n</ul>\n</li>\n<li>手动提交事务：<code>con.commit()</code>;</li>\n<li>出现异常时回滚，不一定在catch语句中，只要在<code>con.commit()</code>前需要回滚时执行都可：<code>con.rollback()</code>;</li>\n<li>关闭连接：<code>con.close();</code></li>\n<li>设置事务隔离级别: java.sql.Connection#setTransactionIsolation</li>\n</ol>\n<p>参考：<a href=\"https://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html\" target=\"_blank\" rel=\"external\">https://docs.oracle.com/javase/tutorial/jdbc/basics/transactions.html</a></p>\n"},{"title":"负载均衡之加权轮询算法","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60606-172810.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30","date":"2016-06-16T01:06:33.000Z","keywords":"负载均衡,加权轮询,算法","description":null,"_content":"\n\n# 负载均衡之加权轮询算法\n\n## 算法举例说明\n\n 服务实例\t| 权重 \n ---|---|\n 127.0.0.1:8001\t| 1\n 127.0.0.1:8002 | 2\n 127.0.0.1:8003\t| 3\n\n  \n### 共有三个实例，总权重为6，那么实现效果应该为每调用6次：\n\n- 每个实例应该被调用权重次数\n- 权重数大的优先被调用\n\n### 根据以上说明，那么进行排列组合：\n\n- 先按照权重大小排序\n- 把权重数做为调用次数排列\n\n **排列的结果是这样的：**\n\n序号|服务实例|权重\n---|---|---\n1|\t127.0.0.1:8003|\t3\n2|\t127.0.0.1:8003|\t3\n3|\t127.0.0.1:8003|\t3\n4|\t127.0.0.1:8002|\t2\n5|\t127.0.0.1:8002|\t2\n6|\t127.0.0.1:8001|\t1\n\n貌似没问题，但每个实例调用不是交替的，分布不够均匀，改进一下重新排列组合：\n\n序号|服务实例|权重\n---|---|---\n1|\t127.0.0.1:8003|\t3\n2|\t127.0.0.1:8002|\t2\n3|\t127.0.0.1:8003|\t3\n4|\t127.0.0.1:8002|\t2\n5|\t127.0.0.1:8003|\t3\n6|\t127.0.0.1:8001|\t1\n\n或者\n\n序号|服务实例|权重\n---|---|---\n1|\t127.0.0.1:8003|\t3   \n2|\t127.0.0.1:8002|\t2\n3|\t127.0.0.1:8003|\t3\n4|\t127.0.0.1:8001|\t1\n5|\t127.0.0.1:8003|\t3\n6|\t127.0.0.1:8002|\t2\n\n\n2个权重变量：weight，current_weight\n\n### weight\n配置的固定不变的权重\n\n### current_weight\n\n会动态调整的权重，初始化为0，运行时动态调整。\n选取开始时，先重新调整current_weight= current_weight+weight，然后通过current_weight值从大到小排序，选择current_weight值最大的（实际编程中不一定要排序，可以直接取最大的）；\n然后重新计算被选择的current_weight值= current_weight-总weight。\n\n下面是用Lua脚本实现的该算法：\n\n ```lua\n \n function _M:next()\n\tlocal servers=self.servers\n \tlocal totalWeight = totalWeight(servers)\n \tfor k,v in pairs(servers) do\n\t\tv.cweight=v.weight+v.cweight\n\tend\n\n\ttable.sort( servers, \n\t\tfunction (a,b)\n\t\t\treturn a.cweight>b.cweight\n\t\tend \n\t)\n\tselected=servers[1]\n\tselected.cweight=selected.cweight-totalWeight\n\n\treturn selected\n\n end\n \n ```\n \n\n\n\n\n\n\n\n\n\n","source":"_posts/技术/负载均衡之加权轮询算法.md","raw":"---\ntitle: 负载均衡之加权轮询算法\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60606-172810.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30'\ndate: 2016-06-16 09:06:33\ncategories:\n\t- 技术\n\t- 算法\ntags:\n\t- 负载均衡\n\t- 加权轮询\n\t- 轮询\n\t- 算法\nkeywords: 负载均衡,加权轮询,算法\ndescription:\n---\n\n\n# 负载均衡之加权轮询算法\n\n## 算法举例说明\n\n 服务实例\t| 权重 \n ---|---|\n 127.0.0.1:8001\t| 1\n 127.0.0.1:8002 | 2\n 127.0.0.1:8003\t| 3\n\n  \n### 共有三个实例，总权重为6，那么实现效果应该为每调用6次：\n\n- 每个实例应该被调用权重次数\n- 权重数大的优先被调用\n\n### 根据以上说明，那么进行排列组合：\n\n- 先按照权重大小排序\n- 把权重数做为调用次数排列\n\n **排列的结果是这样的：**\n\n序号|服务实例|权重\n---|---|---\n1|\t127.0.0.1:8003|\t3\n2|\t127.0.0.1:8003|\t3\n3|\t127.0.0.1:8003|\t3\n4|\t127.0.0.1:8002|\t2\n5|\t127.0.0.1:8002|\t2\n6|\t127.0.0.1:8001|\t1\n\n貌似没问题，但每个实例调用不是交替的，分布不够均匀，改进一下重新排列组合：\n\n序号|服务实例|权重\n---|---|---\n1|\t127.0.0.1:8003|\t3\n2|\t127.0.0.1:8002|\t2\n3|\t127.0.0.1:8003|\t3\n4|\t127.0.0.1:8002|\t2\n5|\t127.0.0.1:8003|\t3\n6|\t127.0.0.1:8001|\t1\n\n或者\n\n序号|服务实例|权重\n---|---|---\n1|\t127.0.0.1:8003|\t3   \n2|\t127.0.0.1:8002|\t2\n3|\t127.0.0.1:8003|\t3\n4|\t127.0.0.1:8001|\t1\n5|\t127.0.0.1:8003|\t3\n6|\t127.0.0.1:8002|\t2\n\n\n2个权重变量：weight，current_weight\n\n### weight\n配置的固定不变的权重\n\n### current_weight\n\n会动态调整的权重，初始化为0，运行时动态调整。\n选取开始时，先重新调整current_weight= current_weight+weight，然后通过current_weight值从大到小排序，选择current_weight值最大的（实际编程中不一定要排序，可以直接取最大的）；\n然后重新计算被选择的current_weight值= current_weight-总weight。\n\n下面是用Lua脚本实现的该算法：\n\n ```lua\n \n function _M:next()\n\tlocal servers=self.servers\n \tlocal totalWeight = totalWeight(servers)\n \tfor k,v in pairs(servers) do\n\t\tv.cweight=v.weight+v.cweight\n\tend\n\n\ttable.sort( servers, \n\t\tfunction (a,b)\n\t\t\treturn a.cweight>b.cweight\n\t\tend \n\t)\n\tselected=servers[1]\n\tselected.cweight=selected.cweight-totalWeight\n\n\treturn selected\n\n end\n \n ```\n \n\n\n\n\n\n\n\n\n\n","slug":"技术/负载均衡之加权轮询算法","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc1s004gz29k4w2zeqct","content":"<h1 id=\"负载均衡之加权轮询算法\"><a href=\"#负载均衡之加权轮询算法\" class=\"headerlink\" title=\"负载均衡之加权轮询算法\"></a>负载均衡之加权轮询算法</h1><h2 id=\"算法举例说明\"><a href=\"#算法举例说明\" class=\"headerlink\" title=\"算法举例说明\"></a>算法举例说明</h2><table>\n<thead>\n<tr>\n<th>服务实例</th>\n<th>权重 </th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td> 127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n<tr>\n<td> 127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td> 127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"共有三个实例，总权重为6，那么实现效果应该为每调用6次：\"><a href=\"#共有三个实例，总权重为6，那么实现效果应该为每调用6次：\" class=\"headerlink\" title=\"共有三个实例，总权重为6，那么实现效果应该为每调用6次：\"></a>共有三个实例，总权重为6，那么实现效果应该为每调用6次：</h3><ul>\n<li>每个实例应该被调用权重次数</li>\n<li>权重数大的优先被调用</li>\n</ul>\n<h3 id=\"根据以上说明，那么进行排列组合：\"><a href=\"#根据以上说明，那么进行排列组合：\" class=\"headerlink\" title=\"根据以上说明，那么进行排列组合：\"></a>根据以上说明，那么进行排列组合：</h3><ul>\n<li>先按照权重大小排序</li>\n<li><p>把权重数做为调用次数排列</p>\n<p><strong>排列的结果是这样的：</strong></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>服务实例</th>\n<th>权重</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>2</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>3</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>5</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>6</td>\n<td>127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>貌似没问题，但每个实例调用不是交替的，分布不够均匀，改进一下重新排列组合：</p>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>服务实例</th>\n<th>权重</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>2</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>3</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>5</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>6</td>\n<td>127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>或者</p>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>服务实例</th>\n<th>权重</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>127.0.0.1:8003</td>\n<td>3   </td>\n</tr>\n<tr>\n<td>2</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>3</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n<td>127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n<tr>\n<td>5</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>6</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>2个权重变量：weight，current_weight</p>\n<h3 id=\"weight\"><a href=\"#weight\" class=\"headerlink\" title=\"weight\"></a>weight</h3><p>配置的固定不变的权重</p>\n<h3 id=\"current-weight\"><a href=\"#current-weight\" class=\"headerlink\" title=\"current_weight\"></a>current_weight</h3><p>会动态调整的权重，初始化为0，运行时动态调整。<br>选取开始时，先重新调整current_weight= current_weight+weight，然后通过current_weight值从大到小排序，选择current_weight值最大的（实际编程中不一定要排序，可以直接取最大的）；<br>然后重新计算被选择的current_weight值= current_weight-总weight。</p>\n<p>下面是用Lua脚本实现的该算法：</p>\n <figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_M:next</span><span class=\"params\">()</span></span></div><div class=\"line\"><span class=\"keyword\">local</span> servers=self.servers</div><div class=\"line\">\t<span class=\"keyword\">local</span> totalWeight = totalWeight(servers)</div><div class=\"line\">\t<span class=\"keyword\">for</span> k,v <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(servers) <span class=\"keyword\">do</span></div><div class=\"line\">\tv.cweight=v.weight+v.cweight</div><div class=\"line\"><span class=\"keyword\">end</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">table</span>.<span class=\"built_in\">sort</span>( servers, </div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">(a,b)</span></span></div><div class=\"line\">\t\t<span class=\"keyword\">return</span> a.cweight&gt;b.cweight</div><div class=\"line\">\t<span class=\"keyword\">end</span> </div><div class=\"line\">)</div><div class=\"line\">selected=servers[<span class=\"number\">1</span>]</div><div class=\"line\">selected.cweight=selected.cweight-totalWeight</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">return</span> selected</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">end</span></div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"负载均衡之加权轮询算法\"><a href=\"#负载均衡之加权轮询算法\" class=\"headerlink\" title=\"负载均衡之加权轮询算法\"></a>负载均衡之加权轮询算法</h1><h2 id=\"算法举例说明\"><a href=\"#算法举例说明\" class=\"headerlink\" title=\"算法举例说明\"></a>算法举例说明</h2><table>\n<thead>\n<tr>\n<th>服务实例</th>\n<th>权重 </th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td> 127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n<tr>\n<td> 127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td> 127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"共有三个实例，总权重为6，那么实现效果应该为每调用6次：\"><a href=\"#共有三个实例，总权重为6，那么实现效果应该为每调用6次：\" class=\"headerlink\" title=\"共有三个实例，总权重为6，那么实现效果应该为每调用6次：\"></a>共有三个实例，总权重为6，那么实现效果应该为每调用6次：</h3><ul>\n<li>每个实例应该被调用权重次数</li>\n<li>权重数大的优先被调用</li>\n</ul>\n<h3 id=\"根据以上说明，那么进行排列组合：\"><a href=\"#根据以上说明，那么进行排列组合：\" class=\"headerlink\" title=\"根据以上说明，那么进行排列组合：\"></a>根据以上说明，那么进行排列组合：</h3><ul>\n<li>先按照权重大小排序</li>\n<li><p>把权重数做为调用次数排列</p>\n<p><strong>排列的结果是这样的：</strong></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>服务实例</th>\n<th>权重</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>2</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>3</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>5</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>6</td>\n<td>127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>貌似没问题，但每个实例调用不是交替的，分布不够均匀，改进一下重新排列组合：</p>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>服务实例</th>\n<th>权重</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>2</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>3</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>5</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>6</td>\n<td>127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>或者</p>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>服务实例</th>\n<th>权重</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>127.0.0.1:8003</td>\n<td>3   </td>\n</tr>\n<tr>\n<td>2</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n<tr>\n<td>3</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n<td>127.0.0.1:8001</td>\n<td>1</td>\n</tr>\n<tr>\n<td>5</td>\n<td>127.0.0.1:8003</td>\n<td>3</td>\n</tr>\n<tr>\n<td>6</td>\n<td>127.0.0.1:8002</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>2个权重变量：weight，current_weight</p>\n<h3 id=\"weight\"><a href=\"#weight\" class=\"headerlink\" title=\"weight\"></a>weight</h3><p>配置的固定不变的权重</p>\n<h3 id=\"current-weight\"><a href=\"#current-weight\" class=\"headerlink\" title=\"current_weight\"></a>current_weight</h3><p>会动态调整的权重，初始化为0，运行时动态调整。<br>选取开始时，先重新调整current_weight= current_weight+weight，然后通过current_weight值从大到小排序，选择current_weight值最大的（实际编程中不一定要排序，可以直接取最大的）；<br>然后重新计算被选择的current_weight值= current_weight-总weight。</p>\n<p>下面是用Lua脚本实现的该算法：</p>\n <figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_M:next</span><span class=\"params\">()</span></span></div><div class=\"line\"><span class=\"keyword\">local</span> servers=self.servers</div><div class=\"line\">\t<span class=\"keyword\">local</span> totalWeight = totalWeight(servers)</div><div class=\"line\">\t<span class=\"keyword\">for</span> k,v <span class=\"keyword\">in</span> <span class=\"built_in\">pairs</span>(servers) <span class=\"keyword\">do</span></div><div class=\"line\">\tv.cweight=v.weight+v.cweight</div><div class=\"line\"><span class=\"keyword\">end</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">table</span>.<span class=\"built_in\">sort</span>( servers, </div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">(a,b)</span></span></div><div class=\"line\">\t\t<span class=\"keyword\">return</span> a.cweight&gt;b.cweight</div><div class=\"line\">\t<span class=\"keyword\">end</span> </div><div class=\"line\">)</div><div class=\"line\">selected=servers[<span class=\"number\">1</span>]</div><div class=\"line\">selected.cweight=selected.cweight-totalWeight</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">return</span> selected</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">end</span></div></pre></td></tr></table></figure>\n"},{"title":"软件开发中的单一职责","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60607-090345.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30","date":"2016-06-28T01:06:33.000Z","keywords":"单一职责","description":null,"_content":"\n# 软件开发中的单一职责\n\n \n最近在实践微服务化过程中，对其“单一职责”原则深有体会。\n那么只有微服务化才可以单一职责，才可以解耦吗？答案是否定的。\n\n单一职责原则是这样定义的：单一的功能，并且完全封装起来。\n\n我们做后端Java开发的，应该最熟悉的就是标准的3层架构了，尤其是使用Spring.io体系的：Controller，Service，Dao/Repository。为什么要分层？就是为了保证单一职责，数据模型的事情交给Controller，业务逻辑的事情交给Service，和数据打交道的事情就交给Dao/Repository。有时候或者有些人会分层分的更多，4层，5层，我自己也这样干过，说白了也是为了保证单一职责，3层不能满足单一职责了，耦合度高了，就分。\n\n我们都知道一个webapp在经过一定时间的开发后，就惨不忍睹，即便是有标准的分层，页面或模板文件一大堆，最初的很清晰的3层标准架构也变味了，Controller，Service，Dao/Repository各层之间、Service之间、Dao/Repository之间互相调用，一团乱麻。这个时候没改一行代码都有可能一个老鼠害了一锅汤，bug就如同蚂蚁洞。\n\n### 这些问题最后就造成：\n\n- 可扩展性灵活性差，出现性能问题\n- 业务变更和开发困难，维护成本很高，交付时间长\n- 回归测试量很大\n- ...\n\n为了解决这些问题，就需要时时刻刻清楚的记住“**单一职责**”，**单一职责**可以用到软件开发的任何地方。\n\n应该说职责分离来解耦是最常用最有效的架构方法，这能够很大限度的简化一切。\n\n### 下面就从软件开发、设计、架构，以及重构/演进/进化，从小到大几个方面来说说**单一职责**：\n\n## 类方法/函数\n\n这应该是最小的能体现**单一职责**的程序单元了。最熟悉的最典型的莫过于Helper/Utils类方法了，但这种类方法的特征很明显，也很容易遵循单一职责，99%以上的开发人员都可以做到。但不仅仅这样的类方法要遵循单一职责原则，每一个类方法都应该遵循**单一职责**原则，尤其是一些处理业务逻辑的类方法更要遵循**单一职责**原则，处理业务的类方法通常要配合类的单一职责原则进行，下节中讨论。\n\n因此，这也是为什么很多TL要求类方法代码行数保持在20行左右，其实就是为了保证单一职责，20行左右是一个**经验粗略数字**，当然，10行或者30行来完成类方法也是可以的。大部分单一职责的类方法用20行左右的代码就够了，如果超过20行就要考虑是否保证了单一职责了。那我们在**迭代重构**的过程中就要考虑拆分这样的类方法来保证单一职责。\n\n类方法的单一职责是最单纯的，很具体的，不惨杂任何额外信息，只关心输入、输出、和职责；一定要明确地定义类方法的职责，保证在迭代中不被错误的扩张，调用方错误的使用。\n\n## 类/函数文件\n\t\n要用面向对象的设计方法，**单一职责原则**来定义类。开发人员一定要很好地理解“单一职责原则”，具有面向对象的抽象思维能力。\n\n当在迭代中一个类过于庞大或者快速膨胀，说明已经有坏味道了，这时候就需要考虑用单一职责原则或者面向对象的分析方法来重构和重新定义类了，通常就是要抽象和拆分类，否则将来会变成一个方法容器。\n\n把类比作一个人，她的职责就是完成自己职责范围内的事情，如果她什么事情都管，就叫多管闲事，可以想象她多管闲事的后果了，会搅得鸡犬不宁。同样，类也是，类如果多管闲事，那会搅得真个应用不稳定，漏洞百出，还很难修复。所以说定义一个类，要明确这个类的职责。使用面向对象的分析和设计方法，能很好地准确定义一个类的职责范围，通常就要用到封装、继承、多态和抽象等设计方法。\n\n \n## 包结构/文件夹\n\n分层就是最常用的架构方法之一，分层具体体现在分包和分类，就是分门别类的意思。俗话说，物以类聚，人以群分。\n\n包结构在单一职责原则上是类的补充，职责范围进一步扩大。如果把一个类叫做一个人，那么包就是一个最小单位的团队，职责就是负责一类特定事情。\n如何分包呢？那就要用到分类学的知识了，要以什么特征来分，可能不仅仅只有一种特征，比如，先用公司域名来做基础包名，这里叫一级包名；然后再用一个特定的有意义的标识作为二级子包名；之后按分层（web,dao,service等等）方法做三级包名，也可以先按照业务再按分层。例如：\n\n```\n\n域名：tietang.wang\n有个项目叫：social\n那么我可以这样分：\nwang.tietang\n\t- social\n\t\t- web\n\t\t- service\n\t\t- dao\n\t\t- commons\n\n也可以这样：\n\nwang.tietang\n\t- commons\n\t- user\n\t\t- web\n\t\t- service\n\t\t- dao\n\t- relation\n\t\t- web\n\t\t- service\n\t\t- dao\t \t\t\n\t\t\t\n\n\n```\n\n## 多工程/module\n\n通常以多maven module或者gradle 多module形式存在，来保证单一职责。\n当业务量还没有达到服务拆分的火候，又需要规整项目结构，通常在一个app发展的太庞大时或者在工程建设初期采取，从文件系统上隔离，通过module依赖来集成。需要注意的是这样的架构或拆分不是随意的，要以单一职责原则来拆分，更具体一点就是要根据业务，技术框架功能等特性来拆分。\n\n比如，按技术组件拆分，通常会有一些技术组件，可以把她放到commons module，如果有多种类型的技术组件，就拆分为commons module的子module；也可以直接将这些技术组件拆分为独立的工程，存在于独立的git/svn仓库，独立管理，专人负责；其他哪些module需要就依赖她。那拆分的这些技术组件的每一个应该遵循单一职责原则，例如数据分片的框架，NIO基础网络框架等等。\n\n比如，按业务拆分，例如有用户，订单，商品，支付，那么就按照这些业务拆分为子module，每一个子module就只负责自己的业务逻辑，也遵循单一职责。\n\n那每个module的职责范围又比类和包更大，这个时候职责也更模糊，有时候很难把握，对于技术组件可能相对清晰，业务module就要熟悉业务，明确业务边界。\n\n多module拆分后也是为将来服务化埋下伏笔，同时在物理文件系统比较清晰了，那在依赖管理上也要掌握好保持清晰的依赖逻辑，把握好单一职责原则。\n\n## 微服务/可部署单元\n\n微服务，从运行时隔离，但业务量发展到一定时候，从单体或者多module工程拆分或演化出来，可独立打包可独立部署并复合单一原则的application，当然了微服务所体现的价值不仅仅是隔离和独立部署，还有很多这里可以参考[单体应用与微服务优缺点辨析](<http://www.infoq.com/cn/news/2015/04/single-app-micro-service>)。单一职责在微服务中的价值是最重要的，包含了app层面和开发app的团队层面，微服务的大部分优点都可以围绕单一职责来张开。\n\n## 团队\n\n先引用《韩非子·扬权》中的一段文字：\n\n```\n夫物者有所宜，材者有所施，各处其宜，故上下无为。 \n使鸡司夜，令狸执鼠，皆用其能，上乃无事。\n上有所长，事乃不方。 \n矜而好能，下之所欺：辩惠好生，下因其材。\n上下易用，国故不治。\n\n```\n\n**参考：**\n\t\n- 原文：http://www.shici8.com/bookview_3501.html\n- 译文：http://www.shici8.com/article_8539.html\n\n各得其所，各司其职。所以，团队也要遵循单一职责原则，这样才能很好地管理团队成员的时间，提高效率。一个人专注做一件事情的效率远高于同时关注多件事情的。同样一个人一直管理和维护同一份代码要比多人同时维护多份代码的效率高很多。每一个人都有自己的个性，他有自己的擅长，让每一个人专注自己擅长的事情，那肯定事半功倍，整个团队绩效肯定也很突出。\n\n \n总之，引用古文名句说明了所有：\n\n- 物以类聚，人以群分。\n- 天下之事，分合交替，分久必合，合久必分！\n- 使鸡司夜，令狸执鼠，皆用其能，上乃无事。\n \n\n \n### 参考：\n\n [http://www.jianshu.com/p/f9d15827465d](<http://www.jianshu.com/p/f9d15827465d>)\n \n [https://zh.wikipedia.org/wiki/单一功能原则](<https://zh.wikipedia.org/wiki/单一功能原则>)\n\n\n\n\n\n\n","source":"_posts/技术/软件开发中的单一职责.md","raw":"---\ntitle: 软件开发中的单一职责\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60607-090345.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30'\ndate: 2016-06-28 09:06:33\ncategories:\n\t- 技术\n\t- 杂谈\ntags:\n\t- 单一职责\n\t- 软件开发\n\t- 微服务\n\nkeywords: 单一职责\ndescription:\n---\n\n# 软件开发中的单一职责\n\n \n最近在实践微服务化过程中，对其“单一职责”原则深有体会。\n那么只有微服务化才可以单一职责，才可以解耦吗？答案是否定的。\n\n单一职责原则是这样定义的：单一的功能，并且完全封装起来。\n\n我们做后端Java开发的，应该最熟悉的就是标准的3层架构了，尤其是使用Spring.io体系的：Controller，Service，Dao/Repository。为什么要分层？就是为了保证单一职责，数据模型的事情交给Controller，业务逻辑的事情交给Service，和数据打交道的事情就交给Dao/Repository。有时候或者有些人会分层分的更多，4层，5层，我自己也这样干过，说白了也是为了保证单一职责，3层不能满足单一职责了，耦合度高了，就分。\n\n我们都知道一个webapp在经过一定时间的开发后，就惨不忍睹，即便是有标准的分层，页面或模板文件一大堆，最初的很清晰的3层标准架构也变味了，Controller，Service，Dao/Repository各层之间、Service之间、Dao/Repository之间互相调用，一团乱麻。这个时候没改一行代码都有可能一个老鼠害了一锅汤，bug就如同蚂蚁洞。\n\n### 这些问题最后就造成：\n\n- 可扩展性灵活性差，出现性能问题\n- 业务变更和开发困难，维护成本很高，交付时间长\n- 回归测试量很大\n- ...\n\n为了解决这些问题，就需要时时刻刻清楚的记住“**单一职责**”，**单一职责**可以用到软件开发的任何地方。\n\n应该说职责分离来解耦是最常用最有效的架构方法，这能够很大限度的简化一切。\n\n### 下面就从软件开发、设计、架构，以及重构/演进/进化，从小到大几个方面来说说**单一职责**：\n\n## 类方法/函数\n\n这应该是最小的能体现**单一职责**的程序单元了。最熟悉的最典型的莫过于Helper/Utils类方法了，但这种类方法的特征很明显，也很容易遵循单一职责，99%以上的开发人员都可以做到。但不仅仅这样的类方法要遵循单一职责原则，每一个类方法都应该遵循**单一职责**原则，尤其是一些处理业务逻辑的类方法更要遵循**单一职责**原则，处理业务的类方法通常要配合类的单一职责原则进行，下节中讨论。\n\n因此，这也是为什么很多TL要求类方法代码行数保持在20行左右，其实就是为了保证单一职责，20行左右是一个**经验粗略数字**，当然，10行或者30行来完成类方法也是可以的。大部分单一职责的类方法用20行左右的代码就够了，如果超过20行就要考虑是否保证了单一职责了。那我们在**迭代重构**的过程中就要考虑拆分这样的类方法来保证单一职责。\n\n类方法的单一职责是最单纯的，很具体的，不惨杂任何额外信息，只关心输入、输出、和职责；一定要明确地定义类方法的职责，保证在迭代中不被错误的扩张，调用方错误的使用。\n\n## 类/函数文件\n\t\n要用面向对象的设计方法，**单一职责原则**来定义类。开发人员一定要很好地理解“单一职责原则”，具有面向对象的抽象思维能力。\n\n当在迭代中一个类过于庞大或者快速膨胀，说明已经有坏味道了，这时候就需要考虑用单一职责原则或者面向对象的分析方法来重构和重新定义类了，通常就是要抽象和拆分类，否则将来会变成一个方法容器。\n\n把类比作一个人，她的职责就是完成自己职责范围内的事情，如果她什么事情都管，就叫多管闲事，可以想象她多管闲事的后果了，会搅得鸡犬不宁。同样，类也是，类如果多管闲事，那会搅得真个应用不稳定，漏洞百出，还很难修复。所以说定义一个类，要明确这个类的职责。使用面向对象的分析和设计方法，能很好地准确定义一个类的职责范围，通常就要用到封装、继承、多态和抽象等设计方法。\n\n \n## 包结构/文件夹\n\n分层就是最常用的架构方法之一，分层具体体现在分包和分类，就是分门别类的意思。俗话说，物以类聚，人以群分。\n\n包结构在单一职责原则上是类的补充，职责范围进一步扩大。如果把一个类叫做一个人，那么包就是一个最小单位的团队，职责就是负责一类特定事情。\n如何分包呢？那就要用到分类学的知识了，要以什么特征来分，可能不仅仅只有一种特征，比如，先用公司域名来做基础包名，这里叫一级包名；然后再用一个特定的有意义的标识作为二级子包名；之后按分层（web,dao,service等等）方法做三级包名，也可以先按照业务再按分层。例如：\n\n```\n\n域名：tietang.wang\n有个项目叫：social\n那么我可以这样分：\nwang.tietang\n\t- social\n\t\t- web\n\t\t- service\n\t\t- dao\n\t\t- commons\n\n也可以这样：\n\nwang.tietang\n\t- commons\n\t- user\n\t\t- web\n\t\t- service\n\t\t- dao\n\t- relation\n\t\t- web\n\t\t- service\n\t\t- dao\t \t\t\n\t\t\t\n\n\n```\n\n## 多工程/module\n\n通常以多maven module或者gradle 多module形式存在，来保证单一职责。\n当业务量还没有达到服务拆分的火候，又需要规整项目结构，通常在一个app发展的太庞大时或者在工程建设初期采取，从文件系统上隔离，通过module依赖来集成。需要注意的是这样的架构或拆分不是随意的，要以单一职责原则来拆分，更具体一点就是要根据业务，技术框架功能等特性来拆分。\n\n比如，按技术组件拆分，通常会有一些技术组件，可以把她放到commons module，如果有多种类型的技术组件，就拆分为commons module的子module；也可以直接将这些技术组件拆分为独立的工程，存在于独立的git/svn仓库，独立管理，专人负责；其他哪些module需要就依赖她。那拆分的这些技术组件的每一个应该遵循单一职责原则，例如数据分片的框架，NIO基础网络框架等等。\n\n比如，按业务拆分，例如有用户，订单，商品，支付，那么就按照这些业务拆分为子module，每一个子module就只负责自己的业务逻辑，也遵循单一职责。\n\n那每个module的职责范围又比类和包更大，这个时候职责也更模糊，有时候很难把握，对于技术组件可能相对清晰，业务module就要熟悉业务，明确业务边界。\n\n多module拆分后也是为将来服务化埋下伏笔，同时在物理文件系统比较清晰了，那在依赖管理上也要掌握好保持清晰的依赖逻辑，把握好单一职责原则。\n\n## 微服务/可部署单元\n\n微服务，从运行时隔离，但业务量发展到一定时候，从单体或者多module工程拆分或演化出来，可独立打包可独立部署并复合单一原则的application，当然了微服务所体现的价值不仅仅是隔离和独立部署，还有很多这里可以参考[单体应用与微服务优缺点辨析](<http://www.infoq.com/cn/news/2015/04/single-app-micro-service>)。单一职责在微服务中的价值是最重要的，包含了app层面和开发app的团队层面，微服务的大部分优点都可以围绕单一职责来张开。\n\n## 团队\n\n先引用《韩非子·扬权》中的一段文字：\n\n```\n夫物者有所宜，材者有所施，各处其宜，故上下无为。 \n使鸡司夜，令狸执鼠，皆用其能，上乃无事。\n上有所长，事乃不方。 \n矜而好能，下之所欺：辩惠好生，下因其材。\n上下易用，国故不治。\n\n```\n\n**参考：**\n\t\n- 原文：http://www.shici8.com/bookview_3501.html\n- 译文：http://www.shici8.com/article_8539.html\n\n各得其所，各司其职。所以，团队也要遵循单一职责原则，这样才能很好地管理团队成员的时间，提高效率。一个人专注做一件事情的效率远高于同时关注多件事情的。同样一个人一直管理和维护同一份代码要比多人同时维护多份代码的效率高很多。每一个人都有自己的个性，他有自己的擅长，让每一个人专注自己擅长的事情，那肯定事半功倍，整个团队绩效肯定也很突出。\n\n \n总之，引用古文名句说明了所有：\n\n- 物以类聚，人以群分。\n- 天下之事，分合交替，分久必合，合久必分！\n- 使鸡司夜，令狸执鼠，皆用其能，上乃无事。\n \n\n \n### 参考：\n\n [http://www.jianshu.com/p/f9d15827465d](<http://www.jianshu.com/p/f9d15827465d>)\n \n [https://zh.wikipedia.org/wiki/单一功能原则](<https://zh.wikipedia.org/wiki/单一功能原则>)\n\n\n\n\n\n\n","slug":"技术/软件开发中的单一职责","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc1u004sz29kaug6xam1","content":"<h1 id=\"软件开发中的单一职责\"><a href=\"#软件开发中的单一职责\" class=\"headerlink\" title=\"软件开发中的单一职责\"></a>软件开发中的单一职责</h1><p>最近在实践微服务化过程中，对其“单一职责”原则深有体会。<br>那么只有微服务化才可以单一职责，才可以解耦吗？答案是否定的。</p>\n<p>单一职责原则是这样定义的：单一的功能，并且完全封装起来。</p>\n<p>我们做后端Java开发的，应该最熟悉的就是标准的3层架构了，尤其是使用Spring.io体系的：Controller，Service，Dao/Repository。为什么要分层？就是为了保证单一职责，数据模型的事情交给Controller，业务逻辑的事情交给Service，和数据打交道的事情就交给Dao/Repository。有时候或者有些人会分层分的更多，4层，5层，我自己也这样干过，说白了也是为了保证单一职责，3层不能满足单一职责了，耦合度高了，就分。</p>\n<p>我们都知道一个webapp在经过一定时间的开发后，就惨不忍睹，即便是有标准的分层，页面或模板文件一大堆，最初的很清晰的3层标准架构也变味了，Controller，Service，Dao/Repository各层之间、Service之间、Dao/Repository之间互相调用，一团乱麻。这个时候没改一行代码都有可能一个老鼠害了一锅汤，bug就如同蚂蚁洞。</p>\n<h3 id=\"这些问题最后就造成：\"><a href=\"#这些问题最后就造成：\" class=\"headerlink\" title=\"这些问题最后就造成：\"></a>这些问题最后就造成：</h3><ul>\n<li>可扩展性灵活性差，出现性能问题</li>\n<li>业务变更和开发困难，维护成本很高，交付时间长</li>\n<li>回归测试量很大</li>\n<li>…</li>\n</ul>\n<p>为了解决这些问题，就需要时时刻刻清楚的记住“<strong>单一职责</strong>”，<strong>单一职责</strong>可以用到软件开发的任何地方。</p>\n<p>应该说职责分离来解耦是最常用最有效的架构方法，这能够很大限度的简化一切。</p>\n<h3 id=\"下面就从软件开发、设计、架构，以及重构-演进-进化，从小到大几个方面来说说单一职责：\"><a href=\"#下面就从软件开发、设计、架构，以及重构-演进-进化，从小到大几个方面来说说单一职责：\" class=\"headerlink\" title=\"下面就从软件开发、设计、架构，以及重构/演进/进化，从小到大几个方面来说说单一职责：\"></a>下面就从软件开发、设计、架构，以及重构/演进/进化，从小到大几个方面来说说<strong>单一职责</strong>：</h3><h2 id=\"类方法-函数\"><a href=\"#类方法-函数\" class=\"headerlink\" title=\"类方法/函数\"></a>类方法/函数</h2><p>这应该是最小的能体现<strong>单一职责</strong>的程序单元了。最熟悉的最典型的莫过于Helper/Utils类方法了，但这种类方法的特征很明显，也很容易遵循单一职责，99%以上的开发人员都可以做到。但不仅仅这样的类方法要遵循单一职责原则，每一个类方法都应该遵循<strong>单一职责</strong>原则，尤其是一些处理业务逻辑的类方法更要遵循<strong>单一职责</strong>原则，处理业务的类方法通常要配合类的单一职责原则进行，下节中讨论。</p>\n<p>因此，这也是为什么很多TL要求类方法代码行数保持在20行左右，其实就是为了保证单一职责，20行左右是一个<strong>经验粗略数字</strong>，当然，10行或者30行来完成类方法也是可以的。大部分单一职责的类方法用20行左右的代码就够了，如果超过20行就要考虑是否保证了单一职责了。那我们在<strong>迭代重构</strong>的过程中就要考虑拆分这样的类方法来保证单一职责。</p>\n<p>类方法的单一职责是最单纯的，很具体的，不惨杂任何额外信息，只关心输入、输出、和职责；一定要明确地定义类方法的职责，保证在迭代中不被错误的扩张，调用方错误的使用。</p>\n<h2 id=\"类-函数文件\"><a href=\"#类-函数文件\" class=\"headerlink\" title=\"类/函数文件\"></a>类/函数文件</h2><p>要用面向对象的设计方法，<strong>单一职责原则</strong>来定义类。开发人员一定要很好地理解“单一职责原则”，具有面向对象的抽象思维能力。</p>\n<p>当在迭代中一个类过于庞大或者快速膨胀，说明已经有坏味道了，这时候就需要考虑用单一职责原则或者面向对象的分析方法来重构和重新定义类了，通常就是要抽象和拆分类，否则将来会变成一个方法容器。</p>\n<p>把类比作一个人，她的职责就是完成自己职责范围内的事情，如果她什么事情都管，就叫多管闲事，可以想象她多管闲事的后果了，会搅得鸡犬不宁。同样，类也是，类如果多管闲事，那会搅得真个应用不稳定，漏洞百出，还很难修复。所以说定义一个类，要明确这个类的职责。使用面向对象的分析和设计方法，能很好地准确定义一个类的职责范围，通常就要用到封装、继承、多态和抽象等设计方法。</p>\n<h2 id=\"包结构-文件夹\"><a href=\"#包结构-文件夹\" class=\"headerlink\" title=\"包结构/文件夹\"></a>包结构/文件夹</h2><p>分层就是最常用的架构方法之一，分层具体体现在分包和分类，就是分门别类的意思。俗话说，物以类聚，人以群分。</p>\n<p>包结构在单一职责原则上是类的补充，职责范围进一步扩大。如果把一个类叫做一个人，那么包就是一个最小单位的团队，职责就是负责一类特定事情。<br>如何分包呢？那就要用到分类学的知识了，要以什么特征来分，可能不仅仅只有一种特征，比如，先用公司域名来做基础包名，这里叫一级包名；然后再用一个特定的有意义的标识作为二级子包名；之后按分层（web,dao,service等等）方法做三级包名，也可以先按照业务再按分层。例如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">域名：tietang.wang</div><div class=\"line\">有个项目叫：social</div><div class=\"line\">那么我可以这样分：</div><div class=\"line\">wang.tietang</div><div class=\"line\">\t- social</div><div class=\"line\">\t\t- web</div><div class=\"line\">\t\t- service</div><div class=\"line\">\t\t- dao</div><div class=\"line\">\t\t- commons</div><div class=\"line\"></div><div class=\"line\">也可以这样：</div><div class=\"line\"></div><div class=\"line\">wang.tietang</div><div class=\"line\">\t- commons</div><div class=\"line\">\t- user</div><div class=\"line\">\t\t- web</div><div class=\"line\">\t\t- service</div><div class=\"line\">\t\t- dao</div><div class=\"line\">\t- relation</div><div class=\"line\">\t\t- web</div><div class=\"line\">\t\t- service</div><div class=\"line\">\t\t- dao</div></pre></td></tr></table></figure>\n<h2 id=\"多工程-module\"><a href=\"#多工程-module\" class=\"headerlink\" title=\"多工程/module\"></a>多工程/module</h2><p>通常以多maven module或者gradle 多module形式存在，来保证单一职责。<br>当业务量还没有达到服务拆分的火候，又需要规整项目结构，通常在一个app发展的太庞大时或者在工程建设初期采取，从文件系统上隔离，通过module依赖来集成。需要注意的是这样的架构或拆分不是随意的，要以单一职责原则来拆分，更具体一点就是要根据业务，技术框架功能等特性来拆分。</p>\n<p>比如，按技术组件拆分，通常会有一些技术组件，可以把她放到commons module，如果有多种类型的技术组件，就拆分为commons module的子module；也可以直接将这些技术组件拆分为独立的工程，存在于独立的git/svn仓库，独立管理，专人负责；其他哪些module需要就依赖她。那拆分的这些技术组件的每一个应该遵循单一职责原则，例如数据分片的框架，NIO基础网络框架等等。</p>\n<p>比如，按业务拆分，例如有用户，订单，商品，支付，那么就按照这些业务拆分为子module，每一个子module就只负责自己的业务逻辑，也遵循单一职责。</p>\n<p>那每个module的职责范围又比类和包更大，这个时候职责也更模糊，有时候很难把握，对于技术组件可能相对清晰，业务module就要熟悉业务，明确业务边界。</p>\n<p>多module拆分后也是为将来服务化埋下伏笔，同时在物理文件系统比较清晰了，那在依赖管理上也要掌握好保持清晰的依赖逻辑，把握好单一职责原则。</p>\n<h2 id=\"微服务-可部署单元\"><a href=\"#微服务-可部署单元\" class=\"headerlink\" title=\"微服务/可部署单元\"></a>微服务/可部署单元</h2><p>微服务，从运行时隔离，但业务量发展到一定时候，从单体或者多module工程拆分或演化出来，可独立打包可独立部署并复合单一原则的application，当然了微服务所体现的价值不仅仅是隔离和独立部署，还有很多这里可以参考<a href=\"http://www.infoq.com/cn/news/2015/04/single-app-micro-service\" target=\"_blank\" rel=\"external\">单体应用与微服务优缺点辨析</a>。单一职责在微服务中的价值是最重要的，包含了app层面和开发app的团队层面，微服务的大部分优点都可以围绕单一职责来张开。</p>\n<h2 id=\"团队\"><a href=\"#团队\" class=\"headerlink\" title=\"团队\"></a>团队</h2><p>先引用《韩非子·扬权》中的一段文字：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">夫物者有所宜，材者有所施，各处其宜，故上下无为。 </div><div class=\"line\">使鸡司夜，令狸执鼠，皆用其能，上乃无事。</div><div class=\"line\">上有所长，事乃不方。 </div><div class=\"line\">矜而好能，下之所欺：辩惠好生，下因其材。</div><div class=\"line\">上下易用，国故不治。</div></pre></td></tr></table></figure>\n<p><strong>参考：</strong></p>\n<ul>\n<li>原文：<a href=\"http://www.shici8.com/bookview_3501.html\" target=\"_blank\" rel=\"external\">http://www.shici8.com/bookview_3501.html</a></li>\n<li>译文：<a href=\"http://www.shici8.com/article_8539.html\" target=\"_blank\" rel=\"external\">http://www.shici8.com/article_8539.html</a></li>\n</ul>\n<p>各得其所，各司其职。所以，团队也要遵循单一职责原则，这样才能很好地管理团队成员的时间，提高效率。一个人专注做一件事情的效率远高于同时关注多件事情的。同样一个人一直管理和维护同一份代码要比多人同时维护多份代码的效率高很多。每一个人都有自己的个性，他有自己的擅长，让每一个人专注自己擅长的事情，那肯定事半功倍，整个团队绩效肯定也很突出。</p>\n<p>总之，引用古文名句说明了所有：</p>\n<ul>\n<li>物以类聚，人以群分。</li>\n<li>天下之事，分合交替，分久必合，合久必分！</li>\n<li>使鸡司夜，令狸执鼠，皆用其能，上乃无事。</li>\n</ul>\n<h3 id=\"参考：\"><a href=\"#参考：\" class=\"headerlink\" title=\"参考：\"></a>参考：</h3><p> <a href=\"http://www.jianshu.com/p/f9d15827465d\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/p/f9d15827465d</a></p>\n<p> <a href=\"https://zh.wikipedia.org/wiki/单一功能原则\" target=\"_blank\" rel=\"external\">https://zh.wikipedia.org/wiki/单一功能原则</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"软件开发中的单一职责\"><a href=\"#软件开发中的单一职责\" class=\"headerlink\" title=\"软件开发中的单一职责\"></a>软件开发中的单一职责</h1><p>最近在实践微服务化过程中，对其“单一职责”原则深有体会。<br>那么只有微服务化才可以单一职责，才可以解耦吗？答案是否定的。</p>\n<p>单一职责原则是这样定义的：单一的功能，并且完全封装起来。</p>\n<p>我们做后端Java开发的，应该最熟悉的就是标准的3层架构了，尤其是使用Spring.io体系的：Controller，Service，Dao/Repository。为什么要分层？就是为了保证单一职责，数据模型的事情交给Controller，业务逻辑的事情交给Service，和数据打交道的事情就交给Dao/Repository。有时候或者有些人会分层分的更多，4层，5层，我自己也这样干过，说白了也是为了保证单一职责，3层不能满足单一职责了，耦合度高了，就分。</p>\n<p>我们都知道一个webapp在经过一定时间的开发后，就惨不忍睹，即便是有标准的分层，页面或模板文件一大堆，最初的很清晰的3层标准架构也变味了，Controller，Service，Dao/Repository各层之间、Service之间、Dao/Repository之间互相调用，一团乱麻。这个时候没改一行代码都有可能一个老鼠害了一锅汤，bug就如同蚂蚁洞。</p>\n<h3 id=\"这些问题最后就造成：\"><a href=\"#这些问题最后就造成：\" class=\"headerlink\" title=\"这些问题最后就造成：\"></a>这些问题最后就造成：</h3><ul>\n<li>可扩展性灵活性差，出现性能问题</li>\n<li>业务变更和开发困难，维护成本很高，交付时间长</li>\n<li>回归测试量很大</li>\n<li>…</li>\n</ul>\n<p>为了解决这些问题，就需要时时刻刻清楚的记住“<strong>单一职责</strong>”，<strong>单一职责</strong>可以用到软件开发的任何地方。</p>\n<p>应该说职责分离来解耦是最常用最有效的架构方法，这能够很大限度的简化一切。</p>\n<h3 id=\"下面就从软件开发、设计、架构，以及重构-演进-进化，从小到大几个方面来说说单一职责：\"><a href=\"#下面就从软件开发、设计、架构，以及重构-演进-进化，从小到大几个方面来说说单一职责：\" class=\"headerlink\" title=\"下面就从软件开发、设计、架构，以及重构/演进/进化，从小到大几个方面来说说单一职责：\"></a>下面就从软件开发、设计、架构，以及重构/演进/进化，从小到大几个方面来说说<strong>单一职责</strong>：</h3><h2 id=\"类方法-函数\"><a href=\"#类方法-函数\" class=\"headerlink\" title=\"类方法/函数\"></a>类方法/函数</h2><p>这应该是最小的能体现<strong>单一职责</strong>的程序单元了。最熟悉的最典型的莫过于Helper/Utils类方法了，但这种类方法的特征很明显，也很容易遵循单一职责，99%以上的开发人员都可以做到。但不仅仅这样的类方法要遵循单一职责原则，每一个类方法都应该遵循<strong>单一职责</strong>原则，尤其是一些处理业务逻辑的类方法更要遵循<strong>单一职责</strong>原则，处理业务的类方法通常要配合类的单一职责原则进行，下节中讨论。</p>\n<p>因此，这也是为什么很多TL要求类方法代码行数保持在20行左右，其实就是为了保证单一职责，20行左右是一个<strong>经验粗略数字</strong>，当然，10行或者30行来完成类方法也是可以的。大部分单一职责的类方法用20行左右的代码就够了，如果超过20行就要考虑是否保证了单一职责了。那我们在<strong>迭代重构</strong>的过程中就要考虑拆分这样的类方法来保证单一职责。</p>\n<p>类方法的单一职责是最单纯的，很具体的，不惨杂任何额外信息，只关心输入、输出、和职责；一定要明确地定义类方法的职责，保证在迭代中不被错误的扩张，调用方错误的使用。</p>\n<h2 id=\"类-函数文件\"><a href=\"#类-函数文件\" class=\"headerlink\" title=\"类/函数文件\"></a>类/函数文件</h2><p>要用面向对象的设计方法，<strong>单一职责原则</strong>来定义类。开发人员一定要很好地理解“单一职责原则”，具有面向对象的抽象思维能力。</p>\n<p>当在迭代中一个类过于庞大或者快速膨胀，说明已经有坏味道了，这时候就需要考虑用单一职责原则或者面向对象的分析方法来重构和重新定义类了，通常就是要抽象和拆分类，否则将来会变成一个方法容器。</p>\n<p>把类比作一个人，她的职责就是完成自己职责范围内的事情，如果她什么事情都管，就叫多管闲事，可以想象她多管闲事的后果了，会搅得鸡犬不宁。同样，类也是，类如果多管闲事，那会搅得真个应用不稳定，漏洞百出，还很难修复。所以说定义一个类，要明确这个类的职责。使用面向对象的分析和设计方法，能很好地准确定义一个类的职责范围，通常就要用到封装、继承、多态和抽象等设计方法。</p>\n<h2 id=\"包结构-文件夹\"><a href=\"#包结构-文件夹\" class=\"headerlink\" title=\"包结构/文件夹\"></a>包结构/文件夹</h2><p>分层就是最常用的架构方法之一，分层具体体现在分包和分类，就是分门别类的意思。俗话说，物以类聚，人以群分。</p>\n<p>包结构在单一职责原则上是类的补充，职责范围进一步扩大。如果把一个类叫做一个人，那么包就是一个最小单位的团队，职责就是负责一类特定事情。<br>如何分包呢？那就要用到分类学的知识了，要以什么特征来分，可能不仅仅只有一种特征，比如，先用公司域名来做基础包名，这里叫一级包名；然后再用一个特定的有意义的标识作为二级子包名；之后按分层（web,dao,service等等）方法做三级包名，也可以先按照业务再按分层。例如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">域名：tietang.wang</div><div class=\"line\">有个项目叫：social</div><div class=\"line\">那么我可以这样分：</div><div class=\"line\">wang.tietang</div><div class=\"line\">\t- social</div><div class=\"line\">\t\t- web</div><div class=\"line\">\t\t- service</div><div class=\"line\">\t\t- dao</div><div class=\"line\">\t\t- commons</div><div class=\"line\"></div><div class=\"line\">也可以这样：</div><div class=\"line\"></div><div class=\"line\">wang.tietang</div><div class=\"line\">\t- commons</div><div class=\"line\">\t- user</div><div class=\"line\">\t\t- web</div><div class=\"line\">\t\t- service</div><div class=\"line\">\t\t- dao</div><div class=\"line\">\t- relation</div><div class=\"line\">\t\t- web</div><div class=\"line\">\t\t- service</div><div class=\"line\">\t\t- dao</div></pre></td></tr></table></figure>\n<h2 id=\"多工程-module\"><a href=\"#多工程-module\" class=\"headerlink\" title=\"多工程/module\"></a>多工程/module</h2><p>通常以多maven module或者gradle 多module形式存在，来保证单一职责。<br>当业务量还没有达到服务拆分的火候，又需要规整项目结构，通常在一个app发展的太庞大时或者在工程建设初期采取，从文件系统上隔离，通过module依赖来集成。需要注意的是这样的架构或拆分不是随意的，要以单一职责原则来拆分，更具体一点就是要根据业务，技术框架功能等特性来拆分。</p>\n<p>比如，按技术组件拆分，通常会有一些技术组件，可以把她放到commons module，如果有多种类型的技术组件，就拆分为commons module的子module；也可以直接将这些技术组件拆分为独立的工程，存在于独立的git/svn仓库，独立管理，专人负责；其他哪些module需要就依赖她。那拆分的这些技术组件的每一个应该遵循单一职责原则，例如数据分片的框架，NIO基础网络框架等等。</p>\n<p>比如，按业务拆分，例如有用户，订单，商品，支付，那么就按照这些业务拆分为子module，每一个子module就只负责自己的业务逻辑，也遵循单一职责。</p>\n<p>那每个module的职责范围又比类和包更大，这个时候职责也更模糊，有时候很难把握，对于技术组件可能相对清晰，业务module就要熟悉业务，明确业务边界。</p>\n<p>多module拆分后也是为将来服务化埋下伏笔，同时在物理文件系统比较清晰了，那在依赖管理上也要掌握好保持清晰的依赖逻辑，把握好单一职责原则。</p>\n<h2 id=\"微服务-可部署单元\"><a href=\"#微服务-可部署单元\" class=\"headerlink\" title=\"微服务/可部署单元\"></a>微服务/可部署单元</h2><p>微服务，从运行时隔离，但业务量发展到一定时候，从单体或者多module工程拆分或演化出来，可独立打包可独立部署并复合单一原则的application，当然了微服务所体现的价值不仅仅是隔离和独立部署，还有很多这里可以参考<a href=\"http://www.infoq.com/cn/news/2015/04/single-app-micro-service\" target=\"_blank\" rel=\"external\">单体应用与微服务优缺点辨析</a>。单一职责在微服务中的价值是最重要的，包含了app层面和开发app的团队层面，微服务的大部分优点都可以围绕单一职责来张开。</p>\n<h2 id=\"团队\"><a href=\"#团队\" class=\"headerlink\" title=\"团队\"></a>团队</h2><p>先引用《韩非子·扬权》中的一段文字：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">夫物者有所宜，材者有所施，各处其宜，故上下无为。 </div><div class=\"line\">使鸡司夜，令狸执鼠，皆用其能，上乃无事。</div><div class=\"line\">上有所长，事乃不方。 </div><div class=\"line\">矜而好能，下之所欺：辩惠好生，下因其材。</div><div class=\"line\">上下易用，国故不治。</div></pre></td></tr></table></figure>\n<p><strong>参考：</strong></p>\n<ul>\n<li>原文：<a href=\"http://www.shici8.com/bookview_3501.html\" target=\"_blank\" rel=\"external\">http://www.shici8.com/bookview_3501.html</a></li>\n<li>译文：<a href=\"http://www.shici8.com/article_8539.html\" target=\"_blank\" rel=\"external\">http://www.shici8.com/article_8539.html</a></li>\n</ul>\n<p>各得其所，各司其职。所以，团队也要遵循单一职责原则，这样才能很好地管理团队成员的时间，提高效率。一个人专注做一件事情的效率远高于同时关注多件事情的。同样一个人一直管理和维护同一份代码要比多人同时维护多份代码的效率高很多。每一个人都有自己的个性，他有自己的擅长，让每一个人专注自己擅长的事情，那肯定事半功倍，整个团队绩效肯定也很突出。</p>\n<p>总之，引用古文名句说明了所有：</p>\n<ul>\n<li>物以类聚，人以群分。</li>\n<li>天下之事，分合交替，分久必合，合久必分！</li>\n<li>使鸡司夜，令狸执鼠，皆用其能，上乃无事。</li>\n</ul>\n<h3 id=\"参考：\"><a href=\"#参考：\" class=\"headerlink\" title=\"参考：\"></a>参考：</h3><p> <a href=\"http://www.jianshu.com/p/f9d15827465d\" target=\"_blank\" rel=\"external\">http://www.jianshu.com/p/f9d15827465d</a></p>\n<p> <a href=\"https://zh.wikipedia.org/wiki/单一功能原则\" target=\"_blank\" rel=\"external\">https://zh.wikipedia.org/wiki/单一功能原则</a></p>\n"},{"title":"FlatBuffers简介","date":"2016-02-19T12:20:42.000Z","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/DPP_00032.JPG","_content":"\n## FlatBuffers简介\n\n代码：https://github.com/google/flatbuffers/\n\n文档：http://google.github.io/flatbuffers/\n\n\nFlatBuffers是一个开源的、跨平台的、高效的、提供了C++/Java接口的序列化工具库。它是Google专门为游戏开发或其他性能敏感的应用程序需求而创建。 允许在不解析和解包就可以直接访问序列化数据，而且仍然很好地向上和向下兼容，这意味着序列化对象可以多版本共存。\n\n\n\n### 支持的操作系统\n\n* Android\n* Windows\n* MacOS X\n* Linux\n\n\n### 目前支持的编程语言\n\n* C++\n* C#\n* Go\n* Java\n* JavaScript\n* PHP\n* Python\n\nand many more in progress...\n\n## 为什么要用FlatBuffers?\n\n+ **对序列化数据的访问不需要打包和拆包**——它将序列化数据存储在缓存中，这些数据既可以存储在文件中，又可以通过网络原样传输，而没有任何解析开销；\n+ **内存效率和速度**——访问数据时的唯一内存需求就是缓冲区，不需要额外的内存分配。 这里可查看详细的基准测试；\n+ **扩展性、灵活性【多版本兼容】**——它支持的可选字段意味着不仅能获得很好的前向/后向兼容性（对于长生命周期的游戏来说尤其重要，因为不需要每个新版本都更新所有数据）；\n+ **最小代码依赖**——仅仅需要自动生成的少量代码和一个单一的头文件依赖，很容易集成到现有系统中。再次，看基准部分细节；\n+ **强类型设计**——尽可能使错误出现在编译期，而不是等到运行期才手动检查和修正；\n+ **使用简单**——生成的C++代码提供了简单的访问和构造接口；而且如果需要，通过一个可选功能可以用来在运行时高效解析Schema和类JSON格式的文本；\n+ **跨平台**——支持C++11、Java，而不需要任何依赖库；在最新的gcc、clang、vs2010等编译器上工作良好；\n\n \n### 为什么不使用Protocol Buffers的，或者JSON\n\nProtocol Buffers的确和FlatBuffers比较类似，但其主要区别在于FlatBuffers在访问数据前不需要解析/拆包这一步。 而且Protocol Buffers既没有可选的文本导入/导出功能，也没有Schemas语法特性（比如union）。同时，在工程中使用时，FlatBuffers的引用比Protocol Buffers方便很多，只需要包含两三个头文件即可。\n\nJSON的可读性很好，而且当和动态类型语言（如JavaScript）一起使用时非常方便。然而在静态类型语言中序列化数据时，JSON不但具有运行效率低的明显缺点，而且会让你写更多的代码来访问数据（这个与直觉相反）。\n\n与Protocol Buffers或JSON Parsing这样的可选方案相比，FlatBuffers的优势在于开销更小，这主要是由于它没有解析过程。http://google.github.io/flatbuffers/md__benchmarks.html\n\n\n\n \n ","source":"_posts/技术/FlatBuffers/FlatBuffers简介.md","raw":"---\ntitle: FlatBuffers简介\ndate: 2016-02-19 20:20:42\ncategories: \n\t- 技术\n\t- FlatBuffers\nthumbnail: http://7xiovs.com1.z0.glb.clouddn.com/DPP_00032.JPG\ntags: \n\t- FlatBuffers\n\t- 序列化\n---\n\n## FlatBuffers简介\n\n代码：https://github.com/google/flatbuffers/\n\n文档：http://google.github.io/flatbuffers/\n\n\nFlatBuffers是一个开源的、跨平台的、高效的、提供了C++/Java接口的序列化工具库。它是Google专门为游戏开发或其他性能敏感的应用程序需求而创建。 允许在不解析和解包就可以直接访问序列化数据，而且仍然很好地向上和向下兼容，这意味着序列化对象可以多版本共存。\n\n\n\n### 支持的操作系统\n\n* Android\n* Windows\n* MacOS X\n* Linux\n\n\n### 目前支持的编程语言\n\n* C++\n* C#\n* Go\n* Java\n* JavaScript\n* PHP\n* Python\n\nand many more in progress...\n\n## 为什么要用FlatBuffers?\n\n+ **对序列化数据的访问不需要打包和拆包**——它将序列化数据存储在缓存中，这些数据既可以存储在文件中，又可以通过网络原样传输，而没有任何解析开销；\n+ **内存效率和速度**——访问数据时的唯一内存需求就是缓冲区，不需要额外的内存分配。 这里可查看详细的基准测试；\n+ **扩展性、灵活性【多版本兼容】**——它支持的可选字段意味着不仅能获得很好的前向/后向兼容性（对于长生命周期的游戏来说尤其重要，因为不需要每个新版本都更新所有数据）；\n+ **最小代码依赖**——仅仅需要自动生成的少量代码和一个单一的头文件依赖，很容易集成到现有系统中。再次，看基准部分细节；\n+ **强类型设计**——尽可能使错误出现在编译期，而不是等到运行期才手动检查和修正；\n+ **使用简单**——生成的C++代码提供了简单的访问和构造接口；而且如果需要，通过一个可选功能可以用来在运行时高效解析Schema和类JSON格式的文本；\n+ **跨平台**——支持C++11、Java，而不需要任何依赖库；在最新的gcc、clang、vs2010等编译器上工作良好；\n\n \n### 为什么不使用Protocol Buffers的，或者JSON\n\nProtocol Buffers的确和FlatBuffers比较类似，但其主要区别在于FlatBuffers在访问数据前不需要解析/拆包这一步。 而且Protocol Buffers既没有可选的文本导入/导出功能，也没有Schemas语法特性（比如union）。同时，在工程中使用时，FlatBuffers的引用比Protocol Buffers方便很多，只需要包含两三个头文件即可。\n\nJSON的可读性很好，而且当和动态类型语言（如JavaScript）一起使用时非常方便。然而在静态类型语言中序列化数据时，JSON不但具有运行效率低的明显缺点，而且会让你写更多的代码来访问数据（这个与直觉相反）。\n\n与Protocol Buffers或JSON Parsing这样的可选方案相比，FlatBuffers的优势在于开销更小，这主要是由于它没有解析过程。http://google.github.io/flatbuffers/md__benchmarks.html\n\n\n\n \n ","slug":"技术/FlatBuffers/FlatBuffers简介","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc4o0051z29krc9sbdj7","content":"<h2 id=\"FlatBuffers简介\"><a href=\"#FlatBuffers简介\" class=\"headerlink\" title=\"FlatBuffers简介\"></a>FlatBuffers简介</h2><p>代码：<a href=\"https://github.com/google/flatbuffers/\" target=\"_blank\" rel=\"external\">https://github.com/google/flatbuffers/</a></p>\n<p>文档：<a href=\"http://google.github.io/flatbuffers/\" target=\"_blank\" rel=\"external\">http://google.github.io/flatbuffers/</a></p>\n<p>FlatBuffers是一个开源的、跨平台的、高效的、提供了C++/Java接口的序列化工具库。它是Google专门为游戏开发或其他性能敏感的应用程序需求而创建。 允许在不解析和解包就可以直接访问序列化数据，而且仍然很好地向上和向下兼容，这意味着序列化对象可以多版本共存。</p>\n<h3 id=\"支持的操作系统\"><a href=\"#支持的操作系统\" class=\"headerlink\" title=\"支持的操作系统\"></a>支持的操作系统</h3><ul>\n<li>Android</li>\n<li>Windows</li>\n<li>MacOS X</li>\n<li>Linux</li>\n</ul>\n<h3 id=\"目前支持的编程语言\"><a href=\"#目前支持的编程语言\" class=\"headerlink\" title=\"目前支持的编程语言\"></a>目前支持的编程语言</h3><ul>\n<li>C++</li>\n<li>C#</li>\n<li>Go</li>\n<li>Java</li>\n<li>JavaScript</li>\n<li>PHP</li>\n<li>Python</li>\n</ul>\n<p>and many more in progress…</p>\n<h2 id=\"为什么要用FlatBuffers\"><a href=\"#为什么要用FlatBuffers\" class=\"headerlink\" title=\"为什么要用FlatBuffers?\"></a>为什么要用FlatBuffers?</h2><ul>\n<li><strong>对序列化数据的访问不需要打包和拆包</strong>——它将序列化数据存储在缓存中，这些数据既可以存储在文件中，又可以通过网络原样传输，而没有任何解析开销；</li>\n<li><strong>内存效率和速度</strong>——访问数据时的唯一内存需求就是缓冲区，不需要额外的内存分配。 这里可查看详细的基准测试；</li>\n<li><strong>扩展性、灵活性【多版本兼容】</strong>——它支持的可选字段意味着不仅能获得很好的前向/后向兼容性（对于长生命周期的游戏来说尤其重要，因为不需要每个新版本都更新所有数据）；</li>\n<li><strong>最小代码依赖</strong>——仅仅需要自动生成的少量代码和一个单一的头文件依赖，很容易集成到现有系统中。再次，看基准部分细节；</li>\n<li><strong>强类型设计</strong>——尽可能使错误出现在编译期，而不是等到运行期才手动检查和修正；</li>\n<li><strong>使用简单</strong>——生成的C++代码提供了简单的访问和构造接口；而且如果需要，通过一个可选功能可以用来在运行时高效解析Schema和类JSON格式的文本；</li>\n<li><strong>跨平台</strong>——支持C++11、Java，而不需要任何依赖库；在最新的gcc、clang、vs2010等编译器上工作良好；</li>\n</ul>\n<h3 id=\"为什么不使用Protocol-Buffers的，或者JSON\"><a href=\"#为什么不使用Protocol-Buffers的，或者JSON\" class=\"headerlink\" title=\"为什么不使用Protocol Buffers的，或者JSON\"></a>为什么不使用Protocol Buffers的，或者JSON</h3><p>Protocol Buffers的确和FlatBuffers比较类似，但其主要区别在于FlatBuffers在访问数据前不需要解析/拆包这一步。 而且Protocol Buffers既没有可选的文本导入/导出功能，也没有Schemas语法特性（比如union）。同时，在工程中使用时，FlatBuffers的引用比Protocol Buffers方便很多，只需要包含两三个头文件即可。</p>\n<p>JSON的可读性很好，而且当和动态类型语言（如JavaScript）一起使用时非常方便。然而在静态类型语言中序列化数据时，JSON不但具有运行效率低的明显缺点，而且会让你写更多的代码来访问数据（这个与直觉相反）。</p>\n<p>与Protocol Buffers或JSON Parsing这样的可选方案相比，FlatBuffers的优势在于开销更小，这主要是由于它没有解析过程。<a href=\"http://google.github.io/flatbuffers/md__benchmarks.html\" target=\"_blank\" rel=\"external\">http://google.github.io/flatbuffers/md__benchmarks.html</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"FlatBuffers简介\"><a href=\"#FlatBuffers简介\" class=\"headerlink\" title=\"FlatBuffers简介\"></a>FlatBuffers简介</h2><p>代码：<a href=\"https://github.com/google/flatbuffers/\" target=\"_blank\" rel=\"external\">https://github.com/google/flatbuffers/</a></p>\n<p>文档：<a href=\"http://google.github.io/flatbuffers/\" target=\"_blank\" rel=\"external\">http://google.github.io/flatbuffers/</a></p>\n<p>FlatBuffers是一个开源的、跨平台的、高效的、提供了C++/Java接口的序列化工具库。它是Google专门为游戏开发或其他性能敏感的应用程序需求而创建。 允许在不解析和解包就可以直接访问序列化数据，而且仍然很好地向上和向下兼容，这意味着序列化对象可以多版本共存。</p>\n<h3 id=\"支持的操作系统\"><a href=\"#支持的操作系统\" class=\"headerlink\" title=\"支持的操作系统\"></a>支持的操作系统</h3><ul>\n<li>Android</li>\n<li>Windows</li>\n<li>MacOS X</li>\n<li>Linux</li>\n</ul>\n<h3 id=\"目前支持的编程语言\"><a href=\"#目前支持的编程语言\" class=\"headerlink\" title=\"目前支持的编程语言\"></a>目前支持的编程语言</h3><ul>\n<li>C++</li>\n<li>C#</li>\n<li>Go</li>\n<li>Java</li>\n<li>JavaScript</li>\n<li>PHP</li>\n<li>Python</li>\n</ul>\n<p>and many more in progress…</p>\n<h2 id=\"为什么要用FlatBuffers\"><a href=\"#为什么要用FlatBuffers\" class=\"headerlink\" title=\"为什么要用FlatBuffers?\"></a>为什么要用FlatBuffers?</h2><ul>\n<li><strong>对序列化数据的访问不需要打包和拆包</strong>——它将序列化数据存储在缓存中，这些数据既可以存储在文件中，又可以通过网络原样传输，而没有任何解析开销；</li>\n<li><strong>内存效率和速度</strong>——访问数据时的唯一内存需求就是缓冲区，不需要额外的内存分配。 这里可查看详细的基准测试；</li>\n<li><strong>扩展性、灵活性【多版本兼容】</strong>——它支持的可选字段意味着不仅能获得很好的前向/后向兼容性（对于长生命周期的游戏来说尤其重要，因为不需要每个新版本都更新所有数据）；</li>\n<li><strong>最小代码依赖</strong>——仅仅需要自动生成的少量代码和一个单一的头文件依赖，很容易集成到现有系统中。再次，看基准部分细节；</li>\n<li><strong>强类型设计</strong>——尽可能使错误出现在编译期，而不是等到运行期才手动检查和修正；</li>\n<li><strong>使用简单</strong>——生成的C++代码提供了简单的访问和构造接口；而且如果需要，通过一个可选功能可以用来在运行时高效解析Schema和类JSON格式的文本；</li>\n<li><strong>跨平台</strong>——支持C++11、Java，而不需要任何依赖库；在最新的gcc、clang、vs2010等编译器上工作良好；</li>\n</ul>\n<h3 id=\"为什么不使用Protocol-Buffers的，或者JSON\"><a href=\"#为什么不使用Protocol-Buffers的，或者JSON\" class=\"headerlink\" title=\"为什么不使用Protocol Buffers的，或者JSON\"></a>为什么不使用Protocol Buffers的，或者JSON</h3><p>Protocol Buffers的确和FlatBuffers比较类似，但其主要区别在于FlatBuffers在访问数据前不需要解析/拆包这一步。 而且Protocol Buffers既没有可选的文本导入/导出功能，也没有Schemas语法特性（比如union）。同时，在工程中使用时，FlatBuffers的引用比Protocol Buffers方便很多，只需要包含两三个头文件即可。</p>\n<p>JSON的可读性很好，而且当和动态类型语言（如JavaScript）一起使用时非常方便。然而在静态类型语言中序列化数据时，JSON不但具有运行效率低的明显缺点，而且会让你写更多的代码来访问数据（这个与直觉相反）。</p>\n<p>与Protocol Buffers或JSON Parsing这样的可选方案相比，FlatBuffers的优势在于开销更小，这主要是由于它没有解析过程。<a href=\"http://google.github.io/flatbuffers/md__benchmarks.html\" target=\"_blank\" rel=\"external\">http://google.github.io/flatbuffers/md__benchmarks.html</a></p>\n"},{"title":"FlatBuffers 使用指南","date":"2016-02-19T12:20:42.000Z","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/IMG_20160218_122224.JPG","_content":"\n# FlatBuffers 使用指南\n\nFlatBuffers序列化性能是protobuf的2倍，但size也是protobuf的2倍\n\n## 编译源码\n\n```\n$ git clone https://github.com/google/flatbuffers.git\n#切换到最新release版本\n$ git checkout v1.2.0\n```\n\n### 安装cmake \n\nhttp://www.cmake.org.\n\n```\nfor mac osx\n$ brew install cmake\nfor centOS\n$ sudo yum install cmake\n```\n\n### 用cmake构建project\n\n```\ncmake -G \"Unix Makefiles\"\ncmake -G \"Visual Studio 10\"\ncmake -G \"Xcode\"\n```\n在*nix系统，mac osx系统也建议使用 `cmake -G \"Unix Makefiles\"`，生成`Makefile`,之后`make & make install`\n编译生成`flatc`并安装到系统。\n\n```\n$ cmake -G \"Unix Makefiles\"\n$ make\n$ make insall\n\n```\n\n\n## 使用schema编译器flatc来生成基础代码\n\n```\n$ cd samples\n#在目录src中生成java代码\n$flatc -j -o src monster.fbs \n\n```\n\n### 编程语言参数:\n\n+ --cpp, -c : Generate a C++ header for all definitions in this file (as filename_generated.h).\n+ --java, -j : Generate Java code.\n+ --csharp, -n : Generate C# code.\n+ --go, -g : Generate Go code.\n+ --python, -p: Generate Python code.\n+ --javascript, -s: Generate JavaScript code.\n+ --php: Generate PHP code.\n\n### 其他常用选项：\n\n+ -o PATH 指定源码输出目录\n+ -I PATH 有include语句时，指定include目录\n\n\n# 完整的参数\n\n```\nusage: flatc [OPTION]... FILE... [-- FILE...]\n  -b              Generate wire format binaries for any data definitions.\n  -t              Generate text output for any data definitions.\n  -c              Generate C++ headers for tables/structs.\n  -g              Generate Go files for tables/structs.\n  -j              Generate Java classes for tables/structs.\n  -s              Generate JavaScript code for tables/structs.\n  -n              Generate C# classes for tables/structs.\n  -p              Generate Python files for tables/structs.\n  -o PATH         Prefix PATH to all generated files.\n  -I PATH         Search for includes in the specified path.\n  -M              Print make rules for generated files.\n  --strict-json   Strict JSON: field names must be / will be quoted,\n                  no trailing commas in tables/vectors.\n  --defaults-json Output fields whose value is the default when\n                  writing JSON\n  --no-prefix     Don't prefix enum values with the enum type in C++.\n  --scoped-enums  Use C++11 style scoped and strongly typed enums.\n                  also implies --no-prefix.\n  --gen-includes  (deprecated), this is the default behavior.\n                  If the original behavior is required (no include\n                  statements) use --no-includes.\n  --no-includes   Don't generate include statements for included\n                  schemas the generated file depends on (C++).\n  --gen-mutable   Generate accessors that can mutate buffers in-place.\n  --gen-onefile   Generate single output file for C#\n  --raw-binary    Allow binaries without file_indentifier to be read.\n                  This may crash flatc given a mismatched schema.\n  --proto         Input is a .proto, translate to .fbs.\n  --schema        Serialize schemas instead of JSON (use with -b)\nFILEs may depend on declarations in earlier files.\nFILEs after the -- must be binary flatbuffer format files.\nOutput files are named using the base file name of the input,\nand written to the current directory or the path given by -o.\nexample: flatc -c -b schema1.fbs schema2.fbs data.json\n```\n\n## 写schema IDL文件\n\n参考：http://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html\n","source":"_posts/技术/FlatBuffers/FlatBuffers使用指南.md","raw":"---\ntitle: FlatBuffers 使用指南\ndate: 2016-02-19 20:20:42\ncategories: \n\t- 技术\n\t- FlatBuffers\nthumbnail: http://7xiovs.com1.z0.glb.clouddn.com/IMG_20160218_122224.JPG\ntags: \n\t- FlatBuffers\n\t- 序列化\n---\n\n# FlatBuffers 使用指南\n\nFlatBuffers序列化性能是protobuf的2倍，但size也是protobuf的2倍\n\n## 编译源码\n\n```\n$ git clone https://github.com/google/flatbuffers.git\n#切换到最新release版本\n$ git checkout v1.2.0\n```\n\n### 安装cmake \n\nhttp://www.cmake.org.\n\n```\nfor mac osx\n$ brew install cmake\nfor centOS\n$ sudo yum install cmake\n```\n\n### 用cmake构建project\n\n```\ncmake -G \"Unix Makefiles\"\ncmake -G \"Visual Studio 10\"\ncmake -G \"Xcode\"\n```\n在*nix系统，mac osx系统也建议使用 `cmake -G \"Unix Makefiles\"`，生成`Makefile`,之后`make & make install`\n编译生成`flatc`并安装到系统。\n\n```\n$ cmake -G \"Unix Makefiles\"\n$ make\n$ make insall\n\n```\n\n\n## 使用schema编译器flatc来生成基础代码\n\n```\n$ cd samples\n#在目录src中生成java代码\n$flatc -j -o src monster.fbs \n\n```\n\n### 编程语言参数:\n\n+ --cpp, -c : Generate a C++ header for all definitions in this file (as filename_generated.h).\n+ --java, -j : Generate Java code.\n+ --csharp, -n : Generate C# code.\n+ --go, -g : Generate Go code.\n+ --python, -p: Generate Python code.\n+ --javascript, -s: Generate JavaScript code.\n+ --php: Generate PHP code.\n\n### 其他常用选项：\n\n+ -o PATH 指定源码输出目录\n+ -I PATH 有include语句时，指定include目录\n\n\n# 完整的参数\n\n```\nusage: flatc [OPTION]... FILE... [-- FILE...]\n  -b              Generate wire format binaries for any data definitions.\n  -t              Generate text output for any data definitions.\n  -c              Generate C++ headers for tables/structs.\n  -g              Generate Go files for tables/structs.\n  -j              Generate Java classes for tables/structs.\n  -s              Generate JavaScript code for tables/structs.\n  -n              Generate C# classes for tables/structs.\n  -p              Generate Python files for tables/structs.\n  -o PATH         Prefix PATH to all generated files.\n  -I PATH         Search for includes in the specified path.\n  -M              Print make rules for generated files.\n  --strict-json   Strict JSON: field names must be / will be quoted,\n                  no trailing commas in tables/vectors.\n  --defaults-json Output fields whose value is the default when\n                  writing JSON\n  --no-prefix     Don't prefix enum values with the enum type in C++.\n  --scoped-enums  Use C++11 style scoped and strongly typed enums.\n                  also implies --no-prefix.\n  --gen-includes  (deprecated), this is the default behavior.\n                  If the original behavior is required (no include\n                  statements) use --no-includes.\n  --no-includes   Don't generate include statements for included\n                  schemas the generated file depends on (C++).\n  --gen-mutable   Generate accessors that can mutate buffers in-place.\n  --gen-onefile   Generate single output file for C#\n  --raw-binary    Allow binaries without file_indentifier to be read.\n                  This may crash flatc given a mismatched schema.\n  --proto         Input is a .proto, translate to .fbs.\n  --schema        Serialize schemas instead of JSON (use with -b)\nFILEs may depend on declarations in earlier files.\nFILEs after the -- must be binary flatbuffer format files.\nOutput files are named using the base file name of the input,\nand written to the current directory or the path given by -o.\nexample: flatc -c -b schema1.fbs schema2.fbs data.json\n```\n\n## 写schema IDL文件\n\n参考：http://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html\n","slug":"技术/FlatBuffers/FlatBuffers使用指南","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc4r0059z29k0zdzzzqy","content":"<h1 id=\"FlatBuffers-使用指南\"><a href=\"#FlatBuffers-使用指南\" class=\"headerlink\" title=\"FlatBuffers 使用指南\"></a>FlatBuffers 使用指南</h1><p>FlatBuffers序列化性能是protobuf的2倍，但size也是protobuf的2倍</p>\n<h2 id=\"编译源码\"><a href=\"#编译源码\" class=\"headerlink\" title=\"编译源码\"></a>编译源码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git clone https://github.com/google/flatbuffers.git</div><div class=\"line\">#切换到最新release版本</div><div class=\"line\">$ git checkout v1.2.0</div></pre></td></tr></table></figure>\n<h3 id=\"安装cmake\"><a href=\"#安装cmake\" class=\"headerlink\" title=\"安装cmake\"></a>安装cmake</h3><p><a href=\"http://www.cmake.org\" target=\"_blank\" rel=\"external\">http://www.cmake.org</a>.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">for mac osx</div><div class=\"line\">$ brew install cmake</div><div class=\"line\">for centOS</div><div class=\"line\">$ sudo yum install cmake</div></pre></td></tr></table></figure>\n<h3 id=\"用cmake构建project\"><a href=\"#用cmake构建project\" class=\"headerlink\" title=\"用cmake构建project\"></a>用cmake构建project</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cmake -G &quot;Unix Makefiles&quot;</div><div class=\"line\">cmake -G &quot;Visual Studio 10&quot;</div><div class=\"line\">cmake -G &quot;Xcode&quot;</div></pre></td></tr></table></figure>\n<p>在*nix系统，mac osx系统也建议使用 <code>cmake -G &quot;Unix Makefiles&quot;</code>，生成<code>Makefile</code>,之后<code>make &amp; make install</code><br>编译生成<code>flatc</code>并安装到系统。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ cmake -G &quot;Unix Makefiles&quot;</div><div class=\"line\">$ make</div><div class=\"line\">$ make insall</div></pre></td></tr></table></figure>\n<h2 id=\"使用schema编译器flatc来生成基础代码\"><a href=\"#使用schema编译器flatc来生成基础代码\" class=\"headerlink\" title=\"使用schema编译器flatc来生成基础代码\"></a>使用schema编译器flatc来生成基础代码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ cd samples</div><div class=\"line\">#在目录src中生成java代码</div><div class=\"line\">$flatc -j -o src monster.fbs</div></pre></td></tr></table></figure>\n<h3 id=\"编程语言参数\"><a href=\"#编程语言参数\" class=\"headerlink\" title=\"编程语言参数:\"></a>编程语言参数:</h3><ul>\n<li>–cpp, -c : Generate a C++ header for all definitions in this file (as filename_generated.h).</li>\n<li>–java, -j : Generate Java code.</li>\n<li>–csharp, -n : Generate C# code.</li>\n<li>–go, -g : Generate Go code.</li>\n<li>–python, -p: Generate Python code.</li>\n<li>–javascript, -s: Generate JavaScript code.</li>\n<li>–php: Generate PHP code.</li>\n</ul>\n<h3 id=\"其他常用选项：\"><a href=\"#其他常用选项：\" class=\"headerlink\" title=\"其他常用选项：\"></a>其他常用选项：</h3><ul>\n<li>-o PATH 指定源码输出目录</li>\n<li>-I PATH 有include语句时，指定include目录</li>\n</ul>\n<h1 id=\"完整的参数\"><a href=\"#完整的参数\" class=\"headerlink\" title=\"完整的参数\"></a>完整的参数</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\">usage: flatc [OPTION]... FILE... [-- FILE...]</div><div class=\"line\">  -b              Generate wire format binaries for any data definitions.</div><div class=\"line\">  -t              Generate text output for any data definitions.</div><div class=\"line\">  -c              Generate C++ headers for tables/structs.</div><div class=\"line\">  -g              Generate Go files for tables/structs.</div><div class=\"line\">  -j              Generate Java classes for tables/structs.</div><div class=\"line\">  -s              Generate JavaScript code for tables/structs.</div><div class=\"line\">  -n              Generate C# classes for tables/structs.</div><div class=\"line\">  -p              Generate Python files for tables/structs.</div><div class=\"line\">  -o PATH         Prefix PATH to all generated files.</div><div class=\"line\">  -I PATH         Search for includes in the specified path.</div><div class=\"line\">  -M              Print make rules for generated files.</div><div class=\"line\">  --strict-json   Strict JSON: field names must be / will be quoted,</div><div class=\"line\">                  no trailing commas in tables/vectors.</div><div class=\"line\">  --defaults-json Output fields whose value is the default when</div><div class=\"line\">                  writing JSON</div><div class=\"line\">  --no-prefix     Don&apos;t prefix enum values with the enum type in C++.</div><div class=\"line\">  --scoped-enums  Use C++11 style scoped and strongly typed enums.</div><div class=\"line\">                  also implies --no-prefix.</div><div class=\"line\">  --gen-includes  (deprecated), this is the default behavior.</div><div class=\"line\">                  If the original behavior is required (no include</div><div class=\"line\">                  statements) use --no-includes.</div><div class=\"line\">  --no-includes   Don&apos;t generate include statements for included</div><div class=\"line\">                  schemas the generated file depends on (C++).</div><div class=\"line\">  --gen-mutable   Generate accessors that can mutate buffers in-place.</div><div class=\"line\">  --gen-onefile   Generate single output file for C#</div><div class=\"line\">  --raw-binary    Allow binaries without file_indentifier to be read.</div><div class=\"line\">                  This may crash flatc given a mismatched schema.</div><div class=\"line\">  --proto         Input is a .proto, translate to .fbs.</div><div class=\"line\">  --schema        Serialize schemas instead of JSON (use with -b)</div><div class=\"line\">FILEs may depend on declarations in earlier files.</div><div class=\"line\">FILEs after the -- must be binary flatbuffer format files.</div><div class=\"line\">Output files are named using the base file name of the input,</div><div class=\"line\">and written to the current directory or the path given by -o.</div><div class=\"line\">example: flatc -c -b schema1.fbs schema2.fbs data.json</div></pre></td></tr></table></figure>\n<h2 id=\"写schema-IDL文件\"><a href=\"#写schema-IDL文件\" class=\"headerlink\" title=\"写schema IDL文件\"></a>写schema IDL文件</h2><p>参考：<a href=\"http://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html\" target=\"_blank\" rel=\"external\">http://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"FlatBuffers-使用指南\"><a href=\"#FlatBuffers-使用指南\" class=\"headerlink\" title=\"FlatBuffers 使用指南\"></a>FlatBuffers 使用指南</h1><p>FlatBuffers序列化性能是protobuf的2倍，但size也是protobuf的2倍</p>\n<h2 id=\"编译源码\"><a href=\"#编译源码\" class=\"headerlink\" title=\"编译源码\"></a>编译源码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git clone https://github.com/google/flatbuffers.git</div><div class=\"line\">#切换到最新release版本</div><div class=\"line\">$ git checkout v1.2.0</div></pre></td></tr></table></figure>\n<h3 id=\"安装cmake\"><a href=\"#安装cmake\" class=\"headerlink\" title=\"安装cmake\"></a>安装cmake</h3><p><a href=\"http://www.cmake.org\" target=\"_blank\" rel=\"external\">http://www.cmake.org</a>.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">for mac osx</div><div class=\"line\">$ brew install cmake</div><div class=\"line\">for centOS</div><div class=\"line\">$ sudo yum install cmake</div></pre></td></tr></table></figure>\n<h3 id=\"用cmake构建project\"><a href=\"#用cmake构建project\" class=\"headerlink\" title=\"用cmake构建project\"></a>用cmake构建project</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cmake -G &quot;Unix Makefiles&quot;</div><div class=\"line\">cmake -G &quot;Visual Studio 10&quot;</div><div class=\"line\">cmake -G &quot;Xcode&quot;</div></pre></td></tr></table></figure>\n<p>在*nix系统，mac osx系统也建议使用 <code>cmake -G &quot;Unix Makefiles&quot;</code>，生成<code>Makefile</code>,之后<code>make &amp; make install</code><br>编译生成<code>flatc</code>并安装到系统。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ cmake -G &quot;Unix Makefiles&quot;</div><div class=\"line\">$ make</div><div class=\"line\">$ make insall</div></pre></td></tr></table></figure>\n<h2 id=\"使用schema编译器flatc来生成基础代码\"><a href=\"#使用schema编译器flatc来生成基础代码\" class=\"headerlink\" title=\"使用schema编译器flatc来生成基础代码\"></a>使用schema编译器flatc来生成基础代码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ cd samples</div><div class=\"line\">#在目录src中生成java代码</div><div class=\"line\">$flatc -j -o src monster.fbs</div></pre></td></tr></table></figure>\n<h3 id=\"编程语言参数\"><a href=\"#编程语言参数\" class=\"headerlink\" title=\"编程语言参数:\"></a>编程语言参数:</h3><ul>\n<li>–cpp, -c : Generate a C++ header for all definitions in this file (as filename_generated.h).</li>\n<li>–java, -j : Generate Java code.</li>\n<li>–csharp, -n : Generate C# code.</li>\n<li>–go, -g : Generate Go code.</li>\n<li>–python, -p: Generate Python code.</li>\n<li>–javascript, -s: Generate JavaScript code.</li>\n<li>–php: Generate PHP code.</li>\n</ul>\n<h3 id=\"其他常用选项：\"><a href=\"#其他常用选项：\" class=\"headerlink\" title=\"其他常用选项：\"></a>其他常用选项：</h3><ul>\n<li>-o PATH 指定源码输出目录</li>\n<li>-I PATH 有include语句时，指定include目录</li>\n</ul>\n<h1 id=\"完整的参数\"><a href=\"#完整的参数\" class=\"headerlink\" title=\"完整的参数\"></a>完整的参数</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\">usage: flatc [OPTION]... FILE... [-- FILE...]</div><div class=\"line\">  -b              Generate wire format binaries for any data definitions.</div><div class=\"line\">  -t              Generate text output for any data definitions.</div><div class=\"line\">  -c              Generate C++ headers for tables/structs.</div><div class=\"line\">  -g              Generate Go files for tables/structs.</div><div class=\"line\">  -j              Generate Java classes for tables/structs.</div><div class=\"line\">  -s              Generate JavaScript code for tables/structs.</div><div class=\"line\">  -n              Generate C# classes for tables/structs.</div><div class=\"line\">  -p              Generate Python files for tables/structs.</div><div class=\"line\">  -o PATH         Prefix PATH to all generated files.</div><div class=\"line\">  -I PATH         Search for includes in the specified path.</div><div class=\"line\">  -M              Print make rules for generated files.</div><div class=\"line\">  --strict-json   Strict JSON: field names must be / will be quoted,</div><div class=\"line\">                  no trailing commas in tables/vectors.</div><div class=\"line\">  --defaults-json Output fields whose value is the default when</div><div class=\"line\">                  writing JSON</div><div class=\"line\">  --no-prefix     Don&apos;t prefix enum values with the enum type in C++.</div><div class=\"line\">  --scoped-enums  Use C++11 style scoped and strongly typed enums.</div><div class=\"line\">                  also implies --no-prefix.</div><div class=\"line\">  --gen-includes  (deprecated), this is the default behavior.</div><div class=\"line\">                  If the original behavior is required (no include</div><div class=\"line\">                  statements) use --no-includes.</div><div class=\"line\">  --no-includes   Don&apos;t generate include statements for included</div><div class=\"line\">                  schemas the generated file depends on (C++).</div><div class=\"line\">  --gen-mutable   Generate accessors that can mutate buffers in-place.</div><div class=\"line\">  --gen-onefile   Generate single output file for C#</div><div class=\"line\">  --raw-binary    Allow binaries without file_indentifier to be read.</div><div class=\"line\">                  This may crash flatc given a mismatched schema.</div><div class=\"line\">  --proto         Input is a .proto, translate to .fbs.</div><div class=\"line\">  --schema        Serialize schemas instead of JSON (use with -b)</div><div class=\"line\">FILEs may depend on declarations in earlier files.</div><div class=\"line\">FILEs after the -- must be binary flatbuffer format files.</div><div class=\"line\">Output files are named using the base file name of the input,</div><div class=\"line\">and written to the current directory or the path given by -o.</div><div class=\"line\">example: flatc -c -b schema1.fbs schema2.fbs data.json</div></pre></td></tr></table></figure>\n<h2 id=\"写schema-IDL文件\"><a href=\"#写schema-IDL文件\" class=\"headerlink\" title=\"写schema IDL文件\"></a>写schema IDL文件</h2><p>参考：<a href=\"http://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html\" target=\"_blank\" rel=\"external\">http://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html</a></p>\n"},{"title":"wrk基准测试工具安装使用","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60608-195617.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30","date":"2016-03-04T01:06:33.000Z","keywords":"基准测试,wrk","description":null,"_content":"\n\n\n\n## git\n\nhttps://github.com/wg/wrk\n\ngit clone https://github.com/wg/wrk.git\n\n## 安装\n\n在makefile中33行\nLDIR     = deps/luajit/src\nLIBS    := -lluajit $(LIBS)\nCFLAGS  += -I$(LDIR)\nLDFLAGS += -L$(LDIR)\n\n下面添加：\n\nLDFLAGS  +=  -L/usr/local/opt/openssl/lib\nCFLAGS += -I/usr/local/opt/openssl/include\n\n\nmake\n\n## 基本使用\n\nBasic Usage\n\n  wrk -t12 -c400 -d30s http://127.0.0.1:8080/index.html\n\n  This runs a benchmark for 30 seconds, using 12 threads, and keeping\n  400 HTTP connections open.\n\n  Output:\n\n```\n  Running 30s test @ http://127.0.0.1:8080/index.html\n    12 threads and 400 connections\n    Thread Stats   Avg      Stdev     Max   +/- Stdev\n      Latency   635.91us    0.89ms  12.92ms   93.69%\n      Req/Sec    56.20k     8.07k   62.00k    86.54%\n    22464657 requests in 30.00s, 17.76GB read\n  Requests/sec: 748868.53\n  Transfer/sec:    606.33MB\n```\n\n## 参数说明\n\n```\n$ wrk\nUsage: wrk <options> <url>                            \n  Options:                                            \n    -c, --connections <N>  Connections to keep open   \n    -d, --duration    <T>  Duration of test           \n    -t, --threads     <N>  Number of threads to use   \n                                                      \n    -s, --script      <S>  Load Lua script file       \n    -H, --header      <H>  Add header to request      \n        --latency          Print latency statistics   \n        --timeout     <T>  Socket/request timeout     \n    -v, --version          Print version details      \n                                                      \n  Numeric arguments may include a SI unit (1k, 1M, 1G)\n  Time arguments may include a time unit (2s, 2m, 2h)\n  \n```\n\n\n","source":"_posts/技术/工具/wrk基准测试工具安装使用.md","raw":"---\ntitle: wrk基准测试工具安装使用\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/my-pic-P60608-195617.jpg?imageView2/1/w/800/h/600/q/75|watermark/2/text/Qnkg6ZOB5rGk/font/5a6L5L2T/fontsize/500/fill/I0VGRUZFRg==/dissolve/100/gravity/SouthEast/dx/30/dy/30'\ndate: 2016-03-04 09:06:33\ncategories:\n\t- 技术\n\t- 工具\ntags:\n\t- 基准测试\n\t- wrk\nkeywords: 基准测试,wrk\ndescription:\n---\n\n\n\n\n## git\n\nhttps://github.com/wg/wrk\n\ngit clone https://github.com/wg/wrk.git\n\n## 安装\n\n在makefile中33行\nLDIR     = deps/luajit/src\nLIBS    := -lluajit $(LIBS)\nCFLAGS  += -I$(LDIR)\nLDFLAGS += -L$(LDIR)\n\n下面添加：\n\nLDFLAGS  +=  -L/usr/local/opt/openssl/lib\nCFLAGS += -I/usr/local/opt/openssl/include\n\n\nmake\n\n## 基本使用\n\nBasic Usage\n\n  wrk -t12 -c400 -d30s http://127.0.0.1:8080/index.html\n\n  This runs a benchmark for 30 seconds, using 12 threads, and keeping\n  400 HTTP connections open.\n\n  Output:\n\n```\n  Running 30s test @ http://127.0.0.1:8080/index.html\n    12 threads and 400 connections\n    Thread Stats   Avg      Stdev     Max   +/- Stdev\n      Latency   635.91us    0.89ms  12.92ms   93.69%\n      Req/Sec    56.20k     8.07k   62.00k    86.54%\n    22464657 requests in 30.00s, 17.76GB read\n  Requests/sec: 748868.53\n  Transfer/sec:    606.33MB\n```\n\n## 参数说明\n\n```\n$ wrk\nUsage: wrk <options> <url>                            \n  Options:                                            \n    -c, --connections <N>  Connections to keep open   \n    -d, --duration    <T>  Duration of test           \n    -t, --threads     <N>  Number of threads to use   \n                                                      \n    -s, --script      <S>  Load Lua script file       \n    -H, --header      <H>  Add header to request      \n        --latency          Print latency statistics   \n        --timeout     <T>  Socket/request timeout     \n    -v, --version          Print version details      \n                                                      \n  Numeric arguments may include a SI unit (1k, 1M, 1G)\n  Time arguments may include a time unit (2s, 2m, 2h)\n  \n```\n\n\n","slug":"技术/工具/wrk基准测试工具安装使用","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc4t005ez29kywg1jefh","content":"<h2 id=\"git\"><a href=\"#git\" class=\"headerlink\" title=\"git\"></a>git</h2><p><a href=\"https://github.com/wg/wrk\" target=\"_blank\" rel=\"external\">https://github.com/wg/wrk</a></p>\n<p>git clone <a href=\"https://github.com/wg/wrk.git\" target=\"_blank\" rel=\"external\">https://github.com/wg/wrk.git</a></p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>在makefile中33行<br>LDIR     = deps/luajit/src<br>LIBS    := -lluajit $(LIBS)<br>CFLAGS  += -I$(LDIR)<br>LDFLAGS += -L$(LDIR)</p>\n<p>下面添加：</p>\n<p>LDFLAGS  +=  -L/usr/local/opt/openssl/lib<br>CFLAGS += -I/usr/local/opt/openssl/include</p>\n<p>make</p>\n<h2 id=\"基本使用\"><a href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"></a>基本使用</h2><p>Basic Usage</p>\n<p>  wrk -t12 -c400 -d30s <a href=\"http://127.0.0.1:8080/index.html\" target=\"_blank\" rel=\"external\">http://127.0.0.1:8080/index.html</a></p>\n<p>  This runs a benchmark for 30 seconds, using 12 threads, and keeping<br>  400 HTTP connections open.</p>\n<p>  Output:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">Running 30s test @ http://127.0.0.1:8080/index.html</div><div class=\"line\">  12 threads and 400 connections</div><div class=\"line\">  Thread Stats   Avg      Stdev     Max   +/- Stdev</div><div class=\"line\">    Latency   635.91us    0.89ms  12.92ms   93.69%</div><div class=\"line\">    Req/Sec    56.20k     8.07k   62.00k    86.54%</div><div class=\"line\">  22464657 requests in 30.00s, 17.76GB read</div><div class=\"line\">Requests/sec: 748868.53</div><div class=\"line\">Transfer/sec:    606.33MB</div></pre></td></tr></table></figure>\n<h2 id=\"参数说明\"><a href=\"#参数说明\" class=\"headerlink\" title=\"参数说明\"></a>参数说明</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ wrk</div><div class=\"line\">Usage: wrk &lt;options&gt; &lt;url&gt;                            </div><div class=\"line\">  Options:                                            </div><div class=\"line\">    -c, --connections &lt;N&gt;  Connections to keep open   </div><div class=\"line\">    -d, --duration    &lt;T&gt;  Duration of test           </div><div class=\"line\">    -t, --threads     &lt;N&gt;  Number of threads to use   </div><div class=\"line\">                                                      </div><div class=\"line\">    -s, --script      &lt;S&gt;  Load Lua script file       </div><div class=\"line\">    -H, --header      &lt;H&gt;  Add header to request      </div><div class=\"line\">        --latency          Print latency statistics   </div><div class=\"line\">        --timeout     &lt;T&gt;  Socket/request timeout     </div><div class=\"line\">    -v, --version          Print version details      </div><div class=\"line\">                                                      </div><div class=\"line\">  Numeric arguments may include a SI unit (1k, 1M, 1G)</div><div class=\"line\">  Time arguments may include a time unit (2s, 2m, 2h)</div></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"git\"><a href=\"#git\" class=\"headerlink\" title=\"git\"></a>git</h2><p><a href=\"https://github.com/wg/wrk\" target=\"_blank\" rel=\"external\">https://github.com/wg/wrk</a></p>\n<p>git clone <a href=\"https://github.com/wg/wrk.git\" target=\"_blank\" rel=\"external\">https://github.com/wg/wrk.git</a></p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>在makefile中33行<br>LDIR     = deps/luajit/src<br>LIBS    := -lluajit $(LIBS)<br>CFLAGS  += -I$(LDIR)<br>LDFLAGS += -L$(LDIR)</p>\n<p>下面添加：</p>\n<p>LDFLAGS  +=  -L/usr/local/opt/openssl/lib<br>CFLAGS += -I/usr/local/opt/openssl/include</p>\n<p>make</p>\n<h2 id=\"基本使用\"><a href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"></a>基本使用</h2><p>Basic Usage</p>\n<p>  wrk -t12 -c400 -d30s <a href=\"http://127.0.0.1:8080/index.html\" target=\"_blank\" rel=\"external\">http://127.0.0.1:8080/index.html</a></p>\n<p>  This runs a benchmark for 30 seconds, using 12 threads, and keeping<br>  400 HTTP connections open.</p>\n<p>  Output:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">Running 30s test @ http://127.0.0.1:8080/index.html</div><div class=\"line\">  12 threads and 400 connections</div><div class=\"line\">  Thread Stats   Avg      Stdev     Max   +/- Stdev</div><div class=\"line\">    Latency   635.91us    0.89ms  12.92ms   93.69%</div><div class=\"line\">    Req/Sec    56.20k     8.07k   62.00k    86.54%</div><div class=\"line\">  22464657 requests in 30.00s, 17.76GB read</div><div class=\"line\">Requests/sec: 748868.53</div><div class=\"line\">Transfer/sec:    606.33MB</div></pre></td></tr></table></figure>\n<h2 id=\"参数说明\"><a href=\"#参数说明\" class=\"headerlink\" title=\"参数说明\"></a>参数说明</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ wrk</div><div class=\"line\">Usage: wrk &lt;options&gt; &lt;url&gt;                            </div><div class=\"line\">  Options:                                            </div><div class=\"line\">    -c, --connections &lt;N&gt;  Connections to keep open   </div><div class=\"line\">    -d, --duration    &lt;T&gt;  Duration of test           </div><div class=\"line\">    -t, --threads     &lt;N&gt;  Number of threads to use   </div><div class=\"line\">                                                      </div><div class=\"line\">    -s, --script      &lt;S&gt;  Load Lua script file       </div><div class=\"line\">    -H, --header      &lt;H&gt;  Add header to request      </div><div class=\"line\">        --latency          Print latency statistics   </div><div class=\"line\">        --timeout     &lt;T&gt;  Socket/request timeout     </div><div class=\"line\">    -v, --version          Print version details      </div><div class=\"line\">                                                      </div><div class=\"line\">  Numeric arguments may include a SI unit (1k, 1M, 1G)</div><div class=\"line\">  Time arguments may include a time unit (2s, 2m, 2h)</div></pre></td></tr></table></figure>\n"},{"title":"装载：HTTP2.0的奇妙日常","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/DPP_0004.JPG","date":"2016-02-22T01:57:03.000Z","keywords":"HTTP2,HTTP2性能","description":"HTTP2.0性能增强的核心：二进制分帧；HTTP2.0 首部压缩；所有的HTTP2.0的请求都在一个TCP链接上；并行双向字节流的请求和响应；HTTP2.0的请求优先级；HTTP2.0的服务器推送；“十年前端，终归如初”","_content":"\n \n转载自AlloyTeam：http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/\n\n\n“多年没见，你的女神后来什么样了”晨伯总是这么八卦我的女神，而不是我。\n    “我给你一个表情，你自己体会一下”![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/youshang_small.jpg>)\n    “你先写个小页面给我看看吧，我指导一下你吧。”晨伯一幅很吊的样子。\n但是这样的小case当然难不了我，虽然多年没碰web，但是我当年可以是AlloyTeam的成员啊。很快我就啪啪啪地完成了页面。晨伯看完我写的页面，一幅“我可是有女朋友的男人”的表情，感叹了一句“现在是HTTP2.0的时代啦，给你普及一下知识点”。\n \n \n## HTTP2.0性能增强的核心：二进制分帧\n\nHTTP 2.0最大的特点： 不会改动HTTP 的语义，HTTP 方法、状态码、URI 及首部字段，等等这些核心概念上一如往常，却能致力于突破上一代标准的性能限制，改进传输性能，实现低延迟和高吞吐量。而之所以叫2.0，是在于新增的二进制分帧层。\n    既然又要保证HTTP的各种动词，方法，首部都不受影响，那就需要在应用层(HTTP2.0)和传输层(TCP or UDP)之间增加一个二进制分帧层。\n    在二进制分帧层上， HTTP 2.0 会将所有传输的信息分割为更小的消息和帧,并对它们采用二进制格式的编码 ，其中HTTP1.x的首部信息会被封装到Headers帧，而我们的request body则封装到Data帧里面。\n    \nhttp2.0\n\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/http2.0.jpg>)\n\n\n然后，HTTP 2.0 通信都在一个连接上完成，这个连接可以承载任意数量的双向数据流。相应地，每个数据流以消息的形式发送，而消息由一或多个帧组成，这些帧可以乱序发送，然后再根据每个帧首部的流标识符重新组装。\n \n  当他侃侃而谈的时候，大概是这个样子的，你们也来感受一下。\n   \n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/stupid.jpg>)\n    \n  “听起来好屌的样子，但是那样，所有的二进制帧都会带上Headers帧，这是多大的数据冗余传送啊，性能会多….”我疑问道。\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)“还没讲完呢，插什么嘴！”（哎呀我差！我这么帅，可别打脸啊。）\n    \n## HTTP2.0 首部压缩\n\n HTTP 2.0 在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键-值对，对于相同的数据，不再通过每次请求和响应发送;通信期间几乎不会改变的通用键-值对(用户代理、可接受的媒体类型,等等)只 需发送一次。事实上,如果请求中不包含首部(例如对同一资源的轮询请求),那么 首部开销就是零字节。此时所有首部都自动使用之前请求发送的首部。\n    如果首部发生变化了，那么只需要发送变化了数据在Headers帧里面，新增或修改的首部帧会被追加到“首部表”。首部表在 HTTP 2.0 的连接存续期内始终存在,由客户端和服务器共同渐进地更新 。\n \n  “好了，现在你倒是给我解释一下，这里使用自动化合并文件和Sprite合图是什么回事？”晨伯不解\n  “本质上，当然是为了减少请求啦，通过多个js或css合并成一个文件，多张小图片拼合成Sprite图，可以让多个HTTP请求减少为一个，减少额外的协议开销，而提升性能。”如是道也\n  “当然，一个HTTP的请求的body太大也是不合理的，有个度。文件的合并也会牺牲模块化和缓存粒度，可以把“稳定”的代码or 小图 合并为一个文件or一张Sprite，让其充分地缓存起来，从而区分开迭代快的文件” 我不明白晨伯的问题，就稍微补充了一下方案。\n\n   晨伯起来又![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)，略疼，略疼。话说多年的程序员交流都用这种肢体动作了吗？ \n \n\n## 所有的HTTP2.0的请求都在一个TCP链接上\n\n   HTTP2.0所有通信都是在一个TCP连接上完成。HTTP 2.0 把 HTTP 协议通信的基本单位缩小为一个一个的帧，这些帧对应 着逻辑流中的消息。并行地在同一个 TCP 连接上双向交换消息。就好比，我请求一个页面http://www.qq.com。页面上所有的资源请求都是客户端与服务器上的一条TCP上请求和响应的！\n    有关注TCP性能的同学就会知道，HTTP性能的关键在于低延迟而不是高带宽！大多数HTTP 连接的时间都很短，而且是突发性的，但TCP 只在长时间连接传输大块数据时效率才最高。HTTP 2.0 通过让所有数据流共用同一个连接，可以更有效地使用TCP 连接，让高带宽也能真正的服务于HTTP的性能提升。\n\n   同时，单链接多资源的方式，使到至上而下的层面都得到了好处：\n   \n   1. 可以减少服务链接压力,内存占用少了,连接吞吐量大了\n   2. 由于 TCP 连接减少而使网络拥塞状况得以改观;\n   3. 慢启动时间减少,拥塞和丢包恢复速度更快。\n \n**也就是说，“资源合并减少请求”的优化手段对于HTTP2.0来说是没有效果的，只会增大无用的工作量而已。**\n \n他说得好有道理，我竟然掩脸而对（因为脸被打疼了）。\n“你在再我说说，这些cdn1.cn,cdn2.cn,cdn3.cn是什么回事啊”晨伯又问到。\n“因为HTTP1.x上如果一个只用一个持久链接，请求只能一个一个顺序请求，为了高效地并行下载资源，浏览器允许我们打开多个TCP会话，但是一个域名下限制6个链接。为了突破这些限制，我们可以域名分区，提高并行下载资源能力…..”我只好把我当年知道的说出来\n当时我就有预感要![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)，而晨伯总是按套路出牌….\n \n## 并行双向字节流的请求和响应\n\n   在HTTP2.0上，客户端和服务器可以把HTTP 消息分解为互不依赖的帧，然后乱序发送，最后再在另一端把它们重新组合起来。注意，同一链接上有多个不同方向的数据流在传输。客户端可以一边乱序发送stream，也可以一边接收者服务器的响应，而服务器那端同理。\n\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/stream.jpg>)\n\n \n把 HTTP 消息分解为独立的帧,交错发送,然后在另一端重新组装是 HTTP 2.0 最 重要的一项增强。事实上,这个机制会在整个 Web 技术栈中引发一系列连锁反应, 从而带来巨大的性能提升,因为:\n \n可以并行交错地发送请求,请求之间互不影响;\n可以并行交错地发送响应,响应之间互不干扰;\n只使用一个连接即可并行发送多个请求和响应;\n消除不必要的延迟,从而减少页面加载的时间;\n \n那么也就是说“域名分区”这种优化手段对于HTTP2.0是无用的，因为资源都是并行交错发送，且没有限制，不需要额外的多域名并行下载。\n \n \n“既然所有资源都是并行交错发送，会不会出现这样的情况【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送图片】” 我疑问道。\n晨伯又![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)。我开始确信，这是多年后程序员的肢体礼仪方式。\n \n## HTTP2.0的请求优先级\n\n   每个HTTP2.0流里面有个优先值，这个优先值确定着客户端和服务器处理不同的流采取不同的优先级策略，高优先级的流都应该优先发送，但又不会绝对的。绝对地准守，可能又会引入首队阻塞的问题：高优先级的请求慢导致阻塞其他资源交付。分配处理资源和客户端与服务器间的带宽，不同优先级的混合也是必须的。\n \n“有了优先级，HTTP2.0根本不会发生【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送黄图】”晨伯道。\n“我根本没有说是服务器在发黄图，好不好。”我吐槽了一下。\n  “还有还有，你这里的一段base64内嵌图片又是什么回事？是黄图吗？” 晨伯又挑战我了。\n内嵌图片这种，有使用条件的优化手段，我还是不要说话好，不然的话按照这个故事的尿性，他应该又要飞拳我。\n \n \nHTTP2.0的服务器推送\n    HTTP 2.0 新增的一个强大的新功能，就是服务器可以对一个客户端请求发送多个响应。换句话说，服务器可以强奸你的浏览器，哦不，应该是，除了对最初请求的响应外，服务器还可以额外向客户端推送资源，而无需客户端明确地请求。\n当浏览器请求一个html，服务器其实大概知道你是接下来要请求资源了，而不需要等待浏览器得到html后解析页面再发送资源请求。我们常用的内嵌图片也可以理解为一种强制的服务器推送：我请求html，却内嵌了张黄图。\n   \n   有了HTTP2.0的服务器推送，HTTP1.x时代的内嵌资源的优化手段也变得没有意义了。而且使用服务器推送的资源的方式更加高效，因为客户端还可以缓存起来，甚至可以由不同的页面共享（依旧遵循同源策略）。当然，你是个正直的浏览器，是可以决绝服务器推送的黄图的。\n \n \n   不知道为什么，说到黄图这个家伙就兴奋起来了，再也没有打我了。然后交谈就变成了16+周岁的少女不宜收听的内容了。不过HTTP2.0的知识收获了不少。\n \n到了我要面试的日子了，互联网公司A果真要（笔试|鄙视）一下我。我写出了下面的页面\n\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/future.png>)\n\n在场面试官，纷纷鼓掌站了起来，“如此高效的页面，难得啊~你被录取了！”。\n这看着这份如同我前端实习时候写的页面，我心中默默感叹“十年前端，终归如初”。\n出于礼貌，我想起了晨伯教我的新式前端工程师肢体礼仪，然后…..\n \n \n \n \n \n \n参考：\nhttp://chimera.labs.oreilly.com/books/1230000000545/ch12.html#_sending_application_data\nhttps://thecustomizewindows.com/2014/08/http-2-0-changes-expected-new-standard-2/","source":"_posts/转载/http2.0/装载：HTTP2-0的奇妙日常.md","raw":"---\ntitle: 装载：HTTP2.0的奇妙日常\nthumbnail: 'http://7xiovs.com1.z0.glb.clouddn.com/DPP_0004.JPG'\ndate: 2016-02-22 09:57:03\ncategories:\n\t- 转载\n\t- http 2.0\ntags:\n\t- http 2.0\nkeywords: HTTP2,HTTP2性能\ndescription: HTTP2.0性能增强的核心：二进制分帧；HTTP2.0 首部压缩；所有的HTTP2.0的请求都在一个TCP链接上；并行双向字节流的请求和响应；HTTP2.0的请求优先级；HTTP2.0的服务器推送；“十年前端，终归如初”\n---\n\n \n转载自AlloyTeam：http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/\n\n\n“多年没见，你的女神后来什么样了”晨伯总是这么八卦我的女神，而不是我。\n    “我给你一个表情，你自己体会一下”![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/youshang_small.jpg>)\n    “你先写个小页面给我看看吧，我指导一下你吧。”晨伯一幅很吊的样子。\n但是这样的小case当然难不了我，虽然多年没碰web，但是我当年可以是AlloyTeam的成员啊。很快我就啪啪啪地完成了页面。晨伯看完我写的页面，一幅“我可是有女朋友的男人”的表情，感叹了一句“现在是HTTP2.0的时代啦，给你普及一下知识点”。\n \n \n## HTTP2.0性能增强的核心：二进制分帧\n\nHTTP 2.0最大的特点： 不会改动HTTP 的语义，HTTP 方法、状态码、URI 及首部字段，等等这些核心概念上一如往常，却能致力于突破上一代标准的性能限制，改进传输性能，实现低延迟和高吞吐量。而之所以叫2.0，是在于新增的二进制分帧层。\n    既然又要保证HTTP的各种动词，方法，首部都不受影响，那就需要在应用层(HTTP2.0)和传输层(TCP or UDP)之间增加一个二进制分帧层。\n    在二进制分帧层上， HTTP 2.0 会将所有传输的信息分割为更小的消息和帧,并对它们采用二进制格式的编码 ，其中HTTP1.x的首部信息会被封装到Headers帧，而我们的request body则封装到Data帧里面。\n    \nhttp2.0\n\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/http2.0.jpg>)\n\n\n然后，HTTP 2.0 通信都在一个连接上完成，这个连接可以承载任意数量的双向数据流。相应地，每个数据流以消息的形式发送，而消息由一或多个帧组成，这些帧可以乱序发送，然后再根据每个帧首部的流标识符重新组装。\n \n  当他侃侃而谈的时候，大概是这个样子的，你们也来感受一下。\n   \n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/stupid.jpg>)\n    \n  “听起来好屌的样子，但是那样，所有的二进制帧都会带上Headers帧，这是多大的数据冗余传送啊，性能会多….”我疑问道。\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)“还没讲完呢，插什么嘴！”（哎呀我差！我这么帅，可别打脸啊。）\n    \n## HTTP2.0 首部压缩\n\n HTTP 2.0 在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键-值对，对于相同的数据，不再通过每次请求和响应发送;通信期间几乎不会改变的通用键-值对(用户代理、可接受的媒体类型,等等)只 需发送一次。事实上,如果请求中不包含首部(例如对同一资源的轮询请求),那么 首部开销就是零字节。此时所有首部都自动使用之前请求发送的首部。\n    如果首部发生变化了，那么只需要发送变化了数据在Headers帧里面，新增或修改的首部帧会被追加到“首部表”。首部表在 HTTP 2.0 的连接存续期内始终存在,由客户端和服务器共同渐进地更新 。\n \n  “好了，现在你倒是给我解释一下，这里使用自动化合并文件和Sprite合图是什么回事？”晨伯不解\n  “本质上，当然是为了减少请求啦，通过多个js或css合并成一个文件，多张小图片拼合成Sprite图，可以让多个HTTP请求减少为一个，减少额外的协议开销，而提升性能。”如是道也\n  “当然，一个HTTP的请求的body太大也是不合理的，有个度。文件的合并也会牺牲模块化和缓存粒度，可以把“稳定”的代码or 小图 合并为一个文件or一张Sprite，让其充分地缓存起来，从而区分开迭代快的文件” 我不明白晨伯的问题，就稍微补充了一下方案。\n\n   晨伯起来又![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)，略疼，略疼。话说多年的程序员交流都用这种肢体动作了吗？ \n \n\n## 所有的HTTP2.0的请求都在一个TCP链接上\n\n   HTTP2.0所有通信都是在一个TCP连接上完成。HTTP 2.0 把 HTTP 协议通信的基本单位缩小为一个一个的帧，这些帧对应 着逻辑流中的消息。并行地在同一个 TCP 连接上双向交换消息。就好比，我请求一个页面http://www.qq.com。页面上所有的资源请求都是客户端与服务器上的一条TCP上请求和响应的！\n    有关注TCP性能的同学就会知道，HTTP性能的关键在于低延迟而不是高带宽！大多数HTTP 连接的时间都很短，而且是突发性的，但TCP 只在长时间连接传输大块数据时效率才最高。HTTP 2.0 通过让所有数据流共用同一个连接，可以更有效地使用TCP 连接，让高带宽也能真正的服务于HTTP的性能提升。\n\n   同时，单链接多资源的方式，使到至上而下的层面都得到了好处：\n   \n   1. 可以减少服务链接压力,内存占用少了,连接吞吐量大了\n   2. 由于 TCP 连接减少而使网络拥塞状况得以改观;\n   3. 慢启动时间减少,拥塞和丢包恢复速度更快。\n \n**也就是说，“资源合并减少请求”的优化手段对于HTTP2.0来说是没有效果的，只会增大无用的工作量而已。**\n \n他说得好有道理，我竟然掩脸而对（因为脸被打疼了）。\n“你在再我说说，这些cdn1.cn,cdn2.cn,cdn3.cn是什么回事啊”晨伯又问到。\n“因为HTTP1.x上如果一个只用一个持久链接，请求只能一个一个顺序请求，为了高效地并行下载资源，浏览器允许我们打开多个TCP会话，但是一个域名下限制6个链接。为了突破这些限制，我们可以域名分区，提高并行下载资源能力…..”我只好把我当年知道的说出来\n当时我就有预感要![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)，而晨伯总是按套路出牌….\n \n## 并行双向字节流的请求和响应\n\n   在HTTP2.0上，客户端和服务器可以把HTTP 消息分解为互不依赖的帧，然后乱序发送，最后再在另一端把它们重新组合起来。注意，同一链接上有多个不同方向的数据流在传输。客户端可以一边乱序发送stream，也可以一边接收者服务器的响应，而服务器那端同理。\n\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/stream.jpg>)\n\n \n把 HTTP 消息分解为独立的帧,交错发送,然后在另一端重新组装是 HTTP 2.0 最 重要的一项增强。事实上,这个机制会在整个 Web 技术栈中引发一系列连锁反应, 从而带来巨大的性能提升,因为:\n \n可以并行交错地发送请求,请求之间互不影响;\n可以并行交错地发送响应,响应之间互不干扰;\n只使用一个连接即可并行发送多个请求和响应;\n消除不必要的延迟,从而减少页面加载的时间;\n \n那么也就是说“域名分区”这种优化手段对于HTTP2.0是无用的，因为资源都是并行交错发送，且没有限制，不需要额外的多域名并行下载。\n \n \n“既然所有资源都是并行交错发送，会不会出现这样的情况【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送图片】” 我疑问道。\n晨伯又![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg>)。我开始确信，这是多年后程序员的肢体礼仪方式。\n \n## HTTP2.0的请求优先级\n\n   每个HTTP2.0流里面有个优先值，这个优先值确定着客户端和服务器处理不同的流采取不同的优先级策略，高优先级的流都应该优先发送，但又不会绝对的。绝对地准守，可能又会引入首队阻塞的问题：高优先级的请求慢导致阻塞其他资源交付。分配处理资源和客户端与服务器间的带宽，不同优先级的混合也是必须的。\n \n“有了优先级，HTTP2.0根本不会发生【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送黄图】”晨伯道。\n“我根本没有说是服务器在发黄图，好不好。”我吐槽了一下。\n  “还有还有，你这里的一段base64内嵌图片又是什么回事？是黄图吗？” 晨伯又挑战我了。\n内嵌图片这种，有使用条件的优化手段，我还是不要说话好，不然的话按照这个故事的尿性，他应该又要飞拳我。\n \n \nHTTP2.0的服务器推送\n    HTTP 2.0 新增的一个强大的新功能，就是服务器可以对一个客户端请求发送多个响应。换句话说，服务器可以强奸你的浏览器，哦不，应该是，除了对最初请求的响应外，服务器还可以额外向客户端推送资源，而无需客户端明确地请求。\n当浏览器请求一个html，服务器其实大概知道你是接下来要请求资源了，而不需要等待浏览器得到html后解析页面再发送资源请求。我们常用的内嵌图片也可以理解为一种强制的服务器推送：我请求html，却内嵌了张黄图。\n   \n   有了HTTP2.0的服务器推送，HTTP1.x时代的内嵌资源的优化手段也变得没有意义了。而且使用服务器推送的资源的方式更加高效，因为客户端还可以缓存起来，甚至可以由不同的页面共享（依旧遵循同源策略）。当然，你是个正直的浏览器，是可以决绝服务器推送的黄图的。\n \n \n   不知道为什么，说到黄图这个家伙就兴奋起来了，再也没有打我了。然后交谈就变成了16+周岁的少女不宜收听的内容了。不过HTTP2.0的知识收获了不少。\n \n到了我要面试的日子了，互联网公司A果真要（笔试|鄙视）一下我。我写出了下面的页面\n\n![](<http://cdn.alloyteam.com/wp-content/uploads/2015/03/future.png>)\n\n在场面试官，纷纷鼓掌站了起来，“如此高效的页面，难得啊~你被录取了！”。\n这看着这份如同我前端实习时候写的页面，我心中默默感叹“十年前端，终归如初”。\n出于礼貌，我想起了晨伯教我的新式前端工程师肢体礼仪，然后…..\n \n \n \n \n \n \n参考：\nhttp://chimera.labs.oreilly.com/books/1230000000545/ch12.html#_sending_application_data\nhttps://thecustomizewindows.com/2014/08/http-2-0-changes-expected-new-standard-2/","slug":"转载/http2.0/装载：HTTP2-0的奇妙日常","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc4x005mz29kkuqif693","content":"<p>转载自AlloyTeam：<a href=\"http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/\" target=\"_blank\" rel=\"external\">http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/</a></p>\n<p>“多年没见，你的女神后来什么样了”晨伯总是这么八卦我的女神，而不是我。<br>    “我给你一个表情，你自己体会一下”<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/youshang_small.jpg\" alt=\"\"><br>    “你先写个小页面给我看看吧，我指导一下你吧。”晨伯一幅很吊的样子。<br>但是这样的小case当然难不了我，虽然多年没碰web，但是我当年可以是AlloyTeam的成员啊。很快我就啪啪啪地完成了页面。晨伯看完我写的页面，一幅“我可是有女朋友的男人”的表情，感叹了一句“现在是HTTP2.0的时代啦，给你普及一下知识点”。</p>\n<h2 id=\"HTTP2-0性能增强的核心：二进制分帧\"><a href=\"#HTTP2-0性能增强的核心：二进制分帧\" class=\"headerlink\" title=\"HTTP2.0性能增强的核心：二进制分帧\"></a>HTTP2.0性能增强的核心：二进制分帧</h2><p>HTTP 2.0最大的特点： 不会改动HTTP 的语义，HTTP 方法、状态码、URI 及首部字段，等等这些核心概念上一如往常，却能致力于突破上一代标准的性能限制，改进传输性能，实现低延迟和高吞吐量。而之所以叫2.0，是在于新增的二进制分帧层。<br>    既然又要保证HTTP的各种动词，方法，首部都不受影响，那就需要在应用层(HTTP2.0)和传输层(TCP or UDP)之间增加一个二进制分帧层。<br>    在二进制分帧层上， HTTP 2.0 会将所有传输的信息分割为更小的消息和帧,并对它们采用二进制格式的编码 ，其中HTTP1.x的首部信息会被封装到Headers帧，而我们的request body则封装到Data帧里面。</p>\n<p>http2.0</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/http2.0.jpg\" alt=\"\"></p>\n<p>然后，HTTP 2.0 通信都在一个连接上完成，这个连接可以承载任意数量的双向数据流。相应地，每个数据流以消息的形式发送，而消息由一或多个帧组成，这些帧可以乱序发送，然后再根据每个帧首部的流标识符重新组装。</p>\n<p>  当他侃侃而谈的时候，大概是这个样子的，你们也来感受一下。</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/stupid.jpg\" alt=\"\"></p>\n<p>  “听起来好屌的样子，但是那样，所有的二进制帧都会带上Headers帧，这是多大的数据冗余传送啊，性能会多….”我疑问道。<br><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">“还没讲完呢，插什么嘴！”（哎呀我差！我这么帅，可别打脸啊。）</p>\n<h2 id=\"HTTP2-0-首部压缩\"><a href=\"#HTTP2-0-首部压缩\" class=\"headerlink\" title=\"HTTP2.0 首部压缩\"></a>HTTP2.0 首部压缩</h2><p> HTTP 2.0 在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键-值对，对于相同的数据，不再通过每次请求和响应发送;通信期间几乎不会改变的通用键-值对(用户代理、可接受的媒体类型,等等)只 需发送一次。事实上,如果请求中不包含首部(例如对同一资源的轮询请求),那么 首部开销就是零字节。此时所有首部都自动使用之前请求发送的首部。<br>    如果首部发生变化了，那么只需要发送变化了数据在Headers帧里面，新增或修改的首部帧会被追加到“首部表”。首部表在 HTTP 2.0 的连接存续期内始终存在,由客户端和服务器共同渐进地更新 。</p>\n<p>  “好了，现在你倒是给我解释一下，这里使用自动化合并文件和Sprite合图是什么回事？”晨伯不解<br>  “本质上，当然是为了减少请求啦，通过多个js或css合并成一个文件，多张小图片拼合成Sprite图，可以让多个HTTP请求减少为一个，减少额外的协议开销，而提升性能。”如是道也<br>  “当然，一个HTTP的请求的body太大也是不合理的，有个度。文件的合并也会牺牲模块化和缓存粒度，可以把“稳定”的代码or 小图 合并为一个文件or一张Sprite，让其充分地缓存起来，从而区分开迭代快的文件” 我不明白晨伯的问题，就稍微补充了一下方案。</p>\n<p>   晨伯起来又<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">，略疼，略疼。话说多年的程序员交流都用这种肢体动作了吗？ </p>\n<h2 id=\"所有的HTTP2-0的请求都在一个TCP链接上\"><a href=\"#所有的HTTP2-0的请求都在一个TCP链接上\" class=\"headerlink\" title=\"所有的HTTP2.0的请求都在一个TCP链接上\"></a>所有的HTTP2.0的请求都在一个TCP链接上</h2><p>   HTTP2.0所有通信都是在一个TCP连接上完成。HTTP 2.0 把 HTTP 协议通信的基本单位缩小为一个一个的帧，这些帧对应 着逻辑流中的消息。并行地在同一个 TCP 连接上双向交换消息。就好比，我请求一个页面<a href=\"http://www.qq.com。页面上所有的资源请求都是客户端与服务器上的一条TCP上请求和响应的！\" target=\"_blank\" rel=\"external\">http://www.qq.com。页面上所有的资源请求都是客户端与服务器上的一条TCP上请求和响应的！</a><br>    有关注TCP性能的同学就会知道，HTTP性能的关键在于低延迟而不是高带宽！大多数HTTP 连接的时间都很短，而且是突发性的，但TCP 只在长时间连接传输大块数据时效率才最高。HTTP 2.0 通过让所有数据流共用同一个连接，可以更有效地使用TCP 连接，让高带宽也能真正的服务于HTTP的性能提升。</p>\n<p>   同时，单链接多资源的方式，使到至上而下的层面都得到了好处：</p>\n<ol>\n<li>可以减少服务链接压力,内存占用少了,连接吞吐量大了</li>\n<li>由于 TCP 连接减少而使网络拥塞状况得以改观;</li>\n<li>慢启动时间减少,拥塞和丢包恢复速度更快。</li>\n</ol>\n<p><strong>也就是说，“资源合并减少请求”的优化手段对于HTTP2.0来说是没有效果的，只会增大无用的工作量而已。</strong></p>\n<p>他说得好有道理，我竟然掩脸而对（因为脸被打疼了）。<br>“你在再我说说，这些cdn1.cn,cdn2.cn,cdn3.cn是什么回事啊”晨伯又问到。<br>“因为HTTP1.x上如果一个只用一个持久链接，请求只能一个一个顺序请求，为了高效地并行下载资源，浏览器允许我们打开多个TCP会话，但是一个域名下限制6个链接。为了突破这些限制，我们可以域名分区，提高并行下载资源能力…..”我只好把我当年知道的说出来<br>当时我就有预感要<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">，而晨伯总是按套路出牌….</p>\n<h2 id=\"并行双向字节流的请求和响应\"><a href=\"#并行双向字节流的请求和响应\" class=\"headerlink\" title=\"并行双向字节流的请求和响应\"></a>并行双向字节流的请求和响应</h2><p>   在HTTP2.0上，客户端和服务器可以把HTTP 消息分解为互不依赖的帧，然后乱序发送，最后再在另一端把它们重新组合起来。注意，同一链接上有多个不同方向的数据流在传输。客户端可以一边乱序发送stream，也可以一边接收者服务器的响应，而服务器那端同理。</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/stream.jpg\" alt=\"\"></p>\n<p>把 HTTP 消息分解为独立的帧,交错发送,然后在另一端重新组装是 HTTP 2.0 最 重要的一项增强。事实上,这个机制会在整个 Web 技术栈中引发一系列连锁反应, 从而带来巨大的性能提升,因为:</p>\n<p>可以并行交错地发送请求,请求之间互不影响;<br>可以并行交错地发送响应,响应之间互不干扰;<br>只使用一个连接即可并行发送多个请求和响应;<br>消除不必要的延迟,从而减少页面加载的时间;</p>\n<p>那么也就是说“域名分区”这种优化手段对于HTTP2.0是无用的，因为资源都是并行交错发送，且没有限制，不需要额外的多域名并行下载。</p>\n<p>“既然所有资源都是并行交错发送，会不会出现这样的情况【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送图片】” 我疑问道。<br>晨伯又<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">。我开始确信，这是多年后程序员的肢体礼仪方式。</p>\n<h2 id=\"HTTP2-0的请求优先级\"><a href=\"#HTTP2-0的请求优先级\" class=\"headerlink\" title=\"HTTP2.0的请求优先级\"></a>HTTP2.0的请求优先级</h2><p>   每个HTTP2.0流里面有个优先值，这个优先值确定着客户端和服务器处理不同的流采取不同的优先级策略，高优先级的流都应该优先发送，但又不会绝对的。绝对地准守，可能又会引入首队阻塞的问题：高优先级的请求慢导致阻塞其他资源交付。分配处理资源和客户端与服务器间的带宽，不同优先级的混合也是必须的。</p>\n<p>“有了优先级，HTTP2.0根本不会发生【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送黄图】”晨伯道。<br>“我根本没有说是服务器在发黄图，好不好。”我吐槽了一下。<br>  “还有还有，你这里的一段base64内嵌图片又是什么回事？是黄图吗？” 晨伯又挑战我了。<br>内嵌图片这种，有使用条件的优化手段，我还是不要说话好，不然的话按照这个故事的尿性，他应该又要飞拳我。</p>\n<p>HTTP2.0的服务器推送<br>    HTTP 2.0 新增的一个强大的新功能，就是服务器可以对一个客户端请求发送多个响应。换句话说，服务器可以强奸你的浏览器，哦不，应该是，除了对最初请求的响应外，服务器还可以额外向客户端推送资源，而无需客户端明确地请求。<br>当浏览器请求一个html，服务器其实大概知道你是接下来要请求资源了，而不需要等待浏览器得到html后解析页面再发送资源请求。我们常用的内嵌图片也可以理解为一种强制的服务器推送：我请求html，却内嵌了张黄图。</p>\n<p>   有了HTTP2.0的服务器推送，HTTP1.x时代的内嵌资源的优化手段也变得没有意义了。而且使用服务器推送的资源的方式更加高效，因为客户端还可以缓存起来，甚至可以由不同的页面共享（依旧遵循同源策略）。当然，你是个正直的浏览器，是可以决绝服务器推送的黄图的。</p>\n<p>   不知道为什么，说到黄图这个家伙就兴奋起来了，再也没有打我了。然后交谈就变成了16+周岁的少女不宜收听的内容了。不过HTTP2.0的知识收获了不少。</p>\n<p>到了我要面试的日子了，互联网公司A果真要（笔试|鄙视）一下我。我写出了下面的页面</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/future.png\" alt=\"\"></p>\n<p>在场面试官，纷纷鼓掌站了起来，“如此高效的页面，难得啊~你被录取了！”。<br>这看着这份如同我前端实习时候写的页面，我心中默默感叹“十年前端，终归如初”。<br>出于礼貌，我想起了晨伯教我的新式前端工程师肢体礼仪，然后…..</p>\n<p>参考：<br><a href=\"http://chimera.labs.oreilly.com/books/1230000000545/ch12.html#_sending_application_data\" target=\"_blank\" rel=\"external\">http://chimera.labs.oreilly.com/books/1230000000545/ch12.html#_sending_application_data</a><br><a href=\"https://thecustomizewindows.com/2014/08/http-2-0-changes-expected-new-standard-2/\" target=\"_blank\" rel=\"external\">https://thecustomizewindows.com/2014/08/http-2-0-changes-expected-new-standard-2/</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>转载自AlloyTeam：<a href=\"http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/\" target=\"_blank\" rel=\"external\">http://www.alloyteam.com/2015/03/http2-0-di-qi-miao-ri-chang/</a></p>\n<p>“多年没见，你的女神后来什么样了”晨伯总是这么八卦我的女神，而不是我。<br>    “我给你一个表情，你自己体会一下”<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/youshang_small.jpg\" alt=\"\"><br>    “你先写个小页面给我看看吧，我指导一下你吧。”晨伯一幅很吊的样子。<br>但是这样的小case当然难不了我，虽然多年没碰web，但是我当年可以是AlloyTeam的成员啊。很快我就啪啪啪地完成了页面。晨伯看完我写的页面，一幅“我可是有女朋友的男人”的表情，感叹了一句“现在是HTTP2.0的时代啦，给你普及一下知识点”。</p>\n<h2 id=\"HTTP2-0性能增强的核心：二进制分帧\"><a href=\"#HTTP2-0性能增强的核心：二进制分帧\" class=\"headerlink\" title=\"HTTP2.0性能增强的核心：二进制分帧\"></a>HTTP2.0性能增强的核心：二进制分帧</h2><p>HTTP 2.0最大的特点： 不会改动HTTP 的语义，HTTP 方法、状态码、URI 及首部字段，等等这些核心概念上一如往常，却能致力于突破上一代标准的性能限制，改进传输性能，实现低延迟和高吞吐量。而之所以叫2.0，是在于新增的二进制分帧层。<br>    既然又要保证HTTP的各种动词，方法，首部都不受影响，那就需要在应用层(HTTP2.0)和传输层(TCP or UDP)之间增加一个二进制分帧层。<br>    在二进制分帧层上， HTTP 2.0 会将所有传输的信息分割为更小的消息和帧,并对它们采用二进制格式的编码 ，其中HTTP1.x的首部信息会被封装到Headers帧，而我们的request body则封装到Data帧里面。</p>\n<p>http2.0</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/http2.0.jpg\" alt=\"\"></p>\n<p>然后，HTTP 2.0 通信都在一个连接上完成，这个连接可以承载任意数量的双向数据流。相应地，每个数据流以消息的形式发送，而消息由一或多个帧组成，这些帧可以乱序发送，然后再根据每个帧首部的流标识符重新组装。</p>\n<p>  当他侃侃而谈的时候，大概是这个样子的，你们也来感受一下。</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/stupid.jpg\" alt=\"\"></p>\n<p>  “听起来好屌的样子，但是那样，所有的二进制帧都会带上Headers帧，这是多大的数据冗余传送啊，性能会多….”我疑问道。<br><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">“还没讲完呢，插什么嘴！”（哎呀我差！我这么帅，可别打脸啊。）</p>\n<h2 id=\"HTTP2-0-首部压缩\"><a href=\"#HTTP2-0-首部压缩\" class=\"headerlink\" title=\"HTTP2.0 首部压缩\"></a>HTTP2.0 首部压缩</h2><p> HTTP 2.0 在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键-值对，对于相同的数据，不再通过每次请求和响应发送;通信期间几乎不会改变的通用键-值对(用户代理、可接受的媒体类型,等等)只 需发送一次。事实上,如果请求中不包含首部(例如对同一资源的轮询请求),那么 首部开销就是零字节。此时所有首部都自动使用之前请求发送的首部。<br>    如果首部发生变化了，那么只需要发送变化了数据在Headers帧里面，新增或修改的首部帧会被追加到“首部表”。首部表在 HTTP 2.0 的连接存续期内始终存在,由客户端和服务器共同渐进地更新 。</p>\n<p>  “好了，现在你倒是给我解释一下，这里使用自动化合并文件和Sprite合图是什么回事？”晨伯不解<br>  “本质上，当然是为了减少请求啦，通过多个js或css合并成一个文件，多张小图片拼合成Sprite图，可以让多个HTTP请求减少为一个，减少额外的协议开销，而提升性能。”如是道也<br>  “当然，一个HTTP的请求的body太大也是不合理的，有个度。文件的合并也会牺牲模块化和缓存粒度，可以把“稳定”的代码or 小图 合并为一个文件or一张Sprite，让其充分地缓存起来，从而区分开迭代快的文件” 我不明白晨伯的问题，就稍微补充了一下方案。</p>\n<p>   晨伯起来又<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">，略疼，略疼。话说多年的程序员交流都用这种肢体动作了吗？ </p>\n<h2 id=\"所有的HTTP2-0的请求都在一个TCP链接上\"><a href=\"#所有的HTTP2-0的请求都在一个TCP链接上\" class=\"headerlink\" title=\"所有的HTTP2.0的请求都在一个TCP链接上\"></a>所有的HTTP2.0的请求都在一个TCP链接上</h2><p>   HTTP2.0所有通信都是在一个TCP连接上完成。HTTP 2.0 把 HTTP 协议通信的基本单位缩小为一个一个的帧，这些帧对应 着逻辑流中的消息。并行地在同一个 TCP 连接上双向交换消息。就好比，我请求一个页面<a href=\"http://www.qq.com。页面上所有的资源请求都是客户端与服务器上的一条TCP上请求和响应的！\" target=\"_blank\" rel=\"external\">http://www.qq.com。页面上所有的资源请求都是客户端与服务器上的一条TCP上请求和响应的！</a><br>    有关注TCP性能的同学就会知道，HTTP性能的关键在于低延迟而不是高带宽！大多数HTTP 连接的时间都很短，而且是突发性的，但TCP 只在长时间连接传输大块数据时效率才最高。HTTP 2.0 通过让所有数据流共用同一个连接，可以更有效地使用TCP 连接，让高带宽也能真正的服务于HTTP的性能提升。</p>\n<p>   同时，单链接多资源的方式，使到至上而下的层面都得到了好处：</p>\n<ol>\n<li>可以减少服务链接压力,内存占用少了,连接吞吐量大了</li>\n<li>由于 TCP 连接减少而使网络拥塞状况得以改观;</li>\n<li>慢启动时间减少,拥塞和丢包恢复速度更快。</li>\n</ol>\n<p><strong>也就是说，“资源合并减少请求”的优化手段对于HTTP2.0来说是没有效果的，只会增大无用的工作量而已。</strong></p>\n<p>他说得好有道理，我竟然掩脸而对（因为脸被打疼了）。<br>“你在再我说说，这些cdn1.cn,cdn2.cn,cdn3.cn是什么回事啊”晨伯又问到。<br>“因为HTTP1.x上如果一个只用一个持久链接，请求只能一个一个顺序请求，为了高效地并行下载资源，浏览器允许我们打开多个TCP会话，但是一个域名下限制6个链接。为了突破这些限制，我们可以域名分区，提高并行下载资源能力…..”我只好把我当年知道的说出来<br>当时我就有预感要<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">，而晨伯总是按套路出牌….</p>\n<h2 id=\"并行双向字节流的请求和响应\"><a href=\"#并行双向字节流的请求和响应\" class=\"headerlink\" title=\"并行双向字节流的请求和响应\"></a>并行双向字节流的请求和响应</h2><p>   在HTTP2.0上，客户端和服务器可以把HTTP 消息分解为互不依赖的帧，然后乱序发送，最后再在另一端把它们重新组合起来。注意，同一链接上有多个不同方向的数据流在传输。客户端可以一边乱序发送stream，也可以一边接收者服务器的响应，而服务器那端同理。</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/stream.jpg\" alt=\"\"></p>\n<p>把 HTTP 消息分解为独立的帧,交错发送,然后在另一端重新组装是 HTTP 2.0 最 重要的一项增强。事实上,这个机制会在整个 Web 技术栈中引发一系列连锁反应, 从而带来巨大的性能提升,因为:</p>\n<p>可以并行交错地发送请求,请求之间互不影响;<br>可以并行交错地发送响应,响应之间互不干扰;<br>只使用一个连接即可并行发送多个请求和响应;<br>消除不必要的延迟,从而减少页面加载的时间;</p>\n<p>那么也就是说“域名分区”这种优化手段对于HTTP2.0是无用的，因为资源都是并行交错发送，且没有限制，不需要额外的多域名并行下载。</p>\n<p>“既然所有资源都是并行交错发送，会不会出现这样的情况【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送图片】” 我疑问道。<br>晨伯又<img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/giveyoufive.jpg\" alt=\"\">。我开始确信，这是多年后程序员的肢体礼仪方式。</p>\n<h2 id=\"HTTP2-0的请求优先级\"><a href=\"#HTTP2-0的请求优先级\" class=\"headerlink\" title=\"HTTP2.0的请求优先级\"></a>HTTP2.0的请求优先级</h2><p>   每个HTTP2.0流里面有个优先值，这个优先值确定着客户端和服务器处理不同的流采取不同的优先级策略，高优先级的流都应该优先发送，但又不会绝对的。绝对地准守，可能又会引入首队阻塞的问题：高优先级的请求慢导致阻塞其他资源交付。分配处理资源和客户端与服务器间的带宽，不同优先级的混合也是必须的。</p>\n<p>“有了优先级，HTTP2.0根本不会发生【浏览器明明在等关键的 CSS 和JS，你TMD的服务器还在发送黄图】”晨伯道。<br>“我根本没有说是服务器在发黄图，好不好。”我吐槽了一下。<br>  “还有还有，你这里的一段base64内嵌图片又是什么回事？是黄图吗？” 晨伯又挑战我了。<br>内嵌图片这种，有使用条件的优化手段，我还是不要说话好，不然的话按照这个故事的尿性，他应该又要飞拳我。</p>\n<p>HTTP2.0的服务器推送<br>    HTTP 2.0 新增的一个强大的新功能，就是服务器可以对一个客户端请求发送多个响应。换句话说，服务器可以强奸你的浏览器，哦不，应该是，除了对最初请求的响应外，服务器还可以额外向客户端推送资源，而无需客户端明确地请求。<br>当浏览器请求一个html，服务器其实大概知道你是接下来要请求资源了，而不需要等待浏览器得到html后解析页面再发送资源请求。我们常用的内嵌图片也可以理解为一种强制的服务器推送：我请求html，却内嵌了张黄图。</p>\n<p>   有了HTTP2.0的服务器推送，HTTP1.x时代的内嵌资源的优化手段也变得没有意义了。而且使用服务器推送的资源的方式更加高效，因为客户端还可以缓存起来，甚至可以由不同的页面共享（依旧遵循同源策略）。当然，你是个正直的浏览器，是可以决绝服务器推送的黄图的。</p>\n<p>   不知道为什么，说到黄图这个家伙就兴奋起来了，再也没有打我了。然后交谈就变成了16+周岁的少女不宜收听的内容了。不过HTTP2.0的知识收获了不少。</p>\n<p>到了我要面试的日子了，互联网公司A果真要（笔试|鄙视）一下我。我写出了下面的页面</p>\n<p><img src=\"http://cdn.alloyteam.com/wp-content/uploads/2015/03/future.png\" alt=\"\"></p>\n<p>在场面试官，纷纷鼓掌站了起来，“如此高效的页面，难得啊~你被录取了！”。<br>这看着这份如同我前端实习时候写的页面，我心中默默感叹“十年前端，终归如初”。<br>出于礼貌，我想起了晨伯教我的新式前端工程师肢体礼仪，然后…..</p>\n<p>参考：<br><a href=\"http://chimera.labs.oreilly.com/books/1230000000545/ch12.html#_sending_application_data\" target=\"_blank\" rel=\"external\">http://chimera.labs.oreilly.com/books/1230000000545/ch12.html#_sending_application_data</a><br><a href=\"https://thecustomizewindows.com/2014/08/http-2-0-changes-expected-new-standard-2/\" target=\"_blank\" rel=\"external\">https://thecustomizewindows.com/2014/08/http-2-0-changes-expected-new-standard-2/</a></p>\n"},{"title":"Hexo命令速记","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/DPP_0004.JPG","date":"2016-02-21T14:31:12.000Z","_content":"\n## 简写\n\n```\nhexo n \"我的博客\" == hexo new \"我的博客\" #新建文章\nhexo p == hexo publish\nhexo g == hexo generate#生成\nhexo s == hexo server #启动服务预览\nhexo d == hexo deploy#部署\n\n```\n\n## 服务器\n\n```\nhexo server #Hexo 会监视文件变动并自动更新，您无须重启服务器。\nhexo server -s #静态模式\nhexo server -p 5000 #更改端口\nhexo server -i 192.168.1.1 #自定义 IP\n\nhexo clean #清除缓存 网页正常情况下可以忽略此条命令\nhexo g #生成静态网页\nhexo d #开始部署\nhexo d -g #部署前先生成今天网页\n```\n\n## 监视文件变动\n\n```\nhexo generate #使用 Hexo 生成静态文件快速而且简单\nhexo generate --watch #监视文件变动\n```\n## 完成后部署\n\n```\n两个命令的作用是相同的\nhexo generate --deploy\nhexo deploy --generate\nhexo deploy -g\nhexo server -g\n```\n\n## 模版\n\n```\nhexo new \"postName\" #新建文章\nhexo new page \"pageName\" #新建页面\nhexo generate #生成静态页面至public目录\nhexo server #开启预览访问端口（默认端口4000，'ctrl + c'关闭server）\nhexo deploy #将.deploy目录部署到GitHub\n\nhexo new [layout] <title>\nhexo new photo \"My Gallery\"\nhexo new \"Hello World\" --lang tw\n```\n\n变量 | 描述\n--- | ---\nlayout | 布局\ntitle\t| 标题\ndate\t| 文件建立日期\n\n\n\n```\nlayout: post\ndate: 2014-03-03 19:07:43\ncomments: true\ncategories: Blog\ntags: [Hexo]\nkeywords: Hexo, Blog\ndescription: 生命在于折腾，又把博客折腾到Hexo了。给Hexo点赞。\n```\n\n常用指令\n---\n\n## 安装升级\n\n```\nnpm install hexo -g #安装  \nnpm update hexo -g #升级  \n```\n\n## init\n\n``` bash\n$ hexo init [folder]\n```\n\n新建一个网站。如果没有设置 `folder` ，Hexo 默认在目前的文件夹建立网站。\n\n## new\n\n``` bash\n$ hexo new [layout] <title>\n$ hexo n [layout] <title>\n```\n\n新建一篇文章。如果没有设置 `layout` 的话，默认使用 [_config.yml](configuration.html) 中的 `default_layout` 参数代替。如果标题包含空格的话，请使用引号括起来。\n\n\n\n## generate\n\n``` bash\n$ hexo generate\n```\n\n生成静态文件。\n\n选项 | 描述\n--- | ---\n`-d`, `--deploy` | 文件生成后立即部署网站\n`-w`, `--watch` | 监视文件变动\n\n## publish\n\n``` bash\n$ hexo publish [layout] <filename>\n```\n\n发表草稿。\n\n## server\n\n``` bash\n$ hexo server\n```\n\n启动服务器。默认情况下，访问网址为： `http://localhost:4000/`。\n\n选项 | 描述\n--- | ---\n`-p`, `--port` | 重设端口\n`-s`, `--static` | 只使用静态文件\n`-l`, `--log` | 启动日记记录，使用覆盖记录格式\n\n## deploy\n\n``` bash\n$ hexo deploy\n```\n\n部署网站。\n\n参数 | 描述\n--- | ---\n`-g`, `--generate` | 部署之前预先生成静态文件\n\n## render\n\n``` bash\n$ hexo render <file1> [file2] ...\n```\n\n渲染文件。\n\n参数 | 描述\n--- | ---\n`-o`, `--output` | 设置输出路径\n\n## migrate\n\n``` bash\n$ hexo migrate <type>\n```\n\n从其他博客系统 [迁移内容](migration.html)。\n\n## clean\n\n``` bash\n$ hexo clean\n```\n\n清除缓存文件 (`db.json`) 和已生成的静态文件 (`public`)。\n\n## list\n\n``` bash\n$ hexo list <type>\n```\n\n列出网站资料。\n\n## version\n\n``` bash\n$ hexo version\n```\n\n显示 Hexo 版本。\n\n## 选项\n\n### 安全模式\n\n``` bash\n$ hexo --safe\n```\n\n在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。\n\n### 调试模式\n\n``` bash\n$ hexo --debug\n```\n\n在终端中显示调试信息并记录到 `debug.log`。当您碰到问题时，可以尝试用调试模式重新执行一次，并 [提交调试信息到 GitHub](https://github.com/hexojs/hexo/issues/new)。\n\n### 简洁模式\n\n``` bash\n$ hexo --silent\n```\n\n隐藏终端信息。\n\n### 自定义配置文件的路径\n\n``` bash\n$ hexo --config custom.yml\n```\n\n自定义配置文件的路径，执行后将不再使用 `_config.yml`。\n\n### 显示草稿\n\n``` bash\n$ hexo --draft\n```\n\n显示 `source/_drafts` 文件夹中的草稿文章。\n\n### 自定义 CWD\n\n``` bash\n$ hexo --cwd /path/to/cwd\n```\n\n自定义当前工作目录（Current working directory）的路径。\n\n\n\n\n","source":"_posts/技术/Hexo/Hexo命令速记.md","raw":"---\ntitle: Hexo命令速记\nthumbnail: http://7xiovs.com1.z0.glb.clouddn.com/DPP_0004.JPG\ndate: 2016-02-21 22:31:12\ncategories: \n\t- 技术\n\t- Hexo\ntags:\n\t- Hexo\n---\n\n## 简写\n\n```\nhexo n \"我的博客\" == hexo new \"我的博客\" #新建文章\nhexo p == hexo publish\nhexo g == hexo generate#生成\nhexo s == hexo server #启动服务预览\nhexo d == hexo deploy#部署\n\n```\n\n## 服务器\n\n```\nhexo server #Hexo 会监视文件变动并自动更新，您无须重启服务器。\nhexo server -s #静态模式\nhexo server -p 5000 #更改端口\nhexo server -i 192.168.1.1 #自定义 IP\n\nhexo clean #清除缓存 网页正常情况下可以忽略此条命令\nhexo g #生成静态网页\nhexo d #开始部署\nhexo d -g #部署前先生成今天网页\n```\n\n## 监视文件变动\n\n```\nhexo generate #使用 Hexo 生成静态文件快速而且简单\nhexo generate --watch #监视文件变动\n```\n## 完成后部署\n\n```\n两个命令的作用是相同的\nhexo generate --deploy\nhexo deploy --generate\nhexo deploy -g\nhexo server -g\n```\n\n## 模版\n\n```\nhexo new \"postName\" #新建文章\nhexo new page \"pageName\" #新建页面\nhexo generate #生成静态页面至public目录\nhexo server #开启预览访问端口（默认端口4000，'ctrl + c'关闭server）\nhexo deploy #将.deploy目录部署到GitHub\n\nhexo new [layout] <title>\nhexo new photo \"My Gallery\"\nhexo new \"Hello World\" --lang tw\n```\n\n变量 | 描述\n--- | ---\nlayout | 布局\ntitle\t| 标题\ndate\t| 文件建立日期\n\n\n\n```\nlayout: post\ndate: 2014-03-03 19:07:43\ncomments: true\ncategories: Blog\ntags: [Hexo]\nkeywords: Hexo, Blog\ndescription: 生命在于折腾，又把博客折腾到Hexo了。给Hexo点赞。\n```\n\n常用指令\n---\n\n## 安装升级\n\n```\nnpm install hexo -g #安装  \nnpm update hexo -g #升级  \n```\n\n## init\n\n``` bash\n$ hexo init [folder]\n```\n\n新建一个网站。如果没有设置 `folder` ，Hexo 默认在目前的文件夹建立网站。\n\n## new\n\n``` bash\n$ hexo new [layout] <title>\n$ hexo n [layout] <title>\n```\n\n新建一篇文章。如果没有设置 `layout` 的话，默认使用 [_config.yml](configuration.html) 中的 `default_layout` 参数代替。如果标题包含空格的话，请使用引号括起来。\n\n\n\n## generate\n\n``` bash\n$ hexo generate\n```\n\n生成静态文件。\n\n选项 | 描述\n--- | ---\n`-d`, `--deploy` | 文件生成后立即部署网站\n`-w`, `--watch` | 监视文件变动\n\n## publish\n\n``` bash\n$ hexo publish [layout] <filename>\n```\n\n发表草稿。\n\n## server\n\n``` bash\n$ hexo server\n```\n\n启动服务器。默认情况下，访问网址为： `http://localhost:4000/`。\n\n选项 | 描述\n--- | ---\n`-p`, `--port` | 重设端口\n`-s`, `--static` | 只使用静态文件\n`-l`, `--log` | 启动日记记录，使用覆盖记录格式\n\n## deploy\n\n``` bash\n$ hexo deploy\n```\n\n部署网站。\n\n参数 | 描述\n--- | ---\n`-g`, `--generate` | 部署之前预先生成静态文件\n\n## render\n\n``` bash\n$ hexo render <file1> [file2] ...\n```\n\n渲染文件。\n\n参数 | 描述\n--- | ---\n`-o`, `--output` | 设置输出路径\n\n## migrate\n\n``` bash\n$ hexo migrate <type>\n```\n\n从其他博客系统 [迁移内容](migration.html)。\n\n## clean\n\n``` bash\n$ hexo clean\n```\n\n清除缓存文件 (`db.json`) 和已生成的静态文件 (`public`)。\n\n## list\n\n``` bash\n$ hexo list <type>\n```\n\n列出网站资料。\n\n## version\n\n``` bash\n$ hexo version\n```\n\n显示 Hexo 版本。\n\n## 选项\n\n### 安全模式\n\n``` bash\n$ hexo --safe\n```\n\n在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。\n\n### 调试模式\n\n``` bash\n$ hexo --debug\n```\n\n在终端中显示调试信息并记录到 `debug.log`。当您碰到问题时，可以尝试用调试模式重新执行一次，并 [提交调试信息到 GitHub](https://github.com/hexojs/hexo/issues/new)。\n\n### 简洁模式\n\n``` bash\n$ hexo --silent\n```\n\n隐藏终端信息。\n\n### 自定义配置文件的路径\n\n``` bash\n$ hexo --config custom.yml\n```\n\n自定义配置文件的路径，执行后将不再使用 `_config.yml`。\n\n### 显示草稿\n\n``` bash\n$ hexo --draft\n```\n\n显示 `source/_drafts` 文件夹中的草稿文章。\n\n### 自定义 CWD\n\n``` bash\n$ hexo --cwd /path/to/cwd\n```\n\n自定义当前工作目录（Current working directory）的路径。\n\n\n\n\n","slug":"技术/Hexo/Hexo命令速记","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc50005tz29k2p0cki3i","content":"<h2 id=\"简写\"><a href=\"#简写\" class=\"headerlink\" title=\"简写\"></a>简写</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo n &quot;我的博客&quot; == hexo new &quot;我的博客&quot; #新建文章</div><div class=\"line\">hexo p == hexo publish</div><div class=\"line\">hexo g == hexo generate#生成</div><div class=\"line\">hexo s == hexo server #启动服务预览</div><div class=\"line\">hexo d == hexo deploy#部署</div></pre></td></tr></table></figure>\n<h2 id=\"服务器\"><a href=\"#服务器\" class=\"headerlink\" title=\"服务器\"></a>服务器</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo server #Hexo 会监视文件变动并自动更新，您无须重启服务器。</div><div class=\"line\">hexo server -s #静态模式</div><div class=\"line\">hexo server -p 5000 #更改端口</div><div class=\"line\">hexo server -i 192.168.1.1 #自定义 IP</div><div class=\"line\"></div><div class=\"line\">hexo clean #清除缓存 网页正常情况下可以忽略此条命令</div><div class=\"line\">hexo g #生成静态网页</div><div class=\"line\">hexo d #开始部署</div><div class=\"line\">hexo d -g #部署前先生成今天网页</div></pre></td></tr></table></figure>\n<h2 id=\"监视文件变动\"><a href=\"#监视文件变动\" class=\"headerlink\" title=\"监视文件变动\"></a>监视文件变动</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo generate #使用 Hexo 生成静态文件快速而且简单</div><div class=\"line\">hexo generate --watch #监视文件变动</div></pre></td></tr></table></figure>\n<h2 id=\"完成后部署\"><a href=\"#完成后部署\" class=\"headerlink\" title=\"完成后部署\"></a>完成后部署</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">两个命令的作用是相同的</div><div class=\"line\">hexo generate --deploy</div><div class=\"line\">hexo deploy --generate</div><div class=\"line\">hexo deploy -g</div><div class=\"line\">hexo server -g</div></pre></td></tr></table></figure>\n<h2 id=\"模版\"><a href=\"#模版\" class=\"headerlink\" title=\"模版\"></a>模版</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo new &quot;postName&quot; #新建文章</div><div class=\"line\">hexo new page &quot;pageName&quot; #新建页面</div><div class=\"line\">hexo generate #生成静态页面至public目录</div><div class=\"line\">hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server）</div><div class=\"line\">hexo deploy #将.deploy目录部署到GitHub</div><div class=\"line\"></div><div class=\"line\">hexo new [layout] &lt;title&gt;</div><div class=\"line\">hexo new photo &quot;My Gallery&quot;</div><div class=\"line\">hexo new &quot;Hello World&quot; --lang tw</div></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>变量</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>layout</td>\n<td>布局</td>\n</tr>\n<tr>\n<td>title</td>\n<td>标题</td>\n</tr>\n<tr>\n<td>date</td>\n<td>文件建立日期</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">layout: post</div><div class=\"line\">date: 2014-03-03 19:07:43</div><div class=\"line\">comments: true</div><div class=\"line\">categories: Blog</div><div class=\"line\">tags: [Hexo]</div><div class=\"line\">keywords: Hexo, Blog</div><div class=\"line\">description: 生命在于折腾，又把博客折腾到Hexo了。给Hexo点赞。</div></pre></td></tr></table></figure>\n<h2 id=\"常用指令\"><a href=\"#常用指令\" class=\"headerlink\" title=\"常用指令\"></a>常用指令</h2><h2 id=\"安装升级\"><a href=\"#安装升级\" class=\"headerlink\" title=\"安装升级\"></a>安装升级</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm install hexo -g #安装  </div><div class=\"line\">npm update hexo -g #升级</div></pre></td></tr></table></figure>\n<h2 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init\"></a>init</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo init [folder]</div></pre></td></tr></table></figure>\n<p>新建一个网站。如果没有设置 <code>folder</code> ，Hexo 默认在目前的文件夹建立网站。</p>\n<h2 id=\"new\"><a href=\"#new\" class=\"headerlink\" title=\"new\"></a>new</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new [layout] &lt;title&gt;</div><div class=\"line\">$ hexo n [layout] &lt;title&gt;</div></pre></td></tr></table></figure>\n<p>新建一篇文章。如果没有设置 <code>layout</code> 的话，默认使用 <a href=\"configuration.html\">_config.yml</a> 中的 <code>default_layout</code> 参数代替。如果标题包含空格的话，请使用引号括起来。</p>\n<h2 id=\"generate\"><a href=\"#generate\" class=\"headerlink\" title=\"generate\"></a>generate</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>生成静态文件。</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-d</code>, <code>--deploy</code></td>\n<td>文件生成后立即部署网站</td>\n</tr>\n<tr>\n<td><code>-w</code>, <code>--watch</code></td>\n<td>监视文件变动</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"publish\"><a href=\"#publish\" class=\"headerlink\" title=\"publish\"></a>publish</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo publish [layout] &lt;filename&gt;</div></pre></td></tr></table></figure>\n<p>发表草稿。</p>\n<h2 id=\"server\"><a href=\"#server\" class=\"headerlink\" title=\"server\"></a>server</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>启动服务器。默认情况下，访问网址为： <code>http://localhost:4000/</code>。</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-p</code>, <code>--port</code></td>\n<td>重设端口</td>\n</tr>\n<tr>\n<td><code>-s</code>, <code>--static</code></td>\n<td>只使用静态文件</td>\n</tr>\n<tr>\n<td><code>-l</code>, <code>--log</code></td>\n<td>启动日记记录，使用覆盖记录格式</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"deploy\"><a href=\"#deploy\" class=\"headerlink\" title=\"deploy\"></a>deploy</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>部署网站。</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-g</code>, <code>--generate</code></td>\n<td>部署之前预先生成静态文件</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"render\"><a href=\"#render\" class=\"headerlink\" title=\"render\"></a>render</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo render &lt;file1&gt; [file2] ...</div></pre></td></tr></table></figure>\n<p>渲染文件。</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-o</code>, <code>--output</code></td>\n<td>设置输出路径</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"migrate\"><a href=\"#migrate\" class=\"headerlink\" title=\"migrate\"></a>migrate</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo migrate &lt;<span class=\"built_in\">type</span>&gt;</div></pre></td></tr></table></figure>\n<p>从其他博客系统 <a href=\"migration.html\">迁移内容</a>。</p>\n<h2 id=\"clean\"><a href=\"#clean\" class=\"headerlink\" title=\"clean\"></a>clean</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo clean</div></pre></td></tr></table></figure>\n<p>清除缓存文件 (<code>db.json</code>) 和已生成的静态文件 (<code>public</code>)。</p>\n<h2 id=\"list\"><a href=\"#list\" class=\"headerlink\" title=\"list\"></a>list</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo list &lt;<span class=\"built_in\">type</span>&gt;</div></pre></td></tr></table></figure>\n<p>列出网站资料。</p>\n<h2 id=\"version\"><a href=\"#version\" class=\"headerlink\" title=\"version\"></a>version</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo version</div></pre></td></tr></table></figure>\n<p>显示 Hexo 版本。</p>\n<h2 id=\"选项\"><a href=\"#选项\" class=\"headerlink\" title=\"选项\"></a>选项</h2><h3 id=\"安全模式\"><a href=\"#安全模式\" class=\"headerlink\" title=\"安全模式\"></a>安全模式</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --safe</div></pre></td></tr></table></figure>\n<p>在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。</p>\n<h3 id=\"调试模式\"><a href=\"#调试模式\" class=\"headerlink\" title=\"调试模式\"></a>调试模式</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --debug</div></pre></td></tr></table></figure>\n<p>在终端中显示调试信息并记录到 <code>debug.log</code>。当您碰到问题时，可以尝试用调试模式重新执行一次，并 <a href=\"https://github.com/hexojs/hexo/issues/new\" target=\"_blank\" rel=\"external\">提交调试信息到 GitHub</a>。</p>\n<h3 id=\"简洁模式\"><a href=\"#简洁模式\" class=\"headerlink\" title=\"简洁模式\"></a>简洁模式</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --silent</div></pre></td></tr></table></figure>\n<p>隐藏终端信息。</p>\n<h3 id=\"自定义配置文件的路径\"><a href=\"#自定义配置文件的路径\" class=\"headerlink\" title=\"自定义配置文件的路径\"></a>自定义配置文件的路径</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --config custom.yml</div></pre></td></tr></table></figure>\n<p>自定义配置文件的路径，执行后将不再使用 <code>_config.yml</code>。</p>\n<h3 id=\"显示草稿\"><a href=\"#显示草稿\" class=\"headerlink\" title=\"显示草稿\"></a>显示草稿</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --draft</div></pre></td></tr></table></figure>\n<p>显示 <code>source/_drafts</code> 文件夹中的草稿文章。</p>\n<h3 id=\"自定义-CWD\"><a href=\"#自定义-CWD\" class=\"headerlink\" title=\"自定义 CWD\"></a>自定义 CWD</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --cwd /path/to/cwd</div></pre></td></tr></table></figure>\n<p>自定义当前工作目录（Current working directory）的路径。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"简写\"><a href=\"#简写\" class=\"headerlink\" title=\"简写\"></a>简写</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo n &quot;我的博客&quot; == hexo new &quot;我的博客&quot; #新建文章</div><div class=\"line\">hexo p == hexo publish</div><div class=\"line\">hexo g == hexo generate#生成</div><div class=\"line\">hexo s == hexo server #启动服务预览</div><div class=\"line\">hexo d == hexo deploy#部署</div></pre></td></tr></table></figure>\n<h2 id=\"服务器\"><a href=\"#服务器\" class=\"headerlink\" title=\"服务器\"></a>服务器</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo server #Hexo 会监视文件变动并自动更新，您无须重启服务器。</div><div class=\"line\">hexo server -s #静态模式</div><div class=\"line\">hexo server -p 5000 #更改端口</div><div class=\"line\">hexo server -i 192.168.1.1 #自定义 IP</div><div class=\"line\"></div><div class=\"line\">hexo clean #清除缓存 网页正常情况下可以忽略此条命令</div><div class=\"line\">hexo g #生成静态网页</div><div class=\"line\">hexo d #开始部署</div><div class=\"line\">hexo d -g #部署前先生成今天网页</div></pre></td></tr></table></figure>\n<h2 id=\"监视文件变动\"><a href=\"#监视文件变动\" class=\"headerlink\" title=\"监视文件变动\"></a>监视文件变动</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo generate #使用 Hexo 生成静态文件快速而且简单</div><div class=\"line\">hexo generate --watch #监视文件变动</div></pre></td></tr></table></figure>\n<h2 id=\"完成后部署\"><a href=\"#完成后部署\" class=\"headerlink\" title=\"完成后部署\"></a>完成后部署</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">两个命令的作用是相同的</div><div class=\"line\">hexo generate --deploy</div><div class=\"line\">hexo deploy --generate</div><div class=\"line\">hexo deploy -g</div><div class=\"line\">hexo server -g</div></pre></td></tr></table></figure>\n<h2 id=\"模版\"><a href=\"#模版\" class=\"headerlink\" title=\"模版\"></a>模版</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">hexo new &quot;postName&quot; #新建文章</div><div class=\"line\">hexo new page &quot;pageName&quot; #新建页面</div><div class=\"line\">hexo generate #生成静态页面至public目录</div><div class=\"line\">hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server）</div><div class=\"line\">hexo deploy #将.deploy目录部署到GitHub</div><div class=\"line\"></div><div class=\"line\">hexo new [layout] &lt;title&gt;</div><div class=\"line\">hexo new photo &quot;My Gallery&quot;</div><div class=\"line\">hexo new &quot;Hello World&quot; --lang tw</div></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>变量</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>layout</td>\n<td>布局</td>\n</tr>\n<tr>\n<td>title</td>\n<td>标题</td>\n</tr>\n<tr>\n<td>date</td>\n<td>文件建立日期</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">layout: post</div><div class=\"line\">date: 2014-03-03 19:07:43</div><div class=\"line\">comments: true</div><div class=\"line\">categories: Blog</div><div class=\"line\">tags: [Hexo]</div><div class=\"line\">keywords: Hexo, Blog</div><div class=\"line\">description: 生命在于折腾，又把博客折腾到Hexo了。给Hexo点赞。</div></pre></td></tr></table></figure>\n<h2 id=\"常用指令\"><a href=\"#常用指令\" class=\"headerlink\" title=\"常用指令\"></a>常用指令</h2><h2 id=\"安装升级\"><a href=\"#安装升级\" class=\"headerlink\" title=\"安装升级\"></a>安装升级</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm install hexo -g #安装  </div><div class=\"line\">npm update hexo -g #升级</div></pre></td></tr></table></figure>\n<h2 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init\"></a>init</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo init [folder]</div></pre></td></tr></table></figure>\n<p>新建一个网站。如果没有设置 <code>folder</code> ，Hexo 默认在目前的文件夹建立网站。</p>\n<h2 id=\"new\"><a href=\"#new\" class=\"headerlink\" title=\"new\"></a>new</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new [layout] &lt;title&gt;</div><div class=\"line\">$ hexo n [layout] &lt;title&gt;</div></pre></td></tr></table></figure>\n<p>新建一篇文章。如果没有设置 <code>layout</code> 的话，默认使用 <a href=\"configuration.html\">_config.yml</a> 中的 <code>default_layout</code> 参数代替。如果标题包含空格的话，请使用引号括起来。</p>\n<h2 id=\"generate\"><a href=\"#generate\" class=\"headerlink\" title=\"generate\"></a>generate</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>生成静态文件。</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-d</code>, <code>--deploy</code></td>\n<td>文件生成后立即部署网站</td>\n</tr>\n<tr>\n<td><code>-w</code>, <code>--watch</code></td>\n<td>监视文件变动</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"publish\"><a href=\"#publish\" class=\"headerlink\" title=\"publish\"></a>publish</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo publish [layout] &lt;filename&gt;</div></pre></td></tr></table></figure>\n<p>发表草稿。</p>\n<h2 id=\"server\"><a href=\"#server\" class=\"headerlink\" title=\"server\"></a>server</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>启动服务器。默认情况下，访问网址为： <code>http://localhost:4000/</code>。</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-p</code>, <code>--port</code></td>\n<td>重设端口</td>\n</tr>\n<tr>\n<td><code>-s</code>, <code>--static</code></td>\n<td>只使用静态文件</td>\n</tr>\n<tr>\n<td><code>-l</code>, <code>--log</code></td>\n<td>启动日记记录，使用覆盖记录格式</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"deploy\"><a href=\"#deploy\" class=\"headerlink\" title=\"deploy\"></a>deploy</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>部署网站。</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-g</code>, <code>--generate</code></td>\n<td>部署之前预先生成静态文件</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"render\"><a href=\"#render\" class=\"headerlink\" title=\"render\"></a>render</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo render &lt;file1&gt; [file2] ...</div></pre></td></tr></table></figure>\n<p>渲染文件。</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-o</code>, <code>--output</code></td>\n<td>设置输出路径</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"migrate\"><a href=\"#migrate\" class=\"headerlink\" title=\"migrate\"></a>migrate</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo migrate &lt;<span class=\"built_in\">type</span>&gt;</div></pre></td></tr></table></figure>\n<p>从其他博客系统 <a href=\"migration.html\">迁移内容</a>。</p>\n<h2 id=\"clean\"><a href=\"#clean\" class=\"headerlink\" title=\"clean\"></a>clean</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo clean</div></pre></td></tr></table></figure>\n<p>清除缓存文件 (<code>db.json</code>) 和已生成的静态文件 (<code>public</code>)。</p>\n<h2 id=\"list\"><a href=\"#list\" class=\"headerlink\" title=\"list\"></a>list</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo list &lt;<span class=\"built_in\">type</span>&gt;</div></pre></td></tr></table></figure>\n<p>列出网站资料。</p>\n<h2 id=\"version\"><a href=\"#version\" class=\"headerlink\" title=\"version\"></a>version</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo version</div></pre></td></tr></table></figure>\n<p>显示 Hexo 版本。</p>\n<h2 id=\"选项\"><a href=\"#选项\" class=\"headerlink\" title=\"选项\"></a>选项</h2><h3 id=\"安全模式\"><a href=\"#安全模式\" class=\"headerlink\" title=\"安全模式\"></a>安全模式</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --safe</div></pre></td></tr></table></figure>\n<p>在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。</p>\n<h3 id=\"调试模式\"><a href=\"#调试模式\" class=\"headerlink\" title=\"调试模式\"></a>调试模式</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --debug</div></pre></td></tr></table></figure>\n<p>在终端中显示调试信息并记录到 <code>debug.log</code>。当您碰到问题时，可以尝试用调试模式重新执行一次，并 <a href=\"https://github.com/hexojs/hexo/issues/new\" target=\"_blank\" rel=\"external\">提交调试信息到 GitHub</a>。</p>\n<h3 id=\"简洁模式\"><a href=\"#简洁模式\" class=\"headerlink\" title=\"简洁模式\"></a>简洁模式</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --silent</div></pre></td></tr></table></figure>\n<p>隐藏终端信息。</p>\n<h3 id=\"自定义配置文件的路径\"><a href=\"#自定义配置文件的路径\" class=\"headerlink\" title=\"自定义配置文件的路径\"></a>自定义配置文件的路径</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --config custom.yml</div></pre></td></tr></table></figure>\n<p>自定义配置文件的路径，执行后将不再使用 <code>_config.yml</code>。</p>\n<h3 id=\"显示草稿\"><a href=\"#显示草稿\" class=\"headerlink\" title=\"显示草稿\"></a>显示草稿</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --draft</div></pre></td></tr></table></figure>\n<p>显示 <code>source/_drafts</code> 文件夹中的草稿文章。</p>\n<h3 id=\"自定义-CWD\"><a href=\"#自定义-CWD\" class=\"headerlink\" title=\"自定义 CWD\"></a>自定义 CWD</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --cwd /path/to/cwd</div></pre></td></tr></table></figure>\n<p>自定义当前工作目录（Current working directory）的路径。</p>\n"},{"title":"领域模型的价值","date":"2016-02-21T12:20:42.000Z","thumbnail":"http://7xiovs.com1.z0.glb.clouddn.com/DPP_00032.JPG","_content":"\n\n## 价值\n\n+ 提供什么服务：\n\t+ 什么来体现服务：运行方式，运行过程和业务逻辑\n+ 提供的质量：如何服务，要做的事情\n\n## 传统数据库为中心\n\n业务逻辑在数据库上，结合系统代码来保证业务逻辑的实现。\n以数据库为中心的开发如何的OO﹐如何多的设计模式﹐架构体系如何优美﹐它始终离不开数据库。\n\n## OO|面向对象\n\n表现点则是直接在对象本身上﹐在于对象之间真正的交互过程﹐结果也是保留在对象的属性和对象与对象的关系中\n逻辑直接存在于对象上﹐这与现实情况是吻合的。\n\n领域模型是一种思维﹐是一种方法,是在系统分析阶段使用﹐而不是在代码中进行纯设计时的工具。不是为了OO而领域﹐不是为了最终要新增数据库而领域。在没有理解领域模型本质时，任何编码都得不到收益。\n\n在分析或架构一个系统时，要得出系统的服务和服务场景，即user case。\n\n## 领域模型的特点\n\n1. 领域模型是对具有某个边界的领域的一个抽象，反映了领域内用户业务需求的本质；领域模型是有边界的，只反应了我们在领域内所关注的部分；\n　　2. 领域模型只反映业务，和任何技术实现无关；领域模型不仅能反映领域中的一些实体概念，如货物、书本、应聘记录、地址等；还能反映领域中的一些过程概念，如资金转账，等；\n　　3. 领域模型确保了我们的软件的业务逻辑都在一个模型中，都在一个地方；这样对提高软件的可维护性，业务可理解性以及可重用性方面都有很好的帮助；\n　　4. 领域模型能够帮助开发人员相对平滑地将领域知识转化为软件构造；\n　　5. 领域模型贯穿软件分析、设计，以及开发的整个过程；领域专家、设计人员、开发人员通过领域模型进行交流，彼此共享知识与信息；因为大家面向的都是同一个模型，所以可以防止需求走样，可以让软件设计开发人员做出来的软件真正满足需求；\n　　6. 要建立正确的领域模型并不简单，需要领域专家、设计、开发人员积极沟通共同努力，然后才能使大家对领域的认识不断深入，从而不断细化和完善领域模型；\n　　7. 为了让领域模型看的见，我们需要用一些方法来表示它；图是表达领域模型最常用的方式，但不是唯一的表达方式，代码或文字描述也能表达领域模型；\n　　8. 领域模型是整个软件的核心，是软件中最有价值和最具竞争力的部分；设计足够精良且符合业务需求的领域模型能够更快速的响应需求变化。","source":"_posts/技术/领域模型/领域模型的价值.md","raw":"---\ntitle: 领域模型的价值\ndate: 2016-02-21 20:20:42\ncategories: \n\t- 技术\n\t- 领域模型\nthumbnail: http://7xiovs.com1.z0.glb.clouddn.com/DPP_00032.JPG\ntags: \n\t- 领域模型\n\t- DDD\n---\n\n\n## 价值\n\n+ 提供什么服务：\n\t+ 什么来体现服务：运行方式，运行过程和业务逻辑\n+ 提供的质量：如何服务，要做的事情\n\n## 传统数据库为中心\n\n业务逻辑在数据库上，结合系统代码来保证业务逻辑的实现。\n以数据库为中心的开发如何的OO﹐如何多的设计模式﹐架构体系如何优美﹐它始终离不开数据库。\n\n## OO|面向对象\n\n表现点则是直接在对象本身上﹐在于对象之间真正的交互过程﹐结果也是保留在对象的属性和对象与对象的关系中\n逻辑直接存在于对象上﹐这与现实情况是吻合的。\n\n领域模型是一种思维﹐是一种方法,是在系统分析阶段使用﹐而不是在代码中进行纯设计时的工具。不是为了OO而领域﹐不是为了最终要新增数据库而领域。在没有理解领域模型本质时，任何编码都得不到收益。\n\n在分析或架构一个系统时，要得出系统的服务和服务场景，即user case。\n\n## 领域模型的特点\n\n1. 领域模型是对具有某个边界的领域的一个抽象，反映了领域内用户业务需求的本质；领域模型是有边界的，只反应了我们在领域内所关注的部分；\n　　2. 领域模型只反映业务，和任何技术实现无关；领域模型不仅能反映领域中的一些实体概念，如货物、书本、应聘记录、地址等；还能反映领域中的一些过程概念，如资金转账，等；\n　　3. 领域模型确保了我们的软件的业务逻辑都在一个模型中，都在一个地方；这样对提高软件的可维护性，业务可理解性以及可重用性方面都有很好的帮助；\n　　4. 领域模型能够帮助开发人员相对平滑地将领域知识转化为软件构造；\n　　5. 领域模型贯穿软件分析、设计，以及开发的整个过程；领域专家、设计人员、开发人员通过领域模型进行交流，彼此共享知识与信息；因为大家面向的都是同一个模型，所以可以防止需求走样，可以让软件设计开发人员做出来的软件真正满足需求；\n　　6. 要建立正确的领域模型并不简单，需要领域专家、设计、开发人员积极沟通共同努力，然后才能使大家对领域的认识不断深入，从而不断细化和完善领域模型；\n　　7. 为了让领域模型看的见，我们需要用一些方法来表示它；图是表达领域模型最常用的方式，但不是唯一的表达方式，代码或文字描述也能表达领域模型；\n　　8. 领域模型是整个软件的核心，是软件中最有价值和最具竞争力的部分；设计足够精良且符合业务需求的领域模型能够更快速的响应需求变化。","slug":"技术/领域模型/领域模型的价值","published":1,"updated":"2017-05-21T04:43:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2yhqc52005zz29kifjafbx7","content":"<h2 id=\"价值\"><a href=\"#价值\" class=\"headerlink\" title=\"价值\"></a>价值</h2><ul>\n<li>提供什么服务：<ul>\n<li>什么来体现服务：运行方式，运行过程和业务逻辑</li>\n</ul>\n</li>\n<li>提供的质量：如何服务，要做的事情</li>\n</ul>\n<h2 id=\"传统数据库为中心\"><a href=\"#传统数据库为中心\" class=\"headerlink\" title=\"传统数据库为中心\"></a>传统数据库为中心</h2><p>业务逻辑在数据库上，结合系统代码来保证业务逻辑的实现。<br>以数据库为中心的开发如何的OO﹐如何多的设计模式﹐架构体系如何优美﹐它始终离不开数据库。</p>\n<h2 id=\"OO-面向对象\"><a href=\"#OO-面向对象\" class=\"headerlink\" title=\"OO|面向对象\"></a>OO|面向对象</h2><p>表现点则是直接在对象本身上﹐在于对象之间真正的交互过程﹐结果也是保留在对象的属性和对象与对象的关系中<br>逻辑直接存在于对象上﹐这与现实情况是吻合的。</p>\n<p>领域模型是一种思维﹐是一种方法,是在系统分析阶段使用﹐而不是在代码中进行纯设计时的工具。不是为了OO而领域﹐不是为了最终要新增数据库而领域。在没有理解领域模型本质时，任何编码都得不到收益。</p>\n<p>在分析或架构一个系统时，要得出系统的服务和服务场景，即user case。</p>\n<h2 id=\"领域模型的特点\"><a href=\"#领域模型的特点\" class=\"headerlink\" title=\"领域模型的特点\"></a>领域模型的特点</h2><ol>\n<li>领域模型是对具有某个边界的领域的一个抽象，反映了领域内用户业务需求的本质；领域模型是有边界的，只反应了我们在领域内所关注的部分；<br>　　2. 领域模型只反映业务，和任何技术实现无关；领域模型不仅能反映领域中的一些实体概念，如货物、书本、应聘记录、地址等；还能反映领域中的一些过程概念，如资金转账，等；<br>　　3. 领域模型确保了我们的软件的业务逻辑都在一个模型中，都在一个地方；这样对提高软件的可维护性，业务可理解性以及可重用性方面都有很好的帮助；<br>　　4. 领域模型能够帮助开发人员相对平滑地将领域知识转化为软件构造；<br>　　5. 领域模型贯穿软件分析、设计，以及开发的整个过程；领域专家、设计人员、开发人员通过领域模型进行交流，彼此共享知识与信息；因为大家面向的都是同一个模型，所以可以防止需求走样，可以让软件设计开发人员做出来的软件真正满足需求；<br>　　6. 要建立正确的领域模型并不简单，需要领域专家、设计、开发人员积极沟通共同努力，然后才能使大家对领域的认识不断深入，从而不断细化和完善领域模型；<br>　　7. 为了让领域模型看的见，我们需要用一些方法来表示它；图是表达领域模型最常用的方式，但不是唯一的表达方式，代码或文字描述也能表达领域模型；<br>　　8. 领域模型是整个软件的核心，是软件中最有价值和最具竞争力的部分；设计足够精良且符合业务需求的领域模型能够更快速的响应需求变化。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"价值\"><a href=\"#价值\" class=\"headerlink\" title=\"价值\"></a>价值</h2><ul>\n<li>提供什么服务：<ul>\n<li>什么来体现服务：运行方式，运行过程和业务逻辑</li>\n</ul>\n</li>\n<li>提供的质量：如何服务，要做的事情</li>\n</ul>\n<h2 id=\"传统数据库为中心\"><a href=\"#传统数据库为中心\" class=\"headerlink\" title=\"传统数据库为中心\"></a>传统数据库为中心</h2><p>业务逻辑在数据库上，结合系统代码来保证业务逻辑的实现。<br>以数据库为中心的开发如何的OO﹐如何多的设计模式﹐架构体系如何优美﹐它始终离不开数据库。</p>\n<h2 id=\"OO-面向对象\"><a href=\"#OO-面向对象\" class=\"headerlink\" title=\"OO|面向对象\"></a>OO|面向对象</h2><p>表现点则是直接在对象本身上﹐在于对象之间真正的交互过程﹐结果也是保留在对象的属性和对象与对象的关系中<br>逻辑直接存在于对象上﹐这与现实情况是吻合的。</p>\n<p>领域模型是一种思维﹐是一种方法,是在系统分析阶段使用﹐而不是在代码中进行纯设计时的工具。不是为了OO而领域﹐不是为了最终要新增数据库而领域。在没有理解领域模型本质时，任何编码都得不到收益。</p>\n<p>在分析或架构一个系统时，要得出系统的服务和服务场景，即user case。</p>\n<h2 id=\"领域模型的特点\"><a href=\"#领域模型的特点\" class=\"headerlink\" title=\"领域模型的特点\"></a>领域模型的特点</h2><ol>\n<li>领域模型是对具有某个边界的领域的一个抽象，反映了领域内用户业务需求的本质；领域模型是有边界的，只反应了我们在领域内所关注的部分；<br>　　2. 领域模型只反映业务，和任何技术实现无关；领域模型不仅能反映领域中的一些实体概念，如货物、书本、应聘记录、地址等；还能反映领域中的一些过程概念，如资金转账，等；<br>　　3. 领域模型确保了我们的软件的业务逻辑都在一个模型中，都在一个地方；这样对提高软件的可维护性，业务可理解性以及可重用性方面都有很好的帮助；<br>　　4. 领域模型能够帮助开发人员相对平滑地将领域知识转化为软件构造；<br>　　5. 领域模型贯穿软件分析、设计，以及开发的整个过程；领域专家、设计人员、开发人员通过领域模型进行交流，彼此共享知识与信息；因为大家面向的都是同一个模型，所以可以防止需求走样，可以让软件设计开发人员做出来的软件真正满足需求；<br>　　6. 要建立正确的领域模型并不简单，需要领域专家、设计、开发人员积极沟通共同努力，然后才能使大家对领域的认识不断深入，从而不断细化和完善领域模型；<br>　　7. 为了让领域模型看的见，我们需要用一些方法来表示它；图是表达领域模型最常用的方式，但不是唯一的表达方式，代码或文字描述也能表达领域模型；<br>　　8. 领域模型是整个软件的核心，是软件中最有价值和最具竞争力的部分；设计足够精良且符合业务需求的领域模型能够更快速的响应需求变化。</li>\n</ol>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cj2yhqbub0001z29k1z36bp8m","category_id":"cj2yhqbuf0002z29kx7jkkeqi","_id":"cj2yhqbuh0005z29kutklf64d"},{"post_id":"cj2yhqc04000bz29k30egd1hz","category_id":"cj2yhqc05000cz29kpb5g27ob","_id":"cj2yhqc06000fz29kec2iads8"},{"post_id":"cj2yhqc07000mz29kpdjtcp88","category_id":"cj2yhqc05000cz29kpb5g27ob","_id":"cj2yhqc09000oz29kcm8ideo6"},{"post_id":"cj2yhqc0a000sz29ksuoo6wy4","category_id":"cj2yhqc0c000tz29kahmcdy3f","_id":"cj2yhqc0d000wz29km007t953"},{"post_id":"cj2yhqc0e0011z29kmqmjpvvf","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc0f0015z29k84syatjb"},{"post_id":"cj2yhqc0h001cz29kjxicw6o1","category_id":"cj2yhqc0i001dz29krhmgbzbp","_id":"cj2yhqc0j001gz29kdv2cpwat"},{"post_id":"cj2yhqc0k001lz29krd4yp2kx","category_id":"cj2yhqc0l001mz29kavth5yzj","_id":"cj2yhqc0l001nz29k1ekr3c49"},{"post_id":"cj2yhqc0m001oz29k8l23ku73","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc0n001qz29ks9om2a3q"},{"post_id":"cj2yhqc0o001vz29ktce89543","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc0q001xz29k01q1b421"},{"post_id":"cj2yhqc0s0024z29kgvd77xm0","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc0t0026z29knp3vd1bz"},{"post_id":"cj2yhqc0v002dz29kzw4rqd68","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc0w002fz29kt61pqkov"},{"post_id":"cj2yhqc0w002iz29kdbgmz76o","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc0x002kz29k5qq9oldd"},{"post_id":"cj2yhqc0y002pz29kpu2h00zd","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc0z002rz29kngvtzhkz"},{"post_id":"cj2yhqc10002sz29k0deo29cd","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc11002uz29kvd9jkzr2"},{"post_id":"cj2yhqc11002xz29ky6q0uck5","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc12002zz29kxgpn64ht"},{"post_id":"cj2yhqc130032z29k9lz67tx4","category_id":"cj2yhqc0f0012z29kfreaoola","_id":"cj2yhqc140034z29kfduatpze"},{"post_id":"cj2yhqc170037z29kumm9y09h","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc19003dz29kokm805wj"},{"post_id":"cj2yhqc170037z29kumm9y09h","category_id":"cj2yhqc18003bz29kjt4npyzi","_id":"cj2yhqc19003fz29kpkuhbe9b"},{"post_id":"cj2yhqc19003iz29k01p8063b","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1c003kz29kitxt016h"},{"post_id":"cj2yhqc19003iz29k01p8063b","category_id":"cj2yhqc18003bz29kjt4npyzi","_id":"cj2yhqc1c003lz29kmcbt9l85"},{"post_id":"cj2yhqc1e003pz29khn4j5gjf","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1f003rz29ktt51zxd5"},{"post_id":"cj2yhqc1e003pz29khn4j5gjf","category_id":"cj2yhqc18003bz29kjt4npyzi","_id":"cj2yhqc1f003sz29kp7kisnaq"},{"post_id":"cj2yhqc1f003tz29kjus942ef","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1h003wz29kpjmt7idv"},{"post_id":"cj2yhqc1f003tz29kjus942ef","category_id":"cj2yhqc18003bz29kjt4npyzi","_id":"cj2yhqc1h003xz29k2gq3ihh5"},{"post_id":"cj2yhqc1i003yz29klctyumk3","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1k0040z29ktvuotrl8"},{"post_id":"cj2yhqc1i003yz29klctyumk3","category_id":"cj2yhqc18003bz29kjt4npyzi","_id":"cj2yhqc1k0041z29ktwnk5071"},{"post_id":"cj2yhqc1k0042z29k6e21nzms","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1l0044z29kpkd9d340"},{"post_id":"cj2yhqc1k0042z29k6e21nzms","category_id":"cj2yhqc18003bz29kjt4npyzi","_id":"cj2yhqc1l0045z29kgncg8hc3"},{"post_id":"cj2yhqc1m0049z29kg5i6wed3","category_id":"cj2yhqc1q004az29kzk2253h0","_id":"cj2yhqc1r004dz29kxn7owltn"},{"post_id":"cj2yhqc1s004gz29k4w2zeqct","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1t004kz29khbdds8w7"},{"post_id":"cj2yhqc1s004gz29k4w2zeqct","category_id":"cj2yhqc1t004iz29ku5t8iz6x","_id":"cj2yhqc1t004mz29kyy7r824v"},{"post_id":"cj2yhqc1u004sz29kaug6xam1","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc1w004wz29kdomhkmae"},{"post_id":"cj2yhqc1u004sz29kaug6xam1","category_id":"cj2yhqc1v004uz29k916a4q7o","_id":"cj2yhqc1w004xz29kp9drlvow"},{"post_id":"cj2yhqc4o0051z29krc9sbdj7","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc4q0055z29k7xpw8cm1"},{"post_id":"cj2yhqc4o0051z29krc9sbdj7","category_id":"cj2yhqc4q0053z29k25fdh5q1","_id":"cj2yhqc4r0056z29kgnx8dmpw"},{"post_id":"cj2yhqc4r0059z29k0zdzzzqy","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc4t005cz29kdjxowyfb"},{"post_id":"cj2yhqc4r0059z29k0zdzzzqy","category_id":"cj2yhqc4q0053z29k25fdh5q1","_id":"cj2yhqc4t005dz29kk017op9d"},{"post_id":"cj2yhqc4t005ez29kywg1jefh","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc4v005iz29kps6054vu"},{"post_id":"cj2yhqc4t005ez29kywg1jefh","category_id":"cj2yhqc4v005gz29k9tde3k36","_id":"cj2yhqc4v005jz29kt3znl0sx"},{"post_id":"cj2yhqc4x005mz29kkuqif693","category_id":"cj2yhqc4y005nz29k8h605rxj","_id":"cj2yhqc4z005rz29kune4gchc"},{"post_id":"cj2yhqc4x005mz29kkuqif693","category_id":"cj2yhqc4z005qz29kjqyatc5p","_id":"cj2yhqc4z005sz29kvnbxa21o"},{"post_id":"cj2yhqc50005tz29k2p0cki3i","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc52005xz29k89pfi4as"},{"post_id":"cj2yhqc50005tz29k2p0cki3i","category_id":"cj2yhqc51005vz29kxdfy57q3","_id":"cj2yhqc52005yz29kfgir4sbd"},{"post_id":"cj2yhqc52005zz29kifjafbx7","category_id":"cj2yhqc180038z29krw969atb","_id":"cj2yhqc540063z29kism8f0qe"},{"post_id":"cj2yhqc52005zz29kifjafbx7","category_id":"cj2yhqc540061z29kn080vi1e","_id":"cj2yhqc550064z29kug8fm926"}],"PostTag":[{"post_id":"cj2yhqbub0001z29k1z36bp8m","tag_id":"cj2yhqbug0003z29kwe6navld","_id":"cj2yhqbuh0006z29kahe86ayj"},{"post_id":"cj2yhqbub0001z29k1z36bp8m","tag_id":"cj2yhqbug0004z29ki59ez0gt","_id":"cj2yhqbui0007z29k042q4yxo"},{"post_id":"cj2yhqc04000bz29k30egd1hz","tag_id":"cj2yhqc06000dz29kaqw59bem","_id":"cj2yhqc06000iz29kwnwjxzhn"},{"post_id":"cj2yhqc04000bz29k30egd1hz","tag_id":"cj2yhqc06000ez29kzldcx803","_id":"cj2yhqc06000jz29kkg4av66q"},{"post_id":"cj2yhqc04000bz29k30egd1hz","tag_id":"cj2yhqc06000gz29k7otzzj6r","_id":"cj2yhqc06000kz29kn261pyor"},{"post_id":"cj2yhqc04000bz29k30egd1hz","tag_id":"cj2yhqc06000hz29kh0s0drf7","_id":"cj2yhqc06000lz29k67t4ieix"},{"post_id":"cj2yhqc07000mz29kpdjtcp88","tag_id":"cj2yhqc06000dz29kaqw59bem","_id":"cj2yhqc09000nz29knneisv0f"},{"post_id":"cj2yhqc07000mz29kpdjtcp88","tag_id":"cj2yhqc06000ez29kzldcx803","_id":"cj2yhqc09000pz29kymww4lzb"},{"post_id":"cj2yhqc07000mz29kpdjtcp88","tag_id":"cj2yhqc06000gz29k7otzzj6r","_id":"cj2yhqc09000qz29klm322ht8"},{"post_id":"cj2yhqc07000mz29kpdjtcp88","tag_id":"cj2yhqc06000hz29kh0s0drf7","_id":"cj2yhqc09000rz29k8iyo5mqf"},{"post_id":"cj2yhqc0a000sz29ksuoo6wy4","tag_id":"cj2yhqc0c000uz29k1xgvkjjv","_id":"cj2yhqc0d000yz29ke6f11fza"},{"post_id":"cj2yhqc0a000sz29ksuoo6wy4","tag_id":"cj2yhqc0c000vz29k9sx8nrkh","_id":"cj2yhqc0d000zz29kdcs43wkk"},{"post_id":"cj2yhqc0a000sz29ksuoo6wy4","tag_id":"cj2yhqc0d000xz29ku3mzp6c5","_id":"cj2yhqc0e0010z29kkcgv9cf9"},{"post_id":"cj2yhqc0e0011z29kmqmjpvvf","tag_id":"cj2yhqc0f0013z29kvhsrwf6y","_id":"cj2yhqc0g0018z29kvdgt3xst"},{"post_id":"cj2yhqc0e0011z29kmqmjpvvf","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc0g0019z29kn5nwmmzw"},{"post_id":"cj2yhqc0e0011z29kmqmjpvvf","tag_id":"cj2yhqc0f0016z29k8yfdqyuf","_id":"cj2yhqc0g001az29k0ddrir1a"},{"post_id":"cj2yhqc0e0011z29kmqmjpvvf","tag_id":"cj2yhqc0g0017z29k3o6znpbd","_id":"cj2yhqc0g001bz29kvjn44tdq"},{"post_id":"cj2yhqc0h001cz29kjxicw6o1","tag_id":"cj2yhqc0j001ez29kyzexh167","_id":"cj2yhqc0j001iz29kq213lk2d"},{"post_id":"cj2yhqc0h001cz29kjxicw6o1","tag_id":"cj2yhqc0j001fz29k99n4pk78","_id":"cj2yhqc0j001jz29k61r60muh"},{"post_id":"cj2yhqc0h001cz29kjxicw6o1","tag_id":"cj2yhqc0j001hz29k9px9hf8t","_id":"cj2yhqc0j001kz29k41vmwuq0"},{"post_id":"cj2yhqc0m001oz29k8l23ku73","tag_id":"cj2yhqc0m001pz29kefgxfg16","_id":"cj2yhqc0n001sz29k717zbh9p"},{"post_id":"cj2yhqc0m001oz29k8l23ku73","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc0n001tz29kbeltzlkz"},{"post_id":"cj2yhqc0m001oz29k8l23ku73","tag_id":"cj2yhqc0n001rz29kpkx3xce5","_id":"cj2yhqc0o001uz29kiniir276"},{"post_id":"cj2yhqc0o001vz29ktce89543","tag_id":"cj2yhqc0f0013z29kvhsrwf6y","_id":"cj2yhqc0r001zz29kz7hwbv44"},{"post_id":"cj2yhqc0o001vz29ktce89543","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc0r0020z29k5joo8j1f"},{"post_id":"cj2yhqc0o001vz29ktce89543","tag_id":"cj2yhqc0f0016z29k8yfdqyuf","_id":"cj2yhqc0r0021z29kzq6w42tm"},{"post_id":"cj2yhqc0o001vz29ktce89543","tag_id":"cj2yhqc0q001wz29kealy3gs3","_id":"cj2yhqc0r0022z29kcx166nua"},{"post_id":"cj2yhqc0o001vz29ktce89543","tag_id":"cj2yhqc0r001yz29kdpsfxezz","_id":"cj2yhqc0r0023z29kjb4hkz60"},{"post_id":"cj2yhqc0s0024z29kgvd77xm0","tag_id":"cj2yhqc0f0013z29kvhsrwf6y","_id":"cj2yhqc0t0028z29kerb3wbr8"},{"post_id":"cj2yhqc0s0024z29kgvd77xm0","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc0u0029z29knripz18x"},{"post_id":"cj2yhqc0s0024z29kgvd77xm0","tag_id":"cj2yhqc0f0016z29k8yfdqyuf","_id":"cj2yhqc0u002az29k1w7g115e"},{"post_id":"cj2yhqc0s0024z29kgvd77xm0","tag_id":"cj2yhqc0t0025z29kzy6z3o6j","_id":"cj2yhqc0u002bz29k872td27m"},{"post_id":"cj2yhqc0s0024z29kgvd77xm0","tag_id":"cj2yhqc0t0027z29k2p9ev9we","_id":"cj2yhqc0u002cz29k9oe3h0qa"},{"post_id":"cj2yhqc0v002dz29kzw4rqd68","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc0w002ez29kfvewgclm"},{"post_id":"cj2yhqc0v002dz29kzw4rqd68","tag_id":"cj2yhqc0t0025z29kzy6z3o6j","_id":"cj2yhqc0w002gz29kdy4my0o7"},{"post_id":"cj2yhqc0v002dz29kzw4rqd68","tag_id":"cj2yhqc0n001rz29kpkx3xce5","_id":"cj2yhqc0w002hz29klevd6egr"},{"post_id":"cj2yhqc0w002iz29kdbgmz76o","tag_id":"cj2yhqc0f0013z29kvhsrwf6y","_id":"cj2yhqc0y002lz29k00l8ichc"},{"post_id":"cj2yhqc0w002iz29kdbgmz76o","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc0y002mz29kb6lxk6ph"},{"post_id":"cj2yhqc0w002iz29kdbgmz76o","tag_id":"cj2yhqc0f0016z29k8yfdqyuf","_id":"cj2yhqc0y002nz29klh01wkp7"},{"post_id":"cj2yhqc0w002iz29kdbgmz76o","tag_id":"cj2yhqc0x002jz29kx6n4zqmq","_id":"cj2yhqc0y002oz29ko5ci5gql"},{"post_id":"cj2yhqc0y002pz29kpu2h00zd","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc0z002qz29ksjei1zzm"},{"post_id":"cj2yhqc10002sz29k0deo29cd","tag_id":"cj2yhqc0f0013z29kvhsrwf6y","_id":"cj2yhqc11002tz29k1e1miezm"},{"post_id":"cj2yhqc10002sz29k0deo29cd","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc11002vz29k7eh4m7ky"},{"post_id":"cj2yhqc10002sz29k0deo29cd","tag_id":"cj2yhqc0f0016z29k8yfdqyuf","_id":"cj2yhqc11002wz29kyoic4ntb"},{"post_id":"cj2yhqc11002xz29ky6q0uck5","tag_id":"cj2yhqc0f0013z29kvhsrwf6y","_id":"cj2yhqc12002yz29kxghrt52n"},{"post_id":"cj2yhqc11002xz29ky6q0uck5","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc130030z29ktjot47ui"},{"post_id":"cj2yhqc11002xz29ky6q0uck5","tag_id":"cj2yhqc0f0016z29k8yfdqyuf","_id":"cj2yhqc130031z29krce5i8qd"},{"post_id":"cj2yhqc130032z29k9lz67tx4","tag_id":"cj2yhqc0f0013z29kvhsrwf6y","_id":"cj2yhqc140033z29kpi5mv41q"},{"post_id":"cj2yhqc130032z29k9lz67tx4","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc140035z29k9tzx0r79"},{"post_id":"cj2yhqc130032z29k9lz67tx4","tag_id":"cj2yhqc0f0016z29k8yfdqyuf","_id":"cj2yhqc140036z29kbi4tjbae"},{"post_id":"cj2yhqc170037z29kumm9y09h","tag_id":"cj2yhqc180039z29k6awco3r5","_id":"cj2yhqc19003ez29kv0n11g0f"},{"post_id":"cj2yhqc170037z29kumm9y09h","tag_id":"cj2yhqc18003az29kc7z7nh6c","_id":"cj2yhqc19003gz29kirz74wea"},{"post_id":"cj2yhqc170037z29kumm9y09h","tag_id":"cj2yhqc18003cz29kyglak4xv","_id":"cj2yhqc19003hz29ka0r3981y"},{"post_id":"cj2yhqc19003iz29k01p8063b","tag_id":"cj2yhqc1c003jz29kqlcli4ht","_id":"cj2yhqc1d003nz29kspjl7h1o"},{"post_id":"cj2yhqc19003iz29k01p8063b","tag_id":"cj2yhqc1c003mz29k8hjnhg0j","_id":"cj2yhqc1d003oz29k29y05lfr"},{"post_id":"cj2yhqc1e003pz29khn4j5gjf","tag_id":"cj2yhqc1c003jz29kqlcli4ht","_id":"cj2yhqc1f003qz29k0nv4qv3j"},{"post_id":"cj2yhqc1f003tz29kjus942ef","tag_id":"cj2yhqc1c003jz29kqlcli4ht","_id":"cj2yhqc1g003uz29k2smvm8cm"},{"post_id":"cj2yhqc1f003tz29kjus942ef","tag_id":"cj2yhqc1c003mz29k8hjnhg0j","_id":"cj2yhqc1g003vz29k0e4p6kv5"},{"post_id":"cj2yhqc1i003yz29klctyumk3","tag_id":"cj2yhqc1c003jz29kqlcli4ht","_id":"cj2yhqc1j003zz29kh0f797g7"},{"post_id":"cj2yhqc1k0042z29k6e21nzms","tag_id":"cj2yhqc180039z29k6awco3r5","_id":"cj2yhqc1l0046z29k6ylxz132"},{"post_id":"cj2yhqc1k0042z29k6e21nzms","tag_id":"cj2yhqc18003az29kc7z7nh6c","_id":"cj2yhqc1l0047z29kzta2df1a"},{"post_id":"cj2yhqc1k0042z29k6e21nzms","tag_id":"cj2yhqc1l0043z29kkt5xlpjg","_id":"cj2yhqc1m0048z29kbo35v30n"},{"post_id":"cj2yhqc1m0049z29kg5i6wed3","tag_id":"cj2yhqc1q004bz29ki7va8t1p","_id":"cj2yhqc1r004ez29kw326hl38"},{"post_id":"cj2yhqc1m0049z29kg5i6wed3","tag_id":"cj2yhqc1r004cz29kh7ybbgzk","_id":"cj2yhqc1r004fz29kcxgp57x2"},{"post_id":"cj2yhqc1s004gz29k4w2zeqct","tag_id":"cj2yhqc1s004hz29kq7vvvk2f","_id":"cj2yhqc1u004oz29kpuy6l8u5"},{"post_id":"cj2yhqc1s004gz29k4w2zeqct","tag_id":"cj2yhqc1t004jz29k4dwi2fjc","_id":"cj2yhqc1u004pz29kdjqlultd"},{"post_id":"cj2yhqc1s004gz29k4w2zeqct","tag_id":"cj2yhqc1t004lz29k5oxcjzex","_id":"cj2yhqc1u004qz29k0xlamu5y"},{"post_id":"cj2yhqc1s004gz29k4w2zeqct","tag_id":"cj2yhqc1t004nz29keo6csx7f","_id":"cj2yhqc1u004rz29k1uf46sf4"},{"post_id":"cj2yhqc1u004sz29kaug6xam1","tag_id":"cj2yhqc1v004tz29kphxrurz7","_id":"cj2yhqc1w004yz29kgin3dw8v"},{"post_id":"cj2yhqc1u004sz29kaug6xam1","tag_id":"cj2yhqc1w004vz29ku4zgedyu","_id":"cj2yhqc1w004zz29k3ljfugqk"},{"post_id":"cj2yhqc1u004sz29kaug6xam1","tag_id":"cj2yhqc0f0014z29kgvc54gpi","_id":"cj2yhqc1w0050z29ksww3w3eg"},{"post_id":"cj2yhqc4o0051z29krc9sbdj7","tag_id":"cj2yhqc4q0052z29kkf7d2nv9","_id":"cj2yhqc4r0057z29krzvmejq5"},{"post_id":"cj2yhqc4o0051z29krc9sbdj7","tag_id":"cj2yhqc4q0054z29ket9k88cb","_id":"cj2yhqc4r0058z29kn2denqpl"},{"post_id":"cj2yhqc4r0059z29k0zdzzzqy","tag_id":"cj2yhqc4q0052z29kkf7d2nv9","_id":"cj2yhqc4t005az29knnke8ixp"},{"post_id":"cj2yhqc4r0059z29k0zdzzzqy","tag_id":"cj2yhqc4q0054z29ket9k88cb","_id":"cj2yhqc4t005bz29krgd2l0f9"},{"post_id":"cj2yhqc4t005ez29kywg1jefh","tag_id":"cj2yhqc4u005fz29kpoq6tqvg","_id":"cj2yhqc4v005kz29kw9avusx5"},{"post_id":"cj2yhqc4t005ez29kywg1jefh","tag_id":"cj2yhqc4v005hz29kbk2r5tkk","_id":"cj2yhqc4w005lz29kx4d2r5vb"},{"post_id":"cj2yhqc4x005mz29kkuqif693","tag_id":"cj2yhqc4z005oz29krbri8xbb","_id":"cj2yhqc4z005pz29kabvl20oq"},{"post_id":"cj2yhqc50005tz29k2p0cki3i","tag_id":"cj2yhqc51005uz29kfp9zqn7l","_id":"cj2yhqc51005wz29k0ndpzdrj"},{"post_id":"cj2yhqc52005zz29kifjafbx7","tag_id":"cj2yhqc530060z29kdmmvkyrr","_id":"cj2yhqc550065z29khutd0sh0"},{"post_id":"cj2yhqc52005zz29kifjafbx7","tag_id":"cj2yhqc540062z29kify8rlwa","_id":"cj2yhqc550066z29k5n3xdyhr"}],"Tag":[{"name":"春天","_id":"cj2yhqbug0003z29kwe6navld"},{"name":"梅花","_id":"cj2yhqbug0004z29ki59ez0gt"},{"name":"MQ","_id":"cj2yhqc06000dz29kaqw59bem"},{"name":"本地文件队列","_id":"cj2yhqc06000ez29kzldcx803"},{"name":"隔离","_id":"cj2yhqc06000gz29k7otzzj6r"},{"name":"降级","_id":"cj2yhqc06000hz29kh0s0drf7"},{"name":"Maxwell","_id":"cj2yhqc0c000uz29k1xgvkjjv"},{"name":"binlog","_id":"cj2yhqc0c000vz29k9sx8nrkh"},{"name":"mysql","_id":"cj2yhqc0d000xz29ku3mzp6c5"},{"name":"spring-cloud","_id":"cj2yhqc0f0013z29kvhsrwf6y"},{"name":"微服务","_id":"cj2yhqc0f0014z29kgvc54gpi"},{"name":"Spring Boot","_id":"cj2yhqc0f0016z29k8yfdqyuf"},{"name":"分布式事务","_id":"cj2yhqc0g0017z29k3o6znpbd"},{"name":"nginx","_id":"cj2yhqc0j001ez29kyzexh167"},{"name":"lua","_id":"cj2yhqc0j001fz29k99n4pk78"},{"name":"openresty","_id":"cj2yhqc0j001hz29k9px9hf8t"},{"name":"Feign","_id":"cj2yhqc0m001pz29kefgxfg16"},{"name":"Spring Cloud","_id":"cj2yhqc0n001rz29kpkx3xce5"},{"name":"API Gateway","_id":"cj2yhqc0q001wz29kealy3gs3"},{"name":"网关","_id":"cj2yhqc0r001yz29kdpsfxezz"},{"name":"Eureka","_id":"cj2yhqc0t0025z29kzy6z3o6j"},{"name":"服务发现","_id":"cj2yhqc0t0027z29k2p9ev9we"},{"name":"分布式配置管理","_id":"cj2yhqc0x002jz29kx6n4zqmq"},{"name":"spring cloud","_id":"cj2yhqc180039z29k6awco3r5"},{"name":"Hystrix","_id":"cj2yhqc18003az29kc7z7nh6c"},{"name":"semaphore","_id":"cj2yhqc18003cz29kyglak4xv"},{"name":"hystrix","_id":"cj2yhqc1c003jz29kqlcli4ht"},{"name":"Circuit Breaker","_id":"cj2yhqc1c003mz29k8hjnhg0j"},{"name":"zuul","_id":"cj2yhqc1l0043z29kkt5xlpjg"},{"name":"JDBC","_id":"cj2yhqc1q004bz29ki7va8t1p"},{"name":"事务","_id":"cj2yhqc1r004cz29kh7ybbgzk"},{"name":"负载均衡","_id":"cj2yhqc1s004hz29kq7vvvk2f"},{"name":"加权轮询","_id":"cj2yhqc1t004jz29k4dwi2fjc"},{"name":"轮询","_id":"cj2yhqc1t004lz29k5oxcjzex"},{"name":"算法","_id":"cj2yhqc1t004nz29keo6csx7f"},{"name":"单一职责","_id":"cj2yhqc1v004tz29kphxrurz7"},{"name":"软件开发","_id":"cj2yhqc1w004vz29ku4zgedyu"},{"name":"FlatBuffers","_id":"cj2yhqc4q0052z29kkf7d2nv9"},{"name":"序列化","_id":"cj2yhqc4q0054z29ket9k88cb"},{"name":"基准测试","_id":"cj2yhqc4u005fz29kpoq6tqvg"},{"name":"wrk","_id":"cj2yhqc4v005hz29kbk2r5tkk"},{"name":"http 2.0","_id":"cj2yhqc4z005oz29krbri8xbb"},{"name":"Hexo","_id":"cj2yhqc51005uz29kfp9zqn7l"},{"name":"领域模型","_id":"cj2yhqc530060z29kdmmvkyrr"},{"name":"DDD","_id":"cj2yhqc540062z29kify8rlwa"}]}}